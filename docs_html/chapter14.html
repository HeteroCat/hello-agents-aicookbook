<h1>第十四章 自动化深度研究智能体</h1>
<p>在第十三章的旅行助手项目中，我们体验了如何将 HelloAgents 应用于一个多智能体产品。本章我们继续向前，聚焦「知识密集型应用」：<strong>构建一个能够自动化执行深度研究任务的智能体助手。</strong></p>
<p>相比旅行规划，深度研究的难点在于信息的不断发散、事实的快速更新以及用户对引用来源的高要求。为了交付可信的研究报告，我们需要让智能体具备三个核心能力：</p>
<p><strong>（1）问题剖析</strong>：将用户的开放主题拆解为可检索的查询语句。</p>
<p><strong>（2）多轮信息采集</strong>：结合不同搜索 API 持续挖掘资料，并去重整合。</p>
<p><strong>（3）反思与总结</strong>：依据阶段结果识别知识空白，决定是否继续检索，并生成结构化总结。</p>
<h2>14.1 项目概述与架构设计</h2>
<h3>14.1.1 为什么需要深度研究助手</h3>
<p>在信息爆炸的时代，我们每天都需要快速了解新的技术、概念或事件。传统的研究方式有几个痛点。首先是<strong>信息过载</strong>。搜索引擎返回成千上万的结果，你需要逐个点开链接，阅读大量内容，才能找到有用的信息。其次是<strong>缺少结构</strong>。即使找到了相关信息，这些信息往往是碎片化的，缺少系统性的组织。最后是<strong>重复劳动</strong>。每次研究新主题时，都需要重复"搜索→阅读→总结→整理"的过程。</p>
<p>这就是深度研究助手需要解决的问题。它不仅仅是一个搜索工具，而是一个能够自主规划、执行和总结的研究助手。</p>
<p><strong>深度研究助手的核心价值：</strong></p>
<ol>
<li><strong>节省时间</strong>：将 1-2 小时的研究工作压缩到 5-10 分钟</li>
<li><strong>提高质量</strong>：系统化的研究流程，避免遗漏重要信息</li>
<li><strong>可追溯</strong>：记录所有搜索结果和来源，方便验证和引用</li>
<li><strong>可扩展</strong>：可以轻松添加新的搜索引擎、数据源和分析工具</li>
</ol>
<h3>14.1.2 技术架构概览</h3>
<p>此次系统仍然采用经典的<strong>前后端分离架构</strong>，如图 14.1 所示。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-1.png" alt="" width="85%">
  <p>图 14.1 深度研究助手技术架构</p>
</div>
<p>系统分为四层架构设计：</p>
<p><strong>前端层 (Vue3+TypeScript)</strong>：全屏模态对话框 UI、Markdown 结果可视化</p>
<p><strong>后端层 (FastAPI)</strong>：API 路由（<code>/research/stream</code>）</p>
<p><strong>智能体层 (HelloAgents)</strong>：三个专门 Agent（TODO Planner、Task Summarizer、Report Writer）+ 两个核心工具（SearchTool、NoteTool）</p>
<p><strong>外部服务层</strong>：搜索引擎+ LLM 提供商</p>
<p>让我们看看一个完整的研究请求是如何在系统中流转的，如图 14.2 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-2.png" alt="" width="85%">
  <p>图 14.2 深度研究助手数据流转过程</p>
</div>
<ol>
<li><strong>用户输入</strong>：用户在前端输入研究主题</li>
<li><strong>前端发送</strong>：前端通过 SSE 连接到<code>/research/stream</code></li>
<li><strong>后端接收</strong>：FastAPI 接收请求，创建研究状态</li>
<li><strong>规划阶段</strong>：调用研究规划 Agent，分解为 3 个子任务</li>
<li><strong>执行阶段</strong>：逐个执行每个子任务
<ul>
<li>使用 SearchTool 搜索</li>
<li>调用任务总结 Agent 总结</li>
<li>使用 NoteTool 记录结果</li>
</ul>
</li>
<li><strong>报告阶段</strong>：调用报告生成 Agent，整合所有总结</li>
<li><strong>流式返回</strong>：通过 SSE 推送进度和结果到前端</li>
<li><strong>前端展示</strong>：前端实时更新任务状态、进度条、日志、报告</li>
</ol>
<p>项目的目录结构如下：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">helloagents-deepresearch/
</span><span class="code-line line-number" line="2">├── backend/                    # 后端代码
</span><span class="code-line line-number" line="3">│   ├── src/
</span><span class="code-line line-number" line="4">│   │   ├── agent.py           # 核心协调器
</span><span class="code-line line-number" line="5">│   │   ├── main.py            # FastAPI入口
</span><span class="code-line line-number" line="6">│   │   ├── models.py          # 数据模型
</span><span class="code-line line-number" line="7">│   │   ├── prompts.py         # Prompt模板
</span><span class="code-line line-number" line="8">│   │   ├── config.py          # 配置管理
</span><span class="code-line line-number" line="9">│   │   └── services/          # 服务层
</span><span class="code-line line-number" line="10">│   │       ├── planner.py     # 规划服务
</span><span class="code-line line-number" line="11">│   │       ├── summarizer.py  # 总结服务
</span><span class="code-line line-number" line="12">│   │       ├── reporter.py    # 报告服务
</span><span class="code-line line-number" line="13">│   │       └── search.py      # 搜索服务
</span><span class="code-line line-number" line="14">│   ├── .env                   # 环境变量
</span><span class="code-line line-number" line="15">│   ├── pyproject.toml         # 依赖管理
</span><span class="code-line line-number" line="16">│   └── workspace/             # 研究笔记
</span><span class="code-line line-number" line="17">│
</span><span class="code-line line-number" line="18">└── frontend/                   # 前端代码
</span><span class="code-line line-number" line="19">    ├── src/
</span><span class="code-line line-number" line="20">    │   ├── App.vue            # 主组件
</span><span class="code-line line-number" line="21">    │   ├── components/        # UI组件
</span><span class="code-line line-number" line="22">    │   │   └── ResearchModal.vue
</span><span class="code-line line-number" line="23">    │   └── composables/       # 组合式函数
</span><span class="code-line line-number" line="24">    │       └── useResearch.ts
</span><span class="code-line line-number" line="25">    ├── package.json           # npm依赖
</span><span class="code-line line-number" line="26">    └── vite.config.ts         # 构建配置
</span></code></pre>
<h3>14.1.3 快速体验：5 分钟运行项目</h3>
<p>在深入学习实现细节之前，让我们先把项目跑起来，看看最终的效果。这样你会对整个系统有一个直观的认识。</p>
<p>你可以通过以下命令检查版本：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1">python <span class="token parameter variable">--version</span>  <span class="token comment"># 应该显示 Python 3.10.x 或更高</span>
</span><span class="code-line line-number" line="2"><span class="token function">node</span> <span class="token parameter variable">--version</span>    <span class="token comment"># 应该显示 v16.x.x 或更高</span>
</span><span class="code-line line-number" line="3"><span class="token function">npm</span> <span class="token parameter variable">--version</span>     <span class="token comment"># 应该显示 8.x.x 或更高</span>
</span></code></pre>
<p>（1）启动后端</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 1. 进入后端目录</span>
</span><span class="code-line line-number" line="2"><span class="token builtin class-name">cd</span> helloagents-deepresearch/backend
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 2. 安装依赖</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># 方式1：使用uv（推荐，更快的Python包管理器）</span>
</span><span class="code-line line-number" line="6">uv <span class="token function">sync</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 方式2：使用pip</span>
</span><span class="code-line line-number" line="9">pip <span class="token function">install</span> <span class="token parameter variable">-e</span> <span class="token builtin class-name">.</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 3. 配置环境变量</span>
</span><span class="code-line line-number" line="12"><span class="token function">cp</span> .env.example .env
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token comment"># 4. 编辑.env文件，填入你的API密钥</span>
</span><span class="code-line line-number" line="15"><span class="token comment"># 使用你喜欢的编辑器打开.env文件</span>
</span><span class="code-line line-number" line="16"><span class="token comment"># 至少需要配置：</span>
</span><span class="code-line line-number" line="17"><span class="token comment"># - LLM_PROVIDER（如 openai、deepseek、qwen）</span>
</span><span class="code-line line-number" line="18"><span class="token comment"># - LLM_API_KEY（你的LLM API密钥）</span>
</span><span class="code-line line-number" line="19"><span class="token comment"># - SEARCH_API（如 duckduckgo、tavily）</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 5. 启动后端</span>
</span><span class="code-line line-number" line="22">python src/main.py
</span></code></pre>
<p>如果一切正常，你会看到类似的输出：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">INFO:     Started server process [12345]
</span><span class="code-line line-number" line="2">INFO:     Waiting for application startup.
</span><span class="code-line line-number" line="3">INFO:     Application startup complete.
</span><span class="code-line line-number" line="4">INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
</span></code></pre>
<p>（2）启动前端</p>
<p>打开一个新的终端窗口：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 1. 进入前端目录</span>
</span><span class="code-line line-number" line="2"><span class="token builtin class-name">cd</span> helloagents-deepresearch/frontend
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 2. 安装依赖</span>
</span><span class="code-line line-number" line="5"><span class="token function">npm</span> <span class="token function">install</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 3. 启动前端</span>
</span><span class="code-line line-number" line="8"><span class="token function">npm</span> run dev
</span></code></pre>
<p>如果一切正常，你会看到类似的输出：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">  VITE v5.0.0  ready in 500 ms
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3">  ➜  Local:   http://localhost:5174/
</span><span class="code-line line-number" line="4">  ➜  Network: use --host to expose
</span><span class="code-line line-number" line="5">  ➜  press h + enter to show help
</span></code></pre>
<p>（3）开始研究</p>
<p>打开浏览器访问 <code>http://localhost:5174</code>，你会看到一个居中的输入卡片，如图 14.3 所示。输入研究主题，例如<code>Datawhale是一个什么样的组织？</code>，选择搜索引擎（如果配置了多个），点击"开始研究"按钮。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-3.png" alt="" width="85%">
  <p>图 14.3 深度研究助手搜索页面</p>
</div>
<p>如图 14.4 所示，系统会自动展开为全屏，左侧显示研究信息，右侧实时显示研究进度和结果。整个研究过程大约需要 1-3 分钟，取决于主题的复杂度和搜索引擎的响应速度。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-4.png" alt="" width="85%">
  <p>图 14.4 深度研究助手展开研究</p>
</div>
<p>研究完成后，你会看到：</p>
<ul>
<li><strong>任务列表</strong>：显示所有子任务及其状态</li>
<li><strong>进度日志</strong>：显示研究过程中的所有操作</li>
<li><strong>最终报告</strong>：结构化的 Markdown 报告，包含所有子任务的总结和来源引用</li>
</ul>
<p>现在你已经成功运行了深度研究助手，对系统有了直观的认识。</p>
<h2>14.2 TODO 驱动的研究范式</h2>
<h3>14.2.1 什么是 TODO 驱动的研究</h3>
<p>传统的搜索引擎只能回答单个问题，而深度研究需要回答一系列相关的问题。TODO 驱动的研究范式将复杂的研究主题分解为多个子任务（TODO），逐个执行并整合结果。</p>
<p>这种范式的核心思想是：<strong>将"研究"这个复杂任务转化为"规划→执行→整合"的流程</strong>。</p>
<p>让我们通过一个例子来理解这个转变。假设你想研究"Datawhale 是一个什么样的组织？"，传统的搜索方式是：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">用户输入：Datawhale是一个什么样的组织？
</span><span class="code-line line-number" line="2">搜索引擎：返回10-20个链接
</span><span class="code-line line-number" line="3">用户：逐个点开链接，阅读内容，记录笔记
</span><span class="code-line line-number" line="4">结果：碎片化的信息，缺少系统性
</span></code></pre>
<p>这种方式的问题在于每个链接只涵盖主题的一个方面、缺少系统性结构，需要手动整理和总结。</p>
<p><strong>TODO 驱动方式：系统化研究</strong></p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">用户输入：Datawhale是一个什么样的组织？
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3">系统规划：
</span><span class="code-line line-number" line="4">  ├─ TODO 1：Datawhale的基本信息（组织定位）
</span><span class="code-line line-number" line="5">  ├─ TODO 2：Datawhale的主要项目（核心内容）
</span><span class="code-line line-number" line="6">  ├─ TODO 3：Datawhale的社区文化（价值观）
</span><span class="code-line line-number" line="7">  └─ TODO 4：Datawhale的影响力（社会贡献）
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">系统执行：
</span><span class="code-line line-number" line="10">  对每个TODO：
</span><span class="code-line line-number" line="11">    1. 搜索相关资料
</span><span class="code-line line-number" line="12">    2. 总结关键信息
</span><span class="code-line line-number" line="13">    3. 记录来源引用
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">系统整合：
</span><span class="code-line line-number" line="16">  生成结构化报告：
</span><span class="code-line line-number" line="17">    ├─ 第一部分：组织定位（来自TODO 1）
</span><span class="code-line line-number" line="18">    ├─ 第二部分：核心内容（来自TODO 2）
</span><span class="code-line line-number" line="19">    ├─ 第三部分：价值观（来自TODO 3）
</span><span class="code-line line-number" line="20">    ├─ 第四部分：社会贡献（来自TODO 4）
</span><span class="code-line line-number" line="21">    └─ 参考文献：所有来源引用
</span></code></pre>
<p>这种方式的优势在于将复杂主题分解为清晰的子问题，每个子任务的搜索结果和总结都被记录下来，方便追溯。同时，系统化的研究流程避免了遗漏重要信息，可以轻松添加新的子任务或调整执行顺序。</p>
<p>一个完整的 TODO 驱动研究系统包含三个核心要素：</p>
<p><strong>（1）智能规划器（TODO Planner）</strong>：负责将研究主题分解为子任务。一个好的规划器需要理解主题的关键方面和研究目标，将主题分解为 3-5 个子任务（太少覆盖不全，太多会冗余），并为每个子任务设计合适的搜索查询。</p>
<p><strong>（2）任务执行器（Task Executor）</strong>：负责执行每个子任务。执行器需要使用搜索引擎获取相关资料，提取关键信息并去除冗余内容，同时保存所有来源引用以方便验证。</p>
<p><strong>（3）报告生成器（Report Writer）</strong>：负责整合所有子任务的结果。生成器需要按照逻辑顺序组织内容，合并重复的信息，并为每个观点添加来源引用。</p>
<p>在我们的案例里，TODO 驱动的研究流程如图 14.5 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-5.png" alt="" width="85%">
  <p>图 14.5 TODO 驱动的研究流程</p>
</div>
<p>整个流程是线性的，但每个阶段都有明确的输入和输出。这种设计使得系统易于理解和调试。</p>
<h3>14.2.2 三阶段研究流程</h3>
<p>TODO 驱动的研究流程分为三个阶段:规划（Planning）、执行（Execution）、报告（Reporting）。每个阶段都有专门的 Agent 负责。</p>
<p><strong>（1）阶段 1：规划</strong></p>
<p>规划阶段的目标是将研究主题分解为 3-5 个子任务。系统接收研究主题和当前日期作为输入，输出 JSON 格式的子任务列表。每个子任务包含三个字段：title（任务标题）、intent（研究意图）和 query（搜索查询）。</p>
<p>研究规划 Agent 会根据主题特点采用不同的分解策略，通常从基础概念入手，然后了解技术现状、实际应用和发展趋势，必要时还会进行对比分析。例如，对于"Datawhale 是一个什么样的组织？"，规划 Agent 可能生成以下子任务：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">[</span>
</span><span class="code-line line-number" line="2">  <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Datawhale的基本信息"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token property">"intent"</span><span class="token operator">:</span> <span class="token string">"了解Datawhale的组织定位、成立时间、发展历程"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Datawhale organization introduction history 2024"</span>
</span><span class="code-line line-number" line="6">  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">  <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Datawhale的主要项目"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    <span class="token property">"intent"</span><span class="token operator">:</span> <span class="token string">"了解Datawhale的核心开源项目和教程"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"Datawhale projects tutorials open source 2024"</span>
</span><span class="code-line line-number" line="11">  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">......
</span><span class="code-line line-number" line="13"><span class="token punctuation">]</span>
</span></code></pre>
<p>一个好的规划应该覆盖全面、逻辑清晰、查询精准、条目数量适中。</p>
<p><strong>（2）阶段 2：执行</strong></p>
<p>执行阶段逐个执行每个子任务，搜索并总结相关资料。系统接收子任务列表和搜索引擎配置作为输入，输出每个子任务的总结（Markdown 格式）和来源引用列表。执行流程如下：</p>
<p>对于每个子任务，执行器会：</p>
<ol>
<li>
<p><strong>搜索资料</strong>：使用配置的搜索引擎执行搜索</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">search_results <span class="token operator">=</span> search_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token string">"input"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    <span class="token string">"backend"</span><span class="token punctuation">:</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"mode"</span><span class="token punctuation">:</span> <span class="token string">"structured"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"max_results"</span><span class="token punctuation">:</span> <span class="token number">5</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
</li>
<li>
<p><strong>获取搜索结果</strong>：提取标题、URL、摘要</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"results"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="3">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">      <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"What is a Multimodal Model?"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">      <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"https://example.com/multimodal-model"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">      <span class="token property">"snippet"</span><span class="token operator">:</span> <span class="token string">"A multimodal model is an AI model that can process multiple types of data..."</span>
</span><span class="code-line line-number" line="7">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    ...
</span><span class="code-line line-number" line="9">  <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span>
</span></code></pre>
</li>
<li>
<p><strong>调用总结 Agent</strong>：总结搜索结果</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">summary <span class="token operator">=</span> summarizer_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    task<span class="token operator">=</span>task<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    search_results<span class="token operator">=</span>search_results
</span><span class="code-line line-number" line="4"><span class="token punctuation">)</span>
</span></code></pre>
</li>
<li>
<p><strong>记录总结和来源</strong>：保存到 NoteTool</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    <span class="token string">"title"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"## </span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">\n\n</span><span class="token interpolation"><span class="token punctuation">{</span>summary<span class="token punctuation">}</span></span><span class="token string">\n\n## 来源\n</span><span class="token interpolation"><span class="token punctuation">{</span>sources<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"research"</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
</li>
</ol>
<p>任务总结 Agent 会从每个搜索结果中提取核心观点，合并相似信息，保留重要的数字、日期、名称等关键数据，并为每个观点添加来源引用。例如，对于"Datawhale 的基本信息"的搜索结果，总结 Agent 可能生成：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">##</span> Datawhale的基本信息</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3">Datawhale是一个专注于数据科学与AI领域的开源组织，成立于2018年[1]。组织的核心使命是"for the learner，和学习者一起成长"，致力于构建一个纯粹的学习社区[2]。
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token bold"><span class="token punctuation">**</span><span class="token content">核心定位：</span><span class="token punctuation">**</span></span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token list punctuation">1.</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">开源教育平台</span><span class="token punctuation">**</span></span>：提供高质量的AI和数据科学学习资源[1]
</span><span class="code-line line-number" line="8"><span class="token list punctuation">2.</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">学习者社区</span><span class="token punctuation">**</span></span>：汇聚了数万名AI学习者和实践者[3]
</span><span class="code-line line-number" line="9"><span class="token list punctuation">3.</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">知识共享</span><span class="token punctuation">**</span></span>：倡导开源精神，所有内容完全免费开放[2]
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token bold"><span class="token punctuation">**</span><span class="token content">发展历程：</span><span class="token punctuation">**</span></span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">2018年</span><span class="token punctuation">**</span></span>：Datawhale成立，发布首个开源教程[1]
</span><span class="code-line line-number" line="14"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">2020年</span><span class="token punctuation">**</span></span>：成为国内领先的AI学习社区之一[3]
</span><span class="code-line line-number" line="15"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">2024年</span><span class="token punctuation">**</span></span>：累计发布50+开源项目，影响10万+学习者[4]
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token title important"><span class="token punctuation">##</span> 来源</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">[1] https://github.com/datawhalechina
</span><span class="code-line line-number" line="20">[2] https://datawhale.club/about
</span><span class="code-line line-number" line="21">[3] https://www.zhihu.com/org/datawhale
</span><span class="code-line line-number" line="22">[4] https://datawhale.cn
</span></code></pre>
<p>在执行过程中，系统会实时推送进度信息到前端：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"status"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"正在搜索：Datawhale的基本信息"</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"status"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"message"</span><span class="token operator">:</span> <span class="token string">"正在总结搜索结果..."</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">}</span>
</span></code></pre>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"task"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"task"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"Datawhale的基本信息"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"completed"</span>
</span><span class="code-line line-number" line="7">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>（3）阶段 3：报告</strong></p>
<p>报告阶段的目标是整合所有子任务的总结，生成最终报告。系统接收所有子任务的总结和研究主题作为输入，输出 Markdown 格式的最终报告。报告包含标题、概述、各个子任务的详细分析、总结和参考文献五个部分。例如，对于"Datawhale 是一个什么样的组织？"，最终报告可能是：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">#</span> Datawhale是一个什么样的组织？</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token title important"><span class="token punctuation">##</span> 概述</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">本报告系统地研究了Datawhale这个开源组织，涵盖基本信息、主要项目、社区文化和影响力四个方面。
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token title important"><span class="token punctuation">##</span> 1. Datawhale的基本信息</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">Datawhale是一个专注于数据科学与AI领域的开源组织，成立于2018年...
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">（此处插入子任务1的总结）
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token title important"><span class="token punctuation">##</span> 2. Datawhale的主要项目</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">Datawhale发布了多个高质量的开源教程，包括Hello-Agents、Joyful-Pandas等...
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">（此处插入子任务2的总结）
</span><span class="code-line line-number" line="18">......
</span><span class="code-line line-number" line="19"><span class="token title important"><span class="token punctuation">##</span> 总结</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">通过本次研究，我们了解了Datawhale的组织定位、核心项目、社区文化和社会贡献。Datawhale是一个纯粹的学习社区，为AI教育做出了重要贡献。
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token title important"><span class="token punctuation">##</span> 参考文献</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">[1] https://github.com/datawhalechina
</span><span class="code-line line-number" line="26">[2] https://datawhale.club/about
</span><span class="code-line line-number" line="27">...
</span></code></pre>
<p>报告生成 Agent 会按照子任务的逻辑顺序组织内容，在开头添加简要概述，合并重复的信息，统一 Markdown 格式，并将所有来源引用整理到参考文献部分。</p>
<h2>14.3 智能体系统设计</h2>
<h3>14.3.1 Agent 职责划分</h3>
<p>在深度研究助手中，我们设计了三个专门的 Agent，每个 Agent 负责一个特定的任务。这使得每个 Agent 都很简单，易于理解和维护。</p>
<p>在第七章中，我们学习了如何使用<code>SimpleAgent</code>来构建智能体。<code>SimpleAgent</code>的设计理念是简单直接：每次调用<code>run()</code>方法时，Agent 会分析用户的问题，决定是否需要调用工具，然后返回结果。这种设计在处理简单任务时非常有效，但当面对深度研究这样的复杂任务时，就需要我们继续采用多智能体协作的方案进行。</p>
<p>如表 14.1 所示，三个 Agent 分别负责规划、总结和报告生成。</p>
<div align="center">
  <p>表 14.1 三个 Agent 的职责划分</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-table-1.png" alt="" width="85%">
</div>
<p>让我们详细介绍每个 Agent 的设计。</p>
<p><strong>Agent 1：研究规划专家（TODO Planner）</strong></p>
<p><strong>职责</strong>：将研究主题分解为 3-5 个子任务</p>
<p><strong>设计理念</strong>：研究规划专家的核心任务是理解用户的研究主题，分析主题的关键方面，然后生成一系列子任务。这个过程类似于人类研究者在开始研究前的"头脑风暴"阶段。</p>
<p><strong>Prompt 设计</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">todo_planner_instructions <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">你是一个研究规划专家。你的任务是将用户的研究主题分解为3-5个子任务。
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">当前日期：{current_date}
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">研究主题：{research_topic}
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">请分析这个研究主题，将其分解为3-5个子任务。每个子任务应该：
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">1. 涵盖主题的一个重要方面
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">2. 有明确的研究目标
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">3. 可以通过搜索引擎找到相关资料
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">请以JSON格式返回子任务列表，每个子任务包含：
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">- title：任务标题（简洁明了）
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">- intent：任务意图（为什么要研究这个）
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">- query：搜索查询（用于搜索引擎的查询字符串，可以使用英文以获得更好的搜索结果）
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">示例输出：
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">[
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">  {{
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">    "title": "什么是多模态模型",
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">    "intent": "了解多模态模型的基础概念，为后续研究打下基础",
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">    "query": "multimodal model definition concept 2024"
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">  }},
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">  ...
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">]
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">请确保：
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">1. 子任务数量在3-5个之间
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">2. 子任务之间有逻辑关系（如从基础到应用，从现状到趋势）
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">3. 搜索查询能够准确找到相关资料
</span></span><span class="code-line line-number" line="32"><span class="token triple-quoted-string string">4. 只返回JSON，不要包含其他文本
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>关键设计点</strong>：提示词包含当前日期以获取最新信息，明确要求 JSON 格式输出便于解析，通过示例帮助 Agent 理解期望输出，并强调子任务数量、逻辑关系等约束。</p>
<p><strong>实现代码</strong>：</p>
<p>这里的 ToolAwareSimpleAgent 是根据 SimpleAgent 拓展实现，可以在 14.3.2 了解，这里不用深究。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">PlanningService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">.</span>_agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">            name<span class="token operator">=</span><span class="token string">"TODO Planner"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">            system_prompt<span class="token operator">=</span><span class="token string">"你是一个研究规划专家"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">            tool_call_listener<span class="token operator">=</span>self<span class="token punctuation">.</span>_on_tool_call
</span><span class="code-line line-number" line="8">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    
</span><span class="code-line line-number" line="10">    <span class="token keyword">def</span> <span class="token function">plan_todo_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> SummaryState<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>TodoItem<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        prompt <span class="token operator">=</span> todo_planner_instructions<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="12">            current_date<span class="token operator">=</span>get_current_date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">            research_topic<span class="token operator">=</span>state<span class="token punctuation">.</span>research_topic<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">        
</span><span class="code-line line-number" line="16">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        tasks_payload <span class="token operator">=</span> self<span class="token punctuation">.</span>_extract_tasks<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">        
</span><span class="code-line line-number" line="19">        todo_items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="20">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tasks_payload<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">            task <span class="token operator">=</span> TodoItem<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="22">                <span class="token builtin">id</span><span class="token operator">=</span>idx<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">                title<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">                intent<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">"intent"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">                query<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">            todo_items<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">        
</span><span class="code-line line-number" line="29">        <span class="token keyword">return</span> todo_items
</span><span class="code-line line-number" line="30">    
</span><span class="code-line line-number" line="31">    <span class="token keyword">def</span> <span class="token function">_extract_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">        <span class="token triple-quoted-string string">"""从Agent响应中提取JSON"""</span>
</span><span class="code-line line-number" line="33">        <span class="token comment"># 使用正则表达式提取JSON部分</span>
</span><span class="code-line line-number" line="34">        json_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\[.*\]'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">        <span class="token keyword">if</span> json_match<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="36">            json_str <span class="token operator">=</span> json_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">            <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="39">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"无法从响应中提取JSON"</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>Agent 2：任务总结专家（Task Summarizer）</strong></p>
<p><strong>职责</strong>：总结搜索结果，提取关键信息</p>
<p><strong>设计理念</strong>：任务总结专家的核心任务是阅读搜索结果，提取关键信息，并以结构化的方式呈现。这个过程类似于人类研究者在阅读文献后做笔记的过程。</p>
<p><strong>Prompt 设计</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">task_summarizer_instructions <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">你是一个任务总结专家。你的任务是总结搜索结果，提取关键信息。
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">任务标题：{task_title}
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">任务意图：{task_intent}
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">搜索查询：{task_query}
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">搜索结果：
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">{search_results}
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">请仔细阅读以上搜索结果，提取关键信息，并以Markdown格式返回总结。
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">总结应该包含：
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">1. **核心观点**：搜索结果中的核心观点和结论
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">2. **关键数据**：重要的数字、日期、名称等
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">3. **来源引用**：为每个观点添加来源引用（使用[1]、[2]等标记）
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">请确保：
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">1. 总结简洁明了，避免冗余
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">2. 保留重要的细节和数据
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">3. 为每个观点添加来源引用
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">4. 使用Markdown格式（标题、列表、加粗等）
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">示例输出：
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">## 核心观点
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">多模态模型是一种能够处理多种类型数据的AI模型[1]。与传统的单模态模型不同，多模态模型可以同时理解文本、图像、音频等[2]。
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">**关键特点：**
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">- 跨模态理解[1]
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">- 统一表示[3]
</span></span><span class="code-line line-number" line="32"><span class="token triple-quoted-string string">- 端到端训练[2]
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="34"><span class="token triple-quoted-string string">## 来源
</span></span><span class="code-line line-number" line="35"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="36"><span class="token triple-quoted-string string">[1] https://example.com/source1
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">[2] https://example.com/source2
</span></span><span class="code-line line-number" line="38"><span class="token triple-quoted-string string">[3] https://example.com/source3
</span></span><span class="code-line line-number" line="39"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>关键设计点</strong>：提示词包含任务标题、意图、查询等上下文帮助 Agent 理解任务，明确要求输出包含核心观点、关键数据、来源引用，强调为每个观点添加来源引用，并通过示例帮助 Agent 理解期望的输出格式。</p>
<p><strong>实现代码</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">SummarizationService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">.</span>_agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">            name<span class="token operator">=</span><span class="token string">"Task Summarizer"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">            system_prompt<span class="token operator">=</span><span class="token string">"你是一个任务总结专家"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">            tool_call_listener<span class="token operator">=</span>self<span class="token punctuation">.</span>_on_tool_call
</span><span class="code-line line-number" line="8">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    
</span><span class="code-line line-number" line="10">    <span class="token keyword">def</span> <span class="token function">summarize_task</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="11">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">        task<span class="token punctuation">:</span> TodoItem<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        search_results<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="14">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># 格式化搜索结果</span>
</span><span class="code-line line-number" line="16">        formatted_sources <span class="token operator">=</span> self<span class="token punctuation">.</span>_format_sources<span class="token punctuation">(</span>search_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        
</span><span class="code-line line-number" line="18">        prompt <span class="token operator">=</span> task_summarizer_instructions<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">            task_title<span class="token operator">=</span>task<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">            task_intent<span class="token operator">=</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">            task_query<span class="token operator">=</span>task<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">            search_results<span class="token operator">=</span>formatted_sources<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">        
</span><span class="code-line line-number" line="25">        summary <span class="token operator">=</span> self<span class="token punctuation">.</span>_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">return</span> summary
</span><span class="code-line line-number" line="27">    
</span><span class="code-line line-number" line="28">    <span class="token keyword">def</span> <span class="token function">_format_sources</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> search_results<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">        <span class="token triple-quoted-string string">"""格式化搜索结果"""</span>
</span><span class="code-line line-number" line="30">        formatted <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>search_results<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">            formatted<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="33">                <span class="token string-interpolation"><span class="token string">f"[</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="34">                <span class="token string-interpolation"><span class="token string">f"URL: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="35">                <span class="token string-interpolation"><span class="token string">f"摘要: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'snippet'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="36">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">        <span class="token keyword">return</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>
</span></code></pre>
<p><strong>Agent 3：报告撰写专家（Report Writer）</strong></p>
<p><strong>职责</strong>：整合所有子任务的总结，生成最终报告</p>
<p><strong>设计理念</strong>：报告撰写专家的核心任务是将所有子任务的总结整合成一份结构化的报告。这个过程类似于人类研究者在完成所有调研后撰写研究报告的过程。</p>
<p><strong>Prompt 设计</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">report_writer_instructions <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">你是一个报告撰写专家。你的任务是整合所有子任务的总结，生成一份结构化的研究报告。
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">研究主题：{research_topic}
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">子任务总结：
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">{task_summaries}
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">请整合以上所有子任务的总结，生成一份结构化的研究报告。
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">报告应该包含：
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">1. **标题**：研究主题
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">2. **概述**：简要介绍研究主题和报告结构（2-3段）
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">3. **各个子任务的详细分析**：按照逻辑顺序组织（使用二级标题）
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">4. **总结**：总结研究的主要发现（1-2段）
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">5. **参考文献**：所有来源引用（按照子任务分组）
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">请确保：
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">1. 报告结构清晰，逻辑连贯
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">2. 消除重复的信息
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">3. 保留所有来源引用
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">4. 使用Markdown格式
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">示例输出：
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string"># 多模态大模型的最新进展
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">## 概述
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">本报告系统地研究了多模态大模型的最新进展...
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">## 1. 什么是多模态模型
</span></span><span class="code-line line-number" line="32"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">（此处插入子任务1的总结）
</span></span><span class="code-line line-number" line="34"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="35"><span class="token triple-quoted-string string">## 2. 最新的多模态模型有哪些
</span></span><span class="code-line line-number" line="36"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">（此处插入子任务2的总结）
</span></span><span class="code-line line-number" line="38"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="39"><span class="token triple-quoted-string string">...
</span></span><span class="code-line line-number" line="40"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="41"><span class="token triple-quoted-string string">## 总结
</span></span><span class="code-line line-number" line="42"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="43"><span class="token triple-quoted-string string">通过本次研究，我们了解了...
</span></span><span class="code-line line-number" line="44"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="45"><span class="token triple-quoted-string string">## 参考文献
</span></span><span class="code-line line-number" line="46"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="47"><span class="token triple-quoted-string string">### 任务1：什么是多模态模型
</span></span><span class="code-line line-number" line="48"><span class="token triple-quoted-string string">[1] https://example.com/source1
</span></span><span class="code-line line-number" line="49"><span class="token triple-quoted-string string">...
</span></span><span class="code-line line-number" line="50"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>关键设计点</strong>：提示词明确要求报告包含标题、概述、详细分析、总结、参考文献等结构，强调按逻辑顺序组织内容，要求合并重复信息消除冗余，并保留所有来源引用。</p>
<p><strong>实现代码</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">ReportingService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">.</span>_agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="4">            name<span class="token operator">=</span><span class="token string">"Report Writer"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">            system_prompt<span class="token operator">=</span><span class="token string">"你是一个报告撰写专家"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">            tool_call_listener<span class="token operator">=</span>self<span class="token punctuation">.</span>_on_tool_call
</span><span class="code-line line-number" line="8">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    
</span><span class="code-line line-number" line="10">    <span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="11">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">        research_topic<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        task_summaries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>TodoItem<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="14">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># 格式化子任务总结</span>
</span><span class="code-line line-number" line="16">        formatted_summaries <span class="token operator">=</span> self<span class="token punctuation">.</span>_format_summaries<span class="token punctuation">(</span>task_summaries<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        
</span><span class="code-line line-number" line="18">        prompt <span class="token operator">=</span> report_writer_instructions<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">            research_topic<span class="token operator">=</span>research_topic<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">            task_summaries<span class="token operator">=</span>formatted_summaries<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">        
</span><span class="code-line line-number" line="23">        report <span class="token operator">=</span> self<span class="token punctuation">.</span>_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">return</span> report
</span><span class="code-line line-number" line="25">    
</span><span class="code-line line-number" line="26">    <span class="token keyword">def</span> <span class="token function">_format_summaries</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="27">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="28">        task_summaries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>TodoItem<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="29">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="30">        <span class="token triple-quoted-string string">"""格式化子任务总结"""</span>
</span><span class="code-line line-number" line="31">        formatted <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="32">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>task<span class="token punctuation">,</span> summary<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>task_summaries<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">            formatted<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="34">                <span class="token string-interpolation"><span class="token string">f"## 任务</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="35">                <span class="token string-interpolation"><span class="token string">f"意图：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="36">                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>summary<span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="37">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">        <span class="token keyword">return</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>
</span></code></pre>
<h3>14.3.2 ToolAwareSimpleAgent 的设计</h3>
<p>在第七章中，我们实现了<code>SimpleAgent</code>，它是 HelloAgents 框架的基础 Agent。但在深度研究助手中，我们需要一个能够<strong>记录工具调用</strong>的 Agent。这就是<code>ToolAwareSimpleAgent</code>的由来。</p>
<p>在深度研究助手中，我们需要记录每个 Agent 的工具调用情况，用于：</p>
<ol>
<li><strong>调试</strong>：查看 Agent 调用了哪些工具，传入了什么参数</li>
<li><strong>日志</strong>：记录研究过程中的所有操作</li>
<li><strong>分析</strong>：分析 Agent 的行为模式</li>
<li><strong>进度展示</strong>：实时显示 Agent 正在做什么</li>
</ol>
<p><code>SimpleAgent</code>本身不支持工具调用监听，因此我们需要扩展它。</p>
<p><code>ToolAwareSimpleAgent</code>在<code>SimpleAgent</code>的基础上增加了一个<code>tool_call_listener</code>参数，这是一个回调函数，每次工具调用时都会被调用。</p>
<p><strong>使用示例：</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> ToolAwareSimpleAgent
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">def</span> <span class="token function">tool_listener</span><span class="token punctuation">(</span>call_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Agent: </span><span class="token interpolation"><span class="token punctuation">{</span>call_info<span class="token punctuation">[</span><span class="token string">'agent_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"工具: </span><span class="token interpolation"><span class="token punctuation">{</span>call_info<span class="token punctuation">[</span><span class="token string">'tool_name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"参数: </span><span class="token interpolation"><span class="token punctuation">{</span>call_info<span class="token punctuation">[</span><span class="token string">'parsed_parameters'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"结果: </span><span class="token interpolation"><span class="token punctuation">{</span>call_info<span class="token punctuation">[</span><span class="token string">'result'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="10">    name<span class="token operator">=</span><span class="token string">"研究助手"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    system_prompt<span class="token operator">=</span><span class="token string">"你是一个研究助手"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    tool_call_listener<span class="token operator">=</span>tool_listener
</span><span class="code-line line-number" line="14"><span class="token punctuation">)</span>
</span></code></pre>
<p><code>ToolAwareSimpleAgent</code>继承自<code>SimpleAgent</code>，重写了<code>_execute_tool_call</code>方法：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">ToolAwareSimpleAgent</span><span class="token punctuation">(</span>SimpleAgent<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">        name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">        system_prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">        llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">        tool_registry<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>ToolRegistry<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">        tool_call_listener<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="11">            name<span class="token operator">=</span>name<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">            system_prompt<span class="token operator">=</span>system_prompt<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">            tool_registry<span class="token operator">=</span>tool_registry<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>_tool_call_listener <span class="token operator">=</span> tool_call_listener
</span><span class="code-line line-number" line="17">    
</span><span class="code-line line-number" line="18">    <span class="token keyword">def</span> <span class="token function">_execute_tool_call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tool_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> parameters<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">        <span class="token triple-quoted-string string">"""执行工具调用，并通知监听器"""</span>
</span><span class="code-line line-number" line="20">        <span class="token comment"># 解析参数</span>
</span><span class="code-line line-number" line="21">        parsed_parameters <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_parameters<span class="token punctuation">(</span>parameters<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">        
</span><span class="code-line line-number" line="23">        <span class="token comment"># 调用工具</span>
</span><span class="code-line line-number" line="24">        result <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_execute_tool_call<span class="token punctuation">(</span>tool_name<span class="token punctuation">,</span> parameters<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">        
</span><span class="code-line line-number" line="26">        <span class="token comment"># 通知监听器</span>
</span><span class="code-line line-number" line="27">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_tool_call_listener<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="28">            self<span class="token punctuation">.</span>_tool_call_listener<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="29">                <span class="token string">"agent_name"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">                <span class="token string">"tool_name"</span><span class="token punctuation">:</span> tool_name<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="31">                <span class="token string">"parsed_parameters"</span><span class="token punctuation">:</span> parsed_parameters<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="32">                <span class="token string">"result"</span><span class="token punctuation">:</span> result<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="33">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">        
</span><span class="code-line line-number" line="35">        <span class="token keyword">return</span> result
</span></code></pre>
<p>在深度研究助手中，我们使用<code>ToolAwareSimpleAgent</code>来记录所有 Agent 的工具调用：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">DeepResearchAgent</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> Configuration<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
</span><span class="code-line line-number" line="4">        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">        
</span><span class="code-line line-number" line="6">        <span class="token comment"># 创建工具调用监听器</span>
</span><span class="code-line line-number" line="7">        <span class="token keyword">def</span> <span class="token function">tool_listener</span><span class="token punctuation">(</span>call_info<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">            self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"tool_call"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">                <span class="token string">"agent"</span><span class="token punctuation">:</span> call_info<span class="token punctuation">[</span><span class="token string">"agent_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">                <span class="token string">"tool"</span><span class="token punctuation">:</span> call_info<span class="token punctuation">[</span><span class="token string">"tool_name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">                <span class="token string">"parameters"</span><span class="token punctuation">:</span> call_info<span class="token punctuation">[</span><span class="token string">"parsed_parameters"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">        
</span><span class="code-line line-number" line="15">        <span class="token comment"># 创建三个Agent，都使用相同的监听器</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>planner <span class="token operator">=</span> PlanningService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> tool_listener<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>summarizer <span class="token operator">=</span> SummarizationService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> tool_listener<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">        self<span class="token punctuation">.</span>reporter <span class="token operator">=</span> ReportingService<span class="token punctuation">(</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> tool_listener<span class="token punctuation">)</span>
</span></code></pre>
<p>这样，所有 Agent 的工具调用都会被记录，并通过 SSE 推送到前端，实时显示给用户。</p>
<h3>14.3.3 Agent 协作模式</h3>
<p>三个 Agent 之间是<strong>顺序协作</strong>的关系，如图 14.6 所示。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-6.png" alt="" width="85%">
  <p>图 14.6 Agent 协作流程</p>
</div>
<p>顺序协作模式的特点是：</p>
<ol>
<li><strong>线性流程</strong>：Agent 按照固定的顺序执行</li>
<li><strong>明确的输入输出</strong>：每个 Agent 的输入来自上一个 Agent 的输出</li>
<li><strong>无并发</strong>：同一时间只有一个 Agent 在工作</li>
</ol>
<p><code>DeepResearchAgent</code>是整个系统的核心协调器，负责调度三个 Agent：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">DeepResearchAgent</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> research_topic<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        <span class="token comment"># 1. 规划阶段</span>
</span><span class="code-line line-number" line="4">        self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"正在规划研究任务..."</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">        todo_list <span class="token operator">=</span> self<span class="token punctuation">.</span>planner<span class="token punctuation">.</span>plan_todo_list<span class="token punctuation">(</span>research_topic<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">        self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"tasks"</span><span class="token punctuation">,</span> <span class="token string">"tasks"</span><span class="token punctuation">:</span> todo_list<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">        
</span><span class="code-line line-number" line="8">        <span class="token comment"># 2. 执行阶段</span>
</span><span class="code-line line-number" line="9">        task_summaries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="10">        <span class="token keyword">for</span> task <span class="token keyword">in</span> todo_list<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">            self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"status"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">                <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"正在研究：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="14">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">            
</span><span class="code-line line-number" line="16">            <span class="token comment"># 搜索</span>
</span><span class="code-line line-number" line="17">            search_results <span class="token operator">=</span> self<span class="token punctuation">.</span>search_service<span class="token punctuation">.</span>search<span class="token punctuation">(</span>task<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">            
</span><span class="code-line line-number" line="19">            <span class="token comment"># 总结</span>
</span><span class="code-line line-number" line="20">            summary <span class="token operator">=</span> self<span class="token punctuation">.</span>summarizer<span class="token punctuation">.</span>summarize_task<span class="token punctuation">(</span>task<span class="token punctuation">,</span> search_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">            task_summaries<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> summary<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">            
</span><span class="code-line line-number" line="23">            self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="24">                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"task_completed"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">                <span class="token string">"task_id"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span><span class="token builtin">id</span>
</span><span class="code-line line-number" line="26">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">        
</span><span class="code-line line-number" line="28">        <span class="token comment"># 3. 报告阶段</span>
</span><span class="code-line line-number" line="29">        self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"正在生成报告..."</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">        report <span class="token operator">=</span> self<span class="token punctuation">.</span>reporter<span class="token punctuation">.</span>generate_report<span class="token punctuation">(</span>research_topic<span class="token punctuation">,</span> task_summaries<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">        self<span class="token punctuation">.</span>_emit_event<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"report"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> report<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">        
</span><span class="code-line line-number" line="33">        <span class="token keyword">return</span> report
</span></code></pre>
<h2>14.4 工具系统集成</h2>
<h3>14.4.1 SearchTool 扩展</h3>
<p>在第七章中，我们实现了<code>SearchTool</code>的基础版本，集成了 Tavily 和 SerpApi 两个搜索引擎，展示了多源搜索的设计思想。在本章的深度研究助手中，我们进一步扩展了<code>SearchTool</code>的能力，新增了 DuckDuckGo、Perplexity、SearXNG 等搜索引擎，并实现了 Advanced 模式（组合多个搜索引擎）。搜索是深度研究助手最核心的功能，这些扩展使得系统能够适应不同的使用场景和需求。</p>
<p>如表 14.2 所示，这次增加的搜索引擎有不同的特点和适用场景。</p>
<div align="center">
  <p>表 14.2 多搜索引擎对比</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-table-2.png" alt="" width="85%">
</div>
<p>我们不再单独讨论如何扩展，可以参考源码以及第七章的拓展案例实现。<code>SearchTool</code>提供了统一的搜索接口，无论使用哪个搜索引擎，调用方式都是一样的。</p>
<p>在深度研究助手中，我们通过配置文件选择搜索引擎：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># config.py</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">class</span> <span class="token class-name">SearchAPI</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> Enum<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">    TAVILY <span class="token operator">=</span> <span class="token string">"tavily"</span>
</span><span class="code-line line-number" line="4">    DUCKDUCKGO <span class="token operator">=</span> <span class="token string">"duckduckgo"</span>
</span><span class="code-line line-number" line="5">    PERPLEXITY <span class="token operator">=</span> <span class="token string">"perplexity"</span>
</span><span class="code-line line-number" line="6">    SEARXNG <span class="token operator">=</span> <span class="token string">"searxng"</span>
</span><span class="code-line line-number" line="7">    ADVANCED <span class="token operator">=</span> <span class="token string">"advanced"</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">class</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">    search_api<span class="token punctuation">:</span> SearchAPI <span class="token operator">=</span> SearchAPI<span class="token punctuation">.</span>DUCKDUCKGO
</span><span class="code-line line-number" line="11">    <span class="token comment"># ...</span>
</span></code></pre>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># .env</span>
</span><span class="code-line line-number" line="2">SEARCH_API<span class="token operator">=</span>tavily
</span></code></pre>
<p>这样，用户可以通过修改<code>.env</code>文件来选择搜索引擎，无需修改代码。</p>
<p><code>SearchTool</code>返回的结果是一个字典，包含：</p>
<ul>
<li><code>results</code>：搜索结果列表，每个结果包含标题、URL、摘要</li>
<li><code>backend</code>：使用的搜索引擎</li>
<li><code>answer</code>：AI 生成的答案（仅 Perplexity）</li>
<li><code>notices</code>：通知信息（如 API 限制、错误等）</li>
</ul>
<p>以下是一些特殊情况的处理。</p>
<p>搜索结果可能包含重复的 URL，我们需要去重：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">deduplicate_sources</span><span class="token punctuation">(</span>sources<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""去除重复的URL"""</span>
</span><span class="code-line line-number" line="3">    seen_urls <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    unique_sources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="5">    
</span><span class="code-line line-number" line="6">    <span class="token keyword">for</span> source <span class="token keyword">in</span> sources<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">        <span class="token keyword">if</span> source<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span> <span class="token keyword">not</span> <span class="token keyword">in</span> seen_urls<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">            seen_urls<span class="token punctuation">.</span>add<span class="token punctuation">(</span>source<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">            unique_sources<span class="token punctuation">.</span>append<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">    
</span><span class="code-line line-number" line="11">    <span class="token keyword">return</span> unique_sources
</span></code></pre>
<p>搜索结果可能包含大量文本，我们需要限制每个来源的 Token 数量：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">limit_source_tokens</span><span class="token punctuation">(</span>source<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> max_tokens<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""限制来源的Token数量"""</span>
</span><span class="code-line line-number" line="3">    snippet <span class="token operator">=</span> source<span class="token punctuation">[</span><span class="token string">"snippet"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="4">    
</span><span class="code-line line-number" line="5">    <span class="token comment"># 简单的Token估算：1个Token约等于4个字符</span>
</span><span class="code-line line-number" line="6">    max_chars <span class="token operator">=</span> max_tokens <span class="token operator">*</span> <span class="token number">4</span>
</span><span class="code-line line-number" line="7">    
</span><span class="code-line line-number" line="8">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>snippet<span class="token punctuation">)</span> <span class="token operator">&gt;</span> max_chars<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">        snippet <span class="token operator">=</span> snippet<span class="token punctuation">[</span><span class="token punctuation">:</span>max_chars<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"..."</span>
</span><span class="code-line line-number" line="10">    
</span><span class="code-line line-number" line="11">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">        <span class="token operator">**</span>source<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        <span class="token string">"snippet"</span><span class="token punctuation">:</span> snippet
</span><span class="code-line line-number" line="14">    <span class="token punctuation">}</span>
</span></code></pre>
<h3>14.4.2 NoteTool 使用</h3>
<p>在深度研究助手中，我们使用<code>NoteTool</code>来持久化研究进度。<code>NoteTool</code>是第九章集成的内置工具，用于创建、读取、更新和删除笔记。</p>
<p>在研究过程中，我们需要记录每个子任务的搜索结果、总结以及最终的研究报告。这些信息需要持久化到磁盘，以便在研究过程中断时能够从上次的进度继续，同时也方便查看研究过程中的所有操作，分析研究的质量和效率。</p>
<p><code>NoteTool</code>将笔记存储在指定的工作空间目录中，每个笔记是一个 Markdown 文件。笔记的文件名是任务 ID，内容包含任务标题、任务意图、搜索查询、搜索结果和总结。</p>
<p>最后生成的文件风格会是下面的树状图风格：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">workspace/
</span><span class="code-line line-number" line="2">├── notes/
</span><span class="code-line line-number" line="3">│   ├── 1.md  # 任务1的笔记
</span><span class="code-line line-number" line="4">│   ├── 2.md  # 任务2的笔记
</span><span class="code-line line-number" line="5">│   ├── 3.md  # 任务3的笔记
</span><span class="code-line line-number" line="6">│   └── ...
</span><span class="code-line line-number" line="7">└── reports/
</span><span class="code-line line-number" line="8">    └── final_report.md  # 最终报告
</span></code></pre>
<p>在深度研究助手中，我们使用<code>NoteTool</code>来记录每个子任务的研究进度：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">NotesService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> workspace<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">.</span>note_tool <span class="token operator">=</span> NoteTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span>workspace<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    
</span><span class="code-line line-number" line="5">    <span class="token keyword">def</span> <span class="token function">save_task_summary</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">        task<span class="token punctuation">:</span> TodoItem<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">        search_results<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">        summary<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="10">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        <span class="token triple-quoted-string string">"""保存任务总结"""</span>
</span><span class="code-line line-number" line="12">        <span class="token comment"># 格式化笔记内容</span>
</span><span class="code-line line-number" line="13">        content <span class="token operator">=</span> self<span class="token punctuation">.</span>_format_note_content<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="14">            task<span class="token operator">=</span>task<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">            search_results<span class="token operator">=</span>search_results<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">            summary<span class="token operator">=</span>summary
</span><span class="code-line line-number" line="17">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">        
</span><span class="code-line line-number" line="19">        <span class="token comment"># 创建笔记</span>
</span><span class="code-line line-number" line="20">        self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">            <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"任务</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">            <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">            <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"research"</span><span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="25">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">    
</span><span class="code-line line-number" line="27">    <span class="token keyword">def</span> <span class="token function">_format_note_content</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="28">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">        task<span class="token punctuation">:</span> TodoItem<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">        search_results<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="31">        summary<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="32">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">        <span class="token triple-quoted-string string">"""格式化笔记内容"""</span>
</span><span class="code-line line-number" line="34">        content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"# 任务</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="35">        content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"## 任务信息\n\n"</span></span>
</span><span class="code-line line-number" line="36">        content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"- **意图**：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="37">        content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"- **查询**：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>query<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="38">        
</span><span class="code-line line-number" line="39">        content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"## 搜索结果\n\n"</span></span>
</span><span class="code-line line-number" line="40">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>search_results<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="41">            content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"[</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="42">            content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"URL: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="43">            content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"摘要: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'snippet'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="44">        
</span><span class="code-line line-number" line="45">        content <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"## 总结\n\n</span><span class="token interpolation"><span class="token punctuation">{</span>summary<span class="token punctuation">}</span></span><span class="token string">\n"</span></span>
</span><span class="code-line line-number" line="46">        
</span><span class="code-line line-number" line="47">        <span class="token keyword">return</span> content
</span></code></pre>
<h3>14.4.3 ToolRegistry 工具管理</h3>
<p><code>ToolRegistry</code>是 HelloAgents 框架的工具注册表，同样也是在我们的第七章所支持，用于管理所有工具的注册和调用。在深度研究助手中，我们使用<code>ToolRegistry</code>来管理<code>SearchTool</code>和<code>NoteTool</code>。</p>
<p>在创建 Agent 之前，我们需要先注册工具：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> ToolAwareSimpleAgent
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> ToolRegistry
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> SearchTool
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> NoteTool
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 创建工具</span>
</span><span class="code-line line-number" line="7">search_tool <span class="token operator">=</span> SearchTool<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">"hybrid"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">note_tool <span class="token operator">=</span> NoteTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"./workspace/notes"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 创建注册表</span>
</span><span class="code-line line-number" line="11">registry <span class="token operator">=</span> ToolRegistry<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token comment"># 注册工具</span>
</span><span class="code-line line-number" line="14">registry<span class="token punctuation">.</span>register_tool<span class="token punctuation">(</span>search_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">registry<span class="token punctuation">.</span>register_tool<span class="token punctuation">(</span>note_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token comment"># 创建Agent</span>
</span><span class="code-line line-number" line="18">agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">    name<span class="token operator">=</span><span class="token string">"研究助手"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">    system_prompt<span class="token operator">=</span><span class="token string">"你是一个研究助手"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">    tool_registry<span class="token operator">=</span>registry
</span><span class="code-line line-number" line="23"><span class="token punctuation">)</span>
</span></code></pre>
<p>当 Agent 需要调用工具时，它会生成工具调用指令，如图 14.7 所示。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-7.png" alt="" width="85%">
  <p>图 14.7 工具调用流程</p>
</div>
<p>**工具调用流程<strong>：</strong></p><strong>
</strong><ol><strong>
</strong><li><strong></strong>Agent 生成指令<strong>：Agent 生成工具调用指令，如<code>[TOOL_CALL:search_tool:{"input": "Datawhale组织", "backend": "tavily"}]</code></strong></li><strong>
</strong><li><strong></strong>解析指令<strong>：<code>ToolRegistry</code>解析指令，提取工具名称和参数</strong></li><strong>
</strong><li><strong></strong>查找工具<strong>：<code>ToolRegistry</code>根据工具名称查找对应的工具</strong></li><strong>
</strong><li><strong></strong>调用工具<strong>：调用工具的<code>run</code>方法，传入参数</strong></li><strong>
</strong><li><strong></strong>返回结果<strong>：工具返回执行结果</strong></li><strong>
</strong><li><strong></strong>格式化结果<strong>：将结果格式化为字符串，返回给 Agent</strong></li><strong>
</strong></ol><strong>
<h2>14.5 服务层实现</h2>
<p>本节将详细介绍核心服务的实现，包括 PlanningService、SummarizationService、ReportingService 和 SearchService。这些服务是连接 Agent 和工具的桥梁，负责具体的业务逻辑。</p>
<h3>14.5.1 任务规划服务</h3>
<p><code>PlanningService</code>负责调用研究规划 Agent，将研究主题分解为子任务。这是整个研究流程的第一步，也是最关键的一步。</p>
</strong><p><strong></strong>（1）方案实现<strong></strong></p><strong>
<p>它的核心职责是：</p>
</strong><ol><strong>
</strong><li><strong></strong>构建规划 Prompt<strong>：根据研究主题和当前日期构建 Prompt</strong></li><strong>
</strong><li><strong></strong>调用规划 Agent<strong>：调用 TODO Planner Agent 生成子任务列表</strong></li><strong>
</strong><li><strong></strong>解析 JSON 响应<strong>：从 Agent 的响应中提取 JSON 格式的子任务列表</strong></li><strong>
</strong><li><strong></strong>验证子任务格式**：确保每个子任务包含必需的字段（title、intent、query）</li>
</ol>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> re
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> Optional
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> HelloAgentsLLM
</span><span class="code-line line-number" line="7"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> ToolAwareSimpleAgent
</span><span class="code-line line-number" line="8"><span class="token keyword">from</span> models <span class="token keyword">import</span> TodoItem<span class="token punctuation">,</span> SummaryState
</span><span class="code-line line-number" line="9"><span class="token keyword">from</span> prompts <span class="token keyword">import</span> todo_planner_instructions
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">class</span> <span class="token class-name">PlanningService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">    <span class="token triple-quoted-string string">"""任务规划服务"""</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="15">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">        tool_call_listener<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="18">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">        self<span class="token punctuation">.</span>_llm <span class="token operator">=</span> llm
</span><span class="code-line line-number" line="20">        self<span class="token punctuation">.</span>_tool_call_listener <span class="token operator">=</span> tool_call_listener
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">        <span class="token comment"># 创建规划Agent</span>
</span><span class="code-line line-number" line="23">        self<span class="token punctuation">.</span>_agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="24">            name<span class="token operator">=</span><span class="token string">"TODO Planner"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">            system_prompt<span class="token operator">=</span><span class="token string">"你是一个研究规划专家，擅长将复杂的研究主题分解为清晰的子任务。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="27">            tool_call_listener<span class="token operator">=</span>tool_call_listener
</span><span class="code-line line-number" line="28">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">    <span class="token keyword">def</span> <span class="token function">plan_todo_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> state<span class="token punctuation">:</span> SummaryState<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>TodoItem<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">        <span class="token triple-quoted-string string">"""规划TODO列表
</span></span><span class="code-line line-number" line="32"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">        Args:
</span></span><span class="code-line line-number" line="34"><span class="token triple-quoted-string string">            state: 研究状态，包含研究主题
</span></span><span class="code-line line-number" line="35"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="36"><span class="token triple-quoted-string string">        Returns:
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">            子任务列表
</span></span><span class="code-line line-number" line="38"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="39">        <span class="token comment"># 构建Prompt</span>
</span><span class="code-line line-number" line="40">        prompt <span class="token operator">=</span> todo_planner_instructions<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="41">            current_date<span class="token operator">=</span>self<span class="token punctuation">.</span>_get_current_date<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="42">            research_topic<span class="token operator">=</span>state<span class="token punctuation">.</span>research_topic<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="43">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45">        <span class="token comment"># 调用Agent</span>
</span><span class="code-line line-number" line="46">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">
</span><span class="code-line line-number" line="48">        <span class="token comment"># 解析JSON</span>
</span><span class="code-line line-number" line="49">        tasks_payload <span class="token operator">=</span> self<span class="token punctuation">.</span>_extract_tasks<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="50">
</span><span class="code-line line-number" line="51">        <span class="token comment"># 验证并创建TodoItem</span>
</span><span class="code-line line-number" line="52">        todo_items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="53">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tasks_payload<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="54">            <span class="token comment"># 验证必需字段</span>
</span><span class="code-line line-number" line="55">            <span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">all</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> item <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">"intent"</span><span class="token punctuation">,</span> <span class="token string">"query"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="56">                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">缺少必需字段"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">
</span><span class="code-line line-number" line="58">            task <span class="token operator">=</span> TodoItem<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="59">                <span class="token builtin">id</span><span class="token operator">=</span>idx<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="60">                title<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="61">                intent<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">"intent"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="62">                query<span class="token operator">=</span>item<span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="63">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="64">            todo_items<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="65">
</span><span class="code-line line-number" line="66">        <span class="token keyword">return</span> todo_items
</span><span class="code-line line-number" line="67">
</span><span class="code-line line-number" line="68">    <span class="token keyword">def</span> <span class="token function">_get_current_date</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="69">        <span class="token triple-quoted-string string">"""获取当前日期"""</span>
</span><span class="code-line line-number" line="70">        <span class="token keyword">return</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y年%m月%d日"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="71">
</span><span class="code-line line-number" line="72">    <span class="token keyword">def</span> <span class="token function">_extract_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="73">        <span class="token triple-quoted-string string">"""从Agent响应中提取JSON
</span></span><span class="code-line line-number" line="74"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="75"><span class="token triple-quoted-string string">        Agent的响应可能包含额外的文本，如：
</span></span><span class="code-line line-number" line="76"><span class="token triple-quoted-string string">        "好的，我将为您规划以下任务：\n[{...}, {...}]\n这些任务涵盖了..."
</span></span><span class="code-line line-number" line="77"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="78"><span class="token triple-quoted-string string">        我们需要提取其中的JSON部分。
</span></span><span class="code-line line-number" line="79"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="80">        <span class="token comment"># 方法1：使用正则表达式提取JSON数组</span>
</span><span class="code-line line-number" line="81">        json_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\[.*\]'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="82">        <span class="token keyword">if</span> json_match<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="83">            json_str <span class="token operator">=</span> json_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="84">            <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="85">                <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="86">            <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="87">                <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"JSON解析失败：</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="88">
</span><span class="code-line line-number" line="89">        <span class="token comment"># 方法2：如果没有找到JSON数组，尝试直接解析整个响应</span>
</span><span class="code-line line-number" line="90">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="91">            <span class="token keyword">return</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="92">        <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="93">            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"无法从响应中提取JSON"</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（2）JSON 解析与验证</strong></p>
<p>Agent 返回的 JSON 可能包含额外的文本或格式错误，我们需要 robust 的解析逻辑：</p>
<p><strong>常见问题</strong>：</p>
<ol>
<li><strong>包含额外文本</strong>：Agent 可能在 JSON 前后添加说明文字</li>
<li><strong>格式错误</strong>：JSON 可能缺少引号、逗号等</li>
<li><strong>字段缺失</strong>：某些子任务可能缺少必需字段</li>
</ol>
<p><strong>解决方案</strong>：</p>
<ol>
<li><strong>使用正则表达式</strong>：提取 JSON 部分</li>
<li><strong>多种解析策略</strong>：先尝试提取 JSON 数组，再尝试直接解析</li>
<li><strong>字段验证</strong>：确保每个子任务包含必需字段</li>
</ol>
<p><strong>示例</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Agent响应示例1：包含额外文本</span>
</span><span class="code-line line-number" line="2">response1 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">好的，我将为您规划以下任务：
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">[
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">  {
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    "title": "什么是多模态模型",
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    "intent": "了解基础概念",
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    "query": "multimodal model definition"
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">  },
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">  {
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">    "title": "最新的多模态模型",
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">    "intent": "了解技术现状",
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">    "query": "latest multimodal models 2024"
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">  }
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">]
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">这些任务涵盖了Datawhale组织的基本信息和核心项目。
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 提取JSON</span>
</span><span class="code-line line-number" line="22">tasks1 <span class="token operator">=</span> service<span class="token punctuation">.</span>_extract_tasks<span class="token punctuation">(</span>response1<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23"><span class="token comment"># 结果：[{"title": "Datawhale的基本信息", ...}, ...]</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token comment"># Agent响应示例2：纯JSON</span>
</span><span class="code-line line-number" line="26">response2 <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">[
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">  {"title": "Datawhale的基本信息", "intent": "了解组织定位", "query": "Datawhale organization introduction"},
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">  {"title": "Datawhale的主要项目", "intent": "了解核心内容", "query": "Datawhale projects tutorials 2024"}
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">]
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33"><span class="token comment"># 提取JSON</span>
</span><span class="code-line line-number" line="34">tasks2 <span class="token operator">=</span> service<span class="token punctuation">.</span>_extract_tasks<span class="token punctuation">(</span>response2<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35"><span class="token comment"># 结果：[{"title": "什么是多模态模型", ...}, ...]</span>
</span></code></pre>
<p><strong>（3）规划质量评估</strong></p>
<p>一个好的规划应该满足以下标准：</p>
<ol>
<li><strong>覆盖全面</strong>：涵盖主题的所有重要方面</li>
<li><strong>逻辑清晰</strong>：子任务之间有明确的逻辑关系</li>
<li><strong>查询精准</strong>：搜索查询能够准确找到相关资料</li>
<li><strong>数量适中</strong>：3-5 个子任务</li>
</ol>
<p>我们可以添加一个评估方法：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">evaluate_plan</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> todo_items<span class="token punctuation">:</span> List<span class="token punctuation">[</span>TodoItem<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""评估规划质量
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">        评估结果，包含分数和建议
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="7">    score <span class="token operator">=</span> <span class="token number">100</span>
</span><span class="code-line line-number" line="8">    suggestions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">    <span class="token comment"># 检查数量</span>
</span><span class="code-line line-number" line="11">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>todo_items<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">        score <span class="token operator">-=</span> <span class="token number">20</span>
</span><span class="code-line line-number" line="13">        suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"子任务数量过少，可能遗漏重要信息"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">    <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>todo_items<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        score <span class="token operator">-=</span> <span class="token number">10</span>
</span><span class="code-line line-number" line="16">        suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"子任务数量过多，可能存在冗余"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">    <span class="token comment"># 检查查询质量</span>
</span><span class="code-line line-number" line="19">    <span class="token keyword">for</span> task <span class="token keyword">in</span> todo_items<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>query<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">            score <span class="token operator">-=</span> <span class="token number">10</span>
</span><span class="code-line line-number" line="22">            suggestions<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务「</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">」的查询过于简单"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">    <span class="token comment"># 检查逻辑关系</span>
</span><span class="code-line line-number" line="25">    <span class="token comment"># （这里可以添加更复杂的逻辑检查）</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="28">        <span class="token string">"score"</span><span class="token punctuation">:</span> score<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">        <span class="token string">"suggestions"</span><span class="token punctuation">:</span> suggestions
</span><span class="code-line line-number" line="30">    <span class="token punctuation">}</span>
</span></code></pre>
<h3>14.5.2 总结服务</h3>
<p><code>SummarizationService</code>负责调用任务总结 Agent，总结搜索结果。这是研究流程的核心环节，决定了研究的质量。</p>
<p>它的职责是：</p>
<ol>
<li><strong>格式化搜索结果</strong>：将搜索结果格式化为易读的文本</li>
<li><strong>构建总结 Prompt</strong>：根据任务信息和搜索结果构建 Prompt</li>
<li><strong>调用总结 Agent</strong>：调用 Task Summarizer Agent 生成总结</li>
<li><strong>提取来源引用</strong>：从总结中提取来源引用</li>
</ol>
<p>核心代码：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> HelloAgentsLLM
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> ToolAwareSimpleAgent
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> models <span class="token keyword">import</span> TodoItem
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> prompts <span class="token keyword">import</span> task_summarizer_instructions
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">class</span> <span class="token class-name">SummarizationService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">    <span class="token triple-quoted-string string">"""总结服务"""</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        tool_call_listener<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="15">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>_llm <span class="token operator">=</span> llm
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>_tool_call_listener <span class="token operator">=</span> tool_call_listener
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">        <span class="token comment"># 创建总结Agent</span>
</span><span class="code-line line-number" line="20">        self<span class="token punctuation">.</span>_agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="21">            name<span class="token operator">=</span><span class="token string">"Task Summarizer"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">            system_prompt<span class="token operator">=</span><span class="token string">"你是一个任务总结专家，擅长从搜索结果中提取关键信息。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">            tool_call_listener<span class="token operator">=</span>tool_call_listener
</span><span class="code-line line-number" line="25">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">    <span class="token keyword">def</span> <span class="token function">summarize_task</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="28">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">        task<span class="token punctuation">:</span> TodoItem<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">        search_results<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">        <span class="token triple-quoted-string string">"""总结任务
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="34"><span class="token triple-quoted-string string">        Args:
</span></span><span class="code-line line-number" line="35"><span class="token triple-quoted-string string">            task: 任务信息
</span></span><span class="code-line line-number" line="36"><span class="token triple-quoted-string string">            search_results: 搜索结果列表
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="38"><span class="token triple-quoted-string string">        Returns:
</span></span><span class="code-line line-number" line="39"><span class="token triple-quoted-string string">            (总结文本, 来源URL列表)
</span></span><span class="code-line line-number" line="40"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="41">        <span class="token comment"># 格式化搜索结果</span>
</span><span class="code-line line-number" line="42">        formatted_sources <span class="token operator">=</span> self<span class="token punctuation">.</span>_format_sources<span class="token punctuation">(</span>search_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">        <span class="token comment"># 构建Prompt</span>
</span><span class="code-line line-number" line="45">        prompt <span class="token operator">=</span> task_summarizer_instructions<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="46">            task_title<span class="token operator">=</span>task<span class="token punctuation">.</span>title<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="47">            task_intent<span class="token operator">=</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="48">            task_query<span class="token operator">=</span>task<span class="token punctuation">.</span>query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="49">            search_results<span class="token operator">=</span>formatted_sources<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="50">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52">        <span class="token comment"># 调用Agent</span>
</span><span class="code-line line-number" line="53">        summary <span class="token operator">=</span> self<span class="token punctuation">.</span>_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="54">
</span><span class="code-line line-number" line="55">        <span class="token comment"># 提取来源URL</span>
</span><span class="code-line line-number" line="56">        source_urls <span class="token operator">=</span> <span class="token punctuation">[</span>result<span class="token punctuation">[</span><span class="token string">"url"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> search_results<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="57">
</span><span class="code-line line-number" line="58">        <span class="token keyword">return</span> summary<span class="token punctuation">,</span> source_urls
</span><span class="code-line line-number" line="59">
</span><span class="code-line line-number" line="60">    <span class="token keyword">def</span> <span class="token function">_format_sources</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> search_results<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="61">        <span class="token string">""</span>"格式化搜索结果
</span><span class="code-line line-number" line="62">
</span><span class="code-line line-number" line="63">        将搜索结果格式化为易读的文本，包含：
</span><span class="code-line line-number" line="64">        <span class="token operator">-</span> 序号
</span><span class="code-line line-number" line="65">        <span class="token operator">-</span> 标题
</span><span class="code-line line-number" line="66">
</span><span class="code-line line-number" line="67"><span class="token comment">### 报告结构设计</span>
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69">最终报告应该包含以下部分，<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line line-number" line="70">
</span><span class="code-line line-number" line="71"><span class="token comment">## 参考文献</span>
</span><span class="code-line line-number" line="72">
</span><span class="code-line line-number" line="73"><span class="token comment">### 任务1：什么是多模态模型</span>
</span><span class="code-line line-number" line="74"><span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>multimodal<span class="token operator">-</span>model<span class="token operator">-</span>definition
</span><span class="code-line line-number" line="75"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line line-number" line="76">
</span><span class="code-line line-number" line="77"><span class="token comment">### 任务2：最新的多模态模型有哪些</span>
</span><span class="code-line line-number" line="78"><span class="token operator">-</span> https<span class="token punctuation">:</span><span class="token operator">//</span>example<span class="token punctuation">.</span>com<span class="token operator">/</span>gpt4v
</span><span class="code-line line-number" line="79"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line line-number" line="80"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span></code></pre>
<h3>14.5.3 报告生成服务</h3>
<p><code>ReportingService</code>负责调用报告生成 Agent，整合所有子任务的总结。这是研究流程的最后一步，生成最终的研究报告。</p>
<p>它的职责是：</p>
<ol>
<li><strong>格式化子任务总结</strong>：将所有子任务的总结格式化为统一的格式</li>
<li><strong>构建报告 Prompt</strong>：根据研究主题和子任务总结构建 Prompt</li>
<li><strong>调用报告 Agent</strong>：调用 Report Writer Agent 生成最终报告</li>
<li><strong>整理引用</strong>：将所有来源引用整理到参考文献部分</li>
</ol>
<p><strong>核心代码实现</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> HelloAgentsLLM
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> ToolAwareSimpleAgent
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> models <span class="token keyword">import</span> TodoItem
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> prompts <span class="token keyword">import</span> report_writer_instructions
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">class</span> <span class="token class-name">ReportingService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">    <span class="token triple-quoted-string string">"""报告生成服务"""</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        tool_call_listener<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="15">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>_llm <span class="token operator">=</span> llm
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>_tool_call_listener <span class="token operator">=</span> tool_call_listener
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">        <span class="token comment"># 创建报告Agent</span>
</span><span class="code-line line-number" line="20">        self<span class="token punctuation">.</span>_agent <span class="token operator">=</span> ToolAwareSimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="21">            name<span class="token operator">=</span><span class="token string">"Report Writer"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">            system_prompt<span class="token operator">=</span><span class="token string">"你是一个报告撰写专家，擅长整合信息并生成结构化的报告。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">            llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">            tool_call_listener<span class="token operator">=</span>tool_call_listener
</span><span class="code-line line-number" line="25">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">    <span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="28">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">        research_topic<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">        task_summaries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>TodoItem<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">        <span class="token triple-quoted-string string">"""生成最终报告
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="34"><span class="token triple-quoted-string string">        Args:
</span></span><span class="code-line line-number" line="35"><span class="token triple-quoted-string string">            research_topic: 研究主题
</span></span><span class="code-line line-number" line="36"><span class="token triple-quoted-string string">            task_summaries: 子任务总结列表，每个元素是(任务, 总结, 来源URL列表)
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="38"><span class="token triple-quoted-string string">        Returns:
</span></span><span class="code-line line-number" line="39"><span class="token triple-quoted-string string">            最终报告（Markdown格式）
</span></span><span class="code-line line-number" line="40"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="41">        <span class="token comment"># 格式化子任务总结</span>
</span><span class="code-line line-number" line="42">        formatted_summaries <span class="token operator">=</span> self<span class="token punctuation">.</span>_format_summaries<span class="token punctuation">(</span>task_summaries<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">        <span class="token comment"># 构建Prompt</span>
</span><span class="code-line line-number" line="45">        prompt <span class="token operator">=</span> report_writer_instructions<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="46">            research_topic<span class="token operator">=</span>research_topic<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="47">            task_summaries<span class="token operator">=</span>formatted_summaries<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="48">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">        <span class="token comment"># 调用Agent</span>
</span><span class="code-line line-number" line="51">        report <span class="token operator">=</span> self<span class="token punctuation">.</span>_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="52">
</span><span class="code-line line-number" line="53">        <span class="token keyword">return</span> report
</span><span class="code-line line-number" line="54">
</span><span class="code-line line-number" line="55">    <span class="token keyword">def</span> <span class="token function">_format_summaries</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="56">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="57">        task_summaries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Tuple<span class="token punctuation">[</span>TodoItem<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="58">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="59">        <span class="token triple-quoted-string string">"""格式化子任务总结
</span></span><span class="code-line line-number" line="60"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="61"><span class="token triple-quoted-string string">        将所有子任务的总结格式化为统一的格式，包含：
</span></span><span class="code-line line-number" line="62"><span class="token triple-quoted-string string">        - 任务序号
</span></span><span class="code-line line-number" line="63"><span class="token triple-quoted-string string">        - 任务标题
</span></span><span class="code-line line-number" line="64"><span class="token triple-quoted-string string">        - 任务意图
</span></span><span class="code-line line-number" line="65"><span class="token triple-quoted-string string">        - 总结内容
</span></span><span class="code-line line-number" line="66"><span class="token triple-quoted-string string">        - 来源URL
</span></span><span class="code-line line-number" line="67"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="68">        formatted <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="69">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>task<span class="token punctuation">,</span> summary<span class="token punctuation">,</span> source_urls<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>task_summaries<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="70">            formatted<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="71">                <span class="token string-interpolation"><span class="token string">f"## 任务</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="72">                <span class="token string-interpolation"><span class="token string">f"**意图**：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>intent<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="73">                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>summary<span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="74">                <span class="token string-interpolation"><span class="token string">f"**来源**：\n"</span></span>
</span><span class="code-line line-number" line="75">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="76">            <span class="token keyword">for</span> url <span class="token keyword">in</span> source_urls<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="77">                formatted<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"- </span><span class="token interpolation"><span class="token punctuation">{</span>url<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="78">            formatted<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="79">
</span><span class="code-line line-number" line="80">        <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>formatted<span class="token punctuation">)</span>
</span></code></pre>
<h3>14.5.4 搜索调度服务</h3>
<p><code>SearchService</code>负责调度搜索引擎，执行搜索并返回结果。这是连接 Agent 和 SearchTool 的桥梁。在这里我们没有采用往常一样的使得 simpleAgent 直接调用工具的形式，而是将 SearchTool 的执行结果通过中间层来返回给 Agent，这样会使得 Agent 更加专注处理得到的信息。</p>
<p>它的职责是：</p>
<ol>
<li><strong>调度搜索引擎</strong>：根据配置选择搜索引擎</li>
<li><strong>执行搜索</strong>：调用 SearchTool 执行搜索</li>
<li><strong>处理结果</strong>：去重、限制 Token、格式化</li>
<li><strong>错误处理</strong>：处理搜索失败的情况</li>
</ol>
<p>核心代码：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Optional
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> logging
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> SearchTool
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> config <span class="token keyword">import</span> Configuration
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">class</span> <span class="token class-name">SearchService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">    <span class="token triple-quoted-string string">"""搜索调度服务"""</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> Configuration<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">        <span class="token comment"># 创建SearchTool</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>search_tool <span class="token operator">=</span> SearchTool<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">"hybrid"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">        max_results<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span>
</span><span class="code-line line-number" line="22">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">        <span class="token triple-quoted-string string">"""执行搜索
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">        Args:
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">            query: 搜索查询
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">            max_results: 最大结果数量
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">        Returns:
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">            搜索结果列表
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="32">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">            <span class="token comment"># 调用SearchTool</span>
</span><span class="code-line line-number" line="34">            raw_response <span class="token operator">=</span> self<span class="token punctuation">.</span>search_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="35">                <span class="token string">"input"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">                <span class="token string">"backend"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>search_api<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">                <span class="token string">"mode"</span><span class="token punctuation">:</span> <span class="token string">"structured"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="38">                <span class="token string">"max_results"</span><span class="token punctuation">:</span> max_results
</span><span class="code-line line-number" line="39">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">
</span><span class="code-line line-number" line="41">            <span class="token comment"># 提取结果</span>
</span><span class="code-line line-number" line="42">            results <span class="token operator">=</span> raw_response<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">            <span class="token comment"># 处理结果</span>
</span><span class="code-line line-number" line="45">            results <span class="token operator">=</span> self<span class="token punctuation">.</span>_deduplicate_sources<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">            results <span class="token operator">=</span> self<span class="token punctuation">.</span>_limit_source_tokens<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">
</span><span class="code-line line-number" line="48">            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"搜索成功：</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">，返回</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">个结果"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">            <span class="token keyword">return</span> results
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="53">            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"搜索失败：</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">，错误：</span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="54">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="55">
</span><span class="code-line line-number" line="56">    <span class="token keyword">def</span> <span class="token function">_deduplicate_sources</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sources<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="57">        <span class="token triple-quoted-string string">"""去除重复的URL"""</span>
</span><span class="code-line line-number" line="58">        seen_urls <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="59">        unique_sources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="60">
</span><span class="code-line line-number" line="61">        <span class="token keyword">for</span> source <span class="token keyword">in</span> sources<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="62">            url <span class="token operator">=</span> source<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="63">            <span class="token keyword">if</span> url <span class="token keyword">and</span> url <span class="token keyword">not</span> <span class="token keyword">in</span> seen_urls<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="64">                seen_urls<span class="token punctuation">.</span>add<span class="token punctuation">(</span>url<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="65">                unique_sources<span class="token punctuation">.</span>append<span class="token punctuation">(</span>source<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="66">
</span><span class="code-line line-number" line="67">        <span class="token keyword">return</span> unique_sources
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69">    <span class="token keyword">def</span> <span class="token function">_limit_source_tokens</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="70">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="71">        sources<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="72">        max_tokens_per_source<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">2000</span>
</span><span class="code-line line-number" line="73">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="74">        <span class="token triple-quoted-string string">"""限制每个来源的Token数量"""</span>
</span><span class="code-line line-number" line="75">        limited_sources <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="76">
</span><span class="code-line line-number" line="77">        <span class="token keyword">for</span> source <span class="token keyword">in</span> sources<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="78">            snippet <span class="token operator">=</span> source<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"snippet"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="79">
</span><span class="code-line line-number" line="80">            <span class="token comment"># 简单的Token估算：1个Token约等于4个字符</span>
</span><span class="code-line line-number" line="81">            max_chars <span class="token operator">=</span> max_tokens_per_source <span class="token operator">*</span> <span class="token number">4</span>
</span><span class="code-line line-number" line="82">
</span><span class="code-line line-number" line="83">            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>snippet<span class="token punctuation">)</span> <span class="token operator">&gt;</span> max_chars<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="84">                snippet <span class="token operator">=</span> snippet<span class="token punctuation">[</span><span class="token punctuation">:</span>max_chars<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">"..."</span>
</span><span class="code-line line-number" line="85">
</span><span class="code-line line-number" line="86">            limited_sources<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="87">                <span class="token operator">**</span>source<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="88">                <span class="token string">"snippet"</span><span class="token punctuation">:</span> snippet
</span><span class="code-line line-number" line="89">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="90">
</span><span class="code-line line-number" line="91">        <span class="token keyword">return</span> limited_sources
</span></code></pre>
<p>根据配置选择搜索引擎，如图 14.8 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-8.png" alt="" width="85%">
  <p>图 14.8 搜索引擎调度流程</p>
</div>
<p>**调度逻辑<strong>：</strong></p><strong>
</strong><ol><strong>
</strong><li><strong></strong>读取配置<strong>：从<code>.env</code>文件读取<code>SEARCH_API</code>配置</strong></li><strong>
</strong><li><strong></strong>选择引擎<strong>：根据配置选择搜索引擎（tavily、duckduckgo、perplexity 等）</strong></li><strong>
</strong><li><strong></strong>执行搜索<strong>：调用 SearchTool 执行搜索</strong></li><strong>
</strong><li><strong></strong>处理结果<strong>：去重、限制 Token、格式化</strong></li><strong>
</strong><li><strong></strong>返回结果<strong>：返回处理后的搜索结果</strong></li><strong>
</strong></ol><strong>
<p>为了提高效率和降低成本，我们可以添加搜索结果缓存：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> hashlib
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">class</span> <span class="token class-name">SearchService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> Configuration<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config
</span><span class="code-line line-number" line="8">        self<span class="token punctuation">.</span>search_tool <span class="token operator">=</span> SearchTool<span class="token punctuation">(</span>backend<span class="token operator">=</span><span class="token string">"hybrid"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">        <span class="token comment"># 缓存目录</span>
</span><span class="code-line line-number" line="11">        self<span class="token punctuation">.</span>cache_dir <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"./cache/search"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">.</span>cache_dir<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">    <span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="15">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">        max_results<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">        use_cache<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</span><span class="code-line line-number" line="19">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        <span class="token triple-quoted-string string">"""执行搜索（带缓存）"""</span>
</span><span class="code-line line-number" line="21">        <span class="token comment"># 生成缓存键</span>
</span><span class="code-line line-number" line="22">        cache_key <span class="token operator">=</span> self<span class="token punctuation">.</span>_generate_cache_key<span class="token punctuation">(</span>query<span class="token punctuation">,</span> max_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">        cache_file <span class="token operator">=</span> self<span class="token punctuation">.</span>cache_dir <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>cache_key<span class="token punctuation">}</span></span><span class="token string">.json"</span></span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">        <span class="token comment"># 尝试从缓存读取</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">if</span> use_cache <span class="token keyword">and</span> cache_file<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="27">            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"从缓存读取搜索结果：</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>cache_file<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">                <span class="token keyword">return</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">        <span class="token comment"># 执行搜索</span>
</span><span class="code-line line-number" line="32">        results <span class="token operator">=</span> self<span class="token punctuation">.</span>_execute_search<span class="token punctuation">(</span>query<span class="token punctuation">,</span> max_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">        <span class="token comment"># 保存到缓存</span>
</span><span class="code-line line-number" line="35">        <span class="token keyword">if</span> use_cache <span class="token keyword">and</span> results<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="36">            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>cache_file<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="37">                json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>results<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">        <span class="token keyword">return</span> results
</span><span class="code-line line-number" line="40">
</span><span class="code-line line-number" line="41">    <span class="token keyword">def</span> <span class="token function">_generate_cache_key</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> max_results<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="42">        <span class="token triple-quoted-string string">"""生成缓存键"""</span>
</span><span class="code-line line-number" line="43">        <span class="token comment"># 使用查询和最大结果数生成MD5哈希</span>
</span><span class="code-line line-number" line="44">        content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>max_results<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>search_api<span class="token punctuation">.</span>value<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="45">        <span class="token keyword">return</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>content<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p>通过四个核心服务（PlanningService、SummarizationService、ReportingService、SearchService），我们构建了一个完整的研究流程。这些服务各司其职，通过清晰的接口协作，实现了从研究主题到最终报告的自动化流程。</p>
<h2>14.6 前端交互设计</h2>
<p>在前面的章节中，我们实现了完整的后端系统。本节将详细介绍前端交互设计，包括全屏模态对话框 UI、实时进度展示和研究结果可视化。</p>
<h3>14.6.1 全屏模态对话框 UI 设计</h3>
<p>深度研究助手采用全屏模态对话框的 UI 设计，这种设计有以下优势：</p>
</strong><ol><strong>
</strong><li><strong></strong>沉浸式体验<strong>：全屏显示，避免干扰，专注于研究</strong></li><strong>
</strong><li><strong></strong>清晰的层次<strong>：主页面和研究页面分离，层次清晰</strong></li><strong>
</strong><li><strong></strong>易于关闭<strong>：点击关闭按钮或按 ESC 键即可返回主页面</strong></li><strong>
</strong><li><strong></strong>响应式设计<strong>：适配不同屏幕尺寸</strong></li><strong>
</strong></ol><strong>
<p>如图 14.9 所示，全屏模态对话框包含以下部分：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-9.png" alt="" width="85%">
  <p>图 14.9 全屏模态对话框 UI</p>
</div>
</strong><p><strong></strong>UI 组件<strong>：</strong></p><strong>
</strong><ol><strong>
</strong><li><strong></strong>顶部栏<strong>：包含研究主题和关闭按钮</strong></li><strong>
</strong><li><strong></strong>进度区域<strong>：显示当前研究进度（规划、执行、报告）</strong></li><strong>
</strong><li><strong></strong>内容区域<strong>：显示研究结果（Markdown 格式）</strong></li><strong>
</strong><li><strong></strong>底部栏**：显示状态信息（如"研究中..."、"已完成"）</li>
</ol>
<p>对应的 Vue 实现如下所示(ResearchModal.vue):</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;template&gt;
</span><span class="code-line line-number" line="2">  &lt;div v-if="isOpen" class="modal-overlay" @click.self="close"&gt;
</span><span class="code-line line-number" line="3">    &lt;div class="modal-container"&gt;
</span><span class="code-line line-number" line="4">      &lt;!-- 顶部栏 --&gt;
</span><span class="code-line line-number" line="5">      &lt;div class="modal-header"&gt;
</span><span class="code-line line-number" line="6">        &lt;h2&gt;{{ researchTopic }}&lt;/h2&gt;
</span><span class="code-line line-number" line="7">        &lt;button @click="close" class="close-button"&gt;
</span><span class="code-line line-number" line="8">          &lt;svg&gt;&lt;!-- 关闭图标 --&gt;&lt;/svg&gt;
</span><span class="code-line line-number" line="9">        &lt;/button&gt;
</span><span class="code-line line-number" line="10">      &lt;/div&gt;
</span><span class="code-line line-number" line="11">      
</span><span class="code-line line-number" line="12">      &lt;!-- 进度区域 --&gt;
</span><span class="code-line line-number" line="13">      &lt;div class="progress-section"&gt;
</span><span class="code-line line-number" line="14">        &lt;div class="progress-bar"&gt;
</span><span class="code-line line-number" line="15">          &lt;div 
</span><span class="code-line line-number" line="16">            class="progress-fill" 
</span><span class="code-line line-number" line="17">            :style="{ width: progressPercentage + '%' }"
</span><span class="code-line line-number" line="18">          &gt;&lt;/div&gt;
</span><span class="code-line line-number" line="19">        &lt;/div&gt;
</span><span class="code-line line-number" line="20">        &lt;div class="progress-text"&gt;{{ progressText }}&lt;/div&gt;
</span><span class="code-line line-number" line="21">      &lt;/div&gt;
</span><span class="code-line line-number" line="22">      
</span><span class="code-line line-number" line="23">      &lt;!-- 内容区域 --&gt;
</span><span class="code-line line-number" line="24">      &lt;div class="content-section"&gt;
</span><span class="code-line line-number" line="25">        &lt;div v-if="isLoading" class="loading-spinner"&gt;
</span><span class="code-line line-number" line="26">          &lt;div class="spinner"&gt;&lt;/div&gt;
</span><span class="code-line line-number" line="27">          &lt;p&gt;研究中，请稍候...&lt;/p&gt;
</span><span class="code-line line-number" line="28">        &lt;/div&gt;
</span><span class="code-line line-number" line="29">        
</span><span class="code-line line-number" line="30">        &lt;div v-else class="markdown-content" v-html="renderedMarkdown"&gt;&lt;/div&gt;
</span><span class="code-line line-number" line="31">      &lt;/div&gt;
</span><span class="code-line line-number" line="32">      
</span><span class="code-line line-number" line="33">      &lt;!-- 底部栏 --&gt;
</span><span class="code-line line-number" line="34">      &lt;div class="modal-footer"&gt;
</span><span class="code-line line-number" line="35">        &lt;span class="status-text"&gt;{{ statusText }}&lt;/span&gt;
</span><span class="code-line line-number" line="36">      &lt;/div&gt;
</span><span class="code-line line-number" line="37">    &lt;/div&gt;
</span><span class="code-line line-number" line="38">  &lt;/div&gt;
</span><span class="code-line line-number" line="39">&lt;/template&gt;
</span><span class="code-line line-number" line="40">
</span><span class="code-line line-number" line="41">&lt;script setup lang="ts"&gt;
</span><span class="code-line line-number" line="42">import { ref, computed, watch } from 'vue'
</span><span class="code-line line-number" line="43">import { marked } from 'marked'
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45">interface Props {
</span><span class="code-line line-number" line="46">  isOpen: boolean
</span><span class="code-line line-number" line="47">  researchTopic: string
</span><span class="code-line line-number" line="48">}
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">const props = defineProps&lt;Props&gt;()
</span><span class="code-line line-number" line="51">const emit = defineEmits&lt;{
</span><span class="code-line line-number" line="52">  close: []
</span><span class="code-line line-number" line="53">}&gt;()
</span><span class="code-line line-number" line="54">
</span><span class="code-line line-number" line="55">// 状态
</span><span class="code-line line-number" line="56">const isLoading = ref(true)
</span><span class="code-line line-number" line="57">const progressPercentage = ref(0)
</span><span class="code-line line-number" line="58">const progressText = ref('准备中...')
</span><span class="code-line line-number" line="59">const statusText = ref('研究中...')
</span><span class="code-line line-number" line="60">const markdownContent = ref('')
</span><span class="code-line line-number" line="61">
</span><span class="code-line line-number" line="62">// 渲染Markdown
</span><span class="code-line line-number" line="63">const renderedMarkdown = computed(() =&gt; {
</span><span class="code-line line-number" line="64">  return marked(markdownContent.value)
</span><span class="code-line line-number" line="65">})
</span><span class="code-line line-number" line="66">
</span><span class="code-line line-number" line="67">// 关闭模态框
</span><span class="code-line line-number" line="68">const close = () =&gt; {
</span><span class="code-line line-number" line="69">  emit('close')
</span><span class="code-line line-number" line="70">}
</span><span class="code-line line-number" line="71">
</span><span class="code-line line-number" line="72">// 监听ESC键
</span><span class="code-line line-number" line="73">const handleKeydown = (e: KeyboardEvent) =&gt; {
</span><span class="code-line line-number" line="74">  if (e.key === 'Escape') {
</span><span class="code-line line-number" line="75">    close()
</span><span class="code-line line-number" line="76">  }
</span><span class="code-line line-number" line="77">}
</span><span class="code-line line-number" line="78">
</span><span class="code-line line-number" line="79">// 挂载时添加键盘监听
</span><span class="code-line line-number" line="80">watch(() =&gt; props.isOpen, (isOpen) =&gt; {
</span><span class="code-line line-number" line="81">  if (isOpen) {
</span><span class="code-line line-number" line="82">    document.addEventListener('keydown', handleKeydown)
</span><span class="code-line line-number" line="83">  } else {
</span><span class="code-line line-number" line="84">    document.removeEventListener('keydown', handleKeydown)
</span><span class="code-line line-number" line="85">  }
</span><span class="code-line line-number" line="86">})
</span><span class="code-line line-number" line="87">&lt;/script&gt;
</span><span class="code-line line-number" line="88">
</span><span class="code-line line-number" line="89">&lt;style scoped&gt;
</span><span class="code-line line-number" line="90">.modal-overlay {
</span><span class="code-line line-number" line="91">  position: fixed;
</span><span class="code-line line-number" line="92">  top: 0;
</span><span class="code-line line-number" line="93">  left: 0;
</span><span class="code-line line-number" line="94">  width: 100vw;
</span><span class="code-line line-number" line="95">  height: 100vh;
</span><span class="code-line line-number" line="96">  background-color: rgba(0, 0, 0, 0.5);
</span><span class="code-line line-number" line="97">  display: flex;
</span><span class="code-line line-number" line="98">  justify-content: center;
</span><span class="code-line line-number" line="99">  align-items: center;
</span><span class="code-line line-number" line="100">  z-index: 1000;
</span><span class="code-line line-number" line="101">}
</span><span class="code-line line-number" line="102">......
</span><span class="code-line line-number" line="103">&lt;/style&gt;
</span></code></pre>
<p>为了适配不同屏幕尺寸，我们添加媒体查询：</p>
<pre class="language-css"><code class="language-css code-highlight"><span class="code-line line-number" line="1"><span class="token comment">/* 平板设备 */</span>
</span><span class="code-line line-number" line="2"><span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">768</span><span class="token unit">px</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">  <span class="token selector"><span class="token class">.modal-container</span></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">95</span><span class="token unit">vw</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="5">    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">95</span><span class="token unit">vh</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="6">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="7">  
</span><span class="code-line line-number" line="8">  <span class="token selector"><span class="token class">.modal-header</span><span class="token punctuation">,</span>
</span></span><span class="code-line line-number" line="9"><span class="token selector">  <span class="token class">.progress-section</span><span class="token punctuation">,</span>
</span></span><span class="code-line line-number" line="10"><span class="token selector">  <span class="token class">.content-section</span><span class="token punctuation">,</span>
</span></span><span class="code-line line-number" line="11"><span class="token selector">  <span class="token class">.modal-footer</span></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token property">padding</span><span class="token punctuation">:</span> <span class="token number">15</span><span class="token unit">px</span> <span class="token number">20</span><span class="token unit">px</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="13">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token comment">/* 手机设备 */</span>
</span><span class="code-line line-number" line="17"><span class="token atrule"><span class="token rule">@media</span> <span class="token punctuation">(</span><span class="token property">max-width</span><span class="token punctuation">:</span> <span class="token number">480</span><span class="token unit">px</span><span class="token punctuation">)</span></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">  <span class="token selector"><span class="token class">.modal-container</span></span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="19">    <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">vw</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="20">    <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token unit">vh</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="21">    <span class="token property">border-radius</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="22">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="23">  
</span><span class="code-line line-number" line="24">  <span class="token selector"><span class="token class">.modal-header</span> h2</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="25">    <span class="token property">font-size</span><span class="token punctuation">:</span> <span class="token number">18</span><span class="token unit">px</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="26">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="27"><span class="token punctuation">}</span>
</span></code></pre>
<h3>14.6.2 实时进度展示</h3>
<p>深度研究助手使用 SSE 实现实时进度展示。SSE 是一种服务器推送技术，允许服务器主动向客户端发送数据，在协议章节也有所讲解。</p>
<p>如图 14.10 所示，SSE 流程包括以下步骤：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/14-figures/14-10.png" alt="" width="85%">
  <p>图 14.10 SSE 流程</p>
</div>
<p><strong>流程说明</strong>：</p>
<ol>
<li><strong>客户端发起请求</strong>：发送 POST 请求到<code>/api/research</code>，包含研究主题</li>
<li><strong>服务器建立 SSE 连接</strong>：返回<code>text/event-stream</code>响应</li>
<li><strong>服务器推送进度</strong>：定期推送研究进度（规划、执行、报告）</li>
<li><strong>客户端接收进度</strong>：监听 SSE 事件，更新 UI</li>
<li><strong>研究完成</strong>：服务器推送最终报告，关闭连接</li>
</ol>
<p>如果想把 SSE 用于前后端的项目中还需要做如下配置。</p>
<p><strong>后端 FastAPI SSE 端点</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> fastapi<span class="token punctuation">.</span>responses <span class="token keyword">import</span> StreamingResponse
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> typing <span class="token keyword">import</span> AsyncGenerator
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> asyncio
</span><span class="code-line line-number" line="5"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">research_stream</span><span class="token punctuation">(</span>topic<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> AsyncGenerator<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">    <span class="token triple-quoted-string string">"""研究流式生成器
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">    
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">    生成SSE格式的数据：
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">    data: {"type": "progress", "data": {...}}
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">    
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">        <span class="token comment"># 1. 规划阶段</span>
</span><span class="code-line line-number" line="18">        <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'stage'</span><span class="token punctuation">:</span> <span class="token string">'planning'</span><span class="token punctuation">,</span> <span class="token string">'percentage'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">'正在规划研究任务...'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="19">        
</span><span class="code-line line-number" line="20">        <span class="token comment"># 调用PlanningService</span>
</span><span class="code-line line-number" line="21">        todo_items <span class="token operator">=</span> <span class="token keyword">await</span> planning_service<span class="token punctuation">.</span>plan_todo_list<span class="token punctuation">(</span>topic<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">        
</span><span class="code-line line-number" line="23">        <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'plan'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>item<span class="token punctuation">.</span><span class="token builtin">dict</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> todo_items<span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="24">        
</span><span class="code-line line-number" line="25">        <span class="token comment"># 2. 执行阶段</span>
</span><span class="code-line line-number" line="26">        task_summaries <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="27">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> task <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>todo_items<span class="token punctuation">,</span> start<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="28">            <span class="token comment"># 更新进度</span>
</span><span class="code-line line-number" line="29">            percentage <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span>idx <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>todo_items<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">70</span>
</span><span class="code-line line-number" line="30">            <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'stage'</span><span class="token punctuation">:</span> <span class="token string">'executing'</span><span class="token punctuation">,</span> <span class="token string">'percentage'</span><span class="token punctuation">:</span> percentage<span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'正在研究任务</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>todo_items<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">：</span><span class="token interpolation"><span class="token punctuation">{</span>task<span class="token punctuation">.</span>title<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="31">            
</span><span class="code-line line-number" line="32">            <span class="token comment"># 搜索</span>
</span><span class="code-line line-number" line="33">            search_results <span class="token operator">=</span> <span class="token keyword">await</span> search_service<span class="token punctuation">.</span>search<span class="token punctuation">(</span>task<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">            
</span><span class="code-line line-number" line="35">            <span class="token comment"># 总结</span>
</span><span class="code-line line-number" line="36">            summary<span class="token punctuation">,</span> source_urls <span class="token operator">=</span> <span class="token keyword">await</span> summarization_service<span class="token punctuation">.</span>summarize_task<span class="token punctuation">(</span>task<span class="token punctuation">,</span> search_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">            
</span><span class="code-line line-number" line="38">            task_summaries<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> summary<span class="token punctuation">,</span> source_urls<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">            
</span><span class="code-line line-number" line="40">            <span class="token comment"># 推送任务总结</span>
</span><span class="code-line line-number" line="41">            <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'task_summary'</span><span class="token punctuation">,</span> <span class="token string">'task_id'</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">'summary'</span><span class="token punctuation">:</span> summary<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="42">        
</span><span class="code-line line-number" line="43">        <span class="token comment"># 3. 报告阶段</span>
</span><span class="code-line line-number" line="44">        <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'stage'</span><span class="token punctuation">:</span> <span class="token string">'reporting'</span><span class="token punctuation">,</span> <span class="token string">'percentage'</span><span class="token punctuation">:</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">'正在生成最终报告...'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="45">        
</span><span class="code-line line-number" line="46">        <span class="token comment"># 生成报告</span>
</span><span class="code-line line-number" line="47">        report <span class="token operator">=</span> <span class="token keyword">await</span> reporting_service<span class="token punctuation">.</span>generate_report<span class="token punctuation">(</span>topic<span class="token punctuation">,</span> task_summaries<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="48">        
</span><span class="code-line line-number" line="49">        <span class="token comment"># 推送最终报告</span>
</span><span class="code-line line-number" line="50">        <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'report'</span><span class="token punctuation">,</span> <span class="token string">'data'</span><span class="token punctuation">:</span> report<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="51">        
</span><span class="code-line line-number" line="52">        <span class="token comment"># 完成</span>
</span><span class="code-line line-number" line="53">        <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'progress'</span><span class="token punctuation">,</span> <span class="token string">'stage'</span><span class="token punctuation">:</span> <span class="token string">'completed'</span><span class="token punctuation">,</span> <span class="token string">'percentage'</span><span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">:</span> <span class="token string">'研究完成！'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="54">        
</span><span class="code-line line-number" line="55">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="56">        <span class="token comment"># 错误处理</span>
</span><span class="code-line line-number" line="57">        <span class="token keyword">yield</span> <span class="token string-interpolation"><span class="token string">f"data: </span><span class="token interpolation"><span class="token punctuation">{</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token string">'message'</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n\n"</span></span>
</span><span class="code-line line-number" line="58">
</span><span class="code-line line-number" line="59"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/api/research"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="60"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">research</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> ResearchRequest<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="61">    <span class="token triple-quoted-string string">"""研究端点（SSE）"""</span>
</span><span class="code-line line-number" line="62">    <span class="token keyword">return</span> StreamingResponse<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="63">        research_stream<span class="token punctuation">(</span>request<span class="token punctuation">.</span>topic<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="64">        media_type<span class="token operator">=</span><span class="token string">"text/event-stream"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="65">        headers<span class="token operator">=</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="66">            <span class="token string">"Cache-Control"</span><span class="token punctuation">:</span> <span class="token string">"no-cache"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="67">            <span class="token string">"Connection"</span><span class="token punctuation">:</span> <span class="token string">"keep-alive"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="68">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="69">    <span class="token punctuation">)</span>
</span></code></pre>
<p><strong>前端使用 EventSource 接收 SSE</strong>：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// composables/useResearch.ts</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> <span class="token punctuation">{</span> ref <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">useResearch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">  <span class="token keyword">const</span> isLoading <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">  <span class="token keyword">const</span> progressPercentage <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">  <span class="token keyword">const</span> progressText <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">  <span class="token keyword">const</span> markdownContent <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">  <span class="token keyword">const</span> error <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">  
</span><span class="code-line line-number" line="11">  <span class="token keyword">const</span> <span class="token function-variable function">startResearch</span> <span class="token operator">=</span> <span class="token punctuation">(</span>topic<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    isLoading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
</span><span class="code-line line-number" line="13">    error<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>
</span><span class="code-line line-number" line="14">    
</span><span class="code-line line-number" line="15">    <span class="token comment">// 创建EventSource</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">const</span> eventSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/api/research?topic=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">    
</span><span class="code-line line-number" line="18">    <span class="token comment">// 监听消息</span>
</span><span class="code-line line-number" line="19">    eventSource<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="20">      <span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">      
</span><span class="code-line line-number" line="22">      <span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">        <span class="token keyword">case</span> <span class="token string">'progress'</span><span class="token operator">:</span>
</span><span class="code-line line-number" line="24">          progressPercentage<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">.</span>percentage
</span><span class="code-line line-number" line="25">          progressText<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">.</span>text
</span><span class="code-line line-number" line="26">          <span class="token keyword">break</span>
</span><span class="code-line line-number" line="27">          
</span><span class="code-line line-number" line="28">        <span class="token keyword">case</span> <span class="token string">'plan'</span><span class="token operator">:</span>
</span><span class="code-line line-number" line="29">          <span class="token comment">// 显示规划结果</span>
</span><span class="code-line line-number" line="30">          <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'规划结果:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">          <span class="token keyword">break</span>
</span><span class="code-line line-number" line="32">          
</span><span class="code-line line-number" line="33">        <span class="token keyword">case</span> <span class="token string">'task_summary'</span><span class="token operator">:</span>
</span><span class="code-line line-number" line="34">          <span class="token comment">// 追加任务总结到Markdown</span>
</span><span class="code-line line-number" line="35">          markdownContent<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n\n## 任务</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>task_id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n\n</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>summary<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line line-number" line="36">          <span class="token keyword">break</span>
</span><span class="code-line line-number" line="37">          
</span><span class="code-line line-number" line="38">        <span class="token keyword">case</span> <span class="token string">'report'</span><span class="token operator">:</span>
</span><span class="code-line line-number" line="39">          <span class="token comment">// 显示最终报告</span>
</span><span class="code-line line-number" line="40">          markdownContent<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">.</span>data
</span><span class="code-line line-number" line="41">          <span class="token keyword">break</span>
</span><span class="code-line line-number" line="42">          
</span><span class="code-line line-number" line="43">        <span class="token keyword">case</span> <span class="token string">'error'</span><span class="token operator">:</span>
</span><span class="code-line line-number" line="44">          error<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">.</span>message
</span><span class="code-line line-number" line="45">          eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">          isLoading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="47">          <span class="token keyword">break</span>
</span><span class="code-line line-number" line="48">          
</span><span class="code-line line-number" line="49">        <span class="token keyword">case</span> <span class="token string">'completed'</span><span class="token operator">:</span>
</span><span class="code-line line-number" line="50">          eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">          isLoading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="52">          <span class="token keyword">break</span>
</span><span class="code-line line-number" line="53">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="54">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="55">    
</span><span class="code-line line-number" line="56">    <span class="token comment">// 错误处理</span>
</span><span class="code-line line-number" line="57">    eventSource<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="58">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'SSE错误:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="59">      error<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'连接失败，请重试'</span>
</span><span class="code-line line-number" line="60">      eventSource<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="61">      isLoading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="62">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="63">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="64">  
</span><span class="code-line line-number" line="65">  <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="66">    isLoading<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="67">    progressPercentage<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="68">    progressText<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="69">    markdownContent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="70">    error<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="71">    startResearch<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="72">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="73"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>在组件中使用</strong>：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;script setup lang="ts"&gt;
</span><span class="code-line line-number" line="2">import { useResearch } from '@/composables/useResearch'
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">const { 
</span><span class="code-line line-number" line="5">  isLoading, 
</span><span class="code-line line-number" line="6">  progressPercentage, 
</span><span class="code-line line-number" line="7">  progressText, 
</span><span class="code-line line-number" line="8">  markdownContent, 
</span><span class="code-line line-number" line="9">  error,
</span><span class="code-line line-number" line="10">  startResearch 
</span><span class="code-line line-number" line="11">} = useResearch()
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">const handleStartResearch = (topic: string) =&gt; {
</span><span class="code-line line-number" line="14">  startResearch(topic)
</span><span class="code-line line-number" line="15">}
</span><span class="code-line line-number" line="16">&lt;/script&gt;
</span></code></pre>
<h3>14.6.3 研究结果可视化</h3>
<p>研究结果以 Markdown 格式展示，包含标题、段落、列表、引用等元素。我们使用<code>marked</code>库将 Markdown 转换为 HTML，并添加自定义样式。</p>
<p><strong>渲染 Markdown</strong>：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> <span class="token punctuation">{</span> marked <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'marked'</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment">// 配置marked</span>
</span><span class="code-line line-number" line="4">marked<span class="token punctuation">.</span><span class="token function">setOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">  breaks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 支持换行</span>
</span><span class="code-line line-number" line="6">  gfm<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>     <span class="token comment">// 支持GitHub Flavored Markdown</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment">// 渲染</span>
</span><span class="code-line line-number" line="10"><span class="token keyword">const</span> renderedHtml <span class="token operator">=</span> <span class="token function">marked</span><span class="token punctuation">(</span>markdownContent<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</span></code></pre>
<p>研究报告中包含大量来源引用，我们需要特殊处理：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">##</span> 参考文献</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token title important"><span class="token punctuation">###</span> 任务1：Datawhale的基本信息</span>
</span><span class="code-line line-number" line="4"><span class="token list punctuation">-</span> <span class="token url">[<span class="token content">Datawhale GitHub</span>](<span class="token url">https://github.com/datawhalechina</span>)</span>
</span><span class="code-line line-number" line="5"><span class="token list punctuation">-</span> <span class="token url">[<span class="token content">Datawhale 官网</span>](<span class="token url">https://datawhale.club</span>)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token title important"><span class="token punctuation">###</span> 任务2：Datawhale的主要项目</span>
</span><span class="code-line line-number" line="8"><span class="token list punctuation">-</span> <span class="token url">[<span class="token content">Hello-Agents 教程</span>](<span class="token url">https://github.com/datawhalechina/Hello-Agents</span>)</span>
</span><span class="code-line line-number" line="9">......
</span></code></pre>
<p>通过全屏模态对话框 UI、SSE 实时进度展示和 Markdown 结果可视化，我们构建了一个用户友好的前端界面。用户可以清晰地看到研究进度，并以美观的格式查看研究结果。</p>
<h2>14.7 本章小结</h2>
<p>在本章中，我们从零开始构建了一个完整的自动化深度研究智能体系统。让我们回顾一下核心要点：</p>
<p><strong>（1）TODO 驱动的研究范式</strong></p>
<p>我们提出了一种新的研究范式——TODO 驱动的研究。这种范式将复杂的研究主题分解为可执行的子任务，通过三个阶段完成研究：</p>
<ul>
<li><strong>规划阶段</strong>：将研究主题分解为 3-5 个子任务，每个子任务包含标题、意图和搜索查询</li>
<li><strong>执行阶段</strong>：对每个子任务执行搜索和总结，生成结构化的知识</li>
<li><strong>报告阶段</strong>：整合所有子任务的总结，生成最终的研究报告</li>
</ul>
<p>这种范式的优势在于：</p>
<ol>
<li><strong>可控性强</strong>：每个子任务都有明确的目标和范围</li>
<li><strong>质量可靠</strong>：通过专门的 Agent 保证每个环节的质量</li>
<li><strong>易于调试</strong>：可以单独调试每个子任务</li>
<li><strong>可扩展性好</strong>：可以轻松添加新的子任务或修改现有子任务</li>
</ol>
<p><strong>（2）三 Agent 协作系统</strong></p>
<p>我们设计了三个专门的 Agent，各司其职：</p>
<ul>
<li><strong>TODO Planner（研究规划专家）</strong>：负责将研究主题分解为子任务</li>
<li><strong>Task Summarizer（任务总结专家）</strong>：负责总结每个子任务的搜索结果</li>
<li><strong>Report Writer（报告撰写专家）</strong>：负责整合所有子任务的总结，生成最终报告</li>
</ul>
<p>这种设计的优势在于：</p>
<ol>
<li><strong>职责清晰</strong>：每个 Agent 专注于一个特定的任务</li>
<li><strong>Prompt 优化</strong>：可以为每个 Agent 定制专门的 Prompt</li>
<li><strong>易于维护</strong>：修改一个 Agent 不会影响其他 Agent</li>
<li><strong>质量保证</strong>：每个 Agent 都是该领域的"专家"</li>
</ol>
<p><strong>（3）ToolAwareSimpleAgent 的设计</strong></p>
<p>我们扩展了 HelloAgents 框架的<code>SimpleAgent</code>，实现了<code>ToolAwareSimpleAgent</code>。这个 Agent 具有工具调用监听能力，可以：</p>
<ul>
<li><strong>监听工具调用</strong>：通过回调函数监听每次工具调用</li>
<li><strong>实时反馈</strong>：将工具调用信息实时推送给前端</li>
<li><strong>调试支持</strong>：记录所有工具调用，便于调试</li>
</ul>
<p>这个 Agent 已经集成到 HelloAgents 框架中，可以在其他项目中复用。</p>
<p><strong>（4）工具系统集成</strong></p>
<p>我们充分利用了 HelloAgents 框架的工具系统：</p>
<ul>
<li><strong>SearchTool</strong>：扩展支持更多种搜索引擎（Tavily、DuckDuckGo、Perplexity 等）</li>
<li><strong>NoteTool</strong>：持久化研究进度，支持恢复和审计</li>
<li><strong>ToolRegistry</strong>：统一管理所有工具，支持自定义扩展</li>
</ul>
<p>通过配置化的设计，用户可以轻松切换搜索引擎，无需修改代码。</p>
<p><strong>（5）核心服务实现</strong></p>
<p>我们实现了四个核心服务，连接 Agent 和工具：</p>
<ul>
<li><strong>PlanningService</strong>：调用规划 Agent，解析 JSON，验证格式</li>
<li><strong>SummarizationService</strong>：调用总结 Agent，处理搜索结果，提取来源</li>
<li><strong>ReportingService</strong>：调用报告 Agent，整合总结，生成报告</li>
<li><strong>SearchService</strong>：调度搜索引擎，处理结果，错误降级，结果缓存</li>
</ul>
<p>这些服务各司其职，通过清晰的接口协作，实现了从研究主题到最终报告的自动化流程。</p>
<p><strong>（6）前端交互设计</strong></p>
<p>我们设计了用户友好的前端界面：</p>
<ul>
<li><strong>全屏模态对话框</strong>：沉浸式体验，清晰的层次</li>
<li><strong>SSE 实时进度</strong>：实时展示研究进度，用户体验良好</li>
<li><strong>Markdown 可视化</strong>：美观的格式，清晰的结构</li>
</ul>
<p>通过 Vue 3 + TypeScript + SSE 的技术栈，我们实现了一个现代化的 Web 应用。</p>
<p>这些知识不仅适用于深度研究助手，也可以应用到其他 AI 应用中。希望读者能够在本章的基础上，探索更多的可能性，构建出更强大的 AI 系统。</p>
<p>在下一章中，我们将构建一个与游戏引擎结合的多 Agent 系统——赛博小镇，探索 Agent 之间的复杂交互和协作模式。敬请期待！</p>