<h1>第九章 上下文工程</h1>
<p>在前面的章节中，我们已经为智能体引入了记忆系统与RAG。然而，要让智能体在真实复杂场景中稳定地“思考”与“行动”，仅有记忆与检索还不够——我们需要一套工程化方法，持续、系统地为模型构造恰当的“上下文”。这就是本章的主题：上下文工程（Context Engineering）。它关注的是“在每一次模型调用前，如何以可复用、可度量、可演进的方式，拼装并优化输入上下文”，从而提升正确性、鲁棒性与效率<sup>[1][2]</sup>。</p>
<p>为了让读者能够快速体验本章的完整功能，我们提供了可直接安装的Python包。你可以通过以下命令安装本章对应的版本：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1">pip <span class="token function">install</span> <span class="token string">"hello-agents[all]==0.2.7"</span>
</span></code></pre>
<p>本章主要介绍上下文工程的核心概念与实践，并在HelloAgents框架中新增了上下文构建器和两个配套工具：</p>
<ul>
<li><strong>ContextBuilder</strong> (<code>hello_agents/context/builder.py</code>)：上下文构建器，实现 GSSC (Gather-Select-Structure-Compress) 流水线，提供统一的上下文管理接口</li>
<li><strong>NoteTool</strong> (<code>hello_agents/tools/builtin/note_tool.py</code>)：结构化笔记工具，支持智能体进行持久化记忆管理</li>
<li><strong>TerminalTool</strong> (<code>hello_agents/tools/builtin/terminal_tool.py</code>)：终端工具，支持智能体进行文件系统操作和即时上下文检索</li>
</ul>
<p>这些组件共同构成了完整的上下文工程解决方案，是实现长时程任务管理和智能体式搜索的关键，将在后续章节中详细介绍。</p>
<p>除了安装框架外，还需要在<code>.env</code>配置LLM的API。本章示例主要使用大语言模型进行上下文管理和智能决策。</p>
<p>配置完成后，即可开始本章的学习之旅！</p>
<h2>9.1 什么是上下文工程</h2>
<p>在经历了数年提示工程（Prompt Engineering）成为应用型AI的焦点之后，一个新的术语开始走到台前：<strong>上下文工程（Context Engineering）</strong>。如今，用语言模型构建系统不再只是找对提示词里的句式和措辞，而是要回答一个更宏观的问题：<strong>什么样的上下文配置，最有可能让模型产出我们期望的行为？</strong></p>
<p>所谓“上下文”，是指在对大语言模型（LLM）进行采样时所包含的那组 tokens。手头的工程问题，是在 LLM 的固有约束之下，<strong>优化这些 tokens 的效用</strong>，以便稳定地得到预期结果。想要有效驾驭 LLM，往往需要“在上下文中思考”——也就是说：在任何一次调用时，都要审视 LLM 可见的整体状态，并预判这种状态可能诱发的行为。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/9-figures/9-1.webp" alt="" width="85%">
  <p>图 9.1 Prompt engineering vs Context engineering</p>
</div>
<p>本节将探讨正在兴起的上下文工程，并给出一个用于构建<strong>可调控、有效</strong>智能体的精炼心智模型。</p>
<p><strong>上下文工程 vs. 提示工程</strong></p>
<p>如图9.1所示，在现在前沿模型厂商的视角中，上下文工程是提示工程的自然演进。提示工程关注如何编写与组织 LLM 的指令以获得更优结果（例如系统提示的写法与结构化策略）；而上下文工程则是<strong>在推理阶段，如何策划与维护“最优的信息集合（tokens）”</strong>，其中不仅包含提示本身，还包含其他会进入上下文窗口的一切信息。</p>
<p>在 LLM 工程的早期阶段，提示往往是主要工作，因为大多数用例（除日常聊天外）都需要针对单轮分类或文本生成做精调式的提示优化。顾名思义，提示工程的核心是“如何写出有效提示”，尤其是系统提示。然而，随着我们开始工程化地构建更强的智能体，它们在更长的时间范围内、跨多次推理轮次地工作，我们就需要能管理<strong>整个上下文状态</strong>的策略——其中包括系统指令、工具、MCP（Model Context Protocol）、外部数据、消息历史等。</p>
<p>一个循环运行的智能体，会不断产生下一轮推理可能相关的数据，这些信息必须被<strong>周期性地提炼</strong>。因此，上下文工程的“艺与术”，在于从持续扩张的“候选信息宇宙”中，<strong>甄别哪些内容应当进入有限的上下文窗口</strong>。</p>
<h2>9.2 为什么上下文工程重要</h2>
<p>尽管模型的速度越来越快、可处理的数据规模越来越大，但我们观察到：LLM 和人类一样，在一定点上会“走神”或“混乱”。针堆找针（needle-in-a-haystack）类基准揭示了一个现象：<strong>上下文腐蚀（context rot）</strong>——随着上下文窗口中的 tokens 增加，模型从上下文中准确回忆信息的能力反而下降。</p>
<p>不同模型的退化曲线或许更平滑，但这一特征几乎在所有模型上都会出现。因此，<strong>上下文必须被视作一种有限资源，且具有边际收益递减</strong>。就像人类有有限的工作记忆容量一样，LLM 也有一笔“注意力预算”。每新增一个 token，都会消耗这笔预算的一部分，因此我们更需要谨慎地筛选哪些 tokens 应该被提供给 LLM。</p>
<p>这种稀缺并非偶然，而是源自 LLM 的架构约束。Transformer 让每个 token 能够与上下文中的<strong>所有</strong> token 建立关联，理论上形成 (n^2) 级别的两两注意力关系。随着上下文长度增长，模型对这些两两关系的建模能力会被“拉薄”，从而自然地产生“上下文规模”与“注意力集中度”的张力。此外，模型的注意力模式来源于训练数据分布——短序列通常比长序列更常见，因此模型对“全上下文依赖”的经验更少、专门参数也更少。</p>
<p>诸如位置编码插值（position encoding interpolation）等技术可以让模型在推理时“适配”比训练期更长的序列，但会牺牲部分对 token 位置的精确理解。总体上，这些因素共同形成的是一个<strong>性能梯度</strong>，而非“悬崖式”崩溃：模型在长上下文下依旧强大，但相较短上下文，在信息检索与长程推理上的精度会有所下降。</p>
<p>基于上述现实，<strong>有意识的上下文工程</strong>就成为构建强健智能体的必需品。</p>
<h3>9.2.1 有效上下文的“解剖学”</h3>
<p>在“有限注意力预算”的约束下，优秀的上下文工程目标是：<strong>用尽可能少、但高信号密度的 tokens，最大化获得期望结果的概率</strong>。落实到实践中，我们建议围绕以下组件开展工程化建设：</p>
<ul>
<li>
<p><strong>系统提示（System Prompt）</strong>：语言清晰、直白，信息层级把握在“刚刚好”的高度。常见两极误区：</p>
<ul>
<li>过度硬编码：在提示中写入复杂、脆弱的 if-else 逻辑，长期维护成本高、易碎。</li>
<li>过于空泛：只给出宏观目标与泛化指引，缺少对期望输出的<strong>具体信号</strong>或假定了错误的“共享上下文”。
建议将提示分区组织（如 &lt;background_information&gt;、<instructions>、工具指引、输出描述等），用 XML/Markdown 分隔。无论格式如何，追求的是<strong>能完整勾勒期望行为的“最小必要信息集”</strong>（“最小”并不等于“最短”）。先用最好的模型在最小提示上试跑，再依据失败模式增补清晰的指令与示例。</instructions></li>
</ul>
</li>
<li>
<p><strong>工具（Tools）</strong>：工具定义了智能体与信息/行动空间的契约，必须促进效率：既要返回<strong>token 友好</strong>的信息，又要鼓励高效的智能体行为。工具应当：</p>
<ul>
<li>职责单一、相互低重叠，接口语义清晰；</li>
<li>对错误鲁棒；</li>
<li>入参描述明确、无歧义，充分发挥模型擅长的表达与推理能力。
常见失败模式是“臃肿工具集”：功能边界模糊，导致“选哪个工具”这一决策本身就含混不清。<strong>如果人类工程师都说不准用哪个工具，别指望智能体做得更好</strong>。精心甄别一个“最小可行工具集（MVTS）”往往能显著提升长期交互中的稳定性与可维护性。</li>
</ul>
</li>
<li>
<p><strong>示例（Few-shot）</strong>：始终推荐提供示例，但不建议把“所有边界条件”的罗列一股脑塞进提示。请精挑细选一组<strong>多样且典型</strong>的示例，直接画像“期望行为”。对 LLM 而言，<strong>好的示例胜过千言万语</strong>。</p>
</li>
</ul>
<p>总的指导思想是：<strong>信息充分但紧致</strong>。如图9.2所示，是进入运行时的动态检索。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/9-figures/9-2.webp" alt="" width="85%">
  <p>图 9.2 Calibrating the system prompt</p>
</div>
<h3>9.2.2 上下文检索与智能体式搜索</h3>
<p>一个简洁的定义：<strong>智能体 = 在循环中自主调用工具的 LLM</strong>。随着底层模型能力增强，智能体的自治水平便可提升：更能独立探索复杂问题空间，并从错误中恢复。</p>
<p>工程实践正在从“推理前一次性检索（embedding 检索）”逐步过渡到“<strong>及时（Just-in-time, JIT）上下文</strong>”。后者不再预先加载所有相关数据，而是维护<strong>轻量化引用</strong>（文件路径、存储查询、URL 等），在运行时通过工具动态加载所需数据。这样可让模型撰写针对性查询、缓存必要结果，并用诸如 <code>head</code>/<code>tail</code> 之类的命令分析大体量数据——无需把整块数据一次性塞入上下文。其认知模式更贴近人类：我们不会死记硬背全部信息，而是用文件系统、收件箱、书签等外部索引按需提取。</p>
<p>除了存储效率，<strong>引用的元数据</strong>本身也能帮助精化行为：目录层级、命名约定、时间戳等都在隐含地传达“目的与时效”。例如，<code>tests/test_utils.py</code> 与 <code>src/core/test_utils.py</code> 的语义暗示就不同。</p>
<p>允许智能体自主导航与检索还能实现<strong>渐进式披露（progressive disclosure）</strong>：每一步交互都会产生新的上下文，反过来指导下一步决策——文件大小暗示复杂度、命名暗示用途、时间戳暗示相关性。智能体得以按层构建理解，只在工作记忆中保留“当前必要子集”，并用“记笔记”的方式做补充持久化，从而维持聚焦而非“被大而全拖垮”。</p>
<p>需要权衡的是：运行时探索往往比预计算检索更慢，并且需要有“主见”的工程设计来确保模型拥有正确的工具与启发式。如果缺少引导，智能体可能会误用工具、追逐死胡同或错过关键信息，造成上下文浪费。</p>
<p>在不少场景中，<strong>混合策略</strong>更有效：前置加载少量“高价值”上下文以保证速度，然后允许智能体按需继续自主探索。边界的选择取决于任务动态性与时效要求。在工程上，可以预先放入类似“项目约定说明（如 README/指南）”的文件，同时提供 <code>glob</code>、<code>grep</code> 等原语，让智能体即时检索具体文件，从而绕开过时索引与复杂语法树的沉没成本。</p>
<h3>9.2.3 面向长时程任务的上下文工程</h3>
<p>长时程任务要求智能体在超出上下文窗口的长序列行动中，仍能保持连贯性、上下文一致与目标导向。例如大型代码库迁移、跨数小时的系统性研究。指望无限增大上下文窗口并不能根治“上下文污染”与相关性退化的问题，因此需要直接面向这些约束的工程手段：<strong>压缩整合（Compaction）</strong>、<strong>结构化笔记（Structured note-taking）</strong>与<strong>子代理架构（Sub-agent architectures）</strong>。</p>
<ul>
<li>
<p><strong>压缩整合（Compaction）</strong></p>
<ul>
<li>定义：当对话接近上下文上限时，对其进行高保真总结，并用该摘要重启一个新的上下文窗口，以维持长程连贯性。</li>
<li>实践：让模型压缩并保留架构性决策、未解决缺陷、实现细节，丢弃重复的工具输出与噪声；新窗口携带压缩摘要 + 最近少量高相关工件（如“最近访问的若干文件”）。</li>
<li>调参建议：先优化<strong>召回</strong>（确保不遗漏关键信息），再优化<strong>精确度</strong>（剔除冗余内容）；一种安全的“轻触式”压缩是对“深历史中的工具调用与结果”进行清理。</li>
</ul>
</li>
<li>
<p><strong>结构化笔记（Structured note-taking）</strong></p>
<ul>
<li>定义：也称“智能体记忆”。智能体以固定频率将关键信息写入<strong>上下文外的持久化存储</strong>，在后续阶段按需拉回。</li>
<li>价值：以极低的上下文开销维持持久状态与依赖关系。例如维护 TODO 列表、项目 NOTES.md、关键结论/依赖/阻塞项的索引，跨数十次工具调用与多轮上下文重置仍能保持进度与一致性。</li>
<li>说明：在非编码场景中同样有效（如长期策略性任务、游戏/仿真中的目标管理与统计计数）。结合第八章的 <code>MemoryTool</code>，可轻松实现文件式/向量式的外部记忆并在运行时检索。</li>
</ul>
</li>
<li>
<p><strong>子代理架构（Sub-agent architectures）</strong></p>
<ul>
<li>思想：由主代理负责高层规划与综合，多个专长子代理在“干净的上下文窗口”中各自深挖、调用工具并探索，最后仅回传<strong>凝练摘要</strong>（常见 1,000–2,000 tokens）。</li>
<li>好处：实现关注点分离。庞杂的搜索上下文留在子代理内部，主代理专注于整合与推理；适合需要并行探索的复杂研究/分析任务。</li>
<li>经验：公开的多智能体研究系统显示，该模式在复杂研究任务上相较单代理基线具有显著优势。</li>
</ul>
</li>
</ul>
<p>方法取舍可以遵循以下经验法则：</p>
<ul>
<li><strong>压缩整合</strong>：适合需要长对话连续性的任务，强调上下文的“接力”。</li>
<li><strong>结构化笔记</strong>：适合有里程碑/阶段性成果的迭代式开发与研究。</li>
<li><strong>子代理架构</strong>：适合复杂研究与分析，能从并行探索中获益。</li>
</ul>
<p>即便模型能力持续提升，“在长交互中维持连贯性与聚焦”仍是构建强健智能体的核心挑战。谨慎而系统的上下文工程将长期保持其关键价值。</p>
<h2>9.3 在 Hello-Agents 中的实践：ContextBuilder</h2>
<p>本节将详细介绍 HelloAgents 框架中的上下文工程实践。我们将从设计动机、核心数据结构、实现细节到完整案例，逐步展示如何构建一个生产级的上下文管理系统。ContextBuilder 的设计理念是"简单高效"，去除不必要的复杂性，统一以"相关性+新近性"的分数进行选择，符合 Agent 模块化与可维护性的工程取向。</p>
<h3>9.3.1 设计动机与目标</h3>
<p>在构建 ContextBuilder 之前，我们首先需要明确其设计目标和核心价值。一个优秀的上下文管理系统应该解决以下几个关键问题：</p>
<ol>
<li>
<p><strong>统一入口</strong>：将"获取(Gather)- 选择(Select)- 结构化(Structure)- 压缩(Compress)"抽象为可复用流水线，减少在 Agent 实现中的重复模板代码。这种统一的接口设计让开发者无需在每个 Agent 中重复编写上下文管理逻辑。</p>
</li>
<li>
<p><strong>稳定形态</strong>：输出固定骨架的上下文模板，便于调试、A/B 测试与评估。我们采用了分区组织的模板结构：</p>
<ul>
<li><code>[Role &amp; Policies]</code>：明确 Agent 的角色定位和行为准则</li>
<li><code>[Task]</code>：当前需要完成的具体任务</li>
<li><code>[State]</code>：Agent 的当前状态和上下文信息</li>
<li><code>[Evidence]</code>：从外部知识库检索的证据信息</li>
<li><code>[Context]</code>：历史对话和相关记忆</li>
<li><code>[Output]</code>：期望的输出格式和要求</li>
</ul>
</li>
<li>
<p><strong>预算守护</strong>：在 token 预算内尽量保留高价值信息，对超限上下文提供兜底压缩策略。这确保了即使在信息量巨大的场景下，系统也能稳定运行。</p>
</li>
<li>
<p><strong>最小规则</strong>：不引入来源/优先级等分类维度，避免复杂度增长。实践表明，基于相关性和新近性的简单评分机制，在大多数场景下已经足够有效。</p>
</li>
</ol>
<h3>9.3.2 核心数据结构</h3>
<p>ContextBuilder 的实现依赖两个核心数据结构，它们定义了系统的配置和信息单元。</p>
<p>（1）ContextPacket：候选信息包</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Any
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token decorator annotation punctuation">@dataclass</span>
</span><span class="code-line line-number" line="6"><span class="token keyword">class</span> <span class="token class-name">ContextPacket</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">    <span class="token triple-quoted-string string">"""候选信息包
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    Attributes:
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">        content: 信息内容
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        timestamp: 时间戳
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        token_count: Token 数量
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">        relevance_score: 相关性分数(0.0-1.0)
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">        metadata: 可选的元数据
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="16">    content<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="17">    timestamp<span class="token punctuation">:</span> datetime
</span><span class="code-line line-number" line="18">    token_count<span class="token punctuation">:</span> <span class="token builtin">int</span>
</span><span class="code-line line-number" line="19">    relevance_score<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.5</span>
</span><span class="code-line line-number" line="20">    metadata<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token keyword">def</span> <span class="token function">__post_init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">        <span class="token triple-quoted-string string">"""初始化后处理"""</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>metadata <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="25">            self<span class="token punctuation">.</span>metadata <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="26">        <span class="token comment"># 确保相关性分数在有效范围内</span>
</span><span class="code-line line-number" line="27">        self<span class="token punctuation">.</span>relevance_score <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>relevance_score<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p><code>ContextPacket</code> 是系统中信息的基本单元。每个候选信息都会被封装为一个 ContextPacket，包含内容、时间戳、token 数量和相关性分数等核心属性。这种统一的数据结构简化了后续的选择和排序逻辑。</p>
<p>（2）ContextConfig：配置管理</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token decorator annotation punctuation">@dataclass</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">class</span> <span class="token class-name">ContextConfig</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">    <span class="token triple-quoted-string string">"""上下文构建配置
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    Attributes:
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">        max_tokens: 最大 token 数量
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">        reserve_ratio: 为系统指令预留的比例(0.0-1.0)
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">        min_relevance: 最低相关性阈值
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">        enable_compression: 是否启用压缩
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">        recency_weight: 新近性权重(0.0-1.0)
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        relevance_weight: 相关性权重(0.0-1.0)
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="13">    max_tokens<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3000</span>
</span><span class="code-line line-number" line="14">    reserve_ratio<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.2</span>
</span><span class="code-line line-number" line="15">    min_relevance<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span>
</span><span class="code-line line-number" line="16">    enable_compression<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</span><span class="code-line line-number" line="17">    recency_weight<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.3</span>
</span><span class="code-line line-number" line="18">    relevance_weight<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.7</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">    <span class="token keyword">def</span> <span class="token function">__post_init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">        <span class="token triple-quoted-string string">"""验证配置参数"""</span>
</span><span class="code-line line-number" line="22">        <span class="token keyword">assert</span> <span class="token number">0.0</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>reserve_ratio <span class="token operator">&lt;=</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token string">"reserve_ratio 必须在 [0, 1] 范围内"</span>
</span><span class="code-line line-number" line="23">        <span class="token keyword">assert</span> <span class="token number">0.0</span> <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>min_relevance <span class="token operator">&lt;=</span> <span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token string">"min_relevance 必须在 [0, 1] 范围内"</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">assert</span> <span class="token builtin">abs</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>recency_weight <span class="token operator">+</span> self<span class="token punctuation">.</span>relevance_weight <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1e-6</span><span class="token punctuation">,</span> \
</span><span class="code-line line-number" line="25">            <span class="token string">"recency_weight + relevance_weight 必须等于 1.0"</span>
</span></code></pre>
<p><code>ContextConfig</code> 封装了所有可配置的参数，使得系统行为可以灵活调整。特别值得注意的是 <code>reserve_ratio</code> 参数，它确保系统指令等关键信息始终有足够的空间，不会被其他信息挤占。</p>
<h3>9.3.3 GSSC 流水线详解</h3>
<p>ContextBuilder 的核心是 GSSC(Gather-Select-Structure-Compress)流水线，它将上下文构建过程分解为四个清晰的阶段。让我们深入了解每个阶段的实现细节。</p>
<p>（1）Gather：多源信息汇集</p>
<p>第一阶段是从多个来源汇集候选信息。这个阶段的关键在于容错性和灵活性。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_gather</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    user_query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    conversation_history<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Message<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    system_instructions<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    custom_packets<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token triple-quoted-string string">"""汇集所有候选信息
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        user_query: 用户查询
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        conversation_history: 对话历史
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">        system_instructions: 系统指令
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">        custom_packets: 自定义信息包
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">        List[ContextPacket]: 候选信息列表
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="19">    packets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">    <span class="token comment"># 1. 添加系统指令(最高优先级,不参与评分)</span>
</span><span class="code-line line-number" line="22">    <span class="token keyword">if</span> system_instructions<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">        packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="24">            content<span class="token operator">=</span>system_instructions<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">            timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">            token_count<span class="token operator">=</span>self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>system_instructions<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="27">            relevance_score<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>  <span class="token comment"># 系统指令始终保留</span>
</span><span class="code-line line-number" line="28">            metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"system_instruction"</span><span class="token punctuation">,</span> <span class="token string">"priority"</span><span class="token punctuation">:</span> <span class="token string">"high"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="29">        <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">    <span class="token comment"># 2. 从记忆系统检索相关记忆</span>
</span><span class="code-line line-number" line="32">    <span class="token keyword">if</span> self<span class="token punctuation">.</span>memory_tool<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="34">            memory_results <span class="token operator">=</span> self<span class="token punctuation">.</span>memory_tool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="35">                <span class="token string">"search"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">                query<span class="token operator">=</span>user_query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">                limit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="38">                min_importance<span class="token operator">=</span><span class="token number">0.3</span>
</span><span class="code-line line-number" line="39">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">            <span class="token comment"># 解析记忆结果并转换为 ContextPacket</span>
</span><span class="code-line line-number" line="41">            memory_packets <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_memory_results<span class="token punctuation">(</span>memory_results<span class="token punctuation">,</span> user_query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">            packets<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>memory_packets<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="44">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 记忆检索失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="45">
</span><span class="code-line line-number" line="46">    <span class="token comment"># 3. 从 RAG 系统检索相关知识</span>
</span><span class="code-line line-number" line="47">    <span class="token keyword">if</span> self<span class="token punctuation">.</span>rag_tool<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="48">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="49">            rag_results <span class="token operator">=</span> self<span class="token punctuation">.</span>rag_tool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="50">                <span class="token string">"search"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="51">                query<span class="token operator">=</span>user_query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="52">                limit<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="53">                min_score<span class="token operator">=</span><span class="token number">0.3</span>
</span><span class="code-line line-number" line="54">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="55">            <span class="token comment"># 解析 RAG 结果并转换为 ContextPacket</span>
</span><span class="code-line line-number" line="56">            rag_packets <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_rag_results<span class="token punctuation">(</span>rag_results<span class="token punctuation">,</span> user_query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">            packets<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>rag_packets<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="58">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="59">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] RAG 检索失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="60">
</span><span class="code-line line-number" line="61">    <span class="token comment"># 4. 添加对话历史(仅保留最近的 N 条)</span>
</span><span class="code-line line-number" line="62">    <span class="token keyword">if</span> conversation_history<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="63">        recent_history <span class="token operator">=</span> conversation_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 默认保留最近 5 条</span>
</span><span class="code-line line-number" line="64">        <span class="token keyword">for</span> msg <span class="token keyword">in</span> recent_history<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="65">            packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="66">                content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">.</span>role<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="67">                timestamp<span class="token operator">=</span>msg<span class="token punctuation">.</span>timestamp <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">)</span> <span class="token keyword">else</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="68">                token_count<span class="token operator">=</span>self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>msg<span class="token punctuation">.</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="69">                relevance_score<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span>  <span class="token comment"># 历史消息的基础相关性</span>
</span><span class="code-line line-number" line="70">                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"conversation_history"</span><span class="token punctuation">,</span> <span class="token string">"role"</span><span class="token punctuation">:</span> msg<span class="token punctuation">.</span>role<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="71">            <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="72">
</span><span class="code-line line-number" line="73">    <span class="token comment"># 5. 添加自定义信息包</span>
</span><span class="code-line line-number" line="74">    <span class="token keyword">if</span> custom_packets<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="75">        packets<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>custom_packets<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="76">
</span><span class="code-line line-number" line="77">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ContextBuilder] 汇集了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>packets<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个候选信息包"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="78">    <span class="token keyword">return</span> packets
</span></code></pre>
<p>这个实现展示了几个重要的设计考虑：</p>
<ul>
<li><strong>容错机制</strong>：每个外部数据源的调用都被 try-except 包裹，确保单个源的失败不会影响整体流程</li>
<li><strong>优先级处理</strong>：系统指令被标记为高优先级，确保始终被保留</li>
<li><strong>历史限制</strong>：对话历史只保留最近的几条，避免上下文窗口被历史信息占据</li>
</ul>
<p>（2）Select：智能信息选择</p>
<p>第二阶段是根据相关性和新近性对候选信息进行评分和选择。这是整个流水线的核心，直接决定了最终上下文的质量。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_select</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    packets<span class="token punctuation">:</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    user_query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    available_tokens<span class="token punctuation">:</span> <span class="token builtin">int</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">    <span class="token triple-quoted-string string">"""选择最相关的信息包
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">        packets: 候选信息包列表
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        user_query: 用户查询(用于计算相关性)
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        available_tokens: 可用的 token 数量
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">        List[ContextPacket]: 选中的信息包列表
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="17">    <span class="token comment"># 1. 分离系统指令和其他信息</span>
</span><span class="code-line line-number" line="18">    system_packets <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> p <span class="token keyword">in</span> packets <span class="token keyword">if</span> p<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"system_instruction"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="19">    other_packets <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token keyword">for</span> p <span class="token keyword">in</span> packets <span class="token keyword">if</span> p<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">"system_instruction"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">    <span class="token comment"># 2. 计算系统指令占用的 token</span>
</span><span class="code-line line-number" line="22">    system_tokens <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>token_count <span class="token keyword">for</span> p <span class="token keyword">in</span> system_packets<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    remaining_tokens <span class="token operator">=</span> available_tokens <span class="token operator">-</span> system_tokens
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">    <span class="token keyword">if</span> remaining_tokens <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"[WARNING] 系统指令已占满所有 token 预算"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">        <span class="token keyword">return</span> system_packets
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">    <span class="token comment"># 3. 为其他信息计算综合分数</span>
</span><span class="code-line line-number" line="30">    scored_packets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">    <span class="token keyword">for</span> packet <span class="token keyword">in</span> other_packets<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">        <span class="token comment"># 计算相关性分数(如果尚未计算)</span>
</span><span class="code-line line-number" line="33">        <span class="token keyword">if</span> packet<span class="token punctuation">.</span>relevance_score <span class="token operator">==</span> <span class="token number">0.5</span><span class="token punctuation">:</span>  <span class="token comment"># 默认值,需要重新计算</span>
</span><span class="code-line line-number" line="34">            relevance <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_relevance<span class="token punctuation">(</span>packet<span class="token punctuation">.</span>content<span class="token punctuation">,</span> user_query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">            packet<span class="token punctuation">.</span>relevance_score <span class="token operator">=</span> relevance
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">        <span class="token comment"># 计算新近性分数</span>
</span><span class="code-line line-number" line="38">        recency <span class="token operator">=</span> self<span class="token punctuation">.</span>_calculate_recency<span class="token punctuation">(</span>packet<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">        <span class="token comment"># 综合分数 = 相关性权重 × 相关性 + 新近性权重 × 新近性</span>
</span><span class="code-line line-number" line="41">        combined_score <span class="token operator">=</span> <span class="token punctuation">(</span>
</span><span class="code-line line-number" line="42">            self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>relevance_weight <span class="token operator">*</span> packet<span class="token punctuation">.</span>relevance_score <span class="token operator">+</span>
</span><span class="code-line line-number" line="43">            self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>recency_weight <span class="token operator">*</span> recency
</span><span class="code-line line-number" line="44">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="45">
</span><span class="code-line line-number" line="46">        <span class="token comment"># 过滤低于最小相关性阈值的信息</span>
</span><span class="code-line line-number" line="47">        <span class="token keyword">if</span> packet<span class="token punctuation">.</span>relevance_score <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>min_relevance<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="48">            scored_packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>combined_score<span class="token punctuation">,</span> packet<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">    <span class="token comment"># 4. 按分数降序排序</span>
</span><span class="code-line line-number" line="51">    scored_packets<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="52">
</span><span class="code-line line-number" line="53">    <span class="token comment"># 5. 贪心选择:按分数从高到低填充,直到达到 token 上限</span>
</span><span class="code-line line-number" line="54">    selected <span class="token operator">=</span> system_packets<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="55">    current_tokens <span class="token operator">=</span> system_tokens
</span><span class="code-line line-number" line="56">
</span><span class="code-line line-number" line="57">    <span class="token keyword">for</span> score<span class="token punctuation">,</span> packet <span class="token keyword">in</span> scored_packets<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="58">        <span class="token keyword">if</span> current_tokens <span class="token operator">+</span> packet<span class="token punctuation">.</span>token_count <span class="token operator">&lt;=</span> available_tokens<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="59">            selected<span class="token punctuation">.</span>append<span class="token punctuation">(</span>packet<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="60">            current_tokens <span class="token operator">+=</span> packet<span class="token punctuation">.</span>token_count
</span><span class="code-line line-number" line="61">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="62">            <span class="token comment"># Token 预算已满,停止选择</span>
</span><span class="code-line line-number" line="63">            <span class="token keyword">break</span>
</span><span class="code-line line-number" line="64">
</span><span class="code-line line-number" line="65">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ContextBuilder] 选择了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>selected<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个信息包,共 </span><span class="token interpolation"><span class="token punctuation">{</span>current_tokens<span class="token punctuation">}</span></span><span class="token string"> tokens"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="66">    <span class="token keyword">return</span> selected
</span><span class="code-line line-number" line="67">
</span><span class="code-line line-number" line="68"><span class="token keyword">def</span> <span class="token function">_calculate_relevance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="69">    <span class="token triple-quoted-string string">"""计算内容与查询的相关性
</span></span><span class="code-line line-number" line="70"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="71"><span class="token triple-quoted-string string">    使用简单的关键词重叠算法。在生产环境中,可以替换为向量相似度计算。
</span></span><span class="code-line line-number" line="72"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="73"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="74"><span class="token triple-quoted-string string">        content: 内容文本
</span></span><span class="code-line line-number" line="75"><span class="token triple-quoted-string string">        query: 查询文本
</span></span><span class="code-line line-number" line="76"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="77"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="78"><span class="token triple-quoted-string string">        float: 相关性分数(0.0-1.0)
</span></span><span class="code-line line-number" line="79"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="80">    <span class="token comment"># 分词(简单实现,可以使用更复杂的分词器)</span>
</span><span class="code-line line-number" line="81">    content_words <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>content<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="82">    query_words <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="83">
</span><span class="code-line line-number" line="84">    <span class="token keyword">if</span> <span class="token keyword">not</span> query_words<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="85">        <span class="token keyword">return</span> <span class="token number">0.0</span>
</span><span class="code-line line-number" line="86">
</span><span class="code-line line-number" line="87">    <span class="token comment"># Jaccard 相似度</span>
</span><span class="code-line line-number" line="88">    intersection <span class="token operator">=</span> content_words <span class="token operator">&amp;</span> query_words
</span><span class="code-line line-number" line="89">    union <span class="token operator">=</span> content_words <span class="token operator">|</span> query_words
</span><span class="code-line line-number" line="90">
</span><span class="code-line line-number" line="91">    <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>intersection<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>union<span class="token punctuation">)</span> <span class="token keyword">if</span> union <span class="token keyword">else</span> <span class="token number">0.0</span>
</span><span class="code-line line-number" line="92">
</span><span class="code-line line-number" line="93"><span class="token keyword">def</span> <span class="token function">_calculate_recency</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> timestamp<span class="token punctuation">:</span> datetime<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="94">    <span class="token triple-quoted-string string">"""计算时间近因性分数
</span></span><span class="code-line line-number" line="95"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="96"><span class="token triple-quoted-string string">    使用指数衰减模型,24小时内保持高分,之后逐渐衰减。
</span></span><span class="code-line line-number" line="97"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="98"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="99"><span class="token triple-quoted-string string">        timestamp: 信息的时间戳
</span></span><span class="code-line line-number" line="100"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="101"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="102"><span class="token triple-quoted-string string">        float: 新近性分数(0.0-1.0)
</span></span><span class="code-line line-number" line="103"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="104">    <span class="token keyword">import</span> math
</span><span class="code-line line-number" line="105">
</span><span class="code-line line-number" line="106">    age_hours <span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3600</span>
</span><span class="code-line line-number" line="107">
</span><span class="code-line line-number" line="108">    <span class="token comment"># 指数衰减:24小时内保持高分,之后逐渐衰减</span>
</span><span class="code-line line-number" line="109">    decay_factor <span class="token operator">=</span> <span class="token number">0.1</span>  <span class="token comment"># 衰减系数</span>
</span><span class="code-line line-number" line="110">    recency_score <span class="token operator">=</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>decay_factor <span class="token operator">*</span> age_hours <span class="token operator">/</span> <span class="token number">24</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="111">
</span><span class="code-line line-number" line="112">    <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">1.0</span><span class="token punctuation">,</span> recency_score<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 限制在 [0.1, 1.0] 范围内</span>
</span></code></pre>
<p>选择阶段的核心算法体现了几个重要的工程考量：</p>
<ul>
<li><strong>评分机制</strong>：采用相关性和新近性的加权组合，权重可配置</li>
<li><strong>贪心算法</strong>：按分数从高到低填充，确保在有限预算内选择最有价值的信息</li>
<li><strong>过滤机制</strong>：通过 <code>min_relevance</code> 参数过滤低质量信息</li>
</ul>
<p>（3）Structure：结构化输出</p>
<p>第三阶段是将选中的信息组织成结构化的上下文模板。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_structure</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> selected_packets<span class="token punctuation">:</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">,</span> user_query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""将选中的信息包组织成结构化的上下文模板
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">        selected_packets: 选中的信息包列表
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">        user_query: 用户查询
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">        str: 结构化的上下文字符串
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="11">    <span class="token comment"># 按类型分组</span>
</span><span class="code-line line-number" line="12">    system_instructions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="13">    evidence <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="14">    context <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16">    <span class="token keyword">for</span> packet <span class="token keyword">in</span> selected_packets<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">        packet_type <span class="token operator">=</span> packet<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"general"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">        <span class="token keyword">if</span> packet_type <span class="token operator">==</span> <span class="token string">"system_instruction"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">            system_instructions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>packet<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">elif</span> packet_type <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"rag_result"</span><span class="token punctuation">,</span> <span class="token string">"knowledge"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">            evidence<span class="token punctuation">.</span>append<span class="token punctuation">(</span>packet<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">            context<span class="token punctuation">.</span>append<span class="token punctuation">(</span>packet<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    <span class="token comment"># 构建结构化模板</span>
</span><span class="code-line line-number" line="27">    sections <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">    <span class="token comment"># [Role &amp; Policies]</span>
</span><span class="code-line line-number" line="30">    <span class="token keyword">if</span> system_instructions<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">        sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"[Role &amp; Policies]\n"</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>system_instructions<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">    <span class="token comment"># [Task]</span>
</span><span class="code-line line-number" line="34">    sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[Task]\n</span><span class="token interpolation"><span class="token punctuation">{</span>user_query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">
</span><span class="code-line line-number" line="36">    <span class="token comment"># [Evidence]</span>
</span><span class="code-line line-number" line="37">    <span class="token keyword">if</span> evidence<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="38">        sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"[Evidence]\n"</span> <span class="token operator">+</span> <span class="token string">"\n---\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>evidence<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">    <span class="token comment"># [Context]</span>
</span><span class="code-line line-number" line="41">    <span class="token keyword">if</span> context<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="42">        sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"[Context]\n"</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">    <span class="token comment"># [Output]</span>
</span><span class="code-line line-number" line="45">    sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">"[Output]\n请基于以上信息,提供准确、有据的回答。"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">
</span><span class="code-line line-number" line="47">    <span class="token keyword">return</span> <span class="token string">"\n\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>sections<span class="token punctuation">)</span>
</span></code></pre>
<p>结构化阶段将散乱的信息包组织成清晰的分区，这种设计有几个优势：</p>
<ul>
<li><strong>可读性</strong>：清晰的分区让人类和模型都更容易理解上下文结构</li>
<li><strong>可调试性</strong>：问题定位更容易，可以快速识别哪个区域的信息有问题</li>
<li><strong>可扩展性</strong>：添加新的信息源只需要创建新的分区</li>
</ul>
<p>（4）Compress：兜底压缩</p>
<p>第四阶段是对超限上下文进行压缩处理。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_compress</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> max_tokens<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""压缩超限的上下文
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">        context: 原始上下文
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">        max_tokens: 最大 token 限制
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">        str: 压缩后的上下文
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="11">    current_tokens <span class="token operator">=</span> self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">    <span class="token keyword">if</span> current_tokens <span class="token operator">&lt;=</span> max_tokens<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">        <span class="token keyword">return</span> context  <span class="token comment"># 无需压缩</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ContextBuilder] 上下文超限(</span><span class="token interpolation"><span class="token punctuation">{</span>current_tokens<span class="token punctuation">}</span></span><span class="token string"> &gt; </span><span class="token interpolation"><span class="token punctuation">{</span>max_tokens<span class="token punctuation">}</span></span><span class="token string">),执行压缩"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">    <span class="token comment"># 分区压缩:保持结构完整性</span>
</span><span class="code-line line-number" line="19">    sections <span class="token operator">=</span> context<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"\n\n"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">    compressed_sections <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="21">    current_total <span class="token operator">=</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">    <span class="token keyword">for</span> section <span class="token keyword">in</span> sections<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        section_tokens <span class="token operator">=</span> self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>section<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">        <span class="token keyword">if</span> current_total <span class="token operator">+</span> section_tokens <span class="token operator">&lt;=</span> max_tokens<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="27">            <span class="token comment"># 完整保留</span>
</span><span class="code-line line-number" line="28">            compressed_sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span>section<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">            current_total <span class="token operator">+=</span> section_tokens
</span><span class="code-line line-number" line="30">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">            <span class="token comment"># 部分保留</span>
</span><span class="code-line line-number" line="32">            remaining_tokens <span class="token operator">=</span> max_tokens <span class="token operator">-</span> current_total
</span><span class="code-line line-number" line="33">            <span class="token keyword">if</span> remaining_tokens <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">:</span>  <span class="token comment"># 至少保留 50 tokens</span>
</span><span class="code-line line-number" line="34">                <span class="token comment"># 简单截断(生产环境中可以使用 LLM 摘要)</span>
</span><span class="code-line line-number" line="35">                truncated <span class="token operator">=</span> self<span class="token punctuation">.</span>_truncate_text<span class="token punctuation">(</span>section<span class="token punctuation">,</span> remaining_tokens<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36">                compressed_sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span>truncated <span class="token operator">+</span> <span class="token string">"\n[... 内容已压缩 ...]"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">            <span class="token keyword">break</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">    compressed_context <span class="token operator">=</span> <span class="token string">"\n\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>compressed_sections<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">    final_tokens <span class="token operator">=</span> self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>compressed_context<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[ContextBuilder] 压缩完成: </span><span class="token interpolation"><span class="token punctuation">{</span>current_tokens<span class="token punctuation">}</span></span><span class="token string"> -&gt; </span><span class="token interpolation"><span class="token punctuation">{</span>final_tokens<span class="token punctuation">}</span></span><span class="token string"> tokens"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43">    <span class="token keyword">return</span> compressed_context
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45"><span class="token keyword">def</span> <span class="token function">_truncate_text</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> max_tokens<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="46">    <span class="token triple-quoted-string string">"""截断文本到指定 token 数量
</span></span><span class="code-line line-number" line="47"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="48"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="49"><span class="token triple-quoted-string string">        text: 原始文本
</span></span><span class="code-line line-number" line="50"><span class="token triple-quoted-string string">        max_tokens: 最大 token 数量
</span></span><span class="code-line line-number" line="51"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="52"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="53"><span class="token triple-quoted-string string">        str: 截断后的文本
</span></span><span class="code-line line-number" line="54"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="55">    <span class="token comment"># 简单实现:按字符比例估算</span>
</span><span class="code-line line-number" line="56">    <span class="token comment"># 生产环境中应该使用精确的 tokenizer</span>
</span><span class="code-line line-number" line="57">    char_per_token <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">else</span> <span class="token number">4</span>
</span><span class="code-line line-number" line="58">    max_chars <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>max_tokens <span class="token operator">*</span> char_per_token<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="59">
</span><span class="code-line line-number" line="60">    <span class="token keyword">return</span> text<span class="token punctuation">[</span><span class="token punctuation">:</span>max_chars<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="61">
</span><span class="code-line line-number" line="62"><span class="token keyword">def</span> <span class="token function">_count_tokens</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="63">    <span class="token triple-quoted-string string">"""估算文本的 token 数量
</span></span><span class="code-line line-number" line="64"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="65"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="66"><span class="token triple-quoted-string string">        text: 文本内容
</span></span><span class="code-line line-number" line="67"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="68"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="69"><span class="token triple-quoted-string string">        int: token 数量
</span></span><span class="code-line line-number" line="70"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="71">    <span class="token comment"># 简单估算:中文 1 字符 ≈ 1 token,英文 1 单词 ≈ 1.3 tokens</span>
</span><span class="code-line line-number" line="72">    <span class="token comment"># 生产环境中应该使用实际的 tokenizer</span>
</span><span class="code-line line-number" line="73">    chinese_chars <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword">for</span> ch <span class="token keyword">in</span> text <span class="token keyword">if</span> <span class="token string">'\u4e00'</span> <span class="token operator">&lt;=</span> ch <span class="token operator">&lt;=</span> <span class="token string">'\u9fff'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="74">    english_words <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token punctuation">[</span>w <span class="token keyword">for</span> w <span class="token keyword">in</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> w<span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="75">
</span><span class="code-line line-number" line="76">    <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>chinese_chars <span class="token operator">+</span> english_words <span class="token operator">*</span> <span class="token number">1.3</span><span class="token punctuation">)</span>
</span></code></pre>
<p>压缩阶段的设计体现了"保持结构完整性"的原则，即使在 token 预算紧张的情况下，也要尽量保留每个分区的关键信息。</p>
<h3>9.3.4 完整使用示例</h3>
<p>现在让我们通过一个完整的示例，展示如何在实际项目中使用 ContextBuilder。</p>
<p>（1）基础使用</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>context <span class="token keyword">import</span> ContextBuilder<span class="token punctuation">,</span> ContextConfig
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MemoryTool<span class="token punctuation">,</span> RAGTool
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>core<span class="token punctuation">.</span>message <span class="token keyword">import</span> Message
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 1. 初始化工具</span>
</span><span class="code-line line-number" line="7">memory_tool <span class="token operator">=</span> MemoryTool<span class="token punctuation">(</span>user_id<span class="token operator">=</span><span class="token string">"user123"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">rag_tool <span class="token operator">=</span> RAGTool<span class="token punctuation">(</span>knowledge_base_path<span class="token operator">=</span><span class="token string">"./knowledge_base"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 2. 创建 ContextBuilder</span>
</span><span class="code-line line-number" line="11">config <span class="token operator">=</span> ContextConfig<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="12">    max_tokens<span class="token operator">=</span><span class="token number">3000</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    reserve_ratio<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    min_relevance<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">    enable_compression<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="16"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">builder <span class="token operator">=</span> ContextBuilder<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">    memory_tool<span class="token operator">=</span>memory_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">    rag_tool<span class="token operator">=</span>rag_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">    config<span class="token operator">=</span>config
</span><span class="code-line line-number" line="22"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24"><span class="token comment"># 3. 准备对话历史</span>
</span><span class="code-line line-number" line="25">conversation_history <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="26">    Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"我正在开发一个数据分析工具"</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="27">    Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"很好!数据分析工具通常需要处理大量数据。您计划使用什么技术栈?"</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"assistant"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="28">    Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"我打算使用Python和Pandas,已经完成了CSV读取模块"</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">    Message<span class="token punctuation">(</span>content<span class="token operator">=</span><span class="token string">"不错的选择!Pandas在数据处理方面非常强大。接下来您可能需要考虑数据清洗和转换。"</span><span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"assistant"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30"><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32"><span class="token comment"># 4. 添加一些记忆</span>
</span><span class="code-line line-number" line="33">memory_tool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="34">    <span class="token string">"add"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="35">    content<span class="token operator">=</span><span class="token string">"用户正在开发数据分析工具,使用Python和Pandas"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">    memory_type<span class="token operator">=</span><span class="token string">"semantic"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">    importance<span class="token operator">=</span><span class="token number">0.8</span>
</span><span class="code-line line-number" line="38"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">memory_tool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="41">    <span class="token string">"add"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="42">    content<span class="token operator">=</span><span class="token string">"已完成CSV读取模块的开发"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="43">    memory_type<span class="token operator">=</span><span class="token string">"episodic"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="44">    importance<span class="token operator">=</span><span class="token number">0.7</span>
</span><span class="code-line line-number" line="45"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">
</span><span class="code-line line-number" line="47"><span class="token comment"># 5. 构建上下文</span>
</span><span class="code-line line-number" line="48">context <span class="token operator">=</span> builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="49">    user_query<span class="token operator">=</span><span class="token string">"如何优化Pandas的内存占用?"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="50">    conversation_history<span class="token operator">=</span>conversation_history<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="51">    system_instructions<span class="token operator">=</span><span class="token string">"你是一位资深的Python数据工程顾问。你的回答需要:1) 提供具体可行的建议 2) 解释技术原理 3) 给出代码示例"</span>
</span><span class="code-line line-number" line="52"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="53">
</span><span class="code-line line-number" line="54"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="55"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"构建的上下文:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="56"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57"><span class="token keyword">print</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="58"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">80</span><span class="token punctuation">)</span>
</span></code></pre>
<p>（2）运行效果展示</p>
<p>运行上述代码后，您将看到如下结构化的上下文输出：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">================================================================================
</span><span class="code-line line-number" line="2">构建的上下文:
</span><span class="code-line line-number" line="3">================================================================================
</span><span class="code-line line-number" line="4">[Role &amp; Policies]
</span><span class="code-line line-number" line="5">你是一位资深的Python数据工程顾问。你的回答需要:1) 提供具体可行的建议 2) 解释技术原理 3) 给出代码示例
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">[Task]
</span><span class="code-line line-number" line="8">如何优化Pandas的内存占用?
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">[Evidence]
</span><span class="code-line line-number" line="11">Pandas内存优化的核心策略包括:
</span><span class="code-line line-number" line="12">1. 使用合适的数据类型(如category代替object)
</span><span class="code-line line-number" line="13">2. 分块读取大文件
</span><span class="code-line line-number" line="14">3. 使用 chunksize 参数
</span><span class="code-line line-number" line="15">---
</span><span class="code-line line-number" line="16">数据类型优化可以显著减少内存占用。例如,将int64降级为int32可以节省50%的内存。
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">[Context]
</span><span class="code-line line-number" line="19">user: 我正在开发一个数据分析工具
</span><span class="code-line line-number" line="20">assistant: 很好!数据分析工具通常需要处理大量数据。您计划使用什么技术栈?
</span><span class="code-line line-number" line="21">user: 我打算使用Python和Pandas,已经完成了CSV读取模块
</span><span class="code-line line-number" line="22">assistant: 不错的选择!Pandas在数据处理方面非常强大。接下来您可能需要考虑数据清洗和转换。
</span><span class="code-line line-number" line="23">记忆: 用户正在开发数据分析工具,使用Python和Pandas
</span><span class="code-line line-number" line="24">记忆: 已完成CSV读取模块的开发
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">[Output]
</span><span class="code-line line-number" line="27">请基于以上信息,提供准确、有据的回答。
</span><span class="code-line line-number" line="28">================================================================================
</span></code></pre>
<p>这个结构化的上下文包含了所有必要的信息：</p>
<ul>
<li><strong>[Role &amp; Policies]</strong>：明确了 AI 的角色和回答要求</li>
<li><strong>[Task]</strong>：清晰地表达了用户的问题</li>
<li><strong>[Evidence]</strong>：从 RAG 系统检索的相关知识</li>
<li><strong>[Context]</strong>：对话历史和相关记忆，提供了充分的背景信息</li>
<li><strong>[Output]</strong>：指导 LLM 如何组织回答</li>
</ul>
<p>（3）与 Agent 集成</p>
<p>最后，让我们展示如何将 ContextBuilder 集成到 Agent 中：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM<span class="token punctuation">,</span> ToolRegistry
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>context <span class="token keyword">import</span> ContextBuilder<span class="token punctuation">,</span> ContextConfig
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MemoryTool<span class="token punctuation">,</span> RAGTool
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">class</span> <span class="token class-name">ContextAwareAgent</span><span class="token punctuation">(</span>SimpleAgent<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">    <span class="token triple-quoted-string string">"""具有上下文感知能力的 Agent"""</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> llm<span class="token punctuation">:</span> HelloAgentsLLM<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> system_prompt<span class="token operator">=</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"system_prompt"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">        <span class="token comment"># 初始化上下文构建器</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">.</span>memory_tool <span class="token operator">=</span> MemoryTool<span class="token punctuation">(</span>user_id<span class="token operator">=</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"user_id"</span><span class="token punctuation">,</span> <span class="token string">"default"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">        self<span class="token punctuation">.</span>rag_tool <span class="token operator">=</span> RAGTool<span class="token punctuation">(</span>knowledge_base_path<span class="token operator">=</span>kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"knowledge_base_path"</span><span class="token punctuation">,</span> <span class="token string">"./kb"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">        self<span class="token punctuation">.</span>context_builder <span class="token operator">=</span> ContextBuilder<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="16">            memory_tool<span class="token operator">=</span>self<span class="token punctuation">.</span>memory_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">            rag_tool<span class="token operator">=</span>self<span class="token punctuation">.</span>rag_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">            config<span class="token operator">=</span>ContextConfig<span class="token punctuation">(</span>max_tokens<span class="token operator">=</span><span class="token number">4000</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">        self<span class="token punctuation">.</span>conversation_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        <span class="token triple-quoted-string string">"""运行 Agent,自动构建优化的上下文"""</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">        <span class="token comment"># 1. 使用 ContextBuilder 构建优化的上下文</span>
</span><span class="code-line line-number" line="27">        optimized_context <span class="token operator">=</span> self<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="28">            user_query<span class="token operator">=</span>user_input<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">            conversation_history<span class="token operator">=</span>self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">            system_instructions<span class="token operator">=</span>self<span class="token punctuation">.</span>system_prompt
</span><span class="code-line line-number" line="31">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">        <span class="token comment"># 2. 使用优化后的上下文调用 LLM</span>
</span><span class="code-line line-number" line="34">        messages <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="35">            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> optimized_context<span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> user_input<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="37">        <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="38">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">        <span class="token comment"># 3. 更新对话历史</span>
</span><span class="code-line line-number" line="41">        <span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>core<span class="token punctuation">.</span>message <span class="token keyword">import</span> Message
</span><span class="code-line line-number" line="42">        <span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="45">            Message<span class="token punctuation">(</span>content<span class="token operator">=</span>user_input<span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="48">            Message<span class="token punctuation">(</span>content<span class="token operator">=</span>response<span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"assistant"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="50">
</span><span class="code-line line-number" line="51">        <span class="token comment"># 4. 将重要交互记录到记忆系统</span>
</span><span class="code-line line-number" line="52">        self<span class="token punctuation">.</span>memory_tool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="53">            <span class="token string">"add"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="54">            content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"Q: </span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">}</span></span><span class="token string">\nA: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">200]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">,</span>  <span class="token comment"># 摘要</span>
</span><span class="code-line line-number" line="55">            memory_type<span class="token operator">=</span><span class="token string">"episodic"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="56">            importance<span class="token operator">=</span><span class="token number">0.6</span>
</span><span class="code-line line-number" line="57">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="58">
</span><span class="code-line line-number" line="59">        <span class="token keyword">return</span> response
</span><span class="code-line line-number" line="60">
</span><span class="code-line line-number" line="61"><span class="token comment"># 使用示例</span>
</span><span class="code-line line-number" line="62">agent <span class="token operator">=</span> ContextAwareAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="63">    name<span class="token operator">=</span><span class="token string">"数据分析顾问"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="64">    llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="65">    system_prompt<span class="token operator">=</span><span class="token string">"你是一位资深的Python数据工程顾问。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="66">    user_id<span class="token operator">=</span><span class="token string">"user123"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="67">    knowledge_base_path<span class="token operator">=</span><span class="token string">"./data_science_kb"</span>
</span><span class="code-line line-number" line="68"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="69">
</span><span class="code-line line-number" line="70">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"如何优化Pandas的内存占用?"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="71"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span></code></pre>
<p>通过这种方式，ContextBuilder 成为了 Agent 的"上下文管理大脑"，自动处理信息的收集、筛选和组织，让 Agent 始终能够在最优的上下文下进行推理和生成。</p>
<h3>9.3.5 最佳实践与优化建议</h3>
<p>在实际应用 ContextBuilder 时，以下几点最佳实践值得注意：</p>
<ol>
<li>
<p><strong>动态调整 token 预算</strong>：根据任务复杂度动态调整 <code>max_tokens</code>，简单任务使用较小预算，复杂任务增加预算。</p>
</li>
<li>
<p><strong>相关性计算优化</strong>：在生产环境中，将简单的关键词重叠替换为向量相似度计算，提升检索质量。</p>
</li>
<li>
<p><strong>缓存机制</strong>：对于不变的系统指令和知识库内容，可以实现缓存机制，避免重复计算。</p>
</li>
<li>
<p><strong>监控与日志</strong>：记录每次上下文构建的统计信息(选中信息数量、token 使用率等)，便于后续优化。</p>
</li>
<li>
<p><strong>A/B 测试</strong>：对于关键参数(如相关性权重、新近性权重)，通过 A/B 测试找到最优配置。</p>
</li>
</ol>
<h2>9.4 NoteTool：结构化笔记</h2>
<p>NoteTool 是为"长时程任务"提供的结构化外部记忆组件。它以 Markdown 文件作为载体，头部使用 YAML 前置元数据记录关键信息，正文用于记录状态、结论、阻塞与行动项等内容。这种设计结合了人类可读性、版本控制友好性和易于回注上下文的特性，是构建长时程智能体的重要工具。</p>
<h3>9.4.1 设计理念与应用场景</h3>
<p>在深入实现细节之前，让我们首先理解 NoteTool 的设计理念和典型应用场景。</p>
<p>（1）为什么需要 NoteTool?</p>
<p>在第八章中，我们介绍了 MemoryTool，它提供了强大的记忆管理能力。然而，MemoryTool 主要关注<strong>对话式记忆</strong>——短期工作记忆、情景记忆和语义记忆。对于需要长期追踪、结构化管理的<strong>项目式任务</strong>，我们需要一种更轻量、更人类友好的记录方式。</p>
<p>NoteTool 填补了这个gap，它提供了：</p>
<ul>
<li><strong>结构化记录</strong>：使用 Markdown + YAML 格式，既适合机器解析，也方便人类阅读和编辑</li>
<li><strong>版本友好</strong>：纯文本格式，天然支持 Git 等版本控制系统</li>
<li><strong>低开销</strong>：无需复杂的数据库操作，适合轻量级的状态追踪</li>
<li><strong>灵活分类</strong>：通过 <code>type</code> 和 <code>tags</code> 灵活组织笔记，支持多维度检索</li>
</ul>
<p>（2）典型应用场景</p>
<p>NoteTool 特别适合以下场景：</p>
<p><strong>场景1：长期项目追踪</strong></p>
<p>想象一个智能体正在协助完成一个大型代码库的重构任务，这可能需要几天甚至几周。NoteTool 可以记录：</p>
<ul>
<li><code>task_state</code>：当前阶段的任务状态和进度</li>
<li><code>conclusion</code>：每个阶段结束后的关键结论</li>
<li><code>blocker</code>：遇到的问题和阻塞点</li>
<li><code>action</code>：下一步的行动计划</li>
</ul>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 记录任务状态</span>
</span><span class="code-line line-number" line="2">notes<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"重构项目 - 第一阶段"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"已完成数据模型层的重构,测试覆盖率达到85%。下一步将重构业务逻辑层。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"task_state"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"refactoring"</span><span class="token punctuation">,</span> <span class="token string">"phase1"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 记录阻塞点</span>
</span><span class="code-line line-number" line="11">notes<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"依赖冲突问题"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"发现某些第三方库版本不兼容,需要解决。影响范围:业务逻辑层的3个模块。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">    <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"blocker"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"dependency"</span><span class="token punctuation">,</span> <span class="token string">"urgent"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>场景2：研究任务管理</strong></p>
<p>一个智能研究助手在进行文献综述时，可以使用 NoteTool 记录：</p>
<ul>
<li>每篇论文的核心观点(<code>conclusion</code>)</li>
<li>待深入调研的主题(<code>action</code>)</li>
<li>重要的参考文献(<code>reference</code>)</li>
</ul>
<p><strong>场景3：与 ContextBuilder 配合</strong></p>
<p>在每轮对话前，Agent 可以通过 <code>search</code> 或 <code>list</code> 操作检索相关笔记，并将其注入到上下文中：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 在 Agent 的 run 方法中</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">    <span class="token comment"># 1. 检索相关笔记</span>
</span><span class="code-line line-number" line="4">    relevant_notes <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">        <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">        <span class="token string">"query"</span><span class="token punctuation">:</span> user_input<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">        <span class="token string">"limit"</span><span class="token punctuation">:</span> <span class="token number">3</span>
</span><span class="code-line line-number" line="8">    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">    <span class="token comment"># 2. 将笔记内容转换为 ContextPacket</span>
</span><span class="code-line line-number" line="11">    note_packets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">for</span> note <span class="token keyword">in</span> relevant_notes<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">        note_packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="14">            content<span class="token operator">=</span>note<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">            timestamp<span class="token operator">=</span>note<span class="token punctuation">[</span><span class="token string">'updated_at'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">            token_count<span class="token operator">=</span>self<span class="token punctuation">.</span>_count_tokens<span class="token punctuation">(</span>note<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">            relevance_score<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">            metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"note"</span><span class="token punctuation">,</span> <span class="token string">"note_type"</span><span class="token punctuation">:</span> note<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="19">        <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">    <span class="token comment"># 3. 构建上下文时传入笔记</span>
</span><span class="code-line line-number" line="22">    context <span class="token operator">=</span> self<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="23">        user_query<span class="token operator">=</span>user_input<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">        custom_packets<span class="token operator">=</span>note_packets<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</span><span class="code-line line-number" line="26">    <span class="token punctuation">)</span>
</span></code></pre>
<h3>9.4.2 存储格式详解</h3>
<p>NoteTool 采用了 Markdown + YAML 的混合格式，这种设计兼顾了结构化和可读性。</p>
<p>（1）笔记文件格式</p>
<p>每个笔记都是一个独立的 <code>.md</code> 文件，格式如下：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token front-matter-block"><span class="token punctuation">---</span>
</span></span><span class="code-line line-number" line="2"><span class="token front-matter-block"><span class="token front-matter yaml language-yaml"><span class="token key atrule">id</span><span class="token punctuation">:</span> note_20250119_153000_0
</span></span></span><span class="code-line line-number" line="3"><span class="token front-matter-block"><span class="token front-matter yaml language-yaml"><span class="token key atrule">title</span><span class="token punctuation">:</span> 项目进展 <span class="token punctuation">-</span> 第一阶段
</span></span></span><span class="code-line line-number" line="4"><span class="token front-matter-block"><span class="token front-matter yaml language-yaml"><span class="token key atrule">type</span><span class="token punctuation">:</span> task_state
</span></span></span><span class="code-line line-number" line="5"><span class="token front-matter-block"><span class="token front-matter yaml language-yaml"><span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>refactoring<span class="token punctuation">,</span> phase1<span class="token punctuation">,</span> backend<span class="token punctuation">]</span>
</span></span></span><span class="code-line line-number" line="6"><span class="token front-matter-block"><span class="token front-matter yaml language-yaml"><span class="token key atrule">created_at</span><span class="token punctuation">:</span> <span class="token datetime number">2025-01-19T15:30:00</span>
</span></span></span><span class="code-line line-number" line="7"><span class="token front-matter-block"><span class="token front-matter yaml language-yaml"><span class="token key atrule">updated_at</span><span class="token punctuation">:</span> <span class="token datetime number">2025-01-19T15:30:00</span></span>
</span></span><span class="code-line line-number" line="8"><span class="token front-matter-block"><span class="token punctuation">---</span></span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token title important"><span class="token punctuation">#</span> 项目进展 - 第一阶段</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token title important"><span class="token punctuation">##</span> 完成情况</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">已完成数据模型层的重构,主要改动包括:
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token list punctuation">1.</span> 统一了实体类的命名规范
</span><span class="code-line line-number" line="17"><span class="token list punctuation">2.</span> 引入了类型提示,提升代码可维护性
</span><span class="code-line line-number" line="18"><span class="token list punctuation">3.</span> 优化了数据库查询性能
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token title important"><span class="token punctuation">##</span> 测试覆盖</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22"><span class="token list punctuation">-</span> 单元测试覆盖率: 85%
</span><span class="code-line line-number" line="23"><span class="token list punctuation">-</span> 集成测试覆盖率: 70%
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token title important"><span class="token punctuation">##</span> 下一步计划</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27"><span class="token list punctuation">1.</span> 重构业务逻辑层
</span><span class="code-line line-number" line="28"><span class="token list punctuation">2.</span> 解决依赖冲突问题
</span><span class="code-line line-number" line="29"><span class="token list punctuation">3.</span> 提升集成测试覆盖率至85%
</span></code></pre>
<p>这种格式的优势：</p>
<ul>
<li><strong>YAML 元数据</strong>：机器可解析，支持精确的字段提取和检索</li>
<li><strong>Markdown 正文</strong>：人类可读，支持丰富的格式化(标题、列表、代码块等)</li>
<li><strong>文件名即 ID</strong>：简化管理，每个笔记的文件名就是其唯一标识</li>
</ul>
<p>（2）索引文件</p>
<p>NoteTool 维护一个 <code>notes_index.json</code> 文件，用于快速检索和管理笔记：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"note_20250119_153000_0"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"note_20250119_153000_0"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"项目进展 - 第一阶段"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"task_state"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    <span class="token property">"tags"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"refactoring"</span><span class="token punctuation">,</span> <span class="token string">"phase1"</span><span class="token punctuation">,</span> <span class="token string">"backend"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    <span class="token property">"created_at"</span><span class="token operator">:</span> <span class="token string">"2025-01-19T15:30:00"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    <span class="token property">"updated_at"</span><span class="token operator">:</span> <span class="token string">"2025-01-19T15:30:00"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    <span class="token property">"file_path"</span><span class="token operator">:</span> <span class="token string">"./notes/note_20250119_153000_0.md"</span>
</span><span class="code-line line-number" line="10">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">}</span>
</span></code></pre>
<p>这个索引文件的作用：</p>
<ul>
<li><strong>快速检索</strong>：无需打开每个文件，直接从索引中查找</li>
<li><strong>元数据管理</strong>：集中管理所有笔记的元数据</li>
<li><strong>完整性校验</strong>：可以检测文件缺失或损坏</li>
</ul>
<h3>9.4.3 核心操作详解</h3>
<p>NoteTool 提供了七个核心操作，覆盖了笔记的完整生命周期管理。</p>
<p>（1）create：创建笔记</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_create_note</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    title<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    note_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"general"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    tags<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token triple-quoted-string string">"""创建笔记
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        title: 笔记标题
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        content: 笔记内容(Markdown格式)
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">        note_type: 笔记类型(task_state/conclusion/blocker/action/reference/general)
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">        tags: 标签列表
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">        str: 笔记ID
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="19">    <span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">    <span class="token comment"># 1. 生成唯一ID</span>
</span><span class="code-line line-number" line="22">    timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    note_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"note_</span><span class="token interpolation"><span class="token punctuation">{</span>timestamp<span class="token punctuation">}</span></span><span class="token string">_</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">    <span class="token comment"># 2. 构建元数据</span>
</span><span class="code-line line-number" line="26">    metadata <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="27">        <span class="token string">"id"</span><span class="token punctuation">:</span> note_id<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="28">        <span class="token string">"title"</span><span class="token punctuation">:</span> title<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">        <span class="token string">"type"</span><span class="token punctuation">:</span> note_type<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">        <span class="token string">"tags"</span><span class="token punctuation">:</span> tags <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="31">        <span class="token string">"created_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="32">        <span class="token string">"updated_at"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35">    <span class="token comment"># 3. 构建完整的 Markdown 文件内容</span>
</span><span class="code-line line-number" line="36">    md_content <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_markdown<span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38">    <span class="token comment"># 4. 保存到文件</span>
</span><span class="code-line line-number" line="39">    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>workspace<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>note_id<span class="token punctuation">}</span></span><span class="token string">.md"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="41">        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>md_content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43">    <span class="token comment"># 5. 更新索引</span>
</span><span class="code-line line-number" line="44">    metadata<span class="token punctuation">[</span><span class="token string">"file_path"</span><span class="token punctuation">]</span> <span class="token operator">=</span> file_path
</span><span class="code-line line-number" line="45">    self<span class="token punctuation">.</span>index<span class="token punctuation">[</span>note_id<span class="token punctuation">]</span> <span class="token operator">=</span> metadata
</span><span class="code-line line-number" line="46">    self<span class="token punctuation">.</span>_save_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">
</span><span class="code-line line-number" line="48">    <span class="token keyword">return</span> note_id
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50"><span class="token keyword">def</span> <span class="token function">_build_markdown</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> metadata<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="51">    <span class="token triple-quoted-string string">"""构建 Markdown 文件内容(YAML + 正文)"""</span>
</span><span class="code-line line-number" line="52">    <span class="token keyword">import</span> yaml
</span><span class="code-line line-number" line="53">
</span><span class="code-line line-number" line="54">    <span class="token comment"># YAML 前置元数据</span>
</span><span class="code-line line-number" line="55">    yaml_header <span class="token operator">=</span> yaml<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> allow_unicode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> sort_keys<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="56">
</span><span class="code-line line-number" line="57">    <span class="token comment"># 组合格式</span>
</span><span class="code-line line-number" line="58">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"---\n</span><span class="token interpolation"><span class="token punctuation">{</span>yaml_header<span class="token punctuation">}</span></span><span class="token string">---\n\n</span><span class="token interpolation"><span class="token punctuation">{</span>content<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span></code></pre>
<p>使用示例：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> NoteTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3">notes <span class="token operator">=</span> NoteTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"./project_notes"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">note_id <span class="token operator">=</span> notes<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"重构项目 - 第一阶段"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""## 完成情况
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">已完成数据模型层的重构,测试覆盖率达到85%。
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">## 下一步
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">重构业务逻辑层"""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"task_state"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"refactoring"</span><span class="token punctuation">,</span> <span class="token string">"phase1"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="15"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 笔记创建成功,ID: </span><span class="token interpolation"><span class="token punctuation">{</span>note_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p>（2）read：读取笔记</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_read_note</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> note_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""读取笔记内容
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">        note_id: 笔记ID
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">        Dict: 包含元数据和内容的字典
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">if</span> note_id <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>index<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"笔记不存在: </span><span class="token interpolation"><span class="token punctuation">{</span>note_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">    file_path <span class="token operator">=</span> self<span class="token punctuation">.</span>index<span class="token punctuation">[</span>note_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"file_path"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">    <span class="token comment"># 读取文件</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">        raw_content <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token comment"># 解析 YAML 元数据和 Markdown 正文</span>
</span><span class="code-line line-number" line="20">    metadata<span class="token punctuation">,</span> content <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_markdown<span class="token punctuation">(</span>raw_content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">        <span class="token string">"metadata"</span><span class="token punctuation">:</span> metadata<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">        <span class="token string">"content"</span><span class="token punctuation">:</span> content
</span><span class="code-line line-number" line="25">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27"><span class="token keyword">def</span> <span class="token function">_parse_markdown</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> raw_content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Dict<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="28">    <span class="token triple-quoted-string string">"""解析 Markdown 文件(分离 YAML 和正文)"""</span>
</span><span class="code-line line-number" line="29">    <span class="token keyword">import</span> yaml
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">    <span class="token comment"># 查找 YAML 分隔符</span>
</span><span class="code-line line-number" line="32">    parts <span class="token operator">=</span> raw_content<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'---\n'</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="35">        <span class="token comment"># 有 YAML 前置元数据</span>
</span><span class="code-line line-number" line="36">        yaml_str <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="37">        content <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">        metadata <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>yaml_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="40">        <span class="token comment"># 无元数据,全部作为正文</span>
</span><span class="code-line line-number" line="41">        metadata <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="42">        content <span class="token operator">=</span> raw_content<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">    <span class="token keyword">return</span> metadata<span class="token punctuation">,</span> content
</span></code></pre>
<p>（3）update：更新笔记</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_update_note</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    note_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    title<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    content<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    note_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    tags<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">    <span class="token triple-quoted-string string">"""更新笔记
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        note_id: 笔记ID
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">        title: 新标题(可选)
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">        content: 新内容(可选)
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">        note_type: 新类型(可选)
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">        tags: 新标签(可选)
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">        str: 操作结果消息
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="21">    <span class="token keyword">if</span> note_id <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>index<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"笔记不存在: </span><span class="token interpolation"><span class="token punctuation">{</span>note_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">    <span class="token comment"># 1. 读取现有笔记</span>
</span><span class="code-line line-number" line="25">    note <span class="token operator">=</span> self<span class="token punctuation">.</span>_read_note<span class="token punctuation">(</span>note_id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">    metadata <span class="token operator">=</span> note<span class="token punctuation">[</span><span class="token string">"metadata"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="27">    old_content <span class="token operator">=</span> note<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">    <span class="token comment"># 2. 更新字段</span>
</span><span class="code-line line-number" line="30">    <span class="token keyword">if</span> title<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">        metadata<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span> <span class="token operator">=</span> title
</span><span class="code-line line-number" line="32">    <span class="token keyword">if</span> note_type<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">        metadata<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">=</span> note_type
</span><span class="code-line line-number" line="34">    <span class="token keyword">if</span> tags <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="35">        metadata<span class="token punctuation">[</span><span class="token string">"tags"</span><span class="token punctuation">]</span> <span class="token operator">=</span> tags
</span><span class="code-line line-number" line="36">    <span class="token keyword">if</span> content <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="37">        old_content <span class="token operator">=</span> content
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">    <span class="token comment"># 更新时间戳</span>
</span><span class="code-line line-number" line="40">    <span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="41">    metadata<span class="token punctuation">[</span><span class="token string">"updated_at"</span><span class="token punctuation">]</span> <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43">    <span class="token comment"># 3. 重新构建并保存</span>
</span><span class="code-line line-number" line="44">    md_content <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_markdown<span class="token punctuation">(</span>metadata<span class="token punctuation">,</span> old_content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="45">    file_path <span class="token operator">=</span> metadata<span class="token punctuation">[</span><span class="token string">"file_path"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="46">
</span><span class="code-line line-number" line="47">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="48">        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>md_content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">    <span class="token comment"># 4. 更新索引</span>
</span><span class="code-line line-number" line="51">    self<span class="token punctuation">.</span>index<span class="token punctuation">[</span>note_id<span class="token punctuation">]</span> <span class="token operator">=</span> metadata
</span><span class="code-line line-number" line="52">    self<span class="token punctuation">.</span>_save_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="53">
</span><span class="code-line line-number" line="54">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"✅ 笔记已更新: </span><span class="token interpolation"><span class="token punctuation">{</span>metadata<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span></code></pre>
<p>（4）search：搜索笔记</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_search_notes</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    note_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    tags<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token triple-quoted-string string">"""搜索笔记
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        query: 搜索关键词
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        limit: 返回数量限制
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">        note_type: 按类型过滤(可选)
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">        tags: 按标签过滤(可选)
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">        List[Dict]: 匹配的笔记列表
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="19">    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="20">    query_lower <span class="token operator">=</span> query<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token keyword">for</span> note_id<span class="token punctuation">,</span> metadata <span class="token keyword">in</span> self<span class="token punctuation">.</span>index<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">        <span class="token comment"># 类型过滤</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">if</span> note_type <span class="token keyword">and</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> note_type<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="25">            <span class="token keyword">continue</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">        <span class="token comment"># 标签过滤</span>
</span><span class="code-line line-number" line="28">        <span class="token keyword">if</span> tags<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">            note_tags <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">            <span class="token keyword">if</span> <span class="token keyword">not</span> note_tags<span class="token punctuation">.</span>intersection<span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">                <span class="token keyword">continue</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">        <span class="token comment"># 读取笔记内容</span>
</span><span class="code-line line-number" line="34">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="35">            note <span class="token operator">=</span> self<span class="token punctuation">.</span>_read_note<span class="token punctuation">(</span>note_id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36">            content <span class="token operator">=</span> note<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="37">            title <span class="token operator">=</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">            <span class="token comment"># 在标题和内容中搜索</span>
</span><span class="code-line line-number" line="40">            <span class="token keyword">if</span> query_lower <span class="token keyword">in</span> title<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> query_lower <span class="token keyword">in</span> content<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="41">                results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="42">                    <span class="token string">"note_id"</span><span class="token punctuation">:</span> note_id<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="43">                    <span class="token string">"title"</span><span class="token punctuation">:</span> title<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="44">                    <span class="token string">"type"</span><span class="token punctuation">:</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="45">                    <span class="token string">"tags"</span><span class="token punctuation">:</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="46">                    <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="47">                    <span class="token string">"updated_at"</span><span class="token punctuation">:</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="48">                <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="50">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 读取笔记 </span><span class="token interpolation"><span class="token punctuation">{</span>note_id<span class="token punctuation">}</span></span><span class="token string"> 失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">            <span class="token keyword">continue</span>
</span><span class="code-line line-number" line="52">
</span><span class="code-line line-number" line="53">    <span class="token comment"># 按更新时间排序</span>
</span><span class="code-line line-number" line="54">    results<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token string">"updated_at"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="55">
</span><span class="code-line line-number" line="56">    <span class="token keyword">return</span> results<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span>
</span></code></pre>
<p>（5）list：列出笔记</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_list_notes</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    note_type<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    tags<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">20</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">    <span class="token triple-quoted-string string">"""列出笔记(按更新时间倒序)
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">        note_type: 按类型过滤(可选)
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">        tags: 按标签过滤(可选)
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">        limit: 返回数量限制
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">        List[Dict]: 笔记元数据列表
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="17">    results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token keyword">for</span> note_id<span class="token punctuation">,</span> metadata <span class="token keyword">in</span> self<span class="token punctuation">.</span>index<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        <span class="token comment"># 类型过滤</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">if</span> note_type <span class="token keyword">and</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> note_type<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">            <span class="token keyword">continue</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">        <span class="token comment"># 标签过滤</span>
</span><span class="code-line line-number" line="25">        <span class="token keyword">if</span> tags<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">            note_tags <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tags"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">            <span class="token keyword">if</span> <span class="token keyword">not</span> note_tags<span class="token punctuation">.</span>intersection<span class="token punctuation">(</span>tags<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="28">                <span class="token keyword">continue</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">        results<span class="token punctuation">.</span>append<span class="token punctuation">(</span>metadata<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32">    <span class="token comment"># 按更新时间排序</span>
</span><span class="code-line line-number" line="33">    results<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35">    <span class="token keyword">return</span> results<span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span>
</span></code></pre>
<p>（6）summary：笔记摘要</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_summary</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""生成笔记摘要统计
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">        Dict: 统计信息
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="7">    total_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>index<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">    <span class="token comment"># 按类型统计</span>
</span><span class="code-line line-number" line="10">    type_counts <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11">    <span class="token keyword">for</span> metadata <span class="token keyword">in</span> self<span class="token punctuation">.</span>index<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">        note_type <span class="token operator">=</span> metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">,</span> <span class="token string">"general"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">        type_counts<span class="token punctuation">[</span>note_type<span class="token punctuation">]</span> <span class="token operator">=</span> type_counts<span class="token punctuation">.</span>get<span class="token punctuation">(</span>note_type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">    <span class="token comment"># 最近更新的笔记</span>
</span><span class="code-line line-number" line="16">    recent_notes <span class="token operator">=</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>index<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">        key<span class="token operator">=</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">        reverse<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="20">    <span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">        <span class="token string">"total_notes"</span><span class="token punctuation">:</span> total_count<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">        <span class="token string">"type_distribution"</span><span class="token punctuation">:</span> type_counts<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">        <span class="token string">"recent_notes"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="26">            <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="27">                <span class="token string">"id"</span><span class="token punctuation">:</span> note<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="28">                <span class="token string">"title"</span><span class="token punctuation">:</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">                <span class="token string">"type"</span><span class="token punctuation">:</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">                <span class="token string">"updated_at"</span><span class="token punctuation">:</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"updated_at"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="32">            <span class="token keyword">for</span> note <span class="token keyword">in</span> recent_notes
</span><span class="code-line line-number" line="33">        <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="34">    <span class="token punctuation">}</span>
</span></code></pre>
<p>（7）delete：删除笔记</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_delete_note</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> note_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""删除笔记
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">        note_id: 笔记ID
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    Returns:
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">        str: 操作结果消息
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">if</span> note_id <span class="token keyword">not</span> <span class="token keyword">in</span> self<span class="token punctuation">.</span>index<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"笔记不存在: </span><span class="token interpolation"><span class="token punctuation">{</span>note_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">    <span class="token comment"># 1. 删除文件</span>
</span><span class="code-line line-number" line="14">    file_path <span class="token operator">=</span> self<span class="token punctuation">.</span>index<span class="token punctuation">[</span>note_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"file_path"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="15">    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">    <span class="token comment"># 2. 从索引中移除</span>
</span><span class="code-line line-number" line="19">    title <span class="token operator">=</span> self<span class="token punctuation">.</span>index<span class="token punctuation">[</span>note_id<span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> note_id<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">    <span class="token keyword">del</span> self<span class="token punctuation">.</span>index<span class="token punctuation">[</span>note_id<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="21">    self<span class="token punctuation">.</span>_save_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"✅ 笔记已删除: </span><span class="token interpolation"><span class="token punctuation">{</span>title<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span></code></pre>
<h3>9.4.4 与 ContextBuilder 的深度集成</h3>
<p>NoteTool 的真正威力在于与 ContextBuilder 的配合使用。让我们通过一个完整的案例来展示这种集成。</p>
<p>（1）场景设定</p>
<p>假设我们正在构建一个长期项目助手，它需要：</p>
<ol>
<li>记录项目的阶段性进展</li>
<li>追踪待解决的问题</li>
<li>在每次对话时，自动回顾相关笔记</li>
<li>基于历史笔记提供连贯的建议</li>
</ol>
<p>（2）实现示例</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>context <span class="token keyword">import</span> ContextBuilder<span class="token punctuation">,</span> ContextConfig<span class="token punctuation">,</span> ContextPacket
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MemoryTool<span class="token punctuation">,</span> RAGTool<span class="token punctuation">,</span> NoteTool
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token keyword">class</span> <span class="token class-name">ProjectAssistant</span><span class="token punctuation">(</span>SimpleAgent<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">    <span class="token triple-quoted-string string">"""长期项目助手,集成 NoteTool 和 ContextBuilder"""</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> project_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token operator">=</span>name<span class="token punctuation">,</span> llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">.</span>project_name <span class="token operator">=</span> project_name
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">        <span class="token comment"># 初始化工具</span>
</span><span class="code-line line-number" line="15">        self<span class="token punctuation">.</span>memory_tool <span class="token operator">=</span> MemoryTool<span class="token punctuation">(</span>user_id<span class="token operator">=</span>project_name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>rag_tool <span class="token operator">=</span> RAGTool<span class="token punctuation">(</span>knowledge_base_path<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"./</span><span class="token interpolation"><span class="token punctuation">{</span>project_name<span class="token punctuation">}</span></span><span class="token string">_kb"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>note_tool <span class="token operator">=</span> NoteTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"./</span><span class="token interpolation"><span class="token punctuation">{</span>project_name<span class="token punctuation">}</span></span><span class="token string">_notes"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">        <span class="token comment"># 初始化上下文构建器</span>
</span><span class="code-line line-number" line="20">        self<span class="token punctuation">.</span>context_builder <span class="token operator">=</span> ContextBuilder<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="21">            memory_tool<span class="token operator">=</span>self<span class="token punctuation">.</span>memory_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">            rag_tool<span class="token operator">=</span>self<span class="token punctuation">.</span>rag_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">            config<span class="token operator">=</span>ContextConfig<span class="token punctuation">(</span>max_tokens<span class="token operator">=</span><span class="token number">4000</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">        self<span class="token punctuation">.</span>conversation_history <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> note_as_action<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">        <span class="token triple-quoted-string string">"""运行助手,自动集成笔记"""</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">        <span class="token comment"># 1. 从 NoteTool 检索相关笔记</span>
</span><span class="code-line line-number" line="32">        relevant_notes <span class="token operator">=</span> self<span class="token punctuation">.</span>_retrieve_relevant_notes<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">        <span class="token comment"># 2. 将笔记转换为 ContextPacket</span>
</span><span class="code-line line-number" line="35">        note_packets <span class="token operator">=</span> self<span class="token punctuation">.</span>_notes_to_packets<span class="token punctuation">(</span>relevant_notes<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">        <span class="token comment"># 3. 构建优化的上下文</span>
</span><span class="code-line line-number" line="38">        context <span class="token operator">=</span> self<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="39">            user_query<span class="token operator">=</span>user_input<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="40">            conversation_history<span class="token operator">=</span>self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="41">            system_instructions<span class="token operator">=</span>self<span class="token punctuation">.</span>_build_system_instructions<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="42">            custom_packets<span class="token operator">=</span>note_packets
</span><span class="code-line line-number" line="43">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45">        <span class="token comment"># 4. 调用 LLM</span>
</span><span class="code-line line-number" line="46">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">
</span><span class="code-line line-number" line="48">        <span class="token comment"># 5. 如果需要,将交互记录为笔记</span>
</span><span class="code-line line-number" line="49">        <span class="token keyword">if</span> note_as_action<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="50">            self<span class="token punctuation">.</span>_save_as_note<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52">        <span class="token comment"># 6. 更新对话历史</span>
</span><span class="code-line line-number" line="53">        self<span class="token punctuation">.</span>_update_history<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="54">
</span><span class="code-line line-number" line="55">        <span class="token keyword">return</span> response
</span><span class="code-line line-number" line="56">
</span><span class="code-line line-number" line="57">    <span class="token keyword">def</span> <span class="token function">_retrieve_relevant_notes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="58">        <span class="token triple-quoted-string string">"""检索相关笔记"""</span>
</span><span class="code-line line-number" line="59">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="60">            <span class="token comment"># 优先检索 blocker 和 action 类型的笔记</span>
</span><span class="code-line line-number" line="61">            blockers <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="62">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"list"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="63">                <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"blocker"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="64">                <span class="token string">"limit"</span><span class="token punctuation">:</span> <span class="token number">2</span>
</span><span class="code-line line-number" line="65">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="66">
</span><span class="code-line line-number" line="67">            <span class="token comment"># 通用搜索</span>
</span><span class="code-line line-number" line="68">            search_results <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="69">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="70">                <span class="token string">"query"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="71">                <span class="token string">"limit"</span><span class="token punctuation">:</span> limit
</span><span class="code-line line-number" line="72">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="73">
</span><span class="code-line line-number" line="74">            <span class="token comment"># 合并并去重</span>
</span><span class="code-line line-number" line="75">            all_notes <span class="token operator">=</span> <span class="token punctuation">{</span>note<span class="token punctuation">[</span><span class="token string">'note_id'</span><span class="token punctuation">]</span><span class="token punctuation">:</span> note <span class="token keyword">for</span> note <span class="token keyword">in</span> blockers <span class="token operator">+</span> search_results<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="76">            <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>all_notes<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="77">
</span><span class="code-line line-number" line="78">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="79">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 笔记检索失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="80">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="81">
</span><span class="code-line line-number" line="82">    <span class="token keyword">def</span> <span class="token function">_notes_to_packets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> notes<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="83">        <span class="token triple-quoted-string string">"""将笔记转换为上下文包"""</span>
</span><span class="code-line line-number" line="84">        packets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="85">
</span><span class="code-line line-number" line="86">        <span class="token keyword">for</span> note <span class="token keyword">in</span> notes<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="87">            content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"[笔记:</span><span class="token interpolation"><span class="token punctuation">{</span>note<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">]\n</span><span class="token interpolation"><span class="token punctuation">{</span>note<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="88">
</span><span class="code-line line-number" line="89">            packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="90">                content<span class="token operator">=</span>content<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="91">                timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span>note<span class="token punctuation">[</span><span class="token string">'updated_at'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="92">                token_count<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token comment"># 简单估算</span>
</span><span class="code-line line-number" line="93">                relevance_score<span class="token operator">=</span><span class="token number">0.75</span><span class="token punctuation">,</span>  <span class="token comment"># 笔记具有较高相关性</span>
</span><span class="code-line line-number" line="94">                metadata<span class="token operator">=</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="95">                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"note"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="96">                    <span class="token string">"note_type"</span><span class="token punctuation">:</span> note<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="97">                    <span class="token string">"note_id"</span><span class="token punctuation">:</span> note<span class="token punctuation">[</span><span class="token string">'note_id'</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="98">                <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="99">            <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="100">
</span><span class="code-line line-number" line="101">        <span class="token keyword">return</span> packets
</span><span class="code-line line-number" line="102">
</span><span class="code-line line-number" line="103">    <span class="token keyword">def</span> <span class="token function">_save_as_note</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="104">        <span class="token triple-quoted-string string">"""将交互保存为笔记"""</span>
</span><span class="code-line line-number" line="105">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="106">            <span class="token comment"># 判断应该保存为什么类型的笔记</span>
</span><span class="code-line line-number" line="107">            <span class="token keyword">if</span> <span class="token string">"问题"</span> <span class="token keyword">in</span> user_input <span class="token keyword">or</span> <span class="token string">"阻塞"</span> <span class="token keyword">in</span> user_input<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="108">                note_type <span class="token operator">=</span> <span class="token string">"blocker"</span>
</span><span class="code-line line-number" line="109">            <span class="token keyword">elif</span> <span class="token string">"计划"</span> <span class="token keyword">in</span> user_input <span class="token keyword">or</span> <span class="token string">"下一步"</span> <span class="token keyword">in</span> user_input<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="110">                note_type <span class="token operator">=</span> <span class="token string">"action"</span>
</span><span class="code-line line-number" line="111">            <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="112">                note_type <span class="token operator">=</span> <span class="token string">"conclusion"</span>
</span><span class="code-line line-number" line="113">
</span><span class="code-line line-number" line="114">            self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="115">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="116">                <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">30]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="117">                <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"## 问题\n</span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">}</span></span><span class="token string">\n\n## 分析\n</span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="118">                <span class="token string">"note_type"</span><span class="token punctuation">:</span> note_type<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="119">                <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> <span class="token string">"auto_generated"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="120">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="121">
</span><span class="code-line line-number" line="122">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="123">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 保存笔记失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="124">
</span><span class="code-line line-number" line="125">    <span class="token keyword">def</span> <span class="token function">_build_system_instructions</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="126">        <span class="token triple-quoted-string string">"""构建系统指令"""</span>
</span><span class="code-line line-number" line="127">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"""你是 </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">}</span></span><span class="token string"> 项目的长期助手。
</span></span></span><span class="code-line line-number" line="128"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="129"><span class="token string-interpolation"><span class="token string">你的职责:
</span></span></span><span class="code-line line-number" line="130"><span class="token string-interpolation"><span class="token string">1. 基于历史笔记提供连贯的建议
</span></span></span><span class="code-line line-number" line="131"><span class="token string-interpolation"><span class="token string">2. 追踪项目进展和待解决问题
</span></span></span><span class="code-line line-number" line="132"><span class="token string-interpolation"><span class="token string">3. 在回答时引用相关的历史笔记
</span></span></span><span class="code-line line-number" line="133"><span class="token string-interpolation"><span class="token string">4. 提供具体、可操作的下一步建议
</span></span></span><span class="code-line line-number" line="134"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="135"><span class="token string-interpolation"><span class="token string">注意:
</span></span></span><span class="code-line line-number" line="136"><span class="token string-interpolation"><span class="token string">- 优先关注标记为 blocker 的问题
</span></span></span><span class="code-line line-number" line="137"><span class="token string-interpolation"><span class="token string">- 在建议中说明依据来源(笔记、记忆或知识库)
</span></span></span><span class="code-line line-number" line="138"><span class="token string-interpolation"><span class="token string">- 保持对项目整体进度的认识"""</span></span>
</span><span class="code-line line-number" line="139">
</span><span class="code-line line-number" line="140">    <span class="token keyword">def</span> <span class="token function">_update_history</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="141">        <span class="token triple-quoted-string string">"""更新对话历史"""</span>
</span><span class="code-line line-number" line="142">        <span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>core<span class="token punctuation">.</span>message <span class="token keyword">import</span> Message
</span><span class="code-line line-number" line="143">
</span><span class="code-line line-number" line="144">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="145">            Message<span class="token punctuation">(</span>content<span class="token operator">=</span>user_input<span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="146">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="147">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="148">            Message<span class="token punctuation">(</span>content<span class="token operator">=</span>response<span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"assistant"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="149">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="150">
</span><span class="code-line line-number" line="151">        <span class="token comment"># 限制历史长度</span>
</span><span class="code-line line-number" line="152">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="153">            self<span class="token punctuation">.</span>conversation_history <span class="token operator">=</span> self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="154">
</span><span class="code-line line-number" line="155"><span class="token comment"># 使用示例</span>
</span><span class="code-line line-number" line="156">assistant <span class="token operator">=</span> ProjectAssistant<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="157">    name<span class="token operator">=</span><span class="token string">"项目助手"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="158">    project_name<span class="token operator">=</span><span class="token string">"data_pipeline_refactoring"</span>
</span><span class="code-line line-number" line="159"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="160">
</span><span class="code-line line-number" line="161"><span class="token comment"># 第一次交互:记录项目状态</span>
</span><span class="code-line line-number" line="162">response <span class="token operator">=</span> assistant<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="163">    <span class="token string">"我们已经完成了数据模型层的重构,测试覆盖率达到85%。下一步计划重构业务逻辑层。"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="164">    note_as_action<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="165"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="166">
</span><span class="code-line line-number" line="167"><span class="token comment"># 第二次交互:提出问题</span>
</span><span class="code-line line-number" line="168">response <span class="token operator">=</span> assistant<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="169">    <span class="token string">"在重构业务逻辑层时,我遇到了依赖版本冲突的问题,该如何解决?"</span>
</span><span class="code-line line-number" line="170"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="171">
</span><span class="code-line line-number" line="172"><span class="token comment"># 查看笔记摘要</span>
</span><span class="code-line line-number" line="173">summary <span class="token operator">=</span> assistant<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"summary"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="174"><span class="token keyword">print</span><span class="token punctuation">(</span>summary<span class="token punctuation">)</span>
</span></code></pre>
<p>（3）运行效果展示</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">[</span>ContextBuilder<span class="token punctuation">]</span> 汇集了 <span class="token number">8</span> 个候选信息包
</span><span class="code-line line-number" line="2"><span class="token punctuation">[</span>ContextBuilder<span class="token punctuation">]</span> 选择了 <span class="token number">7</span> 个信息包,共 <span class="token number">3500</span> tokens
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">✅ 助手回答:
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6">我注意到您之前记录的笔记中提到了这个问题。根据笔记<span class="token punctuation">[</span>重构项目 - 第一阶段<span class="token punctuation">]</span>,您当前的测试覆盖率已经达到85%,这是一个很好的基础。
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">关于依赖版本冲突的问题,我建议:
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token number">1</span>. **使用虚拟环境隔离**: 为业务逻辑层创建独立的虚拟环境,避免与其他模块的依赖冲突
</span><span class="code-line line-number" line="11"><span class="token number">2</span>. **锁定版本**: 在 requirements.txt 中明确指定所有依赖的精确版本
</span><span class="code-line line-number" line="12"><span class="token number">3</span>. **使用 pipdeptree**: 分析依赖树,找出冲突的根源
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">这个问题我会标记为 blocker,建议优先解决。
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token punctuation">[</span>依据来源: 笔记 note_20250119_153000_0, 项目知识库<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">---
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">📋 笔记摘要:
</span><span class="code-line line-number" line="21"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">  <span class="token string">"total_notes"</span><span class="token builtin class-name">:</span> <span class="token number">2</span>,
</span><span class="code-line line-number" line="23">  <span class="token string">"type_distribution"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="24">    <span class="token string">"action"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>,
</span><span class="code-line line-number" line="25">    <span class="token string">"blocker"</span><span class="token builtin class-name">:</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="26">  <span class="token punctuation">}</span>,
</span><span class="code-line line-number" line="27">  <span class="token string">"recent_notes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="28">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="29">      <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"note_20250119_154500_1"</span>,
</span><span class="code-line line-number" line="30">      <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"在重构业务逻辑层时,我遇到了依赖版本冲突的问题..."</span>,
</span><span class="code-line line-number" line="31">      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"blocker"</span>,
</span><span class="code-line line-number" line="32">      <span class="token string">"updated_at"</span><span class="token builtin class-name">:</span> <span class="token string">"2025-01-19T15:45:00"</span>
</span><span class="code-line line-number" line="33">    <span class="token punctuation">}</span>,
</span><span class="code-line line-number" line="34">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="35">      <span class="token string">"id"</span><span class="token builtin class-name">:</span> <span class="token string">"note_20250119_153000_0"</span>,
</span><span class="code-line line-number" line="36">      <span class="token string">"title"</span><span class="token builtin class-name">:</span> <span class="token string">"我们已经完成了数据模型层的重构..."</span>,
</span><span class="code-line line-number" line="37">      <span class="token string">"type"</span><span class="token builtin class-name">:</span> <span class="token string">"action"</span>,
</span><span class="code-line line-number" line="38">      <span class="token string">"updated_at"</span><span class="token builtin class-name">:</span> <span class="token string">"2025-01-19T15:30:00"</span>
</span><span class="code-line line-number" line="39">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="40">  <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="41"><span class="token punctuation">}</span>
</span></code></pre>
<h3>9.4.5 最佳实践</h3>
<p>在实际使用 NoteTool 时，以下最佳实践能帮助您构建更强大的长时程智能体：</p>
<ol>
<li>
<p><strong>合理的笔记分类</strong>：</p>
<ul>
<li><code>task_state</code>：记录阶段性进展和状态</li>
<li><code>conclusion</code>：记录重要的结论和发现</li>
<li><code>blocker</code>：记录阻塞问题，优先级最高</li>
<li><code>action</code>：记录下一步行动计划</li>
<li><code>reference</code>：记录重要的参考资料</li>
</ul>
</li>
<li>
<p><strong>定期清理和归档</strong>：</p>
<ul>
<li>对于已解决的 blocker，更新为 conclusion</li>
<li>对于过时的 action，及时删除或更新</li>
<li>使用 tags 进行版本管理，如 <code>["v1.0", "completed"]</code></li>
</ul>
</li>
<li>
<p><strong>与 ContextBuilder 的配合</strong>：</p>
<ul>
<li>在每轮对话前检索相关笔记</li>
<li>根据笔记类型设置不同的相关性分数(blocker &gt; action &gt; conclusion)</li>
<li>限制笔记数量，避免上下文过载</li>
</ul>
</li>
<li>
<p><strong>人机协作</strong>：</p>
<ul>
<li>笔记是人类可读的 Markdown 格式，支持手动编辑</li>
<li>使用 Git 进行版本控制，追踪笔记的演化</li>
<li>在关键阶段，人工审核 Agent 生成的笔记</li>
</ul>
</li>
<li>
<p><strong>自动化工作流</strong>：</p>
<ul>
<li>定期生成笔记摘要报告</li>
<li>基于笔记自动生成项目进度文档</li>
<li>将笔记内容同步到其他系统(如 Notion、Confluence)</li>
</ul>
</li>
</ol>
<h2>9.5 TerminalTool：即时文件系统访问</h2>
<p>在前面的章节中，我们介绍了 MemoryTool 和 RAGTool，它们分别提供了对话记忆和知识检索能力。然而，在许多实际场景中，智能体需要<strong>即时访问和探索文件系统</strong>——查看日志文件、分析代码库结构、检索配置文件等。这就是 TerminalTool 的用武之地。</p>
<p>TerminalTool 为智能体提供了<strong>安全的命令行执行能力</strong>，支持常用的文件系统和文本处理命令，同时通过多层安全机制确保系统安全。这种设计实现了 9.2.2 节提到的"即时(Just-in-time, JIT)上下文"理念——智能体不需要预先加载所有文件，而是按需探索和检索。</p>
<h3>9.5.1 设计理念与安全机制</h3>
<p>（1）为什么需要 TerminalTool?</p>
<p>在构建长程智能体时，我们经常遇到以下场景：</p>
<p><strong>场景1：代码库探索</strong></p>
<p>一个开发助手需要帮助用户理解一个大型代码库的结构：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 传统方式:预先索引所有文件(成本高、可能过时)</span>
</span><span class="code-line line-number" line="2">rag_tool<span class="token punctuation">.</span>add_document<span class="token punctuation">(</span><span class="token string">"./project/**/*.py"</span><span class="token punctuation">)</span>  <span class="token comment"># 耗时、占用大量存储</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># TerminalTool 方式:即时探索</span>
</span><span class="code-line line-number" line="5">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"find . -name '*.py' -type f"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 快速、实时</span>
</span><span class="code-line line-number" line="6">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep -r 'class UserService' ."</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 精确定位</span>
</span><span class="code-line line-number" line="7">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"head -n 50 src/services/user.py"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># 按需查看</span>
</span></code></pre>
<p><strong>场景2：日志文件分析</strong></p>
<p>一个运维助手需要分析应用日志：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 检查日志文件大小</span>
</span><span class="code-line line-number" line="2">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"ls -lh /var/log/app.log"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 查看最新的错误日志</span>
</span><span class="code-line line-number" line="5">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"tail -n 100 /var/log/app.log | grep ERROR"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 统计错误类型分布</span>
</span><span class="code-line line-number" line="8">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep ERROR /var/log/app.log | cut -d':' -f3 | sort | uniq -c"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>场景3：数据文件预览</strong></p>
<p>一个数据分析助手需要快速了解数据文件的结构：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 查看 CSV 文件的前几行</span>
</span><span class="code-line line-number" line="2">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"head -n 5 data/sales.csv"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 统计行数</span>
</span><span class="code-line line-number" line="5">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"wc -l data/*.csv"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 查看列名</span>
</span><span class="code-line line-number" line="8">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"head -n 1 data/sales.csv | tr ',' '\n'"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这些场景的共同特点是：<strong>需要实时、轻量级的文件系统访问，而不是预先索引和向量化</strong>。TerminalTool 正是为这种"探索式"工作流设计的。</p>
<p>（2）安全机制详解</p>
<p>允许智能体执行命令是一个强大但危险的能力。TerminalTool 通过多层安全机制确保系统安全：</p>
<p><strong>第一层：命令白名单</strong></p>
<p>只允许安全的只读命令，完全禁止任何可能修改系统的操作：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">ALLOWED_COMMANDS <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">    <span class="token comment"># 文件列表与信息</span>
</span><span class="code-line line-number" line="3">    <span class="token string">'ls'</span><span class="token punctuation">,</span> <span class="token string">'dir'</span><span class="token punctuation">,</span> <span class="token string">'tree'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token comment"># 文件内容查看</span>
</span><span class="code-line line-number" line="5">    <span class="token string">'cat'</span><span class="token punctuation">,</span> <span class="token string">'head'</span><span class="token punctuation">,</span> <span class="token string">'tail'</span><span class="token punctuation">,</span> <span class="token string">'less'</span><span class="token punctuation">,</span> <span class="token string">'more'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    <span class="token comment"># 文件搜索</span>
</span><span class="code-line line-number" line="7">    <span class="token string">'find'</span><span class="token punctuation">,</span> <span class="token string">'grep'</span><span class="token punctuation">,</span> <span class="token string">'egrep'</span><span class="token punctuation">,</span> <span class="token string">'fgrep'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    <span class="token comment"># 文本处理</span>
</span><span class="code-line line-number" line="9">    <span class="token string">'wc'</span><span class="token punctuation">,</span> <span class="token string">'sort'</span><span class="token punctuation">,</span> <span class="token string">'uniq'</span><span class="token punctuation">,</span> <span class="token string">'cut'</span><span class="token punctuation">,</span> <span class="token string">'awk'</span><span class="token punctuation">,</span> <span class="token string">'sed'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    <span class="token comment"># 目录操作</span>
</span><span class="code-line line-number" line="11">    <span class="token string">'pwd'</span><span class="token punctuation">,</span> <span class="token string">'cd'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    <span class="token comment"># 文件信息</span>
</span><span class="code-line line-number" line="13">    <span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token string">'stat'</span><span class="token punctuation">,</span> <span class="token string">'du'</span><span class="token punctuation">,</span> <span class="token string">'df'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    <span class="token comment"># 其他</span>
</span><span class="code-line line-number" line="15">    <span class="token string">'echo'</span><span class="token punctuation">,</span> <span class="token string">'which'</span><span class="token punctuation">,</span> <span class="token string">'whereis'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16"><span class="token punctuation">}</span>
</span></code></pre>
<p>如果智能体尝试执行白名单外的命令，会立即被拒绝：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"rm -rf /"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># ❌ 不允许的命令: rm</span>
</span><span class="code-line line-number" line="3"><span class="token comment"># 允许的命令: cat, cd, cut, dir, du, ...</span>
</span></code></pre>
<p><strong>第二层：工作目录限制(沙箱)</strong></p>
<p>TerminalTool 只能访问指定的工作目录及其子目录，无法访问系统其他部分：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 初始化时指定工作目录</span>
</span><span class="code-line line-number" line="2">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"./project"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 允许:访问工作目录内的文件</span>
</span><span class="code-line line-number" line="5">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cat ./src/main.py"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># ✅</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 禁止:访问工作目录外的文件</span>
</span><span class="code-line line-number" line="8">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cat /etc/passwd"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># ❌ 不允许访问工作目录外的路径</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 禁止:通过 .. 逃逸</span>
</span><span class="code-line line-number" line="11">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cd ../../../etc"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># ❌ 不允许访问工作目录外的路径</span>
</span></code></pre>
<p>这种沙箱机制确保了即使智能体的行为出现异常，也无法影响系统其他部分。</p>
<p><strong>第三层：超时控制</strong></p>
<p>每个命令都有执行时间限制，防止无限循环或资源耗尽：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    workspace<span class="token operator">=</span><span class="token string">"./project"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    timeout<span class="token operator">=</span><span class="token number">30</span>  <span class="token comment"># 30秒超时</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 如果命令执行超过30秒</span>
</span><span class="code-line line-number" line="7">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"find / -name '*.log'"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token comment"># ❌ 命令执行超时（超过 30 秒）</span>
</span></code></pre>
<p><strong>第四层：输出大小限制</strong></p>
<p>限制命令输出的大小，防止内存溢出：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    workspace<span class="token operator">=</span><span class="token string">"./project"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    max_output_size<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span>  <span class="token comment"># 10MB</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 如果输出超过10MB</span>
</span><span class="code-line line-number" line="7">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cat huge_file.log"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token comment"># ... (前10MB的内容) ...</span>
</span><span class="code-line line-number" line="9"><span class="token comment"># ⚠️ 输出被截断（超过 10485760 字节）</span>
</span></code></pre>
<p>通过这四层安全机制，TerminalTool 在提供强大能力的同时，最大程度地保证了系统安全。</p>
<h3>9.5.2 核心功能详解</h3>
<p>TerminalTool 的实现聚焦于两个核心功能：命令执行和目录导航。</p>
<p>（1）命令执行</p>
<p>核心的 <code>_execute_command</code> 方法负责实际执行命令：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_execute_command</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> command<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""执行命令"""</span>
</span><span class="code-line line-number" line="3">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">        <span class="token comment"># 在当前目录下执行命令</span>
</span><span class="code-line line-number" line="5">        result <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">            command<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">            shell<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">            cwd<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_dir<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 在当前工作目录执行</span>
</span><span class="code-line line-number" line="9">            capture_output<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">            text<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">            timeout<span class="token operator">=</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">            env<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">        <span class="token comment"># 合并标准输出和标准错误</span>
</span><span class="code-line line-number" line="16">        output <span class="token operator">=</span> result<span class="token punctuation">.</span>stdout
</span><span class="code-line line-number" line="17">        <span class="token keyword">if</span> result<span class="token punctuation">.</span>stderr<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="18">            output <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"\n[stderr]\n</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">.</span>stderr<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">        <span class="token comment"># 检查输出大小</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>max_output_size<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">            output <span class="token operator">=</span> output<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>max_output_size<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="23">            output <span class="token operator">+=</span> <span class="token string-interpolation"><span class="token string">f"\n\n⚠️ 输出被截断（超过 </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>max_output_size<span class="token punctuation">}</span></span><span class="token string"> 字节）"</span></span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">        <span class="token comment"># 添加返回码信息</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">if</span> result<span class="token punctuation">.</span>returncode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="27">            output <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"⚠️ 命令返回码: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">.</span>returncode<span class="token punctuation">}</span></span><span class="token string">\n\n</span><span class="token interpolation"><span class="token punctuation">{</span>output<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">        <span class="token keyword">return</span> output <span class="token keyword">if</span> output <span class="token keyword">else</span> <span class="token string">"✅ 命令执行成功（无输出）"</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">    <span class="token keyword">except</span> subprocess<span class="token punctuation">.</span>TimeoutExpired<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"❌ 命令执行超时（超过 </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>timeout<span class="token punctuation">}</span></span><span class="token string"> 秒）"</span></span>
</span><span class="code-line line-number" line="33">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="34">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"❌ 命令执行失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span></code></pre>
<p>这个实现的关键点：</p>
<ul>
<li><strong>当前目录感知</strong>：使用 <code>cwd</code> 参数在正确的目录下执行命令</li>
<li><strong>错误处理</strong>：捕获并合并标准错误，提供完整的诊断信息</li>
<li><strong>返回码检查</strong>：非零返回码会被标记为警告</li>
<li><strong>容错设计</strong>：超时和异常都会被妥善处理，不会导致智能体崩溃</li>
</ul>
<p>（2）目录导航</p>
<p><code>cd</code> 命令的特殊处理支持智能体在文件系统中导航：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_handle_cd</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parts<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""处理 cd 命令"""</span>
</span><span class="code-line line-number" line="3">    <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>allow_cd<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">        <span class="token keyword">return</span> <span class="token string">"❌ cd 命令已禁用"</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">        <span class="token comment"># cd 无参数，返回当前目录</span>
</span><span class="code-line line-number" line="8">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"当前目录: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>current_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">    target_dir <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">    <span class="token comment"># 处理相对路径</span>
</span><span class="code-line line-number" line="13">    <span class="token keyword">if</span> target_dir <span class="token operator">==</span> <span class="token string">".."</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">        new_dir <span class="token operator">=</span> self<span class="token punctuation">.</span>current_dir<span class="token punctuation">.</span>parent
</span><span class="code-line line-number" line="15">    <span class="token keyword">elif</span> target_dir <span class="token operator">==</span> <span class="token string">"."</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        new_dir <span class="token operator">=</span> self<span class="token punctuation">.</span>current_dir
</span><span class="code-line line-number" line="17">    <span class="token keyword">elif</span> target_dir <span class="token operator">==</span> <span class="token string">"~"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="18">        new_dir <span class="token operator">=</span> self<span class="token punctuation">.</span>workspace
</span><span class="code-line line-number" line="19">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        new_dir <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>current_dir <span class="token operator">/</span> target_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>resolve<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token comment"># 检查是否在工作目录内</span>
</span><span class="code-line line-number" line="23">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        new_dir<span class="token punctuation">.</span>relative_to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>workspace<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">    <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"❌ 不允许访问工作目录外的路径: </span><span class="token interpolation"><span class="token punctuation">{</span>new_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">    <span class="token comment"># 检查目录是否存在</span>
</span><span class="code-line line-number" line="29">    <span class="token keyword">if</span> <span class="token keyword">not</span> new_dir<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="30">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"❌ 目录不存在: </span><span class="token interpolation"><span class="token punctuation">{</span>new_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32">    <span class="token keyword">if</span> <span class="token keyword">not</span> new_dir<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"❌ 不是目录: </span><span class="token interpolation"><span class="token punctuation">{</span>new_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35">    <span class="token comment"># 更新当前目录</span>
</span><span class="code-line line-number" line="36">    self<span class="token punctuation">.</span>current_dir <span class="token operator">=</span> new_dir
</span><span class="code-line line-number" line="37">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"✅ 切换到目录: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>current_dir<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span></code></pre>
<p>这种设计支持智能体进行多步骤的文件系统探索：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 第一步:查看项目结构</span>
</span><span class="code-line line-number" line="2">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"ls -la"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 第二步:进入源代码目录</span>
</span><span class="code-line line-number" line="5">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cd src"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 第三步:查找特定文件</span>
</span><span class="code-line line-number" line="8">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"find . -name '*service*.py'"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 第四步:查看文件内容</span>
</span><span class="code-line line-number" line="11">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cat user_service.py"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<h3>9.5.3 典型使用模式</h3>
<p>TerminalTool 支持多种常见的文件系统操作模式。</p>
<p>（1）探索式导航</p>
<p>智能体可以像人类开发者一样逐步探索代码库：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> TerminalTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"./my_project"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 第一步:查看项目根目录</span>
</span><span class="code-line line-number" line="6"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"ls -la"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">total 24
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">drwxr-xr-x  6 user  staff   192 Jan 19 16:00 .
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">drwxr-xr-x  5 user  staff   160 Jan 19 15:30 ..
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">-rw-r--r--  1 user  staff  1234 Jan 19 15:30 README.md
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">drwxr-xr-x  4 user  staff   128 Jan 19 15:30 src
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">drwxr-xr-x  3 user  staff    96 Jan 19 15:30 tests
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">-rw-r--r--  1 user  staff   456 Jan 19 15:30 requirements.txt
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token comment"># 第二步:查看源代码目录结构</span>
</span><span class="code-line line-number" line="18">terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"cd src"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"tree"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 第三步:搜索特定模式</span>
</span><span class="code-line line-number" line="22"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep -r 'def process' ."</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p>（2）数据文件分析</p>
<p>快速了解数据文件的结构和内容：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"./data"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 查看 CSV 文件的前几行</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"head -n 5 sales_2024.csv"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">date,product,quantity,revenue
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">2024-01-01,Widget A,150,4500.00
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">2024-01-01,Widget B,200,8000.00
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">2024-01-02,Widget A,180,5400.00
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">2024-01-02,Widget C,120,3600.00
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token comment"># 统计总行数</span>
</span><span class="code-line line-number" line="14"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"wc -l *.csv"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">  10234 sales_2024.csv
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">   8567 sales_2023.csv
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">  18801 total
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 提取和统计产品类别</span>
</span><span class="code-line line-number" line="22"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"tail -n +2 sales_2024.csv | cut -d',' -f2 | sort | uniq -c"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">  3456 Widget A
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">  4123 Widget B
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">  2655 Widget C
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p>（3）日志文件分析</p>
<p>实时分析应用日志，快速定位问题：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"/var/log"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 查看最新的错误日志</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"tail -n 50 app.log | grep ERROR"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 统计错误类型分布</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep ERROR app.log | awk '{print $4}' | sort | uniq -c | sort -rn"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">  245 DatabaseConnectionError
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">  123 TimeoutException
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">   67 ValidationError
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">   34 AuthenticationError
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token comment"># 查找特定时间段的日志</span>
</span><span class="code-line line-number" line="16"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep '2024-01-19 15:' app.log | tail -n 20"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p>（4）代码库分析</p>
<p>辅助代码审查和理解：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">terminal <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string">"./codebase"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 统计代码行数</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"find . -name '*.py' -exec wc -l {} + | tail -n 1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 查找所有 TODO 注释</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep -rn 'TODO' --include='*.py'"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 查找特定函数的定义</span>
</span><span class="code-line line-number" line="10"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep -rn 'def process_data' --include='*.py'"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># 查看函数实现</span>
</span><span class="code-line line-number" line="13"><span class="token keyword">print</span><span class="token punctuation">(</span>terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"sed -n '/def process_data/,/^def /p' src/processor.py | head -n -1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<h3>9.5.4 与其他工具的协同</h3>
<p>TerminalTool 的真正威力在于与 MemoryTool、NoteTool 和 ContextBuilder 的协同使用。</p>
<p>（1）与 MemoryTool 协同</p>
<p>TerminalTool 发现的信息可以存储到记忆系统中：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 使用 TerminalTool 发现项目结构</span>
</span><span class="code-line line-number" line="2">structure <span class="token operator">=</span> terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"tree -L 2 src"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 存储到语义记忆</span>
</span><span class="code-line line-number" line="5">memory_tool<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"add"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"项目结构:\n</span><span class="token interpolation"><span class="token punctuation">{</span>structure<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    memory_type<span class="token operator">=</span><span class="token string">"semantic"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    importance<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"project_structure"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">)</span>
</span></code></pre>
<p>（2）与 NoteTool 协同</p>
<p>重要的发现可以记录为结构化笔记：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 发现一个性能瓶颈</span>
</span><span class="code-line line-number" line="2">log_analysis <span class="token operator">=</span> terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep 'slow query' app.log | tail -n 10"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 记录为 blocker 笔记</span>
</span><span class="code-line line-number" line="5">note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"数据库慢查询问题"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"## 问题描述\n发现多个慢查询,影响系统性能\n\n## 日志分析\n```\n</span><span class="token interpolation"><span class="token punctuation">{</span>log_analysis<span class="token punctuation">}</span></span><span class="token string">\n```\n\n## 下一步\n1. 分析慢查询SQL\n2. 添加索引\n3. 优化查询逻辑"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"blocker"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"performance"</span><span class="token punctuation">,</span> <span class="token string">"database"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p>（3）与 ContextBuilder 协同</p>
<p>TerminalTool 的输出可以作为上下文的一部分：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 探索代码库</span>
</span><span class="code-line line-number" line="2">code_structure <span class="token operator">=</span> terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"ls -R src"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">recent_changes <span class="token operator">=</span> terminal<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"git log --oneline -10"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 转换为 ContextPacket</span>
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>context <span class="token keyword">import</span> ContextPacket
</span><span class="code-line line-number" line="7"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">packets <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="10">    ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="11">        content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"代码库结构:\n</span><span class="token interpolation"><span class="token punctuation">{</span>code_structure<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">        timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        token_count<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>code_structure<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        relevance_score<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">        metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"code_structure"</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"terminal"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="16">    <span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="18">        content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"最近提交:\n</span><span class="token interpolation"><span class="token punctuation">{</span>recent_changes<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">        timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        token_count<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>recent_changes<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">        relevance_score<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">        metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"git_history"</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"terminal"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="23">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24"><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26"><span class="token comment"># 在构建上下文时包含这些信息</span>
</span><span class="code-line line-number" line="27">context <span class="token operator">=</span> context_builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="28">    user_query<span class="token operator">=</span><span class="token string">"如何重构用户服务模块?"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">    custom_packets<span class="token operator">=</span>packets
</span><span class="code-line line-number" line="30"><span class="token punctuation">)</span>
</span></code></pre>
<h2>9.6 长程智能体实战：代码库维护助手</h2>
<p>现在，让我们将 ContextBuilder、NoteTool 和 TerminalTool 整合起来，构建一个完整的长程智能体——<strong>代码库维护助手</strong>。这个助手能够：</p>
<ol>
<li>探索和理解代码库结构</li>
<li>记录发现的问题和改进点</li>
<li>追踪长期的重构任务</li>
<li>在上下文窗口限制下保持连贯性</li>
</ol>
<h3>9.6.1 场景设定与需求分析</h3>
<p><strong>业务场景</strong></p>
<p>假设我们正在维护一个中型 Python Web 应用，这个代码库包含约 50 个 Python 文件，使用 Flask 框架构建，涵盖数据模型、业务逻辑、API 接口等多个模块，同时存在一些技术债务需要逐步清理。在这样的场景下，我们需要一个智能助手来帮助我们探索代码库，理解项目结构、依赖关系和代码风格；识别代码中的问题，比如代码重复、复杂度过高、缺少测试等；追踪任务进度，记录待办事项、已完成工作和遇到的阻塞；并基于历史上下文提供连贯的重构建议。</p>
<p><strong>挑战与解决方案</strong></p>
<p>这个场景面临几个典型的长程任务挑战。首先是信息量超出上下文窗口的问题，整个代码库可能包含数万行代码，无法一次性放入上下文窗口，我们通过使用 TerminalTool 进行即时、按需的代码探索来解决这个问题，只在需要时查看具体文件。其次是跨会话的状态管理挑战，重构任务可能持续数天，需要跨多个会话保持进度，我们使用 NoteTool 记录阶段性进展、待办事项和关键决策来应对。最后是上下文质量与相关性的问题，每次对话需要回顾相关的历史信息，但不能被无关信息淹没，我们通过 ContextBuilder 智能筛选和组织上下文，确保高信号密度。</p>
<h3>9.6.2 系统架构设计</h3>
<p>我们的代码库维护助手采用三层架构，如图9.3所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/9-figures/9-3.png" alt="" width="85%">
  <p>图 9.3 代码库维护助手三层架构</p>
</div>
<h3>9.6.3 核心实现</h3>
<p>现在让我们实现这个系统的核心类：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict， Any<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Optional
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>context <span class="token keyword">import</span> ContextBuilder<span class="token punctuation">,</span> ContextConfig<span class="token punctuation">,</span> ContextPacket
</span><span class="code-line line-number" line="7"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MemoryTool<span class="token punctuation">,</span> NoteTool<span class="token punctuation">,</span> TerminalTool
</span><span class="code-line line-number" line="8"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>core<span class="token punctuation">.</span>message <span class="token keyword">import</span> Message
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">class</span> <span class="token class-name">CodebaseMaintainer</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">    <span class="token triple-quoted-string string">"""代码库维护助手 - 长程智能体示例
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">    整合 ContextBuilder + NoteTool + TerminalTool + MemoryTool
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">    实现跨会话的代码库维护任务管理
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        project_name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">        codebase_path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">        llm<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>HelloAgentsLLM<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="23">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        self<span class="token punctuation">.</span>project_name <span class="token operator">=</span> project_name
</span><span class="code-line line-number" line="25">        self<span class="token punctuation">.</span>codebase_path <span class="token operator">=</span> codebase_path
</span><span class="code-line line-number" line="26">        self<span class="token punctuation">.</span>session_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"session_</span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">        <span class="token comment"># 初始化 LLM</span>
</span><span class="code-line line-number" line="29">        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm <span class="token keyword">or</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">        <span class="token comment"># 初始化工具</span>
</span><span class="code-line line-number" line="32">        self<span class="token punctuation">.</span>memory_tool <span class="token operator">=</span> MemoryTool<span class="token punctuation">(</span>user_id<span class="token operator">=</span>project_name<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">        self<span class="token punctuation">.</span>note_tool <span class="token operator">=</span> NoteTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"./</span><span class="token interpolation"><span class="token punctuation">{</span>project_name<span class="token punctuation">}</span></span><span class="token string">_notes"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">        self<span class="token punctuation">.</span>terminal_tool <span class="token operator">=</span> TerminalTool<span class="token punctuation">(</span>workspace<span class="token operator">=</span>codebase_path<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">
</span><span class="code-line line-number" line="36">        <span class="token comment"># 初始化上下文构建器</span>
</span><span class="code-line line-number" line="37">        self<span class="token punctuation">.</span>context_builder <span class="token operator">=</span> ContextBuilder<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="38">            memory_tool<span class="token operator">=</span>self<span class="token punctuation">.</span>memory_tool<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="39">            rag_tool<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 本案例不使用 RAG</span>
</span><span class="code-line line-number" line="40">            config<span class="token operator">=</span>ContextConfig<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="41">                max_tokens<span class="token operator">=</span><span class="token number">4000</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="42">                reserve_ratio<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="43">                min_relevance<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="44">                enable_compression<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="45">            <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">
</span><span class="code-line line-number" line="48">        <span class="token comment"># 对话历史</span>
</span><span class="code-line line-number" line="49">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Message<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="50">
</span><span class="code-line line-number" line="51">        <span class="token comment"># 统计信息</span>
</span><span class="code-line line-number" line="52">        self<span class="token punctuation">.</span>stats <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="53">            <span class="token string">"session_start"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="54">            <span class="token string">"commands_executed"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="55">            <span class="token string">"notes_created"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="56">            <span class="token string">"issues_found"</span><span class="token punctuation">:</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="57">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="58">
</span><span class="code-line line-number" line="59">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 代码库维护助手已初始化: </span><span class="token interpolation"><span class="token punctuation">{</span>project_name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="60">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📁 工作目录: </span><span class="token interpolation"><span class="token punctuation">{</span>codebase_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="61">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🆔 会话ID: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>session_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="62">
</span><span class="code-line line-number" line="63">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> mode<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"auto"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="64">        <span class="token triple-quoted-string string">"""运行助手
</span></span><span class="code-line line-number" line="65"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="66"><span class="token triple-quoted-string string">        Args:
</span></span><span class="code-line line-number" line="67"><span class="token triple-quoted-string string">            user_input: 用户输入
</span></span><span class="code-line line-number" line="68"><span class="token triple-quoted-string string">            mode: 运行模式
</span></span><span class="code-line line-number" line="69"><span class="token triple-quoted-string string">                - "auto": 自动决策是否使用工具
</span></span><span class="code-line line-number" line="70"><span class="token triple-quoted-string string">                - "explore": 侧重代码探索
</span></span><span class="code-line line-number" line="71"><span class="token triple-quoted-string string">                - "analyze": 侧重问题分析
</span></span><span class="code-line line-number" line="72"><span class="token triple-quoted-string string">                - "plan": 侧重任务规划
</span></span><span class="code-line line-number" line="73"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="74"><span class="token triple-quoted-string string">        Returns:
</span></span><span class="code-line line-number" line="75"><span class="token triple-quoted-string string">            str: 助手的回答
</span></span><span class="code-line line-number" line="76"><span class="token triple-quoted-string string">        """</span>
</span><span class="code-line line-number" line="77">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">'='</span><span class="token operator">*</span><span class="token number">80</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="78">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"👤 用户: </span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="79">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">'='</span><span class="token operator">*</span><span class="token number">80</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="80">
</span><span class="code-line line-number" line="81">        <span class="token comment"># 第一步:根据模式执行预处理</span>
</span><span class="code-line line-number" line="82">        pre_context <span class="token operator">=</span> self<span class="token punctuation">.</span>_preprocess_by_mode<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="83">
</span><span class="code-line line-number" line="84">        <span class="token comment"># 第二步:检索相关笔记</span>
</span><span class="code-line line-number" line="85">        relevant_notes <span class="token operator">=</span> self<span class="token punctuation">.</span>_retrieve_relevant_notes<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="86">        note_packets <span class="token operator">=</span> self<span class="token punctuation">.</span>_notes_to_packets<span class="token punctuation">(</span>relevant_notes<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="87">
</span><span class="code-line line-number" line="88">        <span class="token comment"># 第三步:构建优化的上下文</span>
</span><span class="code-line line-number" line="89">        context <span class="token operator">=</span> self<span class="token punctuation">.</span>context_builder<span class="token punctuation">.</span>build<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="90">            user_query<span class="token operator">=</span>user_input<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="91">            conversation_history<span class="token operator">=</span>self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="92">            system_instructions<span class="token operator">=</span>self<span class="token punctuation">.</span>_build_system_instructions<span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="93">            custom_packets<span class="token operator">=</span>note_packets <span class="token operator">+</span> pre_context
</span><span class="code-line line-number" line="94">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="95">
</span><span class="code-line line-number" line="96">        <span class="token comment"># 第四步:调用 LLM</span>
</span><span class="code-line line-number" line="97">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"🤖 正在思考..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="98">        response <span class="token operator">=</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span>context<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="99">
</span><span class="code-line line-number" line="100">        <span class="token comment"># 第五步:后处理</span>
</span><span class="code-line line-number" line="101">        self<span class="token punctuation">.</span>_postprocess_response<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="102">
</span><span class="code-line line-number" line="103">        <span class="token comment"># 第六步:更新对话历史</span>
</span><span class="code-line line-number" line="104">        self<span class="token punctuation">.</span>_update_history<span class="token punctuation">(</span>user_input<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="105">
</span><span class="code-line line-number" line="106">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n🤖 助手: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="107">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">'='</span><span class="token operator">*</span><span class="token number">80</span><span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="108">
</span><span class="code-line line-number" line="109">        <span class="token keyword">return</span> response
</span><span class="code-line line-number" line="110">
</span><span class="code-line line-number" line="111">    <span class="token keyword">def</span> <span class="token function">_preprocess_by_mode</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="112">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="113">        user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="114">        mode<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="115">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="116">        <span class="token triple-quoted-string string">"""根据模式执行预处理,收集相关信息"""</span>
</span><span class="code-line line-number" line="117">        packets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="118">
</span><span class="code-line line-number" line="119">        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">"explore"</span> <span class="token keyword">or</span> mode <span class="token operator">==</span> <span class="token string">"auto"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="120">            <span class="token comment"># 探索模式:自动查看项目结构</span>
</span><span class="code-line line-number" line="121">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"🔍 探索代码库结构..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="122">
</span><span class="code-line line-number" line="123">            structure <span class="token operator">=</span> self<span class="token punctuation">.</span>terminal_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"find . -type f -name '*.py' | head -n 20"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="124">            self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"commands_executed"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="125">
</span><span class="code-line line-number" line="126">            packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="127">                content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"[代码库结构]\n</span><span class="token interpolation"><span class="token punctuation">{</span>structure<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="128">                timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="129">                token_count<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>structure<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="130">                relevance_score<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="131">                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"code_structure"</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"terminal"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="132">            <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="133">
</span><span class="code-line line-number" line="134">        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">"analyze"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="135">            <span class="token comment"># 分析模式:检查代码复杂度和问题</span>
</span><span class="code-line line-number" line="136">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📊 分析代码质量..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="137">
</span><span class="code-line line-number" line="138">            <span class="token comment"># 统计代码行数</span>
</span><span class="code-line line-number" line="139">            loc <span class="token operator">=</span> self<span class="token punctuation">.</span>terminal_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"find . -name '*.py' -exec wc -l {} + | tail -n 1"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="140">
</span><span class="code-line line-number" line="141">            <span class="token comment"># 查找 TODO 和 FIXME</span>
</span><span class="code-line line-number" line="142">            todos <span class="token operator">=</span> self<span class="token punctuation">.</span>terminal_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"grep -rn 'TODO\\|FIXME' --include='*.py' | head -n 10"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="143">
</span><span class="code-line line-number" line="144">            self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"commands_executed"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">2</span>
</span><span class="code-line line-number" line="145">
</span><span class="code-line line-number" line="146">            packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="147">                content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"[代码统计]\n</span><span class="token interpolation"><span class="token punctuation">{</span>loc<span class="token punctuation">}</span></span><span class="token string">\n\n[待办事项]\n</span><span class="token interpolation"><span class="token punctuation">{</span>todos<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="148">                timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="149">                token_count<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>loc<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token builtin">len</span><span class="token punctuation">(</span>todos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="150">                relevance_score<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="151">                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"code_analysis"</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"terminal"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="152">            <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="153">
</span><span class="code-line line-number" line="154">        <span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">"plan"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="155">            <span class="token comment"># 规划模式:加载最近的笔记</span>
</span><span class="code-line line-number" line="156">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📋 加载任务规划..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="157">
</span><span class="code-line line-number" line="158">            task_notes <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="159">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"list"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="160">                <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"task_state"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="161">                <span class="token string">"limit"</span><span class="token punctuation">:</span> <span class="token number">3</span>
</span><span class="code-line line-number" line="162">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="163">
</span><span class="code-line line-number" line="164">            <span class="token keyword">if</span> task_notes<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="165">                content <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"- </span><span class="token interpolation"><span class="token punctuation">{</span>note<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> note <span class="token keyword">in</span> task_notes<span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="166">                packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="167">                    content<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"[当前任务]\n</span><span class="token interpolation"><span class="token punctuation">{</span>content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="168">                    timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="169">                    token_count<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="170">                    relevance_score<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="171">                    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"task_plan"</span><span class="token punctuation">,</span> <span class="token string">"source"</span><span class="token punctuation">:</span> <span class="token string">"notes"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="172">                <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="173">
</span><span class="code-line line-number" line="174">        <span class="token keyword">return</span> packets
</span><span class="code-line line-number" line="175">
</span><span class="code-line line-number" line="176">    <span class="token keyword">def</span> <span class="token function">_retrieve_relevant_notes</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> limit<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="177">        <span class="token triple-quoted-string string">"""检索相关笔记"""</span>
</span><span class="code-line line-number" line="178">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="179">            <span class="token comment"># 优先检索 blocker</span>
</span><span class="code-line line-number" line="180">            blockers <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="181">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"list"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="182">                <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"blocker"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="183">                <span class="token string">"limit"</span><span class="token punctuation">:</span> <span class="token number">2</span>
</span><span class="code-line line-number" line="184">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="185">
</span><span class="code-line line-number" line="186">            <span class="token comment"># 搜索相关笔记</span>
</span><span class="code-line line-number" line="187">            search_results <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="188">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="189">                <span class="token string">"query"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="190">                <span class="token string">"limit"</span><span class="token punctuation">:</span> limit
</span><span class="code-line line-number" line="191">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="192">
</span><span class="code-line line-number" line="193">            <span class="token comment"># 合并去重</span>
</span><span class="code-line line-number" line="194">            all_notes <span class="token operator">=</span> <span class="token punctuation">{</span>note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'note_id'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span><span class="token punctuation">:</span> note <span class="token keyword">for</span> note <span class="token keyword">in</span> <span class="token punctuation">(</span>blockers <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>search_results <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="195">            <span class="token keyword">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span>all_notes<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>limit<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="196">
</span><span class="code-line line-number" line="197">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="198">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 笔记检索失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="199">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="200">
</span><span class="code-line line-number" line="201">    <span class="token keyword">def</span> <span class="token function">_notes_to_packets</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> notes<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>ContextPacket<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="202">        <span class="token triple-quoted-string string">"""将笔记转换为上下文包"""</span>
</span><span class="code-line line-number" line="203">        packets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="204">
</span><span class="code-line line-number" line="205">        <span class="token keyword">for</span> note <span class="token keyword">in</span> notes<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="206">            <span class="token comment"># 根据笔记类型设置不同的相关性分数</span>
</span><span class="code-line line-number" line="207">            relevance_map <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="208">                <span class="token string">"blocker"</span><span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="209">                <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token number">0.8</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="210">                <span class="token string">"task_state"</span><span class="token punctuation">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="211">                <span class="token string">"conclusion"</span><span class="token punctuation">:</span> <span class="token number">0.7</span>
</span><span class="code-line line-number" line="212">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="213">
</span><span class="code-line line-number" line="214">            note_type <span class="token operator">=</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'general'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="215">            relevance <span class="token operator">=</span> relevance_map<span class="token punctuation">.</span>get<span class="token punctuation">(</span>note_type<span class="token punctuation">,</span> <span class="token number">0.6</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="216">
</span><span class="code-line line-number" line="217">            content <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"[笔记:</span><span class="token interpolation"><span class="token punctuation">{</span>note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'Untitled'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">]\n类型: </span><span class="token interpolation"><span class="token punctuation">{</span>note_type<span class="token punctuation">}</span></span><span class="token string">\n\n</span><span class="token interpolation"><span class="token punctuation">{</span>note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="218">
</span><span class="code-line line-number" line="219">            packets<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ContextPacket<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="220">                content<span class="token operator">=</span>content<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="221">                timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>fromisoformat<span class="token punctuation">(</span>note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'updated_at'</span><span class="token punctuation">,</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="222">                token_count<span class="token operator">=</span><span class="token builtin">len</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="223">                relevance_score<span class="token operator">=</span>relevance<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="224">                metadata<span class="token operator">=</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="225">                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"note"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="226">                    <span class="token string">"note_type"</span><span class="token punctuation">:</span> note_type<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="227">                    <span class="token string">"note_id"</span><span class="token punctuation">:</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'note_id'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> note<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="228">                <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="229">            <span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="230">
</span><span class="code-line line-number" line="231">        <span class="token keyword">return</span> packets
</span><span class="code-line line-number" line="232">
</span><span class="code-line line-number" line="233">    <span class="token keyword">def</span> <span class="token function">_build_system_instructions</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="234">        <span class="token triple-quoted-string string">"""构建系统指令"""</span>
</span><span class="code-line line-number" line="235">        base_instructions <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""你是 </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">}</span></span><span class="token string"> 项目的代码库维护助手。
</span></span></span><span class="code-line line-number" line="236"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="237"><span class="token string-interpolation"><span class="token string">你的核心能力:
</span></span></span><span class="code-line line-number" line="238"><span class="token string-interpolation"><span class="token string">1. 使用 TerminalTool 探索代码库(ls, cat, grep, find等)
</span></span></span><span class="code-line line-number" line="239"><span class="token string-interpolation"><span class="token string">2. 使用 NoteTool 记录发现和任务
</span></span></span><span class="code-line line-number" line="240"><span class="token string-interpolation"><span class="token string">3. 基于历史笔记提供连贯的建议
</span></span></span><span class="code-line line-number" line="241"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="242"><span class="token string-interpolation"><span class="token string">当前会话ID: </span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>session_id<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="243"><span class="token string-interpolation"><span class="token string">"""</span></span>
</span><span class="code-line line-number" line="244">
</span><span class="code-line line-number" line="245">        mode_specific <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="246">            <span class="token string">"explore"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="247"><span class="token triple-quoted-string string">当前模式: 探索代码库
</span></span><span class="code-line line-number" line="248"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="249"><span class="token triple-quoted-string string">你应该:
</span></span><span class="code-line line-number" line="250"><span class="token triple-quoted-string string">- 主动使用 terminal 命令了解代码结构
</span></span><span class="code-line line-number" line="251"><span class="token triple-quoted-string string">- 识别关键模块和文件
</span></span><span class="code-line line-number" line="252"><span class="token triple-quoted-string string">- 记录项目架构到笔记
</span></span><span class="code-line line-number" line="253"><span class="token triple-quoted-string string">"""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="254">            <span class="token string">"analyze"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="255"><span class="token triple-quoted-string string">当前模式: 分析代码质量
</span></span><span class="code-line line-number" line="256"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="257"><span class="token triple-quoted-string string">你应该:
</span></span><span class="code-line line-number" line="258"><span class="token triple-quoted-string string">- 查找代码问题(重复、复杂度、TODO等)
</span></span><span class="code-line line-number" line="259"><span class="token triple-quoted-string string">- 评估代码质量
</span></span><span class="code-line line-number" line="260"><span class="token triple-quoted-string string">- 将发现的问题记录为 blocker 或 action 笔记
</span></span><span class="code-line line-number" line="261"><span class="token triple-quoted-string string">"""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="262">            <span class="token string">"plan"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="263"><span class="token triple-quoted-string string">当前模式: 任务规划
</span></span><span class="code-line line-number" line="264"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="265"><span class="token triple-quoted-string string">你应该:
</span></span><span class="code-line line-number" line="266"><span class="token triple-quoted-string string">- 回顾历史笔记和任务
</span></span><span class="code-line line-number" line="267"><span class="token triple-quoted-string string">- 制定下一步行动计划
</span></span><span class="code-line line-number" line="268"><span class="token triple-quoted-string string">- 更新任务状态笔记
</span></span><span class="code-line line-number" line="269"><span class="token triple-quoted-string string">"""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="270">            <span class="token string">"auto"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="271"><span class="token triple-quoted-string string">当前模式: 自动决策
</span></span><span class="code-line line-number" line="272"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="273"><span class="token triple-quoted-string string">你应该:
</span></span><span class="code-line line-number" line="274"><span class="token triple-quoted-string string">- 根据用户需求灵活选择策略
</span></span><span class="code-line line-number" line="275"><span class="token triple-quoted-string string">- 在需要时使用工具
</span></span><span class="code-line line-number" line="276"><span class="token triple-quoted-string string">- 保持回答的专业性和实用性
</span></span><span class="code-line line-number" line="277"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="278">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="279">
</span><span class="code-line line-number" line="280">        <span class="token keyword">return</span> base_instructions <span class="token operator">+</span> mode_specific<span class="token punctuation">.</span>get<span class="token punctuation">(</span>mode<span class="token punctuation">,</span> mode_specific<span class="token punctuation">[</span><span class="token string">"auto"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="281">
</span><span class="code-line line-number" line="282">    <span class="token keyword">def</span> <span class="token function">_postprocess_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="283">        <span class="token triple-quoted-string string">"""后处理:分析回答,自动记录重要信息"""</span>
</span><span class="code-line line-number" line="284">
</span><span class="code-line line-number" line="285">        <span class="token comment"># 如果发现问题,自动创建 blocker 笔记</span>
</span><span class="code-line line-number" line="286">        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>keyword <span class="token keyword">in</span> response<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> keyword <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"问题"</span><span class="token punctuation">,</span> <span class="token string">"bug"</span><span class="token punctuation">,</span> <span class="token string">"错误"</span><span class="token punctuation">,</span> <span class="token string">"阻塞"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="287">            <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="288">                self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="289">                    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="290">                    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"发现问题: </span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">30]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="291">                    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"## 用户输入\n</span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">}</span></span><span class="token string">\n\n## 问题分析\n</span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">500]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="292">                    <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"blocker"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="293">                    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> <span class="token string">"auto_detected"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>session_id<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="294">                <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="295">                self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"notes_created"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="296">                self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"issues_found"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="297">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📝 已自动创建问题笔记"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="298">            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="299">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 创建笔记失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="300">
</span><span class="code-line line-number" line="301">        <span class="token comment"># 如果是任务规划,自动创建 action 笔记</span>
</span><span class="code-line line-number" line="302">        <span class="token keyword">elif</span> <span class="token builtin">any</span><span class="token punctuation">(</span>keyword <span class="token keyword">in</span> user_input<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> keyword <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"计划"</span><span class="token punctuation">,</span> <span class="token string">"下一步"</span><span class="token punctuation">,</span> <span class="token string">"任务"</span><span class="token punctuation">,</span> <span class="token string">"todo"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="303">            <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="304">                self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="305">                    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="306">                    <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"任务规划: </span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">30]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="307">                    <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"## 讨论\n</span><span class="token interpolation"><span class="token punctuation">{</span>user_input<span class="token punctuation">}</span></span><span class="token string">\n\n## 行动计划\n</span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">500]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="308">                    <span class="token string">"note_type"</span><span class="token punctuation">:</span> <span class="token string">"action"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="309">                    <span class="token string">"tags"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span> <span class="token string">"planning"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>session_id<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="310">                <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="311">                self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"notes_created"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="312">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📝 已自动创建行动计划笔记"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="313">            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="314">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[WARNING] 创建笔记失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="315">
</span><span class="code-line line-number" line="316">    <span class="token keyword">def</span> <span class="token function">_update_history</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> user_input<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="317">        <span class="token triple-quoted-string string">"""更新对话历史"""</span>
</span><span class="code-line line-number" line="318">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="319">            Message<span class="token punctuation">(</span>content<span class="token operator">=</span>user_input<span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="320">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="321">        self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="322">            Message<span class="token punctuation">(</span>content<span class="token operator">=</span>response<span class="token punctuation">,</span> role<span class="token operator">=</span><span class="token string">"assistant"</span><span class="token punctuation">,</span> timestamp<span class="token operator">=</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="323">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="324">
</span><span class="code-line line-number" line="325">        <span class="token comment"># 限制历史长度(保留最近10轮对话)</span>
</span><span class="code-line line-number" line="326">        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="327">            self<span class="token punctuation">.</span>conversation_history <span class="token operator">=</span> self<span class="token punctuation">.</span>conversation_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="328">
</span><span class="code-line line-number" line="329">    <span class="token comment"># === 便捷方法 ===</span>
</span><span class="code-line line-number" line="330">
</span><span class="code-line line-number" line="331">    <span class="token keyword">def</span> <span class="token function">explore</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> target<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="332">        <span class="token triple-quoted-string string">"""探索代码库"""</span>
</span><span class="code-line line-number" line="333">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"请探索 </span><span class="token interpolation"><span class="token punctuation">{</span>target<span class="token punctuation">}</span></span><span class="token string"> 的代码结构"</span></span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"explore"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="334">
</span><span class="code-line line-number" line="335">    <span class="token keyword">def</span> <span class="token function">analyze</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> focus<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="336">        <span class="token triple-quoted-string string">"""分析代码质量"""</span>
</span><span class="code-line line-number" line="337">        query <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"请分析代码质量"</span></span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f",重点关注</span><span class="token interpolation"><span class="token punctuation">{</span>focus<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">if</span> focus <span class="token keyword">else</span> <span class="token string">""</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="338">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>run<span class="token punctuation">(</span>query<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"analyze"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="339">
</span><span class="code-line line-number" line="340">    <span class="token keyword">def</span> <span class="token function">plan_next_steps</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="341">        <span class="token triple-quoted-string string">"""规划下一步任务"""</span>
</span><span class="code-line line-number" line="342">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"根据当前进度,规划下一步任务"</span><span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"plan"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="343">
</span><span class="code-line line-number" line="344">    <span class="token keyword">def</span> <span class="token function">execute_command</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> command<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="345">        <span class="token triple-quoted-string string">"""执行终端命令"""</span>
</span><span class="code-line line-number" line="346">        result <span class="token operator">=</span> self<span class="token punctuation">.</span>terminal_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"command"</span><span class="token punctuation">:</span> command<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="347">        self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"commands_executed"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="348">        <span class="token keyword">return</span> result
</span><span class="code-line line-number" line="349">
</span><span class="code-line line-number" line="350">    <span class="token keyword">def</span> <span class="token function">create_note</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="351">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="352">        title<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="353">        content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="354">        note_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"general"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="355">        tags<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="356">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="357">        <span class="token triple-quoted-string string">"""创建笔记"""</span>
</span><span class="code-line line-number" line="358">        result <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="359">            <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"create"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="360">            <span class="token string">"title"</span><span class="token punctuation">:</span> title<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="361">            <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="362">            <span class="token string">"note_type"</span><span class="token punctuation">:</span> note_type<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="363">            <span class="token string">"tags"</span><span class="token punctuation">:</span> tags <span class="token keyword">or</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>project_name<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="364">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="365">        self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"notes_created"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="366">        <span class="token keyword">return</span> result
</span><span class="code-line line-number" line="367">
</span><span class="code-line line-number" line="368">    <span class="token keyword">def</span> <span class="token function">get_stats</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="369">        <span class="token triple-quoted-string string">"""获取统计信息"""</span>
</span><span class="code-line line-number" line="370">        duration <span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"session_start"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="371">
</span><span class="code-line line-number" line="372">        <span class="token comment"># 获取笔记摘要</span>
</span><span class="code-line line-number" line="373">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="374">            note_summary <span class="token operator">=</span> self<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"summary"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="375">        <span class="token keyword">except</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="376">            note_summary <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="377">
</span><span class="code-line line-number" line="378">        <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="379">            <span class="token string">"session_info"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="380">                <span class="token string">"session_id"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>session_id<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="381">                <span class="token string">"project"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>project_name<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="382">                <span class="token string">"duration_seconds"</span><span class="token punctuation">:</span> duration
</span><span class="code-line line-number" line="383">            <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="384">            <span class="token string">"activity"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="385">                <span class="token string">"commands_executed"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"commands_executed"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="386">                <span class="token string">"notes_created"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"notes_created"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="387">                <span class="token string">"issues_found"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>stats<span class="token punctuation">[</span><span class="token string">"issues_found"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="388">            <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="389">            <span class="token string">"notes"</span><span class="token punctuation">:</span> note_summary
</span><span class="code-line line-number" line="390">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="391">
</span><span class="code-line line-number" line="392">    <span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> save_to_file<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="393">        <span class="token triple-quoted-string string">"""生成会话报告"""</span>
</span><span class="code-line line-number" line="394">        report <span class="token operator">=</span> self<span class="token punctuation">.</span>get_stats<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="395">
</span><span class="code-line line-number" line="396">        <span class="token keyword">if</span> save_to_file<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="397">            report_file <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"maintainer_report_</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>session_id<span class="token punctuation">}</span></span><span class="token string">.json"</span></span>
</span><span class="code-line line-number" line="398">            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>report_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="399">                json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>report<span class="token punctuation">,</span> f<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="400">            report<span class="token punctuation">[</span><span class="token string">"report_file"</span><span class="token punctuation">]</span> <span class="token operator">=</span> report_file
</span><span class="code-line line-number" line="401">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📄 报告已保存: </span><span class="token interpolation"><span class="token punctuation">{</span>report_file<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="402">
</span><span class="code-line line-number" line="403">        <span class="token keyword">return</span> report
</span></code></pre>
<h3>9.6.4 完整使用示例</h3>
<p>现在让我们通过一个完整的使用场景，展示这个长程智能体的工作流程：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># ========== 初始化助手 ==========</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> HelloAgentsLLM
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">maintainer <span class="token operator">=</span> CodebaseMaintainer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">    project_name<span class="token operator">=</span><span class="token string">"my_flask_app"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    codebase_path<span class="token operator">=</span><span class="token string">"./my_flask_app"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># ========== 第一天:探索代码库 ==========</span>
</span><span class="code-line line-number" line="13"><span class="token comment"># 1. 初步探索</span>
</span><span class="code-line line-number" line="14">response <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>explore<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">🔍 探索代码库结构...
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">🤖 正在思考...
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">🤖 助手: 我已经扫描了代码库,这是一个 Flask Web 应用,主要包含以下模块:
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">📁 项目结构:
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">- app/
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">  ├── models/      # 数据模型(User, Product, Order等)
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">  ├── routes/      # API路由
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">  ├── services/    # 业务逻辑
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">  └── utils/       # 工具函数
</span></span><span class="code-line line-number" line="27"><span class="token triple-quoted-string string">- tests/           # 测试文件
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">- migrations/      # 数据库迁移
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">- config.py        # 配置文件
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">总计约 3,500 行 Python 代码。
</span></span><span class="code-line line-number" line="32"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">建议下一步:
</span></span><span class="code-line line-number" line="34"><span class="token triple-quoted-string string">1. 查看核心模型定义
</span></span><span class="code-line line-number" line="35"><span class="token triple-quoted-string string">2. 检查路由和API设计
</span></span><span class="code-line line-number" line="36"><span class="token triple-quoted-string string">3. 评估测试覆盖率
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39"><span class="token comment"># 2. 深入分析某个模块</span>
</span><span class="code-line line-number" line="40">response <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"请分析 app/models/ 目录下的数据模型设计"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="42"><span class="token triple-quoted-string string">🤖 助手: 我查看了 app/models/ 目录,发现以下数据模型:
</span></span><span class="code-line line-number" line="43"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="44"><span class="token triple-quoted-string string">1. User (user.py)
</span></span><span class="code-line line-number" line="45"><span class="token triple-quoted-string string">   - 字段: id, username, email, password_hash, created_at
</span></span><span class="code-line line-number" line="46"><span class="token triple-quoted-string string">   - 关系: 一对多 Order
</span></span><span class="code-line line-number" line="47"><span class="token triple-quoted-string string">   - 问题: ⚠️ 缺少索引,email 字段未设置唯一约束
</span></span><span class="code-line line-number" line="48"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="49"><span class="token triple-quoted-string string">2. Product (product.py)
</span></span><span class="code-line line-number" line="50"><span class="token triple-quoted-string string">   - 字段: id, name, description, price, stock
</span></span><span class="code-line line-number" line="51"><span class="token triple-quoted-string string">   - 问题: ✅ 设计合理
</span></span><span class="code-line line-number" line="52"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="53"><span class="token triple-quoted-string string">3. Order (order.py)
</span></span><span class="code-line line-number" line="54"><span class="token triple-quoted-string string">   - 字段: id, user_id, product_id, quantity, status
</span></span><span class="code-line line-number" line="55"><span class="token triple-quoted-string string">   - 问题: ⚠️ 缺少创建时间字段,不利于数据分析
</span></span><span class="code-line line-number" line="56"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="57"><span class="token triple-quoted-string string">建议:
</span></span><span class="code-line line-number" line="58"><span class="token triple-quoted-string string">1. 为 User.email 添加唯一约束
</span></span><span class="code-line line-number" line="59"><span class="token triple-quoted-string string">2. 为 Order 添加 created_at 和 updated_at 字段
</span></span><span class="code-line line-number" line="60"><span class="token triple-quoted-string string">3. 考虑添加软删除支持
</span></span><span class="code-line line-number" line="61"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="62"><span class="token triple-quoted-string string">我已将这些问题记录为 blocker 笔记。
</span></span><span class="code-line line-number" line="63"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="64"><span class="token comment"># [自动创建了 blocker 笔记]</span>
</span><span class="code-line line-number" line="65">
</span><span class="code-line line-number" line="66">
</span><span class="code-line line-number" line="67"><span class="token comment"># ========== 第二天:分析代码质量 ==========</span>
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69"><span class="token comment"># 1. 整体质量分析</span>
</span><span class="code-line line-number" line="70">response <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>analyze<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="71"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="72"><span class="token triple-quoted-string string">📊 分析代码质量...
</span></span><span class="code-line line-number" line="73"><span class="token triple-quoted-string string">🤖 正在思考...
</span></span><span class="code-line line-number" line="74"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="75"><span class="token triple-quoted-string string">🤖 助手: 代码质量分析报告:
</span></span><span class="code-line line-number" line="76"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="77"><span class="token triple-quoted-string string">📊 代码统计:
</span></span><span class="code-line line-number" line="78"><span class="token triple-quoted-string string">- 总行数: 3,542 行
</span></span><span class="code-line line-number" line="79"><span class="token triple-quoted-string string">- 平均文件长度: 约 150 行
</span></span><span class="code-line line-number" line="80"><span class="token triple-quoted-string string">- 最大文件: services/order_service.py (456 行)
</span></span><span class="code-line line-number" line="81"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="82"><span class="token triple-quoted-string string">⚠️ 发现的问题:
</span></span><span class="code-line line-number" line="83"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="84"><span class="token triple-quoted-string string">1. 代码重复 (HIGH):
</span></span><span class="code-line line-number" line="85"><span class="token triple-quoted-string string">   - user_service.py 和 product_service.py 有相似的 CRUD 逻辑
</span></span><span class="code-line line-number" line="86"><span class="token triple-quoted-string string">   - 建议: 提取基类 BaseService
</span></span><span class="code-line line-number" line="87"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="88"><span class="token triple-quoted-string string">2. 复杂度过高 (MEDIUM):
</span></span><span class="code-line line-number" line="89"><span class="token triple-quoted-string string">   - order_service.py::process_order 方法有 8 层嵌套
</span></span><span class="code-line line-number" line="90"><span class="token triple-quoted-string string">   - 建议: 拆分为多个小方法
</span></span><span class="code-line line-number" line="91"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="92"><span class="token triple-quoted-string string">3. 缺少测试 (HIGH):
</span></span><span class="code-line line-number" line="93"><span class="token triple-quoted-string string">   - 测试覆盖率仅 45%
</span></span><span class="code-line line-number" line="94"><span class="token triple-quoted-string string">   - services/ 目录完全没有测试
</span></span><span class="code-line line-number" line="95"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="96"><span class="token triple-quoted-string string">4. TODO/FIXME (12 个):
</span></span><span class="code-line line-number" line="97"><span class="token triple-quoted-string string">   - 大部分是"稍后优化"类的注释
</span></span><span class="code-line line-number" line="98"><span class="token triple-quoted-string string">   - 建议: 清理或转化为正式任务
</span></span><span class="code-line line-number" line="99"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="100"><span class="token triple-quoted-string string">我已将这些问题记录为笔记,并标记优先级。
</span></span><span class="code-line line-number" line="101"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="102"><span class="token comment"># [自动创建了多个 blocker 笔记]</span>
</span><span class="code-line line-number" line="103">
</span><span class="code-line line-number" line="104"><span class="token comment"># 2. 查看具体问题</span>
</span><span class="code-line line-number" line="105">response <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"请查看 order_service.py 的 process_order 方法,给出重构建议"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="106"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="107"><span class="token triple-quoted-string string">🤖 助手: 我查看了 process_order 方法的代码:
</span></span><span class="code-line line-number" line="108"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="109"><span class="token triple-quoted-string string">【原始代码】
</span></span><span class="code-line line-number" line="110"><span class="token triple-quoted-string string">def process_order(self, order_id):
</span></span><span class="code-line line-number" line="111"><span class="token triple-quoted-string string">    order = Order.query.get(order_id)
</span></span><span class="code-line line-number" line="112"><span class="token triple-quoted-string string">    if order:
</span></span><span class="code-line line-number" line="113"><span class="token triple-quoted-string string">        if order.status == 'pending':
</span></span><span class="code-line line-number" line="114"><span class="token triple-quoted-string string">            product = Product.query.get(order.product_id)
</span></span><span class="code-line line-number" line="115"><span class="token triple-quoted-string string">            if product:
</span></span><span class="code-line line-number" line="116"><span class="token triple-quoted-string string">                if product.stock &gt;= order.quantity:
</span></span><span class="code-line line-number" line="117"><span class="token triple-quoted-string string">                    # ... 8 层嵌套继续 ...
</span></span><span class="code-line line-number" line="118"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="119"><span class="token triple-quoted-string string">【问题分析】
</span></span><span class="code-line line-number" line="120"><span class="token triple-quoted-string string">1. 过深的嵌套导致可读性差
</span></span><span class="code-line line-number" line="121"><span class="token triple-quoted-string string">2. 缺少错误处理
</span></span><span class="code-line line-number" line="122"><span class="token triple-quoted-string string">3. 业务逻辑与数据访问混在一起
</span></span><span class="code-line line-number" line="123"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="124"><span class="token triple-quoted-string string">【重构建议】
</span></span><span class="code-line line-number" line="125"><span class="token triple-quoted-string string">def process_order(self, order_id):
</span></span><span class="code-line line-number" line="126"><span class="token triple-quoted-string string">    # 1. 早返回模式,减少嵌套
</span></span><span class="code-line line-number" line="127"><span class="token triple-quoted-string string">    order = self._get_order(order_id)
</span></span><span class="code-line line-number" line="128"><span class="token triple-quoted-string string">    if not order or order.status != 'pending':
</span></span><span class="code-line line-number" line="129"><span class="token triple-quoted-string string">        return False
</span></span><span class="code-line line-number" line="130"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="131"><span class="token triple-quoted-string string">    # 2. 提取方法,单一职责
</span></span><span class="code-line line-number" line="132"><span class="token triple-quoted-string string">    if not self._check_stock(order):
</span></span><span class="code-line line-number" line="133"><span class="token triple-quoted-string string">        return False
</span></span><span class="code-line line-number" line="134"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="135"><span class="token triple-quoted-string string">    # 3. 使用事务确保一致性
</span></span><span class="code-line line-number" line="136"><span class="token triple-quoted-string string">    with db.transaction():
</span></span><span class="code-line line-number" line="137"><span class="token triple-quoted-string string">        self._update_stock(order)
</span></span><span class="code-line line-number" line="138"><span class="token triple-quoted-string string">        self._update_order_status(order, 'processing')
</span></span><span class="code-line line-number" line="139"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="140"><span class="token triple-quoted-string string">    return True
</span></span><span class="code-line line-number" line="141"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="142"><span class="token triple-quoted-string string">【下一步】
</span></span><span class="code-line line-number" line="143"><span class="token triple-quoted-string string">1. 我已创建重构计划笔记
</span></span><span class="code-line line-number" line="144"><span class="token triple-quoted-string string">2. 建议先编写测试用例
</span></span><span class="code-line line-number" line="145"><span class="token triple-quoted-string string">3. 逐步重构,保持功能不变
</span></span><span class="code-line line-number" line="146"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="147"><span class="token comment"># [自动创建了 action 笔记]</span>
</span><span class="code-line line-number" line="148">
</span><span class="code-line line-number" line="149">
</span><span class="code-line line-number" line="150"><span class="token comment"># ========== 第三天:规划重构任务 ==========</span>
</span><span class="code-line line-number" line="151">
</span><span class="code-line line-number" line="152"><span class="token comment"># 1. 回顾进度</span>
</span><span class="code-line line-number" line="153">response <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>plan_next_steps<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="154"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="155"><span class="token triple-quoted-string string">📋 加载任务规划...
</span></span><span class="code-line line-number" line="156"><span class="token triple-quoted-string string">🤖 正在思考...
</span></span><span class="code-line line-number" line="157"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="158"><span class="token triple-quoted-string string">🤖 助手: 基于前两天的探索和分析,我整理了重构任务优先级:
</span></span><span class="code-line line-number" line="159"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="160"><span class="token triple-quoted-string string">🔴 高优先级 (本周完成):
</span></span><span class="code-line line-number" line="161"><span class="token triple-quoted-string string">1. [blocker] User.email 添加唯一约束
</span></span><span class="code-line line-number" line="162"><span class="token triple-quoted-string string">   - 风险: 低,只是数据库迁移
</span></span><span class="code-line line-number" line="163"><span class="token triple-quoted-string string">   - 工作量: 1小时
</span></span><span class="code-line line-number" line="164"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="165"><span class="token triple-quoted-string string">2. [blocker] 提取 BaseService 减少代码重复
</span></span><span class="code-line line-number" line="166"><span class="token triple-quoted-string string">   - 风险: 中,影响多个服务类
</span></span><span class="code-line line-number" line="167"><span class="token triple-quoted-string string">   - 工作量: 半天
</span></span><span class="code-line line-number" line="168"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="169"><span class="token triple-quoted-string string">3. [blocker] 重构 process_order 方法
</span></span><span class="code-line line-number" line="170"><span class="token triple-quoted-string string">   - 风险: 高,核心业务逻辑
</span></span><span class="code-line line-number" line="171"><span class="token triple-quoted-string string">   - 工作量: 1天(包括编写测试)
</span></span><span class="code-line line-number" line="172"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="173"><span class="token triple-quoted-string string">🟡 中优先级 (下周):
</span></span><span class="code-line line-number" line="174"><span class="token triple-quoted-string string">4. 为 services/ 添加单元测试
</span></span><span class="code-line line-number" line="175"><span class="token triple-quoted-string string">5. 清理 TODO 注释
</span></span><span class="code-line line-number" line="176"><span class="token triple-quoted-string string">6. 为 Order 添加时间字段
</span></span><span class="code-line line-number" line="177"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="178"><span class="token triple-quoted-string string">🟢 低优先级 (待定):
</span></span><span class="code-line line-number" line="179"><span class="token triple-quoted-string string">7. 性能优化
</span></span><span class="code-line line-number" line="180"><span class="token triple-quoted-string string">8. 文档更新
</span></span><span class="code-line line-number" line="181"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="182"><span class="token triple-quoted-string string">建议:
</span></span><span class="code-line line-number" line="183"><span class="token triple-quoted-string string">- 本周先解决数据模型问题(任务1、6)
</span></span><span class="code-line line-number" line="184"><span class="token triple-quoted-string string">- 下周进行代码重构(任务2、3)
</span></span><span class="code-line line-number" line="185"><span class="token triple-quoted-string string">- 持续增加测试覆盖率(任务4)
</span></span><span class="code-line line-number" line="186"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="187"><span class="token triple-quoted-string string">我已更新任务状态笔记,您可以随时查看进度。
</span></span><span class="code-line line-number" line="188"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="189">
</span><span class="code-line line-number" line="190"><span class="token comment"># 2. 手动创建详细的重构计划</span>
</span><span class="code-line line-number" line="191">maintainer<span class="token punctuation">.</span>create_note<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="192">    title<span class="token operator">=</span><span class="token string">"本周重构计划 - Week 1"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="193">    content<span class="token operator">=</span><span class="token triple-quoted-string string">"""## 目标
</span></span><span class="code-line line-number" line="194"><span class="token triple-quoted-string string">完成数据模型层的优化
</span></span><span class="code-line line-number" line="195"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="196"><span class="token triple-quoted-string string">## 任务清单
</span></span><span class="code-line line-number" line="197"><span class="token triple-quoted-string string">- [ ] 为 User.email 添加唯一约束
</span></span><span class="code-line line-number" line="198"><span class="token triple-quoted-string string">- [ ] 为 Order 添加 created_at, updated_at 字段
</span></span><span class="code-line line-number" line="199"><span class="token triple-quoted-string string">- [ ] 编写数据库迁移脚本
</span></span><span class="code-line line-number" line="200"><span class="token triple-quoted-string string">- [ ] 更新相关测试用例
</span></span><span class="code-line line-number" line="201"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="202"><span class="token triple-quoted-string string">## 时间安排
</span></span><span class="code-line line-number" line="203"><span class="token triple-quoted-string string">- 周一: 设计迁移脚本
</span></span><span class="code-line line-number" line="204"><span class="token triple-quoted-string string">- 周二-周三: 执行迁移并测试
</span></span><span class="code-line line-number" line="205"><span class="token triple-quoted-string string">- 周四: 更新测试用例
</span></span><span class="code-line line-number" line="206"><span class="token triple-quoted-string string">- 周五: Code Review
</span></span><span class="code-line line-number" line="207"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="208"><span class="token triple-quoted-string string">## 风险
</span></span><span class="code-line line-number" line="209"><span class="token triple-quoted-string string">- 数据库迁移可能影响线上环境,需要在非高峰期执行
</span></span><span class="code-line line-number" line="210"><span class="token triple-quoted-string string">- 现有数据中可能存在重复email,需要先清理
</span></span><span class="code-line line-number" line="211"><span class="token triple-quoted-string string">"""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="212">    note_type<span class="token operator">=</span><span class="token string">"task_state"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="213">    tags<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"refactoring"</span><span class="token punctuation">,</span> <span class="token string">"week1"</span><span class="token punctuation">,</span> <span class="token string">"high_priority"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="214"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="215">
</span><span class="code-line line-number" line="216"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 已创建详细的重构计划"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="217">
</span><span class="code-line line-number" line="218">
</span><span class="code-line line-number" line="219"><span class="token comment"># ========== 一周后:检查进度 ==========</span>
</span><span class="code-line line-number" line="220">
</span><span class="code-line line-number" line="221"><span class="token comment"># 查看笔记摘要</span>
</span><span class="code-line line-number" line="222">summary <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>note_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"summary"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="223"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📊 笔记摘要:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="224"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>summary<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="225"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="226"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="227"><span class="token triple-quoted-string string">  "total_notes": 8,
</span></span><span class="code-line line-number" line="228"><span class="token triple-quoted-string string">  "type_distribution": {
</span></span><span class="code-line line-number" line="229"><span class="token triple-quoted-string string">    "blocker": 3,
</span></span><span class="code-line line-number" line="230"><span class="token triple-quoted-string string">    "action": 2,
</span></span><span class="code-line line-number" line="231"><span class="token triple-quoted-string string">    "task_state": 2,
</span></span><span class="code-line line-number" line="232"><span class="token triple-quoted-string string">    "conclusion": 1
</span></span><span class="code-line line-number" line="233"><span class="token triple-quoted-string string">  },
</span></span><span class="code-line line-number" line="234"><span class="token triple-quoted-string string">  "recent_notes": [
</span></span><span class="code-line line-number" line="235"><span class="token triple-quoted-string string">    {
</span></span><span class="code-line line-number" line="236"><span class="token triple-quoted-string string">      "id": "note_20250119_160000_7",
</span></span><span class="code-line line-number" line="237"><span class="token triple-quoted-string string">      "title": "本周重构计划 - Week 1",
</span></span><span class="code-line line-number" line="238"><span class="token triple-quoted-string string">      "type": "task_state",
</span></span><span class="code-line line-number" line="239"><span class="token triple-quoted-string string">      "updated_at": "2025-01-19T16:00:00"
</span></span><span class="code-line line-number" line="240"><span class="token triple-quoted-string string">    },
</span></span><span class="code-line line-number" line="241"><span class="token triple-quoted-string string">    ...
</span></span><span class="code-line line-number" line="242"><span class="token triple-quoted-string string">  ]
</span></span><span class="code-line line-number" line="243"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="244"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="245">
</span><span class="code-line line-number" line="246"><span class="token comment"># 生成完整报告</span>
</span><span class="code-line line-number" line="247">report <span class="token operator">=</span> maintainer<span class="token punctuation">.</span>generate_report<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="248"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n📄 会话报告:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="249"><span class="token keyword">print</span><span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>report<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="250"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="251"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="252"><span class="token triple-quoted-string string">  "session_info": {
</span></span><span class="code-line line-number" line="253"><span class="token triple-quoted-string string">    "session_id": "session_20250119_150000",
</span></span><span class="code-line line-number" line="254"><span class="token triple-quoted-string string">    "project": "my_flask_app",
</span></span><span class="code-line line-number" line="255"><span class="token triple-quoted-string string">    "duration_seconds": 172800  # 2天
</span></span><span class="code-line line-number" line="256"><span class="token triple-quoted-string string">  },
</span></span><span class="code-line line-number" line="257"><span class="token triple-quoted-string string">  "activity": {
</span></span><span class="code-line line-number" line="258"><span class="token triple-quoted-string string">    "commands_executed": 24,
</span></span><span class="code-line line-number" line="259"><span class="token triple-quoted-string string">    "notes_created": 8,
</span></span><span class="code-line line-number" line="260"><span class="token triple-quoted-string string">    "issues_found": 3
</span></span><span class="code-line line-number" line="261"><span class="token triple-quoted-string string">  },
</span></span><span class="code-line line-number" line="262"><span class="token triple-quoted-string string">  "notes": { ... }
</span></span><span class="code-line line-number" line="263"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="264"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<h3>9.6.5 运行效果分析</h3>
<p>通过这个完整的案例，我们可以看到长程智能体的几个关键特性。首先是跨会话的连贯性，智能体通过 NoteTool 保持了跨多天、多个会话的任务连贯性，第一天探索的问题在第二天分析时被自动考虑，第三天规划时能够综合前两天的所有发现，一周后检查时完整的历史都被保留。其次是智能的上下文管理，ContextBuilder 确保每次对话都有高质量的上下文，自动汇集相关笔记(特别是 blocker 类型)，根据对话模式动态调整预处理策略，在 token 预算内选择最相关的信息。</p>
<p>第三个特性是即时的文件系统访问，TerminalTool 支持灵活的代码探索，无需预先索引整个代码库，可以即时查看具体文件内容，支持复杂的文本处理(grep、awk等)。第四是自动化的知识管理，系统自动化地管理发现的知识，发现问题时自动创建 blocker 笔记，讨论计划时自动创建 action 笔记，关键信息自动存储到记忆系统。最后是人机协作，这个系统支持灵活的人机协作模式，智能体可以自动化地完成探索和分析，人类可以通过笔记系统进行干预和指导，支持手动创建详细的计划笔记。</p>
<p>这个基础框架可以进一步扩展，比如集成 RAGTool 为代码库建立向量索引结合语义检索，拆分为专门的探索者、分析者、规划者实现多智能体协作，集成测试工具自动验证重构结果，通过 TerminalTool 执行 git 命令追踪代码变更，或者使用 Gradio/Streamlit 构建可视化界面。</p>
<h2>9.7 本章总结</h2>
<p>在本章中，我们深入探讨了上下文工程的理论基础和工程实践：</p>
<h3>理论层面</h3>
<ol>
<li><strong>上下文工程的本质</strong>：从"提示工程"到"上下文工程"的演进，核心是管理有限的注意力预算</li>
<li><strong>上下文腐蚀</strong>：理解长上下文带来的性能下降，认识到上下文是稀缺资源</li>
<li><strong>三大策略</strong>：压缩整合、结构化笔记、子代理架构</li>
</ol>
<h3>工程实践</h3>
<ol>
<li><strong>ContextBuilder</strong>：实现了 GSSC 流水线，提供统一的上下文管理接口</li>
<li><strong>NoteTool</strong>：Markdown+YAML 的混合格式，支持结构化的长期记忆</li>
<li><strong>TerminalTool</strong>：安全的命令行工具，支持即时的文件系统访问</li>
<li><strong>长程智能体</strong>：整合三大工具，构建了跨会话的代码库维护助手</li>
</ol>
<h3>核心收获</h3>
<ul>
<li><strong>分层设计</strong>：即时访问(TerminalTool) + 会话记忆(MemoryTool) + 持久笔记(NoteTool)</li>
<li><strong>智能筛选</strong>：基于相关性和新近性的评分机制</li>
<li><strong>安全第一</strong>：多层安全机制确保系统稳定</li>
<li><strong>人机协作</strong>：自动化与可控性的平衡</li>
</ul>
<p>通过这一章的学习，您不仅掌握了上下文工程的核心技术，更重要的是理解了如何构建能够在长时间跨度内保持连贯性和有效性的智能体系统。这些技能将成为您构建生产级智能体应用的重要基础。</p>
<p>在下一章中，我们将探讨智能体通信协议，学习如何让智能体与外部世界进行更广泛的交互。</p>
<h2>习题</h2>
<blockquote>
<p><strong>提示</strong>：部分习题没有标准答案，重点在于培养学习者对上下文工程和长时程任务管理的综合理解和实践能力。</p>
</blockquote>
<ol>
<li>
<p>本章介绍了上下文工程与提示工程的区别。请分析：</p>
<ul>
<li>在9.1节中提到"上下文必须被视作一种有限资源，且具有边际收益递减"。请解释什么是"上下文腐蚀"（context rot）现象？为什么即使模型支持100K甚至200K的上下文窗口，我们仍然需要谨慎管理上下文？</li>
<li>假设你要构建一个"代码审查助手"，需要分析一个包含50个文件的代码库。请对比两种策略：（1）一次性将所有文件内容加载到上下文中；（2）使用JIT（Just-in-time）上下文，通过工具按需检索文件。分析各自的优缺点和适用场景。</li>
<li>在9.2.1节中提到系统提示的两个极端误区："过度硬编码"和"过于空泛"。请各举一个实际例子，并说明如何找到合适的平衡点。</li>
</ul>
</li>
<li>
<p>GSSC（Gather-Select-Structure-Compress）流水线是本章的核心技术。请深入思考：</p>
<blockquote>
<p><strong>提示</strong>：这是一道动手实践题，建议实际操作</p>
</blockquote>
<ul>
<li>在9.3节的ContextBuilder实现中，四个阶段各有不同的职责。请分析：如果某个阶段失效（如Select阶段选择了不相关的信息，或Compress阶段过度压缩导致信息丢失），会对最终的智能体表现产生什么影响？</li>
<li>请基于9.3.4节的代码，为ContextBuilder添加一个"上下文质量评估"功能：在每次构建上下文后，自动评估上下文的信息密度、相关性和完整性，并给出优化建议。</li>
<li>GSSC流水线中的"压缩"阶段使用了LLM进行智能摘要。请思考：在什么情况下，简单的截断（truncation）或滑动窗口（sliding window）策略可能比LLM摘要更合适？设计一个混合压缩策略，结合多种压缩方法的优势。</li>
</ul>
</li>
<li>
<p>NoteTool和TerminalTool是支持长时程任务的关键工具。基于9.4节和9.5节的内容，请完成以下扩展实践：</p>
<blockquote>
<p><strong>提示</strong>：这是一道动手实践题，建议实际操作</p>
</blockquote>
<ul>
<li>NoteTool使用了分层笔记系统（项目笔记、任务笔记、临时笔记）。请设计一个"笔记自动整理"机制：当临时笔记积累到一定数量时，智能体能够自动分析这些笔记，将重要信息提升为任务笔记或项目笔记，并清理冗余内容。</li>
<li>TerminalTool提供了文件系统操作能力，但在9.5.2节中强调了安全性设计。请分析：当前的安全机制（路径验证、命令白名单、权限检查）是否足够？如果智能体需要访问敏感文件或执行危险操作，应该如何设计一个"人机协作审批"流程？</li>
<li>结合NoteTool和TerminalTool，设计一个"智能代码重构助手"：能够分析代码库结构、记录重构计划、逐步执行重构操作，并在笔记中追踪进度和遇到的问题。请画出完整的工作流程图。</li>
</ul>
</li>
<li>
<p>在9.6节的"长时程任务管理"案例中，我们看到了上下文工程在实际应用中的价值。请深入分析：</p>
<ul>
<li>案例中使用了"分层上下文管理"策略：即时访问（TerminalTool）+ 会话记忆（MemoryTool）+ 持久笔记（NoteTool）。请分析：这三层之间应该如何协调？什么信息应该放在哪一层？如何避免信息冗余和不一致？</li>
<li>假设任务执行过程中发生了中断（如系统崩溃、网络断开），智能体需要从笔记中恢复状态并继续执行。请设计一个"断点续传"机制：如何在笔记中记录足够的状态信息？如何验证恢复后的状态是否正确？</li>
<li>长时程任务往往涉及多个子任务的并行或串行执行。请设计一个"任务依赖管理"系统：能够表达任务之间的依赖关系（如"任务B必须在任务A完成后执行"），并自动调度任务执行顺序。这个系统应该如何与NoteTool集成？</li>
</ul>
</li>
<li>
<p>本章多次提到"渐进式披露"（progressive disclosure）的概念。请思考：</p>
<ul>
<li>在9.2.2节中，渐进式披露被描述为"每一步交互都会产生新的上下文，反过来指导下一步决策"。请设计一个具体的应用场景（如学术论文写作、复杂问题调试），展示渐进式披露如何帮助智能体更高效地完成任务。</li>
<li>渐进式披露的一个潜在风险是"探索效率低下"：智能体可能会在不重要的细节上浪费时间，或者错过关键信息。请设计一个"探索引导"机制：通过启发式规则或元认知策略，帮助智能体更聪明地决定"下一步应该探索什么"。</li>
<li>对比"渐进式披露"与传统的"一次性加载所有上下文"：在什么类型的任务中，前者有明显优势？在什么类型的任务中，后者可能更合适？请给出至少3个不同类型的任务示例。</li>
</ul>
</li>
</ol>
<h2>参考文献</h2>
<p>[1] Anthropic. Effective Context Engineering for AI Agents. <code>https://www.anthropic.com/engineering/effective-context-engineering-for-ai-agents</code></p>
<p>[2] David Kim. Context-Engineering (GitHub). <code>https://github.com/davidkimai/Context-Engineering</code></p>