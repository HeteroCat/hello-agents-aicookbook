<h1>第十二章 智能体性能评估</h1>
<p>在前面的章节中，我们构建了 HelloAgents 框架的核心功能，实现了多种智能体范式、工具系统、记忆机制和强化学习训练等。在构建智能体系统时，我们还需要解决一个核心问题：<strong>如何客观地评估智能体的性能？</strong> 具体来说，我们需要回答以下问题：</p>
<ol>
<li>智能体是否具备预期的能力？</li>
<li>在不同任务上的表现如何？</li>
<li>与其他智能体相比处于什么水平？</li>
</ol>
<p>本章将为 HelloAgents 增加<strong>性能评估系统（Evaluation System）</strong>。我们将深入理解智能体评估的理论基础，并实现评估的工具。</p>
<h2>12.1 智能体评估基础</h2>
<h3>12.1.1 为何需要智能体评估</h3>
<p>我们现在的 SimpleAgent，它已经具备了强大的推理和工具调用能力。让我们看一个典型的使用场景：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> SearchTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 创建LLM和智能体</span>
</span><span class="code-line line-number" line="5">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 创建一个强调工具使用的系统提示词</span>
</span><span class="code-line line-number" line="8">system_prompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""你是一个AI助手，可以使用搜索工具来获取最新信息。
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">当需要搜索信息时，请使用以下格式：
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">[TOOL_CALL:search:搜索关键词]
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">例如：
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">- [TOOL_CALL:search:最新AI新闻]
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">- [TOOL_CALL:search:Python编程教程]
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">请在回答问题前先使用搜索工具获取最新信息。"""</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"AI助手"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">,</span> system_prompt<span class="token operator">=</span>system_prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 添加搜索工具</span>
</span><span class="code-line line-number" line="22">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>SearchTool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24"><span class="token comment"># 示例：使用搜索工具回答问题</span>
</span><span class="code-line line-number" line="25">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"最新的AI技术发展趋势是什么？"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n回答：</span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p>这个智能体能正常工作，但我们面临一个核心问题：如何客观地评估它的性能？当我们优化提示词或更换 LLM 模型后，如何知道是否真的有改进？在部署到生产环境前，如何保证智能体的可靠性？这些问题都需要通过系统化的评估来解决。</p>
<p>智能体评估的核心价值在于提供标准化的方法来衡量智能体的能力。通过评估，我们可以用具体的数字指标量化智能体的表现，客观比较不同设计方案的优劣，及时发现智能体在特定场景下的弱点，并向用户证明智能体的可靠性。</p>
<p>与传统软件测试不同，智能体评估面临着独特的挑战。首先是输出的不确定性，同一问题可能有多个正确答案，很难用简单的对错来判断。其次是评估标准的多样性，不同任务需要不同的评估方法，工具调用需要检查函数签名，问答任务需要评估语义相似度。最后是评估成本的高昂，每次评估都需要大量的 API 调用，成本可能达到数百元甚至更多。</p>
<p>为了应对这些挑战，学术界和工业界提出了多个标准化的<strong>评估基准（Benchmark）</strong>。这些基准提供了统一的数据集、评估指标和评分方法，使我们能够在相同的标准下评估和对比不同的智能体系统。</p>
<h3>12.1.2 主流评估基准概览</h3>
<p>智能体评估领域已经涌现出多个具有影响力的基准测试。下面介绍一些主流的评估基准和指标：</p>
<p><strong>（1）工具调用能力评估</strong></p>
<p>工具调用是智能体的核心能力之一。智能体需要理解用户意图，选择合适的工具，并正确构造函数调用。相关的评估基准包括：</p>
<ul>
<li><strong>BFCL (Berkeley Function Calling Leaderboard)</strong><sup>[1]</sup>：UC Berkeley 推出，包含 1120+测试样本，涵盖 simple、multiple、parallel、irrelevance 四个类别，使用 AST 匹配算法评估，数据集规模适中，社区活跃。</li>
<li><strong>ToolBench</strong><sup>[2]</sup>：清华大学推出，包含 16000+真实 API 调用场景，覆盖真实世界的复杂工具使用场景。</li>
<li><strong>API-Bank</strong><sup>[3]</sup>：Microsoft Research 推出，包含 53 个常用 API 工具，专注于评估智能体对 API 文档的理解和调用能力。</li>
</ul>
<p><strong>（2）通用能力评估</strong></p>
<p>评估智能体在真实世界任务中的综合表现，包括多步推理、知识运用、多模态理解等能力：</p>
<ul>
<li><strong>GAIA (General AI Assistants)</strong><sup>[4]</sup>：Meta AI 和 Hugging Face 联合推出，包含 466 个真实世界问题，分为 Level 1/2/3 三个难度级别，评估多步推理、工具使用、文件处理、网页浏览等能力，使用准精确匹配（Quasi Exact Match）算法，任务真实且综合性强。</li>
<li><strong>AgentBench</strong><sup>[5]</sup>：清华大学推出，包含 8 个不同领域的任务，全面评估智能体的通用能力。</li>
<li><strong>WebArena</strong><sup>[6]</sup>：CMU 推出，评估智能体在真实网页环境中的任务完成能力和网页交互能力。</li>
</ul>
<p><strong>（3）多智能体协作评估</strong></p>
<p>评估多个智能体协同工作的能力：</p>
<ul>
<li><strong>ChatEval</strong><sup>[7]</sup>：评估多智能体对话系统的质量。</li>
<li><strong>SOTOPIA</strong><sup>[8]</sup>：评估智能体在社交场景中的互动能力。</li>
<li><strong>自定义协作场景</strong>：根据具体应用场景设计的评估任务。</li>
</ul>
<p><strong>（4）常用评估指标</strong></p>
<p>不同基准使用不同的评估指标，常见的包括：</p>
<ul>
<li><strong>准确性指标</strong>：Accuracy（准确率）、Exact Match（精确匹配）、F1 Score（F1 分数），用于衡量答案的正确性。</li>
<li><strong>效率指标</strong>：Response Time（响应时间）、Token Usage（Token 使用量），用于衡量执行效率。</li>
<li><strong>鲁棒性指标</strong>：Error Rate（错误率）、Failure Recovery（故障恢复），用于衡量容错能力。</li>
<li><strong>协作指标</strong>：Communication Efficiency（通信效率）、Task Completion（任务完成度），用于衡量协作效果。</li>
</ul>
<h3>12.1.3 HelloAgents 评估体系设计</h3>
<p>考虑到学习曲线和实用性，本章将重点介绍以下评估场景：</p>
<ol>
<li>
<p><strong>BFCL</strong>：评估工具调用能力</p>
<ul>
<li>选择理由：数据集规模适中，评估指标清晰，社区活跃</li>
<li>适用场景：评估智能体的函数调用准确性</li>
</ul>
</li>
<li>
<p><strong>GAIA</strong>：评估通用 AI 助手能力</p>
<ul>
<li>选择理由：任务真实，难度分级，综合性强</li>
<li>适用场景：评估智能体的综合问题解决能力</li>
</ul>
</li>
<li>
<p><strong>数据生成质量评估</strong>：评估 LLM 生成数据质量</p>
<ul>
<li>选择理由：通过这个案例可以完整体验如何使用 Agent 创造数据，评估数据的完整演示。</li>
<li>适用场景：评估生成的训练数据、测试数据的质量</li>
<li>评估方法：LLM Judge、Win Rate、人工验证</li>
</ul>
</li>
</ol>
<p>通过这三个评估场景，我们将构建一个完整的评估体系，如图 12.1 展示了我们的评估系统构建思路。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-1.png" alt="" width="85%">
  <p>图 12.1 HelloAgents 评估体系架构图</p>
</div>
<h3>12.1.4 本章学习目标与快速体验</h3>
<p>让我们先看看第十二章的学习内容：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">hello_agents/
</span><span class="code-line line-number" line="2">├── evaluation/                         # 评估模块
</span><span class="code-line line-number" line="3">│   └── benchmarks/                     # 评估基准实现
</span><span class="code-line line-number" line="4">│       ├── bfcl/                       # BFCL评估实现
</span><span class="code-line line-number" line="5">│       │   ├── dataset.py              # BFCL数据集加载器
</span><span class="code-line line-number" line="6">│       │   ├── evaluator.py            # BFCL评估器（AST匹配）
</span><span class="code-line line-number" line="7">│       │   ├── metrics.py              # BFCL专用指标
</span><span class="code-line line-number" line="8">│       │   └── ast_matcher.py          # AST匹配算法
</span><span class="code-line line-number" line="9">│       ├── gaia/                       # GAIA评估实现
</span><span class="code-line line-number" line="10">│       │   ├── dataset.py              # GAIA数据集加载器
</span><span class="code-line line-number" line="11">│       │   ├── evaluator.py            # GAIA评估器（准精确匹配）
</span><span class="code-line line-number" line="12">│       │   ├── metrics.py              # GAIA专用指标
</span><span class="code-line line-number" line="13">│       │   └── quasi_exact_match.py    # 准精确匹配算法
</span><span class="code-line line-number" line="14">│       └── data_generation/            # 数据生成评估实现
</span><span class="code-line line-number" line="15">│           ├── dataset.py              # AIME数据集加载器
</span><span class="code-line line-number" line="16">│           ├── llm_judge.py            # LLM Judge评估器
</span><span class="code-line line-number" line="17">│           └── win_rate.py             # Win Rate评估器
</span><span class="code-line line-number" line="18">└── tools/builtin/                      # 内置工具模块
</span><span class="code-line line-number" line="19">    ├── bfcl_evaluation_tool.py         # BFCL评估工具
</span><span class="code-line line-number" line="20">    ├── gaia_evaluation_tool.py         # GAIA评估工具
</span><span class="code-line line-number" line="21">    ├── llm_judge_tool.py               # LLM Judge工具
</span><span class="code-line line-number" line="22">    └── win_rate_tool.py                # Win Rate工具
</span></code></pre>
<p>对于这一章的内容，学习目标是掌握应用评估工具的能力。让我们先准备好开发环境：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 安装HelloAgents框架（第12章版本）</span>
</span><span class="code-line line-number" line="2">pip <span class="token function">install</span> <span class="token string">"hello-agents[evaluation]==0.2.7"</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 设置环境变量</span>
</span><span class="code-line line-number" line="5"><span class="token builtin class-name">export</span> <span class="token assign-left variable">HF_TOKEN</span><span class="token operator">=</span><span class="token string">"your_huggingface_token"</span>     <span class="token comment"># 用于GAIA数据集(后续也会有设置步骤)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 由于 `bfcl-eval` 官方包强制要求 numpy&lt;=2.0.0, 和HelloAgents 主依赖版本存在冲突,因此需要单独安装</span>
</span><span class="code-line line-number" line="8">pip <span class="token function">install</span> <span class="token string">"numpy==1.26.4"</span> bfcl-eval
</span></code></pre>
<p>在接下来的章节中，我们将深入学习每种评估方法的详细用法和介绍。</p>
<h2>12.2 BFCL：工具调用能力评估</h2>
<h3>12.2.1 BFCL 基准介绍</h3>
<p>BFCL (Berkeley Function Calling Leaderboard) 是由加州大学伯克利分校推出的函数调用能力评估基准<sup>[1]</sup>。在智能体系统中，工具调用（Tool Calling）是核心能力之一。智能体需要完成以下任务：</p>
<ol>
<li><strong>理解任务需求</strong>：从用户的自然语言描述中提取关键信息</li>
<li><strong>选择合适工具</strong>：从可用工具集中选择最适合的工具</li>
<li><strong>构造函数调用</strong>：正确填写函数名和参数</li>
<li><strong>处理复杂场景</strong>：支持多函数调用、并行调用等高级场景</li>
</ol>
<p>BFCL 基准包含四个评估类别，难度递增。从最基础的单函数调用（Simple）开始，逐步增加到需要调用多个函数的场景（Multiple），再到需要并行调用多个函数的复杂场景（Parallel），最后是需要判断是否需要调用函数的场景（Irrelevance）。这四个类别覆盖了智能体在实际应用中可能遇到的各种工具调用场景，如表 12.1 所示：</p>
<div align="center">
  <p>表 12.1 BFCL 基准中的四个评估类别</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-table-1.png" alt="" width="85%">
</div>
BFCL 的评估流程遵循标准的基准测试流程：首先加载数据集并选择评估类别，然后运行智能体获取预测结果，接着将预测结果解析为抽象语法树（AST），最后通过 AST 匹配算法判断预测是否正确。整个流程会遍历所有测试样本，最终计算出准确率等评估指标并生成评估报告。完整的评估流程如图 12.2 所示：
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-2.png" alt="" width="85%">
  <p>图 12.2 BFCL 评估流程图</p>
</div>
<strong>（1）BFCL 数据集结构</strong>
<p>BFCL 数据集采用 JSON 格式，每个测试样本包含以下字段：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"simple_001"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"question"</span><span class="token operator">:</span> <span class="token string">"What's the weather like in Beijing today?"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">  <span class="token property">"function"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="5">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"get_weather"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">      <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Get the current weather for a location"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">      <span class="token property">"parameters"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">        <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">          <span class="token property">"location"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">            <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">            <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"The city name"</span>
</span><span class="code-line line-number" line="14">          <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="15">        <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="17">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="19">  <span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">  <span class="token property">"ground_truth"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="21">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"get_weather"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">      <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="24">        <span class="token property">"location"</span><span class="token operator">:</span> <span class="token string">"Beijing"</span>
</span><span class="code-line line-number" line="25">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="26">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="27">  <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="28"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>关键字段说明：</strong></p>
<ul>
<li><code>question</code>: 用户的自然语言请求</li>
<li><code>function</code>: 可用的函数列表（包含函数签名和描述）</li>
<li><code>ground_truth</code>: 标准答案（期望的函数调用）</li>
</ul>
<p><strong>（2）AST 匹配说明</strong></p>
<p>BFCL 使用<strong>AST 匹配（Abstract Syntax Tree Matching）</strong>作为核心评估算法，因此下文可以了解一下评估的策略。</p>
<p>BFCL 使用抽象语法树（AST）进行智能匹配，而不是简单的字符串匹配。AST 匹配的核心思想是：<strong>将函数调用解析为语法树，然后比较树的结构和节点值</strong>。</p>
<p>给定预测的函数调用 $P$ 和标准答案 $G$，AST 匹配函数定义为：</p>
<p>$$
\text{AST_Match}(P, G) = \begin{cases}
1 &amp; \text{if } \text{AST}(P) \equiv \text{AST}(G) \
0 &amp; \text{otherwise}
\end{cases}
$$</p>
<p>其中 $\text{AST}(x)$ 表示将函数调用解析为抽象语法树，$\equiv$ 表示语法树等价。</p>
<p>两个语法树等价需要满足三个核心条件：函数名必须完全一致（精确匹配），参数键值对集合相等（忽略顺序），以及每个参数的值在语义上等价（例如 <code>2+3</code> 等价于 <code>5</code>）。在具体的匹配过程中，函数名匹配要求字符串精确匹配，例如 <code>get_weather</code> 和 <code>get_temperature</code> 被视为不同的函数。参数匹配则使用 AST 进行智能比较，允许参数顺序不同（<code>f(a=1, b=2)</code> 等价于 <code>f(b=2, a=1)</code>），允许等价表达式（<code>f(x=2+3)</code> 等价于 <code>f(x=5)</code>），也允许不同的字符串表示（<code>f(s="hello")</code> 等价于 <code>f(s='hello')</code>）。对于多函数调用的场景，匹配算法要求调用相同数量的函数，每个函数调用都必须匹配，但调用顺序可以不同（使用集合匹配）。</p>
<p><strong>AST 匹配示例：</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 示例1：参数顺序不同（匹配成功）</span>
</span><span class="code-line line-number" line="2">预测<span class="token punctuation">:</span> get_weather<span class="token punctuation">(</span>city<span class="token operator">=</span><span class="token string">"Beijing"</span><span class="token punctuation">,</span> unit<span class="token operator">=</span><span class="token string">"celsius"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">标准<span class="token punctuation">:</span> get_weather<span class="token punctuation">(</span>unit<span class="token operator">=</span><span class="token string">"celsius"</span><span class="token punctuation">,</span> city<span class="token operator">=</span><span class="token string">"Beijing"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">结果<span class="token punctuation">:</span> ✅ 匹配成功
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 示例2：等价表达式（匹配成功）</span>
</span><span class="code-line line-number" line="7">预测<span class="token punctuation">:</span> calculate<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">标准<span class="token punctuation">:</span> calculate<span class="token punctuation">(</span>x<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">结果<span class="token punctuation">:</span> ✅ 匹配成功
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 示例3：函数名错误（匹配失败）</span>
</span><span class="code-line line-number" line="12">预测<span class="token punctuation">:</span> get_temperature<span class="token punctuation">(</span>city<span class="token operator">=</span><span class="token string">"Beijing"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">标准<span class="token punctuation">:</span> get_weather<span class="token punctuation">(</span>city<span class="token operator">=</span><span class="token string">"Beijing"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">结果<span class="token punctuation">:</span> ❌ 匹配失败
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token comment"># 示例4：参数值错误（匹配失败）</span>
</span><span class="code-line line-number" line="17">预测<span class="token punctuation">:</span> get_weather<span class="token punctuation">(</span>city<span class="token operator">=</span><span class="token string">"Shanghai"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">标准<span class="token punctuation">:</span> get_weather<span class="token punctuation">(</span>city<span class="token operator">=</span><span class="token string">"Beijing"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">结果<span class="token punctuation">:</span> ❌ 匹配失败
</span></code></pre>
<p><strong>（3）BFCL 评估指标</strong></p>
<p>BFCL 使用以下指标评估智能体性能：</p>
<p><strong>1. 准确率 (Accuracy)</strong></p>
<p>准确率是最核心的指标，定义为 AST 匹配成功的样本比例：</p>
<p>$$
\text{Accuracy} = \frac{1}{N} \sum_{i=1}^{N} \text{AST_Match}(P_i, G_i)
$$</p>
<p>其中：</p>
<ul>
<li>$N$ 是总样本数</li>
<li>$P_i$ 是第 $i$ 个样本的预测结果</li>
<li>$G_i$ 是第 $i$ 个样本的标准答案</li>
<li>$\text{AST_Match}(P_i, G_i) \in {0, 1}$ 是 AST 匹配函数</li>
</ul>
<p><strong>2. AST 匹配率 (AST Match Rate)</strong></p>
<p>与准确率相同，强调使用 AST 匹配算法：</p>
<p>$$
\text{AST Match Rate} = \text{Accuracy}
$$</p>
<p><strong>3. 分类准确率 (Category-wise Accuracy)</strong></p>
<p>对于每个类别 $c \in {\text{simple}, \text{multiple}, \text{parallel}, \ldots}$，计算该类别的准确率：</p>
<p>$$
\text{Accuracy}<em>c = \frac{1}{|D_c|} \sum</em>{i \in D_c} \text{AST_Match}(P_i, G_i)
$$</p>
<p>其中 $D_c$ 是类别 $c$ 的样本集合，$|D_c|$ 是该类别的样本数。</p>
<p><strong>4. 加权准确率 (Weighted Accuracy)</strong></p>
<p>考虑不同类别的难度权重：</p>
<p>$$
\text{Weighted Accuracy} = \sum_{c} w_c \cdot \text{Accuracy}_c
$$</p>
<p>其中 $w_c$ 是类别 $c$ 的权重，满足 $\sum_c w_c = 1$。</p>
<p><strong>5. 错误率 (Error Rate)</strong></p>
<p>未能正确调用函数的样本比例：</p>
<p>$$
\text{Error Rate} = 1 - \text{Accuracy} = \frac{1}{N} \sum_{i=1}^{N} (1 - \text{AST_Match}(P_i, G_i))
$$</p>
<p><strong>指标解释：</strong></p>
<ul>
<li><strong>Accuracy = 1.0</strong>：所有样本都完全正确</li>
<li><strong>Accuracy = 0.8</strong>：80%的样本正确，20%的样本错误</li>
<li><strong>Accuracy = 0.0</strong>：所有样本都错误</li>
</ul>
<p><strong>分类准确率示例：</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 假设评估结果</span>
</span><span class="code-line line-number" line="2">simple_accuracy <span class="token operator">=</span> <span class="token number">0.95</span>      <span class="token comment"># Simple类别：95%正确</span>
</span><span class="code-line line-number" line="3">multiple_accuracy <span class="token operator">=</span> <span class="token number">0.82</span>    <span class="token comment"># Multiple类别：82%正确</span>
</span><span class="code-line line-number" line="4">parallel_accuracy <span class="token operator">=</span> <span class="token number">0.68</span>    <span class="token comment"># Parallel类别：68%正确</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 加权准确率（假设权重相等）</span>
</span><span class="code-line line-number" line="7">weighted_accuracy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.95</span> <span class="token operator">+</span> <span class="token number">0.82</span> <span class="token operator">+</span> <span class="token number">0.68</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">0.817</span>
</span></code></pre>
<p><strong>（4）BFCL 官方评估工具</strong></p>
<p>BFCL 提供官方 CLI 工具进行评估：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 安装BFCL评估工具</span>
</span><span class="code-line line-number" line="2">pip <span class="token function">install</span> bfcl
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 运行官方评估</span>
</span><span class="code-line line-number" line="5">bfcl evaluate <span class="token punctuation">\</span>
</span><span class="code-line line-number" line="6">    --model-result-path ./results.json <span class="token punctuation">\</span>
</span><span class="code-line line-number" line="7">    --test-category simple_python
</span></code></pre>
<p>使用官方评估工具的优势在于：它使用官方的 AST 匹配算法，评估结果与排行榜完全一致，支持所有 BFCL v4 类别，并且能够自动生成详细的评估报告。</p>
<h3>12.2.2 获取 BFCL 数据集</h3>
<p>BFCL 数据集可以通过以下方式获取：</p>
<p><strong>方法 1：从官方 GitHub 仓库克隆（推荐）</strong></p>
<p>这是最可靠的方式，可以获取完整的数据集和 ground truth：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 克隆BFCL仓库</span>
</span><span class="code-line line-number" line="2"><span class="token function">git</span> clone https://github.com/ShishirPatil/gorilla.git temp_gorilla
</span><span class="code-line line-number" line="3"><span class="token builtin class-name">cd</span> temp_gorilla/berkeley-function-call-leaderboard
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 查看BFCL v4数据集</span>
</span><span class="code-line line-number" line="6"><span class="token function">ls</span> bfcl_eval/data/
</span><span class="code-line line-number" line="7"><span class="token comment"># 输出: BFCL_v4_simple_python.json  BFCL_v4_multiple.json  BFCL_v4_parallel.json  ...</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 查看ground truth</span>
</span><span class="code-line line-number" line="10"><span class="token function">ls</span> bfcl_eval/data/possible_answer/
</span><span class="code-line line-number" line="11"><span class="token comment"># 输出: BFCL_v4_simple_python.json  BFCL_v4_multiple.json  ...</span>
</span></code></pre>
<p>推荐这种方式的原因是：它包含完整的 ground truth（标准答案），数据格式与官方评估工具完全一致，可以直接使用官方评估脚本，并且支持 BFCL v4 最新版本。</p>
<p><strong>方法 2：使用 HelloAgents 加载官方数据</strong></p>
<p>克隆仓库后，使用 HelloAgents 加载数据：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>evaluation <span class="token keyword">import</span> BFCLDataset
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 加载BFCL官方数据</span>
</span><span class="code-line line-number" line="4">dataset <span class="token operator">=</span> BFCLDataset<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="5">    bfcl_data_dir<span class="token operator">=</span><span class="token string">"./temp_gorilla/berkeley-function-call-leaderboard/bfcl_eval/data"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    category<span class="token operator">=</span><span class="token string">"simple_python"</span>  <span class="token comment"># BFCL v4类别</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 加载数据（包括测试数据和ground truth）</span>
</span><span class="code-line line-number" line="10">data <span class="token operator">=</span> dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 加载了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个测试样本"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 加载了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">.</span>ground_truth<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个ground truth"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14"><span class="token comment"># 输出:</span>
</span><span class="code-line line-number" line="15"><span class="token comment"># ✅ 加载了 400 个测试样本</span>
</span><span class="code-line line-number" line="16"><span class="token comment"># ✅ 加载了 400 个ground truth</span>
</span></code></pre>
<p>这个加载器的工作原理是：首先从<code>bfcl_eval/data/</code>加载测试数据，然后从<code>bfcl_eval/data/possible_answer/</code>加载 ground truth，接着自动合并测试数据和 ground truth，最后保留原始 BFCL 数据格式。其中 BFCL v4 数据集类别可以在表 12.2 查看。</p>
<div align="center">
  <p>表 12.2 BFCL 基准中的四个评估类别</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-table-2.png" alt="" width="85%">
</div>
<p>当然也可以通过代码查看可用类别：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 获取所有支持的类别</span>
</span><span class="code-line line-number" line="2">categories <span class="token operator">=</span> dataset<span class="token punctuation">.</span>get_available_categories<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"支持的类别: </span><span class="token interpolation"><span class="token punctuation">{</span>categories<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token comment"># 输出: ['simple_python', 'simple_java', 'simple_javascript', 'multiple', ...]</span>
</span></code></pre>
<h3>12.2.3 在 HelloAgents 中实现 BFCL 评估</h3>
<p>现在让我们看看如何在 HelloAgents 框架中实现 BFCL 评估。我们提供了三种使用方式：</p>
<p><strong>方式 1：使用 BFCLEvaluationTool（推荐）</strong></p>
<p>这是最简单的方式，一行代码完成评估、报告生成和官方评估：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> BFCLEvaluationTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 1. 创建要评估的智能体</span>
</span><span class="code-line line-number" line="5">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"TestAgent"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 2. 创建BFCL评估工具</span>
</span><span class="code-line line-number" line="9">bfcl_tool <span class="token operator">=</span> BFCLEvaluationTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 3. 运行评估（自动完成所有步骤）</span>
</span><span class="code-line line-number" line="12">results <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="13">    agent<span class="token operator">=</span>agent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span>  <span class="token comment"># 评估类别</span>
</span><span class="code-line line-number" line="15">    max_samples<span class="token operator">=</span><span class="token number">5</span>              <span class="token comment"># 评估样本数（0表示全部）</span>
</span><span class="code-line line-number" line="16"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18"><span class="token comment"># 4. 查看结果</span>
</span><span class="code-line line-number" line="19"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"正确数: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'correct_samples'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'total_samples'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>运行输出：</strong></p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">============================================================
</span><span class="code-line line-number" line="2">BFCL一键评估
</span><span class="code-line line-number" line="3">============================================================
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">配置:
</span><span class="code-line line-number" line="6">   评估类别: simple_python
</span><span class="code-line line-number" line="7">   样本数量: 5
</span><span class="code-line line-number" line="8">   智能体: TestAgent
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">============================================================
</span><span class="code-line line-number" line="11">步骤1: 运行HelloAgents评估
</span><span class="code-line line-number" line="12">============================================================
</span><span class="code-line line-number" line="13">✅ BFCL数据集加载完成
</span><span class="code-line line-number" line="14">   数据目录: ./temp_gorilla/berkeley-function-call-leaderboard/bfcl_eval/data
</span><span class="code-line line-number" line="15">   类别: simple_python
</span><span class="code-line line-number" line="16">   样本数: 400
</span><span class="code-line line-number" line="17">   Ground truth数: 400
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">🔧 开始 BFCL 评估...
</span><span class="code-line line-number" line="20">   进度: 1/5
</span><span class="code-line line-number" line="21">   进度: 5/5
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">✅ BFCL 评估完成
</span><span class="code-line line-number" line="24">   总体准确率: 100.00%
</span><span class="code-line line-number" line="25">   simple_python: 100.00% (5/5)
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">📊 评估结果:
</span><span class="code-line line-number" line="28">   准确率: 100.00%
</span><span class="code-line line-number" line="29">   正确数: 5/5
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">============================================================
</span><span class="code-line line-number" line="32">步骤2: 导出BFCL格式结果
</span><span class="code-line line-number" line="33">============================================================
</span><span class="code-line line-number" line="34">✅ BFCL格式结果已导出
</span><span class="code-line line-number" line="35">   输出文件: ./evaluation_results/bfcl_official/BFCL_v4_simple_python_result.json
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">============================================================
</span><span class="code-line line-number" line="38">步骤3: 运行BFCL官方评估
</span><span class="code-line line-number" line="39">============================================================
</span><span class="code-line line-number" line="40">✅ 结果文件已复制到: ./result/Qwen_Qwen3-8B/BFCL_v4_simple_python_result.json
</span><span class="code-line line-number" line="41">
</span><span class="code-line line-number" line="42">🔄 运行命令: bfcl evaluate --model Qwen/Qwen3-8B --test-category simple_python --partial-eval
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">============================================================
</span><span class="code-line line-number" line="45">BFCL官方评估结果
</span><span class="code-line line-number" line="46">============================================================
</span><span class="code-line line-number" line="47">📊 评估结果汇总:
</span><span class="code-line line-number" line="48">Model,Overall Acc,simple_python
</span><span class="code-line line-number" line="49">Qwen/Qwen3-8B,100.00,100.00
</span><span class="code-line line-number" line="50">
</span><span class="code-line line-number" line="51">🎯 最终结果:
</span><span class="code-line line-number" line="52">   准确率: 100.00%
</span><span class="code-line line-number" line="53">   正确数: 5/5
</span><span class="code-line line-number" line="54">
</span><span class="code-line line-number" line="55">============================================================
</span><span class="code-line line-number" line="56">步骤4: 生成评估报告
</span><span class="code-line line-number" line="57">============================================================
</span><span class="code-line line-number" line="58">📄 报告已生成: ./evaluation_reports/bfcl_report_20251011_005938.md
</span><span class="code-line line-number" line="59">
</span><span class="code-line line-number" line="60">准确率: 100.00%
</span><span class="code-line line-number" line="61">正确数: 5/5
</span></code></pre>
<p><strong>自动生成的 Markdown 报告：</strong></p>
<p>评估完成后，会自动生成一份详细的 Markdown 报告，包含：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">#</span> BFCL评估报告</span>
</span><span class="code-line line-number" line="2"><span class="token bold"><span class="token punctuation">**</span><span class="token content">生成时间</span><span class="token punctuation">**</span></span>: 2025-10-11 00:59:38
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token title important"><span class="token punctuation">##</span> 📊 评估概览</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">智能体</span><span class="token punctuation">**</span></span>: TestAgent
</span><span class="code-line line-number" line="7"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">评估类别</span><span class="token punctuation">**</span></span>: simple_python
</span><span class="code-line line-number" line="8"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">总体准确率</span><span class="token punctuation">**</span></span>: 100.00%
</span><span class="code-line line-number" line="9"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">正确样本数</span><span class="token punctuation">**</span></span>: 5/5
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token title important"><span class="token punctuation">##</span> 📈 详细指标</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token title important"><span class="token punctuation">###</span> 分类准确率</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">simple_python</span><span class="token punctuation">**</span></span>: 100.00% (5/5)
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token title important"><span class="token punctuation">##</span> 📝 样本详情</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 样本ID </span><span class="token punctuation">|</span><span class="token table-header important"> 问题 </span><span class="token punctuation">|</span><span class="token table-header important"> 预测结果 </span><span class="token punctuation">|</span><span class="token table-header important"> 正确答案 </span><span class="token punctuation">|</span><span class="token table-header important"> 是否正确 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="20"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">--------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="21"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> simple_python_0 </span><span class="token punctuation">|</span><span class="token table-data"> Find the area of a triangle... </span><span class="token punctuation">|</span><span class="token table-data"> [{'name': 'calculate_triangle_area'...}] </span><span class="token punctuation">|</span><span class="token table-data"> [{'function_name': {'base': [10]...}}] </span><span class="token punctuation">|</span><span class="token table-data"> ✅ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="22"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> simple_python_1 </span><span class="token punctuation">|</span><span class="token table-data"> Calculate the factorial of 5... </span><span class="token punctuation">|</span><span class="token table-data"> [{'name': 'calculate_factorial'...}] </span><span class="token punctuation">|</span><span class="token table-data"> [{'function_name': {'number': [5]}}] </span><span class="token punctuation">|</span><span class="token table-data"> ✅ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="23"><span class="token table"><span class="token table-data-rows"></span></span>...
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token title important"><span class="token punctuation">##</span> 📊 准确率可视化</span>
</span><span class="code-line line-number" line="26">准确率: ██████████████████████████████████████████████████ 100.00%
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28"><span class="token title important"><span class="token punctuation">##</span> 💡 建议</span>
</span><span class="code-line line-number" line="29"><span class="token list punctuation">-</span> ✅ 表现优秀！智能体在工具调用方面表现出色。
</span></code></pre>
<p><strong>方式 2：使用一键评估脚本</strong></p>
<p>适合命令行快速评估，在这一章配套的代码案例里，我们提供了<code>04_run_bfcl_evaluation.py</code>，支持直接命令行调用测评：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 运行评估脚本</span>
</span><span class="code-line line-number" line="2">python chapter12/04_run_bfcl_evaluation.py <span class="token parameter variable">--category</span> simple_python <span class="token parameter variable">--samples</span> <span class="token number">10</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 指定模型名称（用于BFCL官方评估）</span>
</span><span class="code-line line-number" line="5">python examples/04_run_bfcl_evaluation.py <span class="token punctuation">\</span>
</span><span class="code-line line-number" line="6">    <span class="token parameter variable">--category</span> simple_python <span class="token punctuation">\</span>
</span><span class="code-line line-number" line="7">    <span class="token parameter variable">--samples</span> <span class="token number">10</span> <span class="token punctuation">\</span>
</span><span class="code-line line-number" line="8">    --model-name <span class="token string">"Qwen/Qwen3-8B"</span>
</span></code></pre>
<p>脚本支持三个参数：<code>--category</code>指定评估类别（默认 simple_python），<code>--samples</code>指定评估样本数（默认 5，0 表示全部），<code>--model-name</code>指定模型名称用于 BFCL 官方评估（默认 Qwen/Qwen3-8B）。</p>
<p><strong>方式 3：直接使用 Dataset 和 Evaluator</strong></p>
<p>适合需要自定义评估流程的场景：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>evaluation <span class="token keyword">import</span> BFCLDataset<span class="token punctuation">,</span> BFCLEvaluator
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 1. 创建智能体</span>
</span><span class="code-line line-number" line="5">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"TestAgent"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 2. 加载数据集</span>
</span><span class="code-line line-number" line="9">dataset <span class="token operator">=</span> BFCLDataset<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="10">    bfcl_data_dir<span class="token operator">=</span><span class="token string">"./temp_gorilla/berkeley-function-call-leaderboard/bfcl_eval/data"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    category<span class="token operator">=</span><span class="token string">"simple_python"</span>
</span><span class="code-line line-number" line="12"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">data <span class="token operator">=</span> dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token comment"># 3. 创建评估器</span>
</span><span class="code-line line-number" line="16">evaluator <span class="token operator">=</span> BFCLEvaluator<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="17">    dataset<span class="token operator">=</span>dataset<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">    category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">    evaluation_mode<span class="token operator">=</span><span class="token string">"ast"</span>  <span class="token comment"># 使用AST匹配模式</span>
</span><span class="code-line line-number" line="20"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22"><span class="token comment"># 4. 运行评估</span>
</span><span class="code-line line-number" line="23">results <span class="token operator">=</span> evaluator<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token comment"># 5. 查看结果</span>
</span><span class="code-line line-number" line="26"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"正确数: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'correct_samples'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'total_samples'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29"><span class="token comment"># 6. 导出BFCL格式结果（可选）</span>
</span><span class="code-line line-number" line="30">evaluator<span class="token punctuation">.</span>export_to_bfcl_format<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="31">    results<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="32">    output_path<span class="token operator">=</span><span class="token string">"./evaluation_results/my_results.json"</span>
</span><span class="code-line line-number" line="33"><span class="token punctuation">)</span>
</span></code></pre>
<p>通过以上三种方式，我们可以根据不同的需求选择合适的评估方法。如果只是想快速了解智能体的表现，使用 BFCLEvaluationTool 的一键评估最为便捷；如果需要批量评估或集成到 CI/CD 流程，使用命令行脚本更加合适；如果需要深度定制评估流程或集成到自己的系统中，直接使用 Dataset 和 Evaluator 提供了最大的灵活性。</p>
<h3>12.2.4 BFCL 官方评估工具集成</h3>
<p>前面我们学习了如何使用 HelloAgents 内置的评估功能。实际上，<code>BFCLEvaluationTool</code>已经<strong>自动集成了 BFCL 官方评估工具</strong>，让你能够获得权威的、可对比的评估结果。</p>
<p>整个评估流程包括四个步骤：首先从 BFCL v4 数据集加载测试数据，然后使用 HelloAgents 运行评估获取智能体的预测结果，接着将结果导出为 BFCL 官方格式（JSONL），最后使用官方评估脚本计算最终分数。这个流程确保了评估结果与 BFCL 排行榜完全一致，如图 12.3 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-3.png" alt="" width="85%">
  <p>图 12.3 Helloagents 载入 BFCL 评估过程</p>
</div>
使用`BFCLEvaluationTool`时，官方评估会<strong>自动运行</strong>（默认启用）：
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> BFCLEvaluationTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 创建智能体</span>
</span><span class="code-line line-number" line="5">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"TestAgent"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 创建评估工具</span>
</span><span class="code-line line-number" line="9">bfcl_tool <span class="token operator">=</span> BFCLEvaluationTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 运行评估（自动运行官方评估）</span>
</span><span class="code-line line-number" line="12">results <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="13">    agent<span class="token operator">=</span>agent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">    max_samples<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    <span class="token comment"># run_official_eval=True  # 默认为True，可以省略</span>
</span><span class="code-line line-number" line="17">    model_name<span class="token operator">=</span><span class="token string">"Qwen/Qwen3-8B"</span>  <span class="token comment"># 可选，指定模型名称</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">)</span>
</span></code></pre>
<p>工具会自动执行完整的评估流程：首先运行 HelloAgents 评估获取预测结果，然后将结果导出为 BFCL 格式并保存到<code>evaluation_results/bfcl_official/</code>目录，接着复制结果文件到<code>result/{model_name}/</code>目录以符合官方评估工具的要求，随后运行 BFCL 官方评估命令计算分数，最后显示官方评估结果并生成 Markdown 格式的评估报告。</p>
<p><strong>官方评估输出示例：</strong></p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">============================================================
</span><span class="code-line line-number" line="2">步骤3: 运行BFCL官方评估
</span><span class="code-line line-number" line="3">============================================================
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">✅ 结果文件已复制到:
</span><span class="code-line line-number" line="6">   ./result/Qwen_Qwen3-8B/BFCL_v4_simple_python_result.json
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">🔄 运行命令: bfcl evaluate --model Qwen/Qwen3-8B --test-category simple_python --partial-eval
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">============================================================
</span><span class="code-line line-number" line="11">BFCL官方评估结果
</span><span class="code-line line-number" line="12">============================================================
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">📊 评估结果汇总:
</span><span class="code-line line-number" line="15">Model,Overall Acc,simple_python
</span><span class="code-line line-number" line="16">Qwen/Qwen3-8B,100.00,100.00
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">🎯 最终结果:
</span><span class="code-line line-number" line="19">   准确率: 100.00%
</span><span class="code-line line-number" line="20">   正确数: 5/5
</span></code></pre>
<p>如果你想手动控制评估流程，可以禁用自动官方评估：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 禁用官方评估</span>
</span><span class="code-line line-number" line="2">results <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="3">    agent<span class="token operator">=</span>agent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    max_samples<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    run_official_eval<span class="token operator">=</span><span class="token boolean">False</span>  <span class="token comment"># 禁用官方评估</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 然后手动运行官方评估</span>
</span><span class="code-line line-number" line="10"><span class="token keyword">import</span> subprocess
</span><span class="code-line line-number" line="11">subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span>
</span><span class="code-line line-number" line="12">    <span class="token string">"bfcl"</span><span class="token punctuation">,</span> <span class="token string">"evaluate"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    <span class="token string">"--model"</span><span class="token punctuation">,</span> <span class="token string">"Qwen/Qwen3-8B"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    <span class="token string">"--test-category"</span><span class="token punctuation">,</span> <span class="token string">"simple_python"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">    <span class="token string">"--partial-eval"</span>
</span><span class="code-line line-number" line="16"><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span></code></pre>
<p>你也可以手动生成报告：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 运行评估</span>
</span><span class="code-line line-number" line="2">results <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 手动生成报告</span>
</span><span class="code-line line-number" line="5">report <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>generate_report<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">    results<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    output_file<span class="token operator">=</span><span class="token string">"./my_reports/custom_report.md"</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 打印报告内容</span>
</span><span class="code-line line-number" line="11"><span class="token keyword">print</span><span class="token punctuation">(</span>report<span class="token punctuation">)</span>
</span></code></pre>
<h3>12.2.5 核心组件实现细节</h3>
<p>在前面的小节中，我们学习了如何使用 BFCL 评估工具。现在让我们深入了解 HelloAgents 评估系统的核心组件是如何实现的。理解这些实现细节不仅能帮助你更好地使用评估系统，还能让你根据自己的需求进行定制和扩展。</p>
<p><strong>（1）BFCLDataset：数据集加载器</strong></p>
<p>BFCLDataset 负责加载和管理 BFCL 数据集：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">BFCLDataset</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""BFCL数据集加载器"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> category<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"simple"</span><span class="token punctuation">,</span> local_data_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        self<span class="token punctuation">.</span>category <span class="token operator">=</span> category
</span><span class="code-line line-number" line="6">        self<span class="token punctuation">.</span>local_data_path <span class="token operator">=</span> local_data_path
</span><span class="code-line line-number" line="7">        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">        <span class="token triple-quoted-string string">"""加载数据集"""</span>
</span><span class="code-line line-number" line="11">        <span class="token comment"># 优先从本地加载</span>
</span><span class="code-line line-number" line="12">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>local_data_path<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_load_from_local<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">        <span class="token comment"># 否则从Hugging Face加载</span>
</span><span class="code-line line-number" line="15">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_load_from_huggingface<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p>因为 BFCL 的数据集就在官方的仓库内，所以这里建议的方式是直接在本地 clone 一份进行测评。当找不到时才到 huggingface 进行加载。</p>
<p><strong>（2）BFCLEvaluator：评估执行器</strong></p>
<p>BFCLEvaluator 负责执行评估流程。它的核心是<code>evaluate()</code>方法，该方法协调整个评估过程：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">BFCLEvaluator</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""BFCL评估器"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> agent<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> max_samples<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token triple-quoted-string string">"""执行评估"""</span>
</span><span class="code-line line-number" line="6">        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">        <span class="token keyword">for</span> item <span class="token keyword">in</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">[</span><span class="token punctuation">:</span>max_samples<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">            <span class="token comment"># 1. 构造提示词</span>
</span><span class="code-line line-number" line="10">            prompt <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_prompt<span class="token punctuation">(</span>item<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">            <span class="token comment"># 2. 调用智能体</span>
</span><span class="code-line line-number" line="13">            response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">            <span class="token comment"># 3. 提取函数调用</span>
</span><span class="code-line line-number" line="16">            predicted_calls <span class="token operator">=</span> self<span class="token punctuation">.</span>_extract_function_calls<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">            <span class="token comment"># 4. 与标准答案对比</span>
</span><span class="code-line line-number" line="19">            is_correct <span class="token operator">=</span> self<span class="token punctuation">.</span>_compare_calls<span class="token punctuation">(</span>predicted_calls<span class="token punctuation">,</span> item<span class="token punctuation">[</span><span class="token string">"ground_truth"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">                <span class="token string">"id"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">                <span class="token string">"prediction"</span><span class="token punctuation">:</span> predicted_calls<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">                <span class="token string">"ground_truth"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"ground_truth"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">                <span class="token string">"is_correct"</span><span class="token punctuation">:</span> is_correct
</span><span class="code-line line-number" line="26">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">"results"</span><span class="token punctuation">:</span> results<span class="token punctuation">,</span> <span class="token string">"total_samples"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">}</span>
</span></code></pre>
<p>这个评估器的设计包含三个核心要点：首先是提示词构造，需要将数据集中的问题和函数定义转换为智能体可理解的提示词；其次是函数调用提取，需要从智能体的响应中提取函数调用，并支持多种格式（JSON、代码块等）；最后是 AST 匹配，使用抽象语法树进行函数调用对比，这比简单的字符串匹配更准确。</p>
<p>让我们看看函数调用提取的实现：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_extract_function_calls</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""从响应中提取函数调用
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    支持多种格式：
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    1. JSON格式：{"name": "func", "arguments": {...}}
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    2. 代码块格式：```python\nfunc(arg1=val1)\n```
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    3. 纯文本格式：func(arg1=val1)
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="9">    calls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token comment"># 尝试JSON解析</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">        json_match <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'\{.*\}'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">        <span class="token keyword">if</span> json_match<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">            data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_match<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token string">"name"</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">                calls<span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">            <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">                calls<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">    <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">pass</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">    <span class="token comment"># 尝试代码块提取</span>
</span><span class="code-line line-number" line="24">    code_blocks <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r'```(?:python)?\n(.*?)\n```'</span><span class="token punctuation">,</span> response<span class="token punctuation">,</span> re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">    <span class="token keyword">for</span> code <span class="token keyword">in</span> code_blocks<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">        <span class="token comment"># 解析Python函数调用</span>
</span><span class="code-line line-number" line="27">        parsed_calls <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_python_calls<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">        calls<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>parsed_calls<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">    <span class="token keyword">return</span> calls
</span></code></pre>
<p><strong>（3）BFCLMetrics：指标计算器</strong></p>
<p>BFCLMetrics 负责计算各种评估指标：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">BFCLMetrics</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""BFCL指标计算器"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">compute_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> results<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token triple-quoted-string string">"""计算所有指标"""</span>
</span><span class="code-line line-number" line="6">        <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">            <span class="token string">"accuracy"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_compute_accuracy<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">            <span class="token string">"ast_match_rate"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_compute_ast_match_rate<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">            <span class="token string">"parameter_accuracy"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_compute_parameter_accuracy<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">            <span class="token string">"f1_score"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_compute_f1_score<span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">            <span class="token string">"category_statistics"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_compute_category_stats<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">        <span class="token punctuation">}</span>
</span></code></pre>
<p><strong>AST 匹配的实现</strong>：</p>
<p>AST 匹配是 BFCL 评估的核心技术。它比简单的字符串匹配更智能，能够识别语义等价的函数调用：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_ast_match</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> pred_call<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> true_call<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""使用AST匹配函数调用
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    AST匹配的优势：
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    1. 忽略参数顺序：func(a=1, b=2) 等价于 func(b=2, a=1)
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    2. 识别等价表达式：2+3 等价于 5
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    3. 忽略空格和格式差异
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="9">    <span class="token comment"># 1. 函数名必须完全匹配</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">if</span> pred_call<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> true_call<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        <span class="token keyword">return</span> <span class="token boolean">False</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">    <span class="token comment"># 2. 将参数转换为AST节点</span>
</span><span class="code-line line-number" line="14">    pred_args <span class="token operator">=</span> self<span class="token punctuation">.</span>_args_to_ast<span class="token punctuation">(</span>pred_call<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"arguments"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">    true_args <span class="token operator">=</span> self<span class="token punctuation">.</span>_args_to_ast<span class="token punctuation">(</span>true_call<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"arguments"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">    <span class="token comment"># 3. 比较AST节点</span>
</span><span class="code-line line-number" line="18">    <span class="token keyword">return</span> ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>pred_args<span class="token punctuation">)</span> <span class="token operator">==</span> ast<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>true_args<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token keyword">def</span> <span class="token function">_args_to_ast</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ast<span class="token punctuation">.</span>AST<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">    <span class="token triple-quoted-string string">"""将参数字典转换为AST节点"""</span>
</span><span class="code-line line-number" line="22">    <span class="token comment"># 构造一个虚拟的函数调用</span>
</span><span class="code-line line-number" line="23">    code <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"func(</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>k<span class="token punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">repr</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token keyword">in</span> args<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span>
</span><span class="code-line line-number" line="24">    tree <span class="token operator">=</span> ast<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">    <span class="token keyword">return</span> tree<span class="token punctuation">.</span>body<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>value  <span class="token comment"># 返回Call节点</span>
</span></code></pre>
<p><strong>（4）工具化封装：BFCLEvaluationTool</strong></p>
<p>最后，我们将这些组件封装成一个 Tool，让它可以被智能体直接调用：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">BFCLEvaluationTool</span><span class="token punctuation">(</span>Tool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""BFCL评估工具"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> local_data_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">            name<span class="token operator">=</span><span class="token string">"bfcl_evaluation"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">            description<span class="token operator">=</span><span class="token string">"评估智能体的工具调用能力"</span>
</span><span class="code-line line-number" line="8">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="10">        self<span class="token punctuation">.</span>evaluator <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="11">        self<span class="token punctuation">.</span>metrics_calculator <span class="token operator">=</span> BFCLMetrics<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> parameters<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">        <span class="token triple-quoted-string string">"""执行评估"""</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># 1. 加载数据集</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>dataset <span class="token operator">=</span> BFCLDataset<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">        <span class="token comment"># 2. 创建评估器</span>
</span><span class="code-line line-number" line="19">        self<span class="token punctuation">.</span>evaluator <span class="token operator">=</span> BFCLEvaluator<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">        <span class="token comment"># 3. 运行评估</span>
</span><span class="code-line line-number" line="22">        results <span class="token operator">=</span> self<span class="token punctuation">.</span>evaluator<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">        <span class="token comment"># 4. 计算指标</span>
</span><span class="code-line line-number" line="25">        metrics <span class="token operator">=</span> self<span class="token punctuation">.</span>metrics_calculator<span class="token punctuation">.</span>compute_metrics<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">        <span class="token comment"># 5. 返回JSON结果</span>
</span><span class="code-line line-number" line="28">        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>results<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这个工具的设计遵循三个核心原则：首先继承 Tool 基类以遵循 HelloAgents 的工具规范，确保与框架的无缝集成；其次进行严格的参数验证，检查必需参数并提供友好的错误提示，提升用户体验；最后对结果进行格式化，返回 JSON 字符串以便于解析和展示。通过这种模块化的设计，我们实现了一个既易用又灵活的评估系统，用户可以直接使用高层的 Tool 接口快速完成评估，也可以深入到底层组件进行定制以满足特殊需求。</p>
<h3>12.2.6 扩展与优化建议</h3>
<p>通过前面的学习，我们已经掌握了如何使用 HelloAgents 进行 BFCL 评估。需要注意的是，我们目前的实现是基于 SimpleAgent 的简单复现，主要完成了 BFCL 评估的基础功能。在实际应用中，BFCL 基准包含多个难度级别和场景，要在排行榜上获得更高的分数，还需要进一步的优化和扩展。</p>
<p><strong>（1）当前实现的局限性</strong></p>
<p>我们当前的 SimpleAgent 实现主要聚焦于评估流程的搭建，在工具调用能力上还有提升空间。SimpleAgent 使用自定义的工具调用格式<code>[TOOL_CALL:tool_name:parameters]</code>，这种格式需要 LLM 主动学习和使用，在复杂场景下的表现可能不如使用原生函数调用（Function Calling）的智能体。此外，我们目前只测试了 simple_python 等基础类别，对于 multiple、parallel、irrelevance 等更复杂的场景，还需要针对性的优化。</p>
<p><strong>（2）提升 BFCL 分数的方向</strong></p>
<p>要进一步提升 BFCL 评估分数，可以从以下几个方向入手。首先是优化智能体的工具调用能力，可以考虑使用支持原生函数调用的 LLM（如 GPT-4、Claude 等），或者改进提示词让 LLM 更好地理解工具调用格式。其次是扩展工具库，BFCL 测试中涉及各种类型的函数，可以根据测试数据集的特点，预先实现常用的工具类型，提高智能体的工具覆盖率。第三是针对不同难度级别设计不同的策略，例如在 multiple 场景下需要智能体能够规划多步骤的工具调用序列，在 parallel 场景下需要识别可以并行执行的工具调用，在 irrelevance 场景下需要判断是否真的需要调用工具。</p>
<p><strong>（3）实践建议</strong></p>
<p>对于想要在 BFCL 上取得更好成绩的开发者，建议采用以下实践策略。首先，从 simple 类别开始，确保基础的单函数调用能够稳定工作，这是后续优化的基础。然后，逐步测试 multiple、parallel 等更复杂的类别，分析失败案例，找出智能体的薄弱环节。在优化过程中，可以参考 BFCL 排行榜上的高分模型，学习它们的设计思路和优化技巧。同时，建议使用官方评估工具进行验证，确保优化后的结果与排行榜标准一致。</p>
<p>这里总结一些评估时可以进一步处理的建议：</p>
<p><strong>1. 渐进式评估</strong></p>
<p>从小样本开始，逐步增加样本数：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 第一步：快速测试（5个样本）</span>
</span><span class="code-line line-number" line="2">results_quick <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 第二步：中等规模测试（50个样本）</span>
</span><span class="code-line line-number" line="5"><span class="token keyword">if</span> results_quick<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0.8</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">    results_medium <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 第三步：完整评估（全部样本）</span>
</span><span class="code-line line-number" line="9"><span class="token keyword">if</span> results_medium<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0.8</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">    results_full <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>2. 多类别评估</strong></p>
<p>评估不同难度的任务：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">categories <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> <span class="token string">"multiple"</span><span class="token punctuation">,</span> <span class="token string">"parallel"</span><span class="token punctuation">,</span> <span class="token string">"irrelevance"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">for</span> category <span class="token keyword">in</span> categories<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n评估类别: </span><span class="token interpolation"><span class="token punctuation">{</span>category<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    results <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> category<span class="token operator">=</span>category<span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>3. 对比评估</strong></p>
<p>对比不同配置的智能体：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 配置1：默认提示词</span>
</span><span class="code-line line-number" line="2">agent1 <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Agent-Default"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">results1 <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent1<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 配置2：优化提示词</span>
</span><span class="code-line line-number" line="6">agent2 <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"Agent-Optimized"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token comment"># ... 设置优化的系统提示词 ...</span>
</span><span class="code-line line-number" line="8">results2 <span class="token operator">=</span> bfcl_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>agent2<span class="token punctuation">,</span> category<span class="token operator">=</span><span class="token string">"simple_python"</span><span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 对比结果</span>
</span><span class="code-line line-number" line="11"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"默认配置准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>results1<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"优化配置准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>results2<span class="token punctuation">[</span><span class="token string">'overall_accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p>如果你的评估结果很好，可以考虑提交到 BFCL 官方排行榜！</p>
<p><strong>步骤 1：准备提交材料</strong></p>
<ol>
<li>模型描述文档</li>
<li>评估结果文件（所有类别）</li>
<li>模型访问方式（API 或开源链接）</li>
</ol>
<p><strong>步骤 2：提交到 GitHub</strong></p>
<p>访问 BFCL 官方仓库，按照说明提交 Pull Request：</p>
<ul>
<li>仓库地址：<a href="https://github.com/ShishirPatil/gorilla">https://github.com/ShishirPatil/gorilla</a></li>
<li>提交指南：参考<code>CONTRIBUTING.md</code></li>
</ul>
<p><strong>步骤 3：等待审核</strong></p>
<p>BFCL 团队会审核你的提交，验证结果的准确性。审核通过后，你的模型将出现在官方排行榜上！</p>
<h2>12.3 GAIA：通用 AI 助手能力评估</h2>
<h3>12.3.1 GAIA 基准介绍</h3>
<p>GAIA (General AI Assistants) 是由 Meta AI 和 Hugging Face 联合推出的评估基准，专注于评估 AI 助手的<strong>通用能力</strong><sup>[2]</sup>。与 BFCL 专注于工具调用不同，GAIA 评估的是智能体在真实世界任务中的综合表现。</p>
<p>GAIA 的设计理念是：<strong>真实世界的问题往往需要多种能力的综合运用</strong>。一个优秀的 AI 助手不仅需要调用工具，还需要：</p>
<ul>
<li><strong>多步推理</strong>：将复杂问题分解为多个子问题</li>
<li><strong>知识运用</strong>：利用内置知识和外部知识库</li>
<li><strong>多模态理解</strong>：处理文本、图片、文件等多种输入</li>
<li><strong>网页浏览</strong>：从互联网获取最新信息</li>
<li><strong>文件操作</strong>：读取和处理各种格式的文件</li>
</ul>
<p><strong>（1）GAIA 数据集结构</strong></p>
<p>了解 GAIA 的评估理念后，让我们深入了解 GAIA 数据集的具体结构。GAIA 包含 466 个精心设计的真实世界问题，这些问题按照复杂度和所需推理步骤分为三个难度级别，从简单的零步推理任务到需要多步复杂推理的困难任务，全面覆盖了智能体在实际应用中可能遇到的各种场景，如表 12.3 所示：</p>
<div align="center">
  <p>表 12.3 GAIA 数据集难度级别分布</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-table-3.png" alt="" width="85%">
</div>
关于 GAIA 数据集的样本示例可以参考下面的代码片段：
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"gaia_001"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"Question"</span><span class="token operator">:</span> <span class="token string">"What is the total population of the top 3 most populous cities in California?"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">  <span class="token property">"Level"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">  <span class="token property">"Final answer"</span><span class="token operator">:</span> <span class="token string">"12847521"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">  <span class="token property">"file_name"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">  <span class="token property">"file_path"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">  <span class="token property">"Annotator Metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="9">    <span class="token property">"Steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="10">      <span class="token string">"Search for most populous cities in California"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">      <span class="token string">"Get population data for top 3 cities"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">      <span class="token string">"Sum the populations"</span>
</span><span class="code-line line-number" line="13">    <span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    <span class="token property">"Number of steps"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">    <span class="token property">"How long did this take?"</span><span class="token operator">:</span> <span class="token string">"5 minutes"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    <span class="token property">"Tools"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"web_search"</span><span class="token punctuation">,</span> <span class="token string">"calculator"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="17">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">}</span>
</span></code></pre>
<p><strong>关键字段说明：</strong></p>
<ul>
<li><code>Question</code>: 问题描述</li>
<li><code>Level</code>: 难度级别（1-3）</li>
<li><code>Final answer</code>: 标准答案（可能是数字、文本或文件）</li>
<li><code>file_name/file_path</code>: 附件文件（如果有）</li>
<li><code>Annotator Metadata</code>: 标注者提供的元数据（推理步骤、所需工具等）</li>
</ul>
<p><strong>（2）准精确匹配介绍</strong></p>
<p>GAIA 使用<strong>准精确匹配（Quasi Exact Match）</strong>评估算法，这是 GAIA 官方定义的评估标准。该算法的核心思想是：<strong>先对答案进行归一化处理，然后进行精确匹配</strong>。</p>
<p>给定预测答案 $A_{\text{pred}}$ 和标准答案 $A_{\text{true}}$，准精确匹配函数定义为：</p>
<p>$$
\text{Quasi_Exact_Match}(A_{\text{pred}}, A_{\text{true}}) = \begin{cases}
1 &amp; \text{if } \mathcal{N}(A_{\text{pred}}) = \mathcal{N}(A_{\text{true}}) \
0 &amp; \text{otherwise}
\end{cases}
$$</p>
<p>其中 $\mathcal{N}(\cdot)$ 是归一化函数，根据答案类型应用不同的规则。</p>
<p>归一化函数根据答案类型应用不同的规则。对于数字类型，需要移除逗号分隔符（<code>1,000</code> → <code>1000</code>）和单位符号（<code>$100</code> → <code>100</code>，<code>50%</code> → <code>50</code>），例如<code>"$1,234.56"</code>归一化为<code>"1234.56"</code>。对于字符串类型，需要转换为小写（<code>"Apple"</code> → <code>"apple"</code>）、移除冠词（<code>"the apple"</code> → <code>"apple"</code>）、移除多余空格（<code>"hello  world"</code> → <code>"hello world"</code>）和移除末尾标点（<code>"hello."</code> → <code>"hello"</code>），例如<code>"The United States"</code>归一化为<code>"united states"</code>。对于列表类型，需要按逗号分隔元素，对每个元素应用字符串归一化，按字母顺序排序后重新连接，例如<code>"Paris, London, Berlin"</code>归一化为<code>"berlin,london,paris"</code>。</p>
<p><strong>归一化示例：</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 数字答案</span>
</span><span class="code-line line-number" line="2">原始答案<span class="token punctuation">:</span> <span class="token string">"$1,234.56"</span>
</span><span class="code-line line-number" line="3">归一化后<span class="token punctuation">:</span> <span class="token string">"1234.56"</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 字符串答案</span>
</span><span class="code-line line-number" line="6">原始答案<span class="token punctuation">:</span> <span class="token string">"The United States of America"</span>
</span><span class="code-line line-number" line="7">归一化后<span class="token punctuation">:</span> <span class="token string">"united states of america"</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 列表答案</span>
</span><span class="code-line line-number" line="10">原始答案<span class="token punctuation">:</span> <span class="token string">"Paris, London, Berlin"</span>
</span><span class="code-line line-number" line="11">归一化后<span class="token punctuation">:</span> <span class="token string">"berlin, london, paris"</span>
</span></code></pre>
<p><strong>（3）GAIA 评估指标</strong></p>
<p>GAIA 使用以下指标评估智能体性能：</p>
<p><strong>1. 精确匹配率 (Exact Match Rate)</strong></p>
<p>精确匹配率是 GAIA 的核心指标，定义为准精确匹配成功的样本比例：</p>
<p>$$
\text{Exact Match Rate} = \frac{1}{N} \sum_{i=1}^{N} \text{Quasi_Exact_Match}(A_{\text{pred},i}, A_{\text{true},i})
$$</p>
<p>其中：</p>
<ul>
<li>$N$ 是总样本数</li>
<li>$A_{\text{pred},i}$ 是第 $i$ 个样本的预测答案</li>
<li>$A_{\text{true},i}$ 是第 $i$ 个样本的标准答案</li>
<li>$\text{Quasi_Exact_Match}(\cdot, \cdot) \in {0, 1}$ 是准精确匹配函数</li>
</ul>
<p><strong>2. 分级准确率 (Level-wise Accuracy)</strong></p>
<p>对于每个难度级别 $\ell \in {1, 2, 3}$，计算该级别的准确率：</p>
<p>$$
\text{Accuracy}<em>\ell = \frac{1}{|D</em>\ell|} \sum_{i \in D_\ell} \text{Quasi_Exact_Match}(A_{\text{pred},i}, A_{\text{true},i})
$$</p>
<p>其中 $D_\ell$ 是难度级别 $\ell$ 的样本集合，$|D_\ell|$ 是该级别的样本数。</p>
<p><strong>3. 难度递进下降率 (Difficulty Progression Drop Rate)</strong></p>
<p>衡量智能体在难度增加时的性能衰减：</p>
<p>$$
\text{Drop Rate}<em>{\ell \to \ell+1} = \frac{\text{Accuracy}</em>\ell - \text{Accuracy}<em>{\ell+1}}{\text{Accuracy}</em>\ell}
$$</p>
<ul>
<li>$\text{Drop Rate}_{1 \to 2}$：从 Level 1 到 Level 2 的下降率</li>
<li>$\text{Drop Rate}_{2 \to 3}$：从 Level 2 到 Level 3 的下降率</li>
</ul>
<p><strong>4. 平均推理步骤数 (Average Reasoning Steps)</strong></p>
<p>评估智能体完成任务所需的平均步骤数：</p>
<p>$$
\text{Avg Steps} = \frac{1}{N_{\text{correct}}} \sum_{i \in \text{Correct}} \text{steps}_i
$$</p>
<p>其中 $N_{\text{correct}}$ 是正确回答的样本数，$\text{steps}_i$ 是第 $i$ 个样本的推理步骤数。</p>
<p><strong>指标解释：</strong></p>
<ul>
<li><strong>Exact Match Rate = 1.0</strong>：所有样本都完全正确</li>
<li><strong>Exact Match Rate = 0.5</strong>：50%的样本正确，50%的样本错误</li>
<li><strong>Drop Rate = 0.3</strong>：难度增加导致准确率下降 30%</li>
<li><strong>Drop Rate = 0.0</strong>：难度增加不影响准确率（理想情况）</li>
</ul>
<p><strong>评估示例：</strong></p>
<p>假设我们评估了 10 个样本，结果可以参考表 12.4 所示：</p>
<div align="center">
  <p>表 12.4 GAIA 数据集难度级别分布</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-table-4.png" alt="" width="85%">
</div>
<p>如果要计算这个案例的指标的话，可以参考下面的 Python 脚本。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 1. 精确匹配率</span>
</span><span class="code-line line-number" line="2">total_samples <span class="token operator">=</span> <span class="token number">10</span>
</span><span class="code-line line-number" line="3">correct_samples <span class="token operator">=</span> <span class="token number">7</span>  <span class="token comment"># 样本1,2,3,5,6,8,9</span>
</span><span class="code-line line-number" line="4">exact_match_rate <span class="token operator">=</span> correct_samples <span class="token operator">/</span> total_samples <span class="token operator">=</span> <span class="token number">0.70</span>  <span class="token comment"># 70%</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 2. 分级准确率</span>
</span><span class="code-line line-number" line="7">level_1_correct <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># 样本1,2,3</span>
</span><span class="code-line line-number" line="8">level_1_total <span class="token operator">=</span> <span class="token number">3</span>
</span><span class="code-line line-number" line="9">level_1_accuracy <span class="token operator">=</span> <span class="token number">3</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">1.00</span>  <span class="token comment"># 100%</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">level_2_correct <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment"># 样本5,6</span>
</span><span class="code-line line-number" line="12">level_2_total <span class="token operator">=</span> <span class="token number">3</span>
</span><span class="code-line line-number" line="13">level_2_accuracy <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token operator">=</span> <span class="token number">0.67</span>  <span class="token comment"># 67%</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">level_3_correct <span class="token operator">=</span> <span class="token number">2</span>  <span class="token comment"># 样本8,9</span>
</span><span class="code-line line-number" line="16">level_3_total <span class="token operator">=</span> <span class="token number">4</span>
</span><span class="code-line line-number" line="17">level_3_accuracy <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">/</span> <span class="token number">4</span> <span class="token operator">=</span> <span class="token number">0.50</span>  <span class="token comment"># 50%</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token comment"># 3. 难度递进下降率</span>
</span><span class="code-line line-number" line="20">drop_rate_1_to_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1.00</span> <span class="token operator">-</span> <span class="token number">0.67</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1.00</span> <span class="token operator">=</span> <span class="token number">0.33</span>  <span class="token comment"># 33%</span>
</span><span class="code-line line-number" line="21">drop_rate_2_to_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0.67</span> <span class="token operator">-</span> <span class="token number">0.50</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.67</span> <span class="token operator">=</span> <span class="token number">0.25</span>  <span class="token comment"># 25%</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"精确匹配率: </span><span class="token interpolation"><span class="token punctuation">{</span>exact_match_rate<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 70.00%</span>
</span><span class="code-line line-number" line="24"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Level 1准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>level_1_accuracy<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 100.00%</span>
</span><span class="code-line line-number" line="25"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Level 2准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>level_2_accuracy<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 66.67%</span>
</span><span class="code-line line-number" line="26"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Level 3准确率: </span><span class="token interpolation"><span class="token punctuation">{</span>level_3_accuracy<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 50.00%</span>
</span><span class="code-line line-number" line="27"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Level 1→2 下降率: </span><span class="token interpolation"><span class="token punctuation">{</span>drop_rate_1_to_2<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 33.00%</span>
</span><span class="code-line line-number" line="28"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Level 2→3 下降率: </span><span class="token interpolation"><span class="token punctuation">{</span>drop_rate_2_to_3<span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 25.00%</span>
</span></code></pre>
<p><strong>结果分析：</strong></p>
<ul>
<li><strong>整体表现</strong>：70%的精确匹配率，表现良好</li>
<li><strong>难度敏感性</strong>：从 Level 1 到 Level 2 下降 33%，说明智能体在中等难度任务上有明显衰减</li>
<li><strong>能力边界</strong>：Level 3 准确率为 50%，说明智能体在复杂任务上仍有提升空间</li>
</ul>
<p>下降率越大，说明智能体在处理复杂任务时的能力衰减越明显。</p>
<p><strong>（4）GAIA 官方系统提示词</strong></p>
<p>GAIA 要求使用特定的系统提示词，确保模型输出符合评估格式：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">GAIA_SYSTEM_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""You are a general AI assistant. I will ask you a question. Report your thoughts, and finish your answer with the following template: FINAL ANSWER: [YOUR FINAL ANSWER].
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">YOUR FINAL ANSWER should be a number OR as few words as possible OR a comma separated list of numbers and/or strings.
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">If you are asked for a number, don't use comma to write your number neither use units such as $ or percent sign unless specified otherwise.
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">If you are asked for a string, don't use articles, neither abbreviations (e.g. for cities), and write the digits in plain text unless specified otherwise.
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">If you are asked for a comma separated list, apply the above rules depending of whether the element to be put in the list is a number or a string."""</span>
</span></code></pre>
<p>GAIA 对答案格式有严格的要求：答案必须以<code>FINAL ANSWER: [答案]</code>的格式给出；对于数字类型的答案，不使用逗号分隔符和单位符号；对于字符串类型的答案，不使用冠词和缩写；对于列表类型的答案，使用逗号分隔并按字母顺序排列。</p>
<h3>12.3.2 获取 GAIA 数据集</h3>
<p><strong>重要提示</strong>：GAIA 是<strong>受限数据集（Gated Dataset）</strong>，需要先在 HuggingFace 上申请访问权限。</p>
<p><strong>步骤 1：申请访问权限</strong></p>
<ol>
<li>访问 <a href="https://huggingface.co/datasets/gaia-benchmark/GAIA">https://huggingface.co/datasets/gaia-benchmark/GAIA</a></li>
<li>点击"Request access"按钮</li>
<li>填写申请表单（通常会在几秒内批准）</li>
<li>获取你的 HuggingFace Token：<a href="https://huggingface.co/settings/tokens">https://huggingface.co/settings/tokens</a></li>
</ol>
<p><strong>步骤 2：配置环境变量</strong></p>
<p>在<code>.env</code>文件中添加你的 HuggingFace Token：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># HuggingFace API 配置</span>
</span><span class="code-line line-number" line="2"><span class="token assign-left variable">HF_TOKEN</span><span class="token operator">=</span>hf_your_token_here
</span></code></pre>
<p><strong>方法 1：使用 HelloAgents 自动下载（推荐）</strong></p>
<p>HelloAgents 会自动处理 GAIA 数据集的下载和缓存：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>evaluation <span class="token keyword">import</span> GAIADataset
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> os
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 确保设置了HF_TOKEN，如果设置了.env无需这一行</span>
</span><span class="code-line line-number" line="5">os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"HF_TOKEN"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hf_your_token_here"</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 自动下载到 ./data/gaia/</span>
</span><span class="code-line line-number" line="8">dataset <span class="token operator">=</span> GAIADataset<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="9">    dataset_name<span class="token operator">=</span><span class="token string">"gaia-benchmark/GAIA"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    split<span class="token operator">=</span><span class="token string">"validation"</span><span class="token punctuation">,</span>  <span class="token comment"># 或 "test"</span>
</span><span class="code-line line-number" line="11">    level<span class="token operator">=</span><span class="token number">1</span>  <span class="token comment"># 可选: 1, 2, 3, None(全部)</span>
</span><span class="code-line line-number" line="12"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">items <span class="token operator">=</span> dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加载了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个测试样本"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16"><span class="token comment"># 输出: 加载了 53 个测试样本 (Level 1)</span>
</span></code></pre>
<p><strong>工作原理</strong>：</p>
<ul>
<li>首次运行时，使用<code>snapshot_download</code>下载整个数据集到<code>./data/gaia/</code></li>
<li>数据集包含 114 个文件（问题、图片、PDF 等材料）</li>
<li>后续使用直接从本地加载，速度很快</li>
</ul>
<p><strong>数据集目录结构</strong>：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">./data/gaia/
</span><span class="code-line line-number" line="2">├── 2023/
</span><span class="code-line line-number" line="3">│   ├── validation/
</span><span class="code-line line-number" line="4">│   │   ├── metadata.jsonl  (165个问题)
</span><span class="code-line line-number" line="5">│   │   ├── *.png, *.pdf, *.csv, *.xlsx  (附件文件)
</span><span class="code-line line-number" line="6">│   └── test/
</span><span class="code-line line-number" line="7">│       ├── metadata.jsonl  (301个问题)
</span><span class="code-line line-number" line="8">│       └── ... (附件文件)
</span><span class="code-line line-number" line="9">├── GAIA.py
</span><span class="code-line line-number" line="10">└── README.md
</span></code></pre>
<p><strong>方法 2：手动下载</strong></p>
<p>如果你想手动下载数据集：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> huggingface_hub <span class="token keyword">import</span> snapshot_download
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> os
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 设置Token</span>
</span><span class="code-line line-number" line="5">os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"HF_TOKEN"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"hf_your_token_here"</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 下载数据集</span>
</span><span class="code-line line-number" line="8">snapshot_download<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="9">    repo_id<span class="token operator">=</span><span class="token string">"gaia-benchmark/GAIA"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    repo_type<span class="token operator">=</span><span class="token string">"dataset"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    local_dir<span class="token operator">=</span><span class="token string">"./data/gaia"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    token<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"HF_TOKEN"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>查看数据集统计</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 查看数据集统计</span>
</span><span class="code-line line-number" line="2">stats <span class="token operator">=</span> dataset<span class="token punctuation">.</span>get_statistics<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"总样本数: </span><span class="token interpolation"><span class="token punctuation">{</span>stats<span class="token punctuation">[</span><span class="token string">'total_samples'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"级别分布: </span><span class="token interpolation"><span class="token punctuation">{</span>stats<span class="token punctuation">[</span><span class="token string">'level_distribution'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># 输出:</span>
</span><span class="code-line line-number" line="6"><span class="token comment"># 总样本数: 165</span>
</span><span class="code-line line-number" line="7"><span class="token comment"># 级别分布: {1: 53, 2: 62, 3: 50}</span>
</span></code></pre>
<h3>12.3.3 在 HelloAgents 中实现 GAIA 评估</h3>
<p>与 BFCL 类似，我们提供两种评估方式，推荐使用<strong>方式 1</strong>。</p>
<p><strong>方式 1：使用 GAIAEvaluationTool 一键评估</strong></p>
<p>这是最简单的方式，自动完成数据集下载、评估执行、结果导出和报告生成：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> GAIAEvaluationTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># GAIA官方系统提示词（来自论文）</span>
</span><span class="code-line line-number" line="5">GAIA_SYSTEM_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""You are a general AI assistant. I will ask you a question. Report your thoughts, and finish your answer with the following template: FINAL ANSWER: [YOUR FINAL ANSWER].
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">YOUR FINAL ANSWER should be a number OR as few words as possible OR a comma separated list of numbers and/or strings.
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">If you are asked for a number, don't use comma to write your number neither use units such as $ or percent sign unless specified otherwise.
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">If you are asked for a string, don't use articles, neither abbreviations (e.g. for cities), and write the digits in plain text unless specified otherwise.
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">If you are asked for a comma separated list, apply the above rules depending of whether the element to be put in the list is a number or a string."""</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token comment"># 1. 创建智能体（使用GAIA官方系统提示词）</span>
</span><span class="code-line line-number" line="16">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="18">    name<span class="token operator">=</span><span class="token string">"TestAgent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">    system_prompt<span class="token operator">=</span>GAIA_SYSTEM_PROMPT  <span class="token comment"># 关键：使用GAIA官方提示词</span>
</span><span class="code-line line-number" line="21"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token comment"># 2. 创建GAIA评估工具</span>
</span><span class="code-line line-number" line="24">gaia_tool <span class="token operator">=</span> GAIAEvaluationTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26"><span class="token comment"># 3. 一键运行评估</span>
</span><span class="code-line line-number" line="27">results <span class="token operator">=</span> gaia_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="28">    agent<span class="token operator">=</span>agent<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">    level<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token comment"># Level 1: 简单任务</span>
</span><span class="code-line line-number" line="30">    max_samples<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>  <span class="token comment"># 评估5个样本</span>
</span><span class="code-line line-number" line="31">    export_results<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>  <span class="token comment"># 导出GAIA格式结果</span>
</span><span class="code-line line-number" line="32">    generate_report<span class="token operator">=</span><span class="token boolean">True</span>  <span class="token comment"># 生成评估报告</span>
</span><span class="code-line line-number" line="33"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35"><span class="token comment"># 4. 查看结果</span>
</span><span class="code-line line-number" line="36"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"精确匹配率: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'exact_match_rate'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"部分匹配率: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'partial_match_rate'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"正确数: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'exact_matches'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">[</span><span class="token string">'total_samples'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>运行结果：</strong></p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">============================================================
</span><span class="code-line line-number" line="2">GAIA一键评估
</span><span class="code-line line-number" line="3">============================================================
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">配置:
</span><span class="code-line line-number" line="6">   智能体: TestAgent
</span><span class="code-line line-number" line="7">   难度级别: 1
</span><span class="code-line line-number" line="8">   样本数量: 5
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">============================================================
</span><span class="code-line line-number" line="11">步骤1: 运行HelloAgents评估
</span><span class="code-line line-number" line="12">============================================================
</span><span class="code-line line-number" line="13">   正在从HuggingFace下载: gaia-benchmark/GAIA
</span><span class="code-line line-number" line="14">   📥 下载GAIA数据集...
</span><span class="code-line line-number" line="15">   ✓ 数据集下载完成
</span><span class="code-line line-number" line="16">   ✓ 加载了 165 个样本
</span><span class="code-line line-number" line="17">✅ GAIA数据集加载完成
</span><span class="code-line line-number" line="18">   数据源: gaia-benchmark/GAIA
</span><span class="code-line line-number" line="19">   分割: validation
</span><span class="code-line line-number" line="20">   级别: 1
</span><span class="code-line line-number" line="21">   样本数: 53
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">🌟 开始 GAIA 评估...
</span><span class="code-line line-number" line="24">   样本数量: 5
</span><span class="code-line line-number" line="25">   进度: 5/5
</span><span class="code-line line-number" line="26">✅ GAIA 评估完成
</span><span class="code-line line-number" line="27">   精确匹配率: 80.00%
</span><span class="code-line line-number" line="28">   部分匹配率: 80.00%
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">============================================================
</span><span class="code-line line-number" line="31">步骤2: 导出GAIA格式结果
</span><span class="code-line line-number" line="32">============================================================
</span><span class="code-line line-number" line="33">✅ GAIA格式结果已导出
</span><span class="code-line line-number" line="34">   输出文件: evaluation_results\gaia_official\gaia_level1_result_20251011_012648.jsonl
</span><span class="code-line line-number" line="35">   样本数: 5
</span><span class="code-line line-number" line="36">   包含推理轨迹: True
</span><span class="code-line line-number" line="37">📄 提交说明已生成: evaluation_results\gaia_official\SUBMISSION_GUIDE_20251011_012648.md
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">============================================================
</span><span class="code-line line-number" line="40">步骤3: 生成评估报告
</span><span class="code-line line-number" line="41">============================================================
</span><span class="code-line line-number" line="42">📄 报告已生成: evaluation_reports\gaia_report_20251011_012648.md
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">============================================================
</span><span class="code-line line-number" line="45">🎯 最终结果
</span><span class="code-line line-number" line="46">============================================================
</span><span class="code-line line-number" line="47">   精确匹配率: 80.00%
</span><span class="code-line line-number" line="48">   部分匹配率: 80.00%
</span><span class="code-line line-number" line="49">   正确数: 4/5
</span></code></pre>
<p>评估完成后会自动生成三类文件：首先是 GAIA 格式结果文件（<code>evaluation_results/gaia_official/gaia_level1_result_*.jsonl</code>），采用 JSONL 格式（每行一个 JSON 对象），可直接用于提交到 GAIA 排行榜；其次是提交说明文件（<code>evaluation_results/gaia_official/SUBMISSION_GUIDE_*.md</code>），包含详细的提交步骤、结果文件格式说明和注意事项；最后是评估报告（<code>evaluation_reports/gaia_report_*.md</code>），包含评估结果摘要、详细指标、样本详情和可视化图表。</p>
<p><strong>注意</strong>：如果你发现生成的评估结果不理想（例如准确率较低），这是正常现象。虽然 Level 1 是一步推理任务，但仍然需要智能体具备工具调用能力（如搜索引擎、计算器等）才能正确回答问题。我们当前使用的 SimpleAgent 主要用于演示评估流程，在工具调用能力上还有提升空间。</p>
<p><strong>方式 2：使用 Dataset + Evaluator（灵活定制）</strong></p>
<p>如果需要更细粒度的控制，可以直接使用底层组件：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>evaluation <span class="token keyword">import</span> GAIADataset<span class="token punctuation">,</span> GAIAEvaluator
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 1. 加载数据集</span>
</span><span class="code-line line-number" line="4">dataset <span class="token operator">=</span> GAIADataset<span class="token punctuation">(</span>level<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">items <span class="token operator">=</span> dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"加载了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>items<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个样本"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 2. 创建评估器</span>
</span><span class="code-line line-number" line="9">evaluator <span class="token operator">=</span> GAIAEvaluator<span class="token punctuation">(</span>dataset<span class="token operator">=</span>dataset<span class="token punctuation">,</span> level<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 3. 运行评估</span>
</span><span class="code-line line-number" line="12">results <span class="token operator">=</span> evaluator<span class="token punctuation">.</span>evaluate<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> max_samples<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token comment"># 4. 导出GAIA格式结果</span>
</span><span class="code-line line-number" line="15">evaluator<span class="token punctuation">.</span>export_to_gaia_format<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="16">    results<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    <span class="token string">"gaia_results.jsonl"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">    include_reasoning<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="19"><span class="token punctuation">)</span>
</span></code></pre>
<p>生成的评估报告（<code>gaia_report_*.md</code>）可参考下面的文件：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">#</span> GAIA评估报告</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token bold"><span class="token punctuation">**</span><span class="token content">生成时间</span><span class="token punctuation">**</span></span>: 2025-10-11 01:26:48
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token title important"><span class="token punctuation">##</span> 📊 评估概览</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">智能体</span><span class="token punctuation">**</span></span>: TestAgent
</span><span class="code-line line-number" line="8"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">难度级别</span><span class="token punctuation">**</span></span>: 1
</span><span class="code-line line-number" line="9"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">总样本数</span><span class="token punctuation">**</span></span>: 2
</span><span class="code-line line-number" line="10"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">精确匹配数</span><span class="token punctuation">**</span></span>: 1
</span><span class="code-line line-number" line="11"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">部分匹配数</span><span class="token punctuation">**</span></span>: 1
</span><span class="code-line line-number" line="12"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">精确匹配率</span><span class="token punctuation">**</span></span>: 50.00%
</span><span class="code-line line-number" line="13"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">部分匹配率</span><span class="token punctuation">**</span></span>: 50.00%
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token title important"><span class="token punctuation">##</span> 📈 详细指标</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token title important"><span class="token punctuation">###</span> 分级准确率</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token list punctuation">-</span> <span class="token bold"><span class="token punctuation">**</span><span class="token content">Level 1</span><span class="token punctuation">**</span></span>: 50.00% 精确 / 50.00% 部分 (1/2)
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token title important"><span class="token punctuation">##</span> 📝 样本详情（前10个）</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 任务ID </span><span class="token punctuation">|</span><span class="token table-header important"> 级别 </span><span class="token punctuation">|</span><span class="token table-header important"> 预测答案 </span><span class="token punctuation">|</span><span class="token table-header important"> 正确答案 </span><span class="token punctuation">|</span><span class="token table-header important"> 精确匹配 </span><span class="token punctuation">|</span><span class="token table-header important"> 部分匹配 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="24"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">--------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span><span class="token punctuation">----------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="25"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> e1fc63a2-da7a-432f-be78-7c4a95598703 </span><span class="token punctuation">|</span><span class="token table-data"> 1 </span><span class="token punctuation">|</span><span class="token table-data"> 24000 </span><span class="token punctuation">|</span><span class="token table-data"> 17 </span><span class="token punctuation">|</span><span class="token table-data"> ❌ </span><span class="token punctuation">|</span><span class="token table-data"> ❌ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="26"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 8e867cd7-cff9-4e6c-867a-ff5ddc2550be </span><span class="token punctuation">|</span><span class="token table-data"> 1 </span><span class="token punctuation">|</span><span class="token table-data"> 3 </span><span class="token punctuation">|</span><span class="token table-data"> 3 </span><span class="token punctuation">|</span><span class="token table-data"> ✅ </span><span class="token punctuation">|</span><span class="token table-data"> ✅ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="27"><span class="token table"><span class="token table-data-rows"></span></span>
</span><span class="code-line line-number" line="28"><span class="token title important"><span class="token punctuation">##</span> 📊 准确率可视化</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">精确匹配: █████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░ 50.00%
</span><span class="code-line line-number" line="31">部分匹配: █████████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░ 50.00%
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34"><span class="token title important"><span class="token punctuation">##</span> 💡 建议</span>
</span><span class="code-line line-number" line="35">
</span><span class="code-line line-number" line="36"><span class="token list punctuation">-</span> ⚠️ 表现一般，需要改进。
</span><span class="code-line line-number" line="37"><span class="token list punctuation">-</span> 💡 建议检查工具使用和多步推理能力。
</span></code></pre>
<p>**生成的 GAIA 格式结果（<code>gaia_level1_result_*.jsonl</code>）：<strong></strong></p><strong>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span><span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"e1fc63a2-da7a-432f-be78-7c4a95598703"</span><span class="token punctuation">,</span> <span class="token property">"model_answer"</span><span class="token operator">:</span> <span class="token string">"24000"</span><span class="token punctuation">,</span> <span class="token property">"reasoning_trace"</span><span class="token operator">:</span> <span class="token string">"24000"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="2"><span class="token punctuation">{</span><span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"8e867cd7-cff9-4e6c-867a-ff5ddc2550be"</span><span class="token punctuation">,</span> <span class="token property">"model_answer"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token property">"reasoning_trace"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">}</span>
</span></code></pre>
<h3>12.3.4 提交结果到 GAIA 官方排行榜</h3>
<p>使用 GAIAEvaluationTool 运行评估后，会在<code>evaluation_results/gaia_official/</code>目录下生成提交所需的文件和详细的提交说明。</p>
</strong><ol><strong>
</strong><li><strong>
</strong><p><strong></strong>GAIA 格式结果文件**：<code>gaia_level1_result_*.jsonl</code></p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span><span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"xxx"</span><span class="token punctuation">,</span> <span class="token property">"model_answer"</span><span class="token operator">:</span> <span class="token string">"答案"</span><span class="token punctuation">,</span> <span class="token property">"reasoning_trace"</span><span class="token operator">:</span> <span class="token string">"推理过程"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="2"><span class="token punctuation">{</span><span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"yyy"</span><span class="token punctuation">,</span> <span class="token property">"model_answer"</span><span class="token operator">:</span> <span class="token string">"答案"</span><span class="token punctuation">,</span> <span class="token property">"reasoning_trace"</span><span class="token operator">:</span> <span class="token string">"推理过程"</span><span class="token punctuation">}</span>
</span></code></pre>
</li>
<li>
<p><strong>提交说明文件</strong>：<code>SUBMISSION_GUIDE_*.md</code></p>
</li>
</ol>
<p>打开自动生成的<code>SUBMISSION_GUIDE_*.md</code>文件，里面包含完整的提交指南：</p>
<p>具体来说，打开浏览器，访问：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">https://huggingface.co/spaces/gaia-benchmark/leaderboard
</span></code></pre>
<p>如图 12.4 所示，提交表单中填写信息即可：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-4.png" alt="" width="85%">
  <p>图 12.4 BFCL 评估流程图</p>
</div>
<p>提交前，可以手动检查生成的 JSONL 文件：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 读取结果文件</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"evaluation_results/gaia_official/gaia_level1_result_*.jsonl"</span><span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">        result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Task ID: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'task_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Answer: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'model_answer'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Reasoning: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">[</span><span class="token string">'reasoning_trace'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span></code></pre>
<h3>12.3.5 核心组件实现细节</h3>
<p>GAIA 评估系统的实现与 BFCL 类似，但针对通用能力评估有一些特殊的设计。</p>
<p><strong>（1）GAIADataset：支持多模态的数据加载器</strong></p>
<p>GAIA 数据集的特殊之处在于它包含多模态数据（文本、文件、图片等）：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">GAIADataset</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""GAIA数据集加载器
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    支持从HuggingFace加载GAIA数据集（受限数据集）
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="8">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">        level<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">        split<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"validation"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">        local_data_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="12">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">        self<span class="token punctuation">.</span>level <span class="token operator">=</span> level
</span><span class="code-line line-number" line="14">        self<span class="token punctuation">.</span>split <span class="token operator">=</span> split
</span><span class="code-line line-number" line="15">        self<span class="token punctuation">.</span>local_data_dir <span class="token operator">=</span> local_data_dir <span class="token keyword">or</span> <span class="token string">"./data/gaia"</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">        <span class="token triple-quoted-string string">"""加载数据集"""</span>
</span><span class="code-line line-number" line="20">        <span class="token comment"># 从HuggingFace下载</span>
</span><span class="code-line line-number" line="21">        items <span class="token operator">=</span> self<span class="token punctuation">.</span>_load_from_huggingface<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">        <span class="token comment"># 按级别过滤</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>level<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="25">            items <span class="token operator">=</span> <span class="token punctuation">[</span>item <span class="token keyword">for</span> item <span class="token keyword">in</span> items <span class="token keyword">if</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>level<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">        self<span class="token punctuation">.</span>data <span class="token operator">=</span> items
</span><span class="code-line line-number" line="28">        <span class="token keyword">return</span> items
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">    <span class="token keyword">def</span> <span class="token function">_load_from_huggingface</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">        <span class="token triple-quoted-string string">"""从HuggingFace下载GAIA数据集"""</span>
</span><span class="code-line line-number" line="32">        <span class="token keyword">from</span> huggingface_hub <span class="token keyword">import</span> snapshot_download
</span><span class="code-line line-number" line="33">        <span class="token keyword">import</span> json
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35">        <span class="token comment"># 下载数据集</span>
</span><span class="code-line line-number" line="36">        repo_id <span class="token operator">=</span> <span class="token string">"gaia-benchmark/GAIA"</span>
</span><span class="code-line line-number" line="37">        local_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="38">            repo_id<span class="token operator">=</span>repo_id<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="39">            repo_type<span class="token operator">=</span><span class="token string">"dataset"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="40">            local_dir<span class="token operator">=</span>self<span class="token punctuation">.</span>local_data_dir<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="41">            local_dir_use_symlinks<span class="token operator">=</span><span class="token boolean">False</span>
</span><span class="code-line line-number" line="42">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">        <span class="token comment"># 加载JSONL文件</span>
</span><span class="code-line line-number" line="45">        data_file <span class="token operator">=</span> Path<span class="token punctuation">(</span>local_dir<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token string">"2023"</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>split <span class="token operator">/</span> <span class="token string">"metadata.jsonl"</span>
</span><span class="code-line line-number" line="46">        items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="47">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="48">            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="49">                item <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="50">                items<span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_standardize_item<span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52">        <span class="token keyword">return</span> items
</span></code></pre>
<p><strong>（2）GAIAEvaluator：实现 GAIA 官方评估算法</strong></p>
<p>GAIA 的评估使用<strong>准精确匹配（Quasi Exact Match）</strong>算法，需要特殊的答案归一化和匹配逻辑：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">GAIAEvaluator</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""GAIA评估器
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    实现GAIA官方的准精确匹配（Quasi Exact Match）评估算法
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">    <span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> agent<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> max_samples<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">        <span class="token triple-quoted-string string">"""执行评估"""</span>
</span><span class="code-line line-number" line="9">        dataset_items <span class="token operator">=</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">        <span class="token keyword">if</span> max_samples<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">            dataset_items <span class="token operator">=</span> dataset_items<span class="token punctuation">[</span><span class="token punctuation">:</span>max_samples<span class="token punctuation">]</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">        results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="15">        <span class="token keyword">for</span> i<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataset_items<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">            <span class="token comment"># 1. 构造提示词</span>
</span><span class="code-line line-number" line="17">            prompt <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_prompt<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">"question"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">            <span class="token comment"># 2. 调用智能体</span>
</span><span class="code-line line-number" line="20">            response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>prompt<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">            <span class="token comment"># 3. 提取答案（GAIA格式：FINAL ANSWER: [答案]）</span>
</span><span class="code-line line-number" line="23">            predicted_answer <span class="token operator">=</span> self<span class="token punctuation">.</span>_extract_answer<span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">            <span class="token comment"># 4. 归一化答案（GAIA官方规则）</span>
</span><span class="code-line line-number" line="26">            normalized_pred <span class="token operator">=</span> self<span class="token punctuation">.</span>_normalize_answer<span class="token punctuation">(</span>predicted_answer<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">            normalized_truth <span class="token operator">=</span> self<span class="token punctuation">.</span>_normalize_answer<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token string">"final_answer"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29">            <span class="token comment"># 5. 准精确匹配</span>
</span><span class="code-line line-number" line="30">            exact_match <span class="token operator">=</span> <span class="token punctuation">(</span>normalized_pred <span class="token operator">==</span> normalized_truth<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32">            results<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="33">                <span class="token string">"task_id"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"task_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="34">                <span class="token string">"predicted"</span><span class="token punctuation">:</span> predicted_answer<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="35">                <span class="token string">"expected"</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">"final_answer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">                <span class="token string">"exact_match"</span><span class="token punctuation">:</span> exact_match<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">                <span class="token string">"level"</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"level"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_format_results<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</span></code></pre>
<p>GAIA 使用特定的归一化规则来处理不同类型的答案：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_normalize_answer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> answer<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""标准化答案字符串（GAIA官方标准化规则）
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    规则：
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    1. 数字：移除逗号分隔符和单位符号
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    2. 字符串：移除冠词、转小写、移除多余空格
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    3. 列表：逗号分隔，按字母顺序排序
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="9">    <span class="token keyword">if</span> <span class="token keyword">not</span> answer<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">        <span class="token keyword">return</span> <span class="token string">""</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">    answer <span class="token operator">=</span> answer<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">    <span class="token comment"># 检查是否是逗号分隔的列表</span>
</span><span class="code-line line-number" line="15">    <span class="token keyword">if</span> <span class="token string">','</span> <span class="token keyword">in</span> answer<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        parts <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>_normalize_single_answer<span class="token punctuation">(</span>p<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> answer<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="17">        parts<span class="token punctuation">.</span>sort<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># GAIA要求按字母顺序排序</span>
</span><span class="code-line line-number" line="18">        <span class="token keyword">return</span> <span class="token string">','</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>parts<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_normalize_single_answer<span class="token punctuation">(</span>answer<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22"><span class="token keyword">def</span> <span class="token function">_normalize_single_answer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> answer<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">    <span class="token triple-quoted-string string">"""标准化单个答案（不包含逗号的答案）"""</span>
</span><span class="code-line line-number" line="24">    answer <span class="token operator">=</span> answer<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    <span class="token comment"># 移除常见的冠词</span>
</span><span class="code-line line-number" line="27">    articles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'the'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'an'</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="28">    words <span class="token operator">=</span> answer<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">    <span class="token keyword">if</span> words <span class="token keyword">and</span> words<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">in</span> articles<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="30">        words <span class="token operator">=</span> words<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">        answer <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>words<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">    <span class="token comment"># 移除货币符号和百分号</span>
</span><span class="code-line line-number" line="34">    answer <span class="token operator">=</span> answer<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'%'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'€'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'£'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">
</span><span class="code-line line-number" line="36">    <span class="token comment"># 移除数字中的逗号分隔符</span>
</span><span class="code-line line-number" line="37">    answer <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'(\d),(\d)'</span><span class="token punctuation">,</span> <span class="token string">r'\1\2'</span><span class="token punctuation">,</span> answer<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">    <span class="token comment"># 移除多余空格</span>
</span><span class="code-line line-number" line="40">    answer <span class="token operator">=</span> <span class="token string">' '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>answer<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">
</span><span class="code-line line-number" line="42">    <span class="token comment"># 移除末尾的标点符号</span>
</span><span class="code-line line-number" line="43">    answer <span class="token operator">=</span> answer<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">'.,;:!?'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45">    <span class="token keyword">return</span> answer
</span></code></pre>
<p>GAIA 要求模型输出格式为<code>FINAL ANSWER: [答案]</code>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_extract_answer</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""从响应中提取答案（GAIA格式）
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    GAIA要求答案格式为：FINAL ANSWER: [答案]
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="6">    <span class="token comment"># 首先尝试提取GAIA官方格式的答案</span>
</span><span class="code-line line-number" line="7">    final_answer_pattern <span class="token operator">=</span> <span class="token string">r'FINAL ANSWER:\s*(.+?)(?:\n|$)'</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>final_answer_pattern<span class="token punctuation">,</span> response<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE <span class="token operator">|</span> re<span class="token punctuation">.</span>MULTILINE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">        answer <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">        <span class="token comment"># 移除可能的方括号</span>
</span><span class="code-line line-number" line="12">        answer <span class="token operator">=</span> answer<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">'[]'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">        <span class="token keyword">return</span> answer
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">    <span class="token comment"># 备用方案：查找其他答案标记</span>
</span><span class="code-line line-number" line="16">    answer_patterns <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="17">        <span class="token string">r'答案[：:]\s*(.+)'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">        <span class="token string">r'最终答案[：:]\s*(.+)'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">        <span class="token string">r'Final answer[：:]\s*(.+)'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        <span class="token string">r'Answer[：:]\s*(.+)'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">    <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">    <span class="token keyword">for</span> pattern <span class="token keyword">in</span> answer_patterns<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> response<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">        <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">            <span class="token keyword">return</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">    <span class="token comment"># 如果没有找到标记，返回最后一个非空行</span>
</span><span class="code-line line-number" line="29">    lines <span class="token operator">=</span> response<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">    <span class="token keyword">for</span> line <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">        line <span class="token operator">=</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">        <span class="token keyword">if</span> line <span class="token keyword">and</span> <span class="token keyword">not</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">            <span class="token keyword">return</span> line
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p>评估完成后，可以导出为 GAIA 官方要求的 JSONL 格式：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">export_to_gaia_format</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    results<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    output_path<span class="token punctuation">:</span> Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    include_reasoning<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">    <span class="token triple-quoted-string string">"""导出为GAIA官方格式（JSONL）
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    GAIA要求的格式：
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    {"task_id": "xxx", "model_answer": "答案", "reasoning_trace": "推理过程"}
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="12">    output_path <span class="token operator">=</span> Path<span class="token punctuation">(</span>output_path<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">    output_path<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"detailed_results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">            entry <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">                <span class="token string">"task_id"</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token string">"task_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">                <span class="token string">"model_answer"</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token string">"predicted"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="20">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">            <span class="token keyword">if</span> include_reasoning<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">                entry<span class="token punctuation">[</span><span class="token string">"reasoning_trace"</span><span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"response"</span><span class="token punctuation">,</span> result<span class="token punctuation">[</span><span class="token string">"predicted"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>entry<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n'</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（3）GAIAEvaluationTool：一键评估工具</strong></p>
<p>GAIAEvaluationTool 封装了完整的评估流程，提供一键评估功能：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">GAIAEvaluationTool</span><span class="token punctuation">(</span>Tool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""GAIA评估工具
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    提供一键评估功能：
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    1. 运行HelloAgents评估
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    2. 导出GAIA格式结果
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    3. 生成评估报告
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    4. 生成提交说明
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        agent<span class="token punctuation">:</span> Any<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        level<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">        max_samples<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        local_data_dir<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">        export_results<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">        generate_report<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>
</span><span class="code-line line-number" line="19">    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        <span class="token triple-quoted-string string">"""执行GAIA一键评估"""</span>
</span><span class="code-line line-number" line="21">        <span class="token comment"># 步骤1: 运行HelloAgents评估</span>
</span><span class="code-line line-number" line="22">        results <span class="token operator">=</span> self<span class="token punctuation">.</span>_run_evaluation<span class="token punctuation">(</span>agent<span class="token punctuation">,</span> level<span class="token punctuation">,</span> max_samples<span class="token punctuation">,</span> local_data_dir<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">        <span class="token comment"># 步骤2: 导出GAIA格式结果</span>
</span><span class="code-line line-number" line="25">        <span class="token keyword">if</span> export_results<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">            self<span class="token punctuation">.</span>_export_results<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">        <span class="token comment"># 步骤3: 生成评估报告</span>
</span><span class="code-line line-number" line="29">        <span class="token keyword">if</span> generate_report<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="30">            self<span class="token punctuation">.</span>generate_report<span class="token punctuation">(</span>results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32">        <span class="token keyword">return</span> results
</span></code></pre>
<p>GAIAEvaluationTool 会自动生成评估报告：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">generate_report</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    results<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    output_file<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Path<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="5"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">    <span class="token triple-quoted-string string">"""生成评估报告"""</span>
</span><span class="code-line line-number" line="7">    report <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""# GAIA评估报告
</span></span></span><span class="code-line line-number" line="8"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="9"><span class="token string-interpolation"><span class="token string">**生成时间**: </span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="10"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="11"><span class="token string-interpolation"><span class="token string">## 📊 评估概览
</span></span></span><span class="code-line line-number" line="12"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="13"><span class="token string-interpolation"><span class="token string">- **智能体**: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"agent_name"</span><span class="token punctuation">,</span> <span class="token string">"Unknown"</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="14"><span class="token string-interpolation"><span class="token string">- **难度级别**: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"level_filter"</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token string">'全部'</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="15"><span class="token string-interpolation"><span class="token string">- **总样本数**: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"total_samples"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="16"><span class="token string-interpolation"><span class="token string">- **精确匹配数**: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"exact_matches"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="17"><span class="token string-interpolation"><span class="token string">- **精确匹配率**: </span><span class="token interpolation"><span class="token punctuation">{</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"exact_match_rate"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.2%</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="18"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="19"><span class="token string-interpolation"><span class="token string">## 📈 详细指标
</span></span></span><span class="code-line line-number" line="20"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="21"><span class="token string-interpolation"><span class="token string">### 分级准确率
</span></span></span><span class="code-line line-number" line="22"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="23"><span class="token string-interpolation"><span class="token string">{self._format_level_metrics(results.get("level_metrics", {}))}
</span></span></span><span class="code-line line-number" line="24"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="25"><span class="token string-interpolation"><span class="token string">## 📝 样本详情（前10个）
</span></span></span><span class="code-line line-number" line="26"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="27"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_format_sample_details<span class="token punctuation">(</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"detailed_results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="28"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="29"><span class="token string-interpolation"><span class="token string">## 📊 准确率可视化
</span></span></span><span class="code-line line-number" line="30"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="31"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_format_visualization<span class="token punctuation">(</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"exact_match_rate"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="32"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="33"><span class="token string-interpolation"><span class="token string">## 💡 建议
</span></span></span><span class="code-line line-number" line="34"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="35"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>_format_suggestions<span class="token punctuation">(</span>results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"exact_match_rate"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="36"><span class="token string-interpolation"><span class="token string">"""</span></span>
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38">    <span class="token comment"># 保存报告</span>
</span><span class="code-line line-number" line="39">    <span class="token keyword">if</span> output_file <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="40">        output_dir <span class="token operator">=</span> Path<span class="token punctuation">(</span><span class="token string">"./evaluation_reports"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">        output_dir<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">        output_file <span class="token operator">=</span> output_dir <span class="token operator">/</span> <span class="token string-interpolation"><span class="token string">f"gaia_report_</span><span class="token interpolation"><span class="token punctuation">{</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y%m%d_%H%M%S'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.md"</span></span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>output_file<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="45">        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>report<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">
</span><span class="code-line line-number" line="47">    <span class="token keyword">return</span> report
</span></code></pre>
<h2>12.4 数据生成质量评估</h2>
<p>在 AI 系统开发中，高质量的训练数据是系统性能的基础。本节介绍如何使用 HelloAgents 框架评估生成数据的质量，以 AIME（美国数学邀请赛）<sup>[9]</sup>风格的数学题目生成为例。</p>
<p>AIME 是美国数学协会（MAA）主办的中等难度数学竞赛，介于 AMC 10/12 和美国数学奥林匹克（USAMO）之间。AIME 题目具有鲜明的特点：每道题的答案都是 0 到 999 之间的整数，题目涵盖代数、几何、数论、组合、概率等多个数学领域，需要多步推理但不涉及高深理论，难度适中（相当于 AIME 第 6-9 题的水平）。这些特点使得 AIME 题目成为评估数学题目生成质量的理想基准：答案格式统一便于自动化评估，题目难度适中适合大规模生成。我们使用 HuggingFace 上的<code>TianHongZXY/aime-1983-2025</code>数据集作为参考，该数据集包含从 1983 年到 2025 年的 900 多道 AIME 真题，为我们的生成和评估提供了丰富的参考样本。</p>
<h3>12.4.1 评估方法概述</h3>
<p>在数据生成质量评估中，我们采用三种互补的评估方法：LLM Judge、Win Rate 和人工打分。选择这三种方法有两个重要原因。首先，从方法论角度来看，这些是当前智能体领域常用的自动化测评方案，也是许多学术论文中的主流做法，具有广泛的认可度和实践基础。其次，从适用性角度来看，这三种方法天然适合我们的评估场景：LLM Judge 和 Win Rate 用于评估题目生成质量（从正确性、清晰度、难度匹配等维度进行多维度评估），而人工打分用于评估答案生成质量（通过人类专家验证答案的准确性），这种分工非常合理且易于理解。</p>
<p>下面我们详细介绍这三种评估方法的具体实现。整个案例的实现流程如图 12.5 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-5.png" alt="" width="85%">
  <p>图 12.5 数据生成质量评估流程图</p>
</div>
<strong>（1）LLM Judge 评估</strong>
<p><strong>设计动机</strong>：在数据生成质量评估中，我们需要对大量生成的题目进行快速、一致的质量评估。传统的人工评估虽然准确，但成本高、效率低，难以应对大规模数据生成的需求。LLM Judge 通过使用大语言模型作为评委，可以自动化地从多个维度评估生成数据的质量，不仅大幅提升评估效率，还能保持评估标准的一致性。更重要的是，LLM Judge 可以提供详细的评分理由和改进建议，帮助我们理解生成数据的优缺点，为后续优化提供方向。</p>
<p>在我们的实现中，LLM Judge 从四个关键维度评估 AIME 题目的质量：</p>
<div align="center">
  <p>表 12.5 LLM Judge 评估 AIME 题目的维度</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-table-4.png" alt="" width="85%">
</div>
<p>有了四个维度的评分后，我们需要将这些评分汇总成整体的评估指标。我们定义了三个关键指标来衡量生成题目的质量水平：</p>
<p><strong>评估指标</strong>：</p>
<p><strong>1. 平均分（Average Score）</strong>：计算所有题目在四个维度上的平均得分，反映生成题目的整体质量水平。
$$
\text{Average Score} = \frac{1}{N} \sum_{i=1}^{N} \frac{\sum_{d=1}^{4} S_{i,d}}{4}
$$</p>
<p><strong>2. 及格率（Pass Rate）</strong>：统计平均分达到 3.5 分及以上的题目比例，反映生成题目的基本质量保障。</p>
<p>$$
\text{Pass Rate} = \frac{|{i : \text{Score}_i \geq 3.5}|}{N}
$$</p>
<p><strong>3. 优秀率（Excellent Rate）</strong>：统计平均分达到 4.5 分及以上的题目比例，反映生成题目的高质量占比。</p>
<p>$$
\text{Excellent Rate} = \frac{|{i : \text{Score}_i \geq 4.5}|}{N}
$$</p>
<p>其中：</p>
<ul>
<li>$N$ 是评估的题目总数</li>
<li>$S_{i,d}$ 是第 $i$ 个题目在第 $d$ 个维度的得分（1-5 分）</li>
<li>$\text{Score}_i$ 是第 $i$ 个题目的平均分（四个维度得分的平均值）</li>
</ul>
<p>这三个指标从不同角度反映生成质量：平均分给出整体水平，及格率保证基本质量，优秀率衡量高质量产出能力。</p>
<p><strong>（2）Win Rate 评估</strong></p>
<p><strong>设计动机</strong>：虽然 LLM Judge 可以提供多维度的绝对评分，但我们还需要一个相对评估指标来衡量生成题目与真题的质量差距。Win Rate 评估通过成对对比的方式，让 LLM 直接判断生成题目和真题哪个更好，这种相对比较比绝对评分更符合人类的判断习惯，也更容易发现生成题目的相对优势和劣势。理想情况下，如果生成题目的质量接近真题，Win Rate 应该在 50%左右（即生成题目和真题各有 50%的胜率）。这个指标简单直观，可以快速判断生成系统的整体质量水平。</p>
<p>在我们的实现中，Win Rate 评估通过以下图 12.6 所示流程进行评估：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-6.png" alt="" width="85%">
  <p>图 12.6 数据生成质量评估流程图</p>
</div>
<p>在成对对比评估中，每次比较会产生三种可能的结果：生成题目获胜（Win）、真题获胜（Loss）或平局（Tie）。我们通过统计这三种结果的比例来评估生成题目的质量：</p>
<p><strong>评估指标</strong>：</p>
<p><strong>1. 胜率（Win Rate）</strong>：生成题目被判定为更好的比例，反映生成题目相对于真题的优势。</p>
<p>$$
\text{Win Rate} = \frac{\text{Wins}}{\text{Total Comparisons}}
$$</p>
<p><strong>2. 败率（Loss Rate）</strong>：真题被判定为更好的比例，反映生成题目相对于真题的劣势。</p>
<p>$$
\text{Loss Rate} = \frac{\text{Losses}}{\text{Total Comparisons}}
$$</p>
<p><strong>3. 平局率（Tie Rate）</strong>：两者被判定为质量相当的比例，反映生成题目与真题的相似程度。</p>
<p>$$
\text{Tie Rate} = \frac{\text{Ties}}{\text{Total Comparisons}}
$$</p>
<p>其中，Total Comparisons 是总的对比次数，Wins、Losses 和 Ties 分别是生成题目获胜、失败和平局的次数。这三个指标满足：Win Rate + Loss Rate + Tie Rate = 100%。</p>
<p><strong>理想结果</strong>：Win Rate ≈ 50%（说明生成质量接近真题）。如果 Win Rate 显著低于 50%，说明生成题目质量不如真题，需要优化生成策略；如果 Win Rate 显著高于 50%，可能说明生成题目在某些方面超越了真题，或者评估标准存在偏差。</p>
<p><strong>（3）人工验证</strong></p>
<p><strong>设计动机</strong>：尽管 LLM Judge 和 Win Rate 可以自动化评估题目质量，但对于数学题目这种需要严格逻辑推理的内容，人工验证仍然是不可或缺的。特别是在评估答案生成质量时，需要人类专家验证答案的准确性、解答步骤的完整性和数学推理的严密性。此外，人工验证还可以发现自动化评估可能遗漏的问题，如题目的创新性、趣味性等主观因素。为了提高人工验证的效率和体验，我们开发了基于 Gradio 的 Web 界面，让验证者可以方便地浏览题目、评分、标注状态和添加评论，大大降低了人工验证的门槛。</p>
<p>在我们的实现中，人工验证通过以下步骤进行：</p>
<ol>
<li>阅读题目、答案、解答</li>
<li>评分（1-5 分）：正确性、清晰度、难度匹配、完整性</li>
<li>标注状态：
<ul>
<li>✅ approved（通过）</li>
<li>❌ rejected（拒绝）</li>
<li>🔄 needs_revision（需修改）</li>
</ul>
</li>
<li>添加评论</li>
</ol>
<h3>12.4.2 系统架构</h3>
<p>数据生成与评估系统采用模块化设计：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">data_generation/
</span><span class="code-line line-number" line="2">├── aime_generator.py              # AIME题目生成器
</span><span class="code-line line-number" line="3">├── human_verification_ui.py       # 人工验证界面
</span><span class="code-line line-number" line="4">├── run_complete_evaluation.py     # 完整评估流程
</span><span class="code-line line-number" line="5">│
</span><span class="code-line line-number" line="6">├── generated_data/                # 生成的数据
</span><span class="code-line line-number" line="7">│   ├── aime_generated_XXXXXX.json
</span><span class="code-line line-number" line="8">│   └── generation_report_XXXXXX.md
</span><span class="code-line line-number" line="9">│
</span><span class="code-line line-number" line="10">└── evaluation_results/            # 评估结果
</span><span class="code-line line-number" line="11">    └── XXXXXX/
</span><span class="code-line line-number" line="12">        ├── llm_judge/
</span><span class="code-line line-number" line="13">        ├── win_rate/
</span><span class="code-line line-number" line="14">        └── comprehensive_report.md
</span></code></pre>
<p>系统包含四个核心组件：首先是 AIMEGenerator（题目生成器），使用 HelloAgents 框架生成 AIME 风格题目，支持批量生成和进度保存，并能自动处理 API 速率限制；其次是 LLMJudgeTool（LLM Judge 评估工具），提供 4 维度质量评估，自动生成 JSON 结果和 Markdown 报告；第三是 WinRateTool（Win Rate 评估工具），通过成对对比评估计算胜率、败率和平局率；最后是 HumanVerificationUI（人工验证界面），基于 Gradio Web 界面，支持评分和状态标注。</p>
<h3>12.4.3 AIME 题目生成器实现</h3>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">AIMEGenerator</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""AIME Problem Generator"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="5">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">        llm<span class="token punctuation">:</span> HelloAgentsLLM <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">        delay_seconds<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">        use_reference_examples<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">        reference_dataset<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"TianHongZXY/aime-1983-2025"</span>
</span><span class="code-line line-number" line="10">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> llm <span class="token keyword">or</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">.</span>agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="13">            name<span class="token operator">=</span><span class="token string">"AIME Generator"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">            llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">            system_prompt<span class="token operator">=</span><span class="token string">"You are a professional mathematics competition problem designer."</span>
</span><span class="code-line line-number" line="16">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>delay_seconds <span class="token operator">=</span> delay_seconds
</span><span class="code-line line-number" line="18">        self<span class="token punctuation">.</span>use_reference_examples <span class="token operator">=</span> use_reference_examples
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">        <span class="token comment"># Load reference examples from 900+ AIME problems (1983-2025)</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">if</span> use_reference_examples<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">            dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span>reference_dataset<span class="token punctuation">,</span> split<span class="token operator">=</span><span class="token string">"test"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">            self<span class="token punctuation">.</span>reference_examples <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span>
</span></code></pre>
<p>我们的目标是生成类似风格的数据集，所以从 900+道 AIME 真题（1983-2025）中随机选择参考样例</p>
<p>生成提示词设计（英文）：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">GENERATION_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""You are a professional mathematics competition problem designer, skilled in creating AIME (American Invitational Mathematics Examination) style problems.
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">【Reference Example】(For style reference only, please generate a completely different problem)
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">Problem: {example_problem}
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">Answer: {example_answer}
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">AIME Problem Characteristics:
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">1. Answer: An integer between 0 and 999
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">2. Topics: Algebra, Geometry, Number Theory, Combinatorics, Probability, etc.
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">3. Style: Requires multi-step reasoning, but no advanced theory
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">4. Difficulty: Medium to hard (similar to AIME problems 6-9)
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">Please generate a **completely different** AIME-style mathematics problem, including:
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">1. Problem statement (clear and complete, different from the reference)
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">2. Answer (an integer between 0 and 999, different from the reference)
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">3. Detailed solution (including all reasoning steps)
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">4. Topic classification (Algebra/Geometry/Number Theory/Combinatorics/Probability)
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">Please output in the following JSON format:
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">    "problem": "Problem statement in English",
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">    "answer": 123,
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">    "solution": "Detailed solution steps in English",
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">    "topic": "Algebra"
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p>我们选择使用英文生成题目有四个重要原因：首先是与 AIME 真题保持一致（AIME 是英文竞赛，生成英文题目更合理），其次是确保评估的公平性（LLM Judge 评估时英文 vs 英文更公平），第三是便于国际化（英文题目可以被更广泛使用），最后是避免翻译问题（不需要担心中英文翻译的准确性）。</p>
<p>批量生成实现：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">generate_and_save</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_problems<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span> output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"data_generation/generated_data"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""Generate and save problems with intelligent delay"""</span>
</span><span class="code-line line-number" line="3">    <span class="token comment"># Clean old checkpoints</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">for</span> <span class="token builtin">file</span> <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token keyword">if</span> <span class="token builtin">file</span><span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"checkpoint_"</span><span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token builtin">file</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".json"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">            os<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>output_dir<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">    <span class="token comment"># Generate with tqdm progress bar</span>
</span><span class="code-line line-number" line="9">    <span class="token keyword">with</span> tqdm<span class="token punctuation">(</span>total<span class="token operator">=</span>num_problems<span class="token punctuation">,</span> desc<span class="token operator">=</span><span class="token string">"Generating AIME problems"</span><span class="token punctuation">,</span> unit<span class="token operator">=</span><span class="token string">"problem"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> pbar<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">        last_call_time <span class="token operator">=</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_problems<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">            <span class="token comment"># Ensure minimum delay between API calls</span>
</span><span class="code-line line-number" line="14">            <span class="token keyword">if</span> last_call_time <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">                elapsed <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> last_call_time
</span><span class="code-line line-number" line="16">                <span class="token keyword">if</span> elapsed <span class="token operator">&lt;</span> self<span class="token punctuation">.</span>delay_seconds<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">                    wait_time <span class="token operator">=</span> self<span class="token punctuation">.</span>delay_seconds <span class="token operator">-</span> elapsed
</span><span class="code-line line-number" line="18">                    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>wait_time<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">            <span class="token comment"># Generate problem (randomly select reference example)</span>
</span><span class="code-line line-number" line="21">            start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">            problem <span class="token operator">=</span> self<span class="token punctuation">.</span>generate_single<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">            last_call_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">            generation_time <span class="token operator">=</span> last_call_time <span class="token operator">-</span> start_time
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">            <span class="token comment"># Update progress bar</span>
</span><span class="code-line line-number" line="27">            pbar<span class="token punctuation">.</span>set_postfix<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="28">                <span class="token string">"topic"</span><span class="token punctuation">:</span> problem<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'topic'</span><span class="token punctuation">,</span> <span class="token string">'N/A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">                <span class="token string">"answer"</span><span class="token punctuation">:</span> problem<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'answer'</span><span class="token punctuation">,</span> <span class="token string">'N/A'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">                <span class="token string">"time"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>generation_time<span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span>
</span><span class="code-line line-number" line="31">            <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">            pbar<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">    <span class="token keyword">return</span> generated_data_path
</span></code></pre>
<p>LaTeX 数学公式支持：</p>
<p>生成的 AIME 题目包含 LaTeX 数学公式（如 <code>$\frac{a}{b}$</code>、<code>$\sqrt{x}$</code>），需要特殊处理 JSON 解析：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_parse_response</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""解析LLM响应（支持LaTeX数学公式）"""</span>
</span><span class="code-line line-number" line="3">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">    <span class="token comment"># 提取JSON部分</span>
</span><span class="code-line line-number" line="6">    <span class="token keyword">if</span> <span class="token string">"```json"</span> <span class="token keyword">in</span> response<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">        json_str <span class="token operator">=</span> response<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"```json"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"```"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">        json_str <span class="token operator">=</span> response<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">        problem_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">    <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">        <span class="token comment"># 修复LaTeX转义问题：将 \frac 转为 \\frac</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># 正则表达式：找到未转义的反斜杠</span>
</span><span class="code-line line-number" line="16">        fixed_json_str <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'(?&lt;!\\)\\(?!["\\/bfnrtu])'</span><span class="token punctuation">,</span> <span class="token string">r'\\\\'</span><span class="token punctuation">,</span> json_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        problem_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>fixed_json_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token keyword">return</span> problem_data
</span></code></pre>
<p>LaTeX 公式中的反斜杠（如 <code>\frac</code>、<code>\sqrt</code>）在 JSON 中是非法的转义字符，会导致解析失败：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">Invalid \escape: line 4 column 185 (char 375)
</span></code></pre>
<p>通过正则表达式将未转义的反斜杠替换为双反斜杠，使其在 JSON 中合法。</p>
<h3>12.4.4 LLM Judge 评估工具</h3>
<p>LLM Judge 工具使用 LLM 作为评委，对生成的题目进行多维度评估。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">LLMJudgeTool</span><span class="token punctuation">(</span>Tool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""LLM Judge评估工具"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> params<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token triple-quoted-string string">"""运行LLM Judge评估"""</span>
</span><span class="code-line line-number" line="6">        <span class="token comment"># 1. 加载生成数据</span>
</span><span class="code-line line-number" line="7">        gen_dataset <span class="token operator">=</span> AIDataset<span class="token punctuation">(</span>dataset_type<span class="token operator">=</span><span class="token string">"generated"</span><span class="token punctuation">,</span> data_path<span class="token operator">=</span>params<span class="token punctuation">[</span><span class="token string">"generated_data_path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">        gen_problems <span class="token operator">=</span> gen_dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">        <span class="token comment"># 2. 加载参考数据（AIME 2025）</span>
</span><span class="code-line line-number" line="11">        ref_dataset <span class="token operator">=</span> AIDataset<span class="token punctuation">(</span>dataset_type<span class="token operator">=</span><span class="token string">"real"</span><span class="token punctuation">,</span> year<span class="token operator">=</span><span class="token number">2025</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">        ref_problems <span class="token operator">=</span> ref_dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">        <span class="token comment"># 3. 创建评估器</span>
</span><span class="code-line line-number" line="15">        evaluator <span class="token operator">=</span> LLMJudgeEvaluator<span class="token punctuation">(</span>llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> judge_model<span class="token operator">=</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"judge_model"</span><span class="token punctuation">,</span> <span class="token string">"gpt-4o"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">        <span class="token comment"># 4. 运行评估</span>
</span><span class="code-line line-number" line="18">        results <span class="token operator">=</span> evaluator<span class="token punctuation">.</span>evaluate_batch<span class="token punctuation">(</span>gen_problems<span class="token punctuation">,</span> max_samples<span class="token operator">=</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"max_samples"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">        <span class="token comment"># 5. 保存结果</span>
</span><span class="code-line line-number" line="21">        evaluator<span class="token punctuation">.</span>export_results<span class="token punctuation">(</span>results<span class="token punctuation">,</span> result_file<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">        <span class="token comment"># 6. 生成报告</span>
</span><span class="code-line line-number" line="24">        self<span class="token punctuation">.</span>_generate_report<span class="token punctuation">(</span>results<span class="token punctuation">,</span> report_file<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"metrics"</span><span class="token punctuation">:</span> results<span class="token punctuation">[</span><span class="token string">"metrics"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>评估提示词</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">EVALUATION_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""请评估以下AIME数学题目的质量。
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">题目：
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">{problem}
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">答案：{answer}
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">解答：
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">{solution}
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">请从以下4个维度评分（1-5分）：
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">1. &lt;strong&gt;正确性 (Correctness)&lt;/strong&gt;：数学逻辑是否正确，答案是否准确
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">2. &lt;strong&gt;清晰度 (Clarity)&lt;/strong&gt;：问题表述是否清晰，解答是否易懂
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">3. &lt;strong&gt;难度匹配 (Difficulty Match)&lt;/strong&gt;：难度是否符合AIME标准（中等偏难）
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">4. &lt;strong&gt;完整性 (Completeness)&lt;/strong&gt;：解答步骤是否完整，是否包含必要的推理
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">请按以下JSON格式输出：
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">    "correctness": 5,
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">    "clarity": 4,
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">    "difficulty_match": 4,
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">    "completeness": 5,
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">    "comments": "评价理由"
</span></span><span class="code-line line-number" line="25"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="26"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>评估报告示例</strong>：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">#</span> LLM Judge评估报告</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token title important"><span class="token punctuation">##</span> 总体评分</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>平均总分<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 4.2/5.0
</span><span class="code-line line-number" line="6"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>通过率<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 85.0% (≥3.5分)
</span><span class="code-line line-number" line="7"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>优秀率<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 40.0% (≥4.5分)
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token title important"><span class="token punctuation">##</span> 各维度评分</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 维度 </span><span class="token punctuation">|</span><span class="token table-header important"> 平均分 </span><span class="token punctuation">|</span><span class="token table-header important"> 评级 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="12"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">--------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="13"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 正确性 </span><span class="token punctuation">|</span><span class="token table-data"> 4.3/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="14"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 清晰度 </span><span class="token punctuation">|</span><span class="token table-data"> 4.1/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="15"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 难度匹配 </span><span class="token punctuation">|</span><span class="token table-data"> 4.0/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="16"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 完整性 </span><span class="token punctuation">|</span><span class="token table-data"> 4.4/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span></code></pre>
<h3>12.4.5 Win Rate 评估工具</h3>
<p>Win Rate 工具通过成对对比评估生成数据相对于真题的质量。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">WinRateTool</span><span class="token punctuation">(</span>Tool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""Win Rate评估工具"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> params<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token triple-quoted-string string">"""运行Win Rate评估"""</span>
</span><span class="code-line line-number" line="6">        <span class="token comment"># 1. 加载生成数据</span>
</span><span class="code-line line-number" line="7">        gen_dataset <span class="token operator">=</span> AIDataset<span class="token punctuation">(</span>dataset_type<span class="token operator">=</span><span class="token string">"generated"</span><span class="token punctuation">,</span> data_path<span class="token operator">=</span>params<span class="token punctuation">[</span><span class="token string">"generated_data_path"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">        gen_problems <span class="token operator">=</span> gen_dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">        <span class="token comment"># 2. 加载参考数据（AIME 2025）</span>
</span><span class="code-line line-number" line="11">        ref_dataset <span class="token operator">=</span> AIDataset<span class="token punctuation">(</span>dataset_type<span class="token operator">=</span><span class="token string">"real"</span><span class="token punctuation">,</span> year<span class="token operator">=</span><span class="token number">2025</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">        ref_problems <span class="token operator">=</span> ref_dataset<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">        <span class="token comment"># 3. 创建评估器</span>
</span><span class="code-line line-number" line="15">        evaluator <span class="token operator">=</span> WinRateEvaluator<span class="token punctuation">(</span>llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span> judge_model<span class="token operator">=</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"judge_model"</span><span class="token punctuation">,</span> <span class="token string">"gpt-4o"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">        <span class="token comment"># 4. 运行评估</span>
</span><span class="code-line line-number" line="18">        results <span class="token operator">=</span> evaluator<span class="token punctuation">.</span>evaluate_win_rate<span class="token punctuation">(</span>gen_problems<span class="token punctuation">,</span> ref_problems<span class="token punctuation">,</span> num_comparisons<span class="token operator">=</span>params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"num_comparisons"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">        <span class="token comment"># 5. 保存结果和报告</span>
</span><span class="code-line line-number" line="21">        evaluator<span class="token punctuation">.</span>export_results<span class="token punctuation">(</span>results<span class="token punctuation">,</span> result_file<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">        self<span class="token punctuation">.</span>_generate_report<span class="token punctuation">(</span>results<span class="token punctuation">,</span> report_file<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"success"</span><span class="token punctuation">,</span> <span class="token string">"metrics"</span><span class="token punctuation">:</span> results<span class="token punctuation">[</span><span class="token string">"metrics"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p>AIDataset 负责加载生成数据和 AIME 真题数据，支持两种数据类型：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">AIDataset</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""AI数据集加载器
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">    支持两种数据类型：
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    1. generated: 生成的数据（JSON格式）
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    2. real: AIME真题（从HuggingFace加载）
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="10">        self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">        dataset_type<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"generated"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">        data_path<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        year<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="14">    <span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        self<span class="token punctuation">.</span>dataset_type <span class="token operator">=</span> dataset_type
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>data_path <span class="token operator">=</span> data_path
</span><span class="code-line line-number" line="17">        self<span class="token punctuation">.</span>year <span class="token operator">=</span> year  <span class="token comment"># 仅用于real类型，默认2025</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token keyword">def</span> <span class="token function">load</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="20">        <span class="token triple-quoted-string string">"""加载数据集"""</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>dataset_type <span class="token operator">==</span> <span class="token string">"generated"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_load_generated_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>dataset_type <span class="token operator">==</span> <span class="token string">"real"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>_load_real_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    <span class="token keyword">def</span> <span class="token function">_load_real_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="27">        <span class="token triple-quoted-string string">"""从HuggingFace加载AIME 2025真题"""</span>
</span><span class="code-line line-number" line="28">        <span class="token keyword">from</span> huggingface_hub <span class="token keyword">import</span> snapshot_download
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">        <span class="token comment"># 使用AIME 2025数据集</span>
</span><span class="code-line line-number" line="31">        repo_id <span class="token operator">=</span> <span class="token string">"math-ai/aime25"</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">        <span class="token comment"># 下载数据集</span>
</span><span class="code-line line-number" line="34">        local_dir <span class="token operator">=</span> snapshot_download<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="35">            repo_id<span class="token operator">=</span>repo_id<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">            repo_type<span class="token operator">=</span><span class="token string">"dataset"</span>
</span><span class="code-line line-number" line="37">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">        <span class="token comment"># 读取JSONL文件</span>
</span><span class="code-line line-number" line="40">        data_file <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>Path<span class="token punctuation">(</span>local_dir<span class="token punctuation">)</span><span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"*.jsonl"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="41">        data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="42">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>data_file<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="43">            <span class="token keyword">for</span> line <span class="token keyword">in</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="44">                <span class="token keyword">if</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="45">                    data<span class="token punctuation">.</span>append<span class="token punctuation">(</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">
</span><span class="code-line line-number" line="47">        <span class="token comment"># 统一数据格式（AIME 2025使用小写字段名）</span>
</span><span class="code-line line-number" line="48">        problems <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="49">        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> item <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="50">            problem <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="51">                <span class="token string">"problem_id"</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"aime_2025_</span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="52">                <span class="token string">"problem"</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"problem"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="53">                <span class="token string">"answer"</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"answer"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="54">                <span class="token string">"solution"</span><span class="token punctuation">:</span> item<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"solution"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># AIME 2025没有solution字段</span>
</span><span class="code-line line-number" line="55">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="56">            problems<span class="token punctuation">.</span>append<span class="token punctuation">(</span>problem<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">
</span><span class="code-line line-number" line="58">        <span class="token keyword">return</span> problems
</span></code></pre>
<p>我们选择只使用 AIME 2025 数据集有四个原因：首先是数据的时效性（2025 年是最新的 AIME 竞赛数据），其次是简化维护（只维护一个数据集，代码更简洁），第三是格式统一（JSONL 格式，字段名统一为小写），最后是代表性充分（30 道题目足以评估生成质量）。</p>
<p><strong>对比提示词</strong>：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">COMPARISON_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""请比较以下两个AIME数学题目的质量，判断哪个更好。
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">【题目A - 生成题目】
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">问题：{problem_a}
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">答案：{answer_a}
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">解答：{solution_a}
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">【题目B - AIME真题】
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">问题：{problem_b}
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">答案：{answer_b}
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">解答：{solution_b}
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">请从以下方面比较：
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">1. 数学逻辑的严谨性
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">2. 问题表述的清晰度
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">3. 难度的合理性
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">4. 解答的完整性
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">请按以下JSON格式输出：
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">    "winner": "A" 或 "B" 或 "Tie",
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">    "reason": "判断理由"
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="24"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>评估报告示例</strong>：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">#</span> Win Rate评估报告</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token title important"><span class="token punctuation">##</span> 胜率统计</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 指标 </span><span class="token punctuation">|</span><span class="token table-header important"> 数值 </span><span class="token punctuation">|</span><span class="token table-header important"> 百分比 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="6"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">--------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="7"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 生成数据胜出 </span><span class="token punctuation">|</span><span class="token table-data"> 9次 </span><span class="token punctuation">|</span><span class="token table-data"> 45.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="8"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> AIME真题胜出 </span><span class="token punctuation">|</span><span class="token table-data"> 8次 </span><span class="token punctuation">|</span><span class="token table-data"> 40.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="9"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 平局 </span><span class="token punctuation">|</span><span class="token table-data"> 3次 </span><span class="token punctuation">|</span><span class="token table-data"> 15.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="10"><span class="token table"><span class="token table-data-rows"></span></span>
</span><span class="code-line line-number" line="11"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>Win Rate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 45.0%
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">✅ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>良好<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 生成数据质量接近参考数据（差距&lt;10%）。
</span></code></pre>
<h3>12.4.6 人工验证界面</h3>
<p>使用 Gradio 创建 Web 界面，支持人工验证生成的题目。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">HumanVerificationUI</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""人工验证界面"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">launch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> share<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token triple-quoted-string string">"""启动Gradio界面"""</span>
</span><span class="code-line line-number" line="6">        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Blocks<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"AIME题目人工验证"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> demo<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="7">            gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token string">"# 🎯 AIME题目人工验证系统"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">                <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">                    <span class="token comment"># 题目显示区域</span>
</span><span class="code-line line-number" line="12">                    problem_text <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"问题描述"</span><span class="token punctuation">,</span> lines<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> interactive<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">                    answer_text <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"答案"</span><span class="token punctuation">,</span> interactive<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">                    solution_text <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"解答过程"</span><span class="token punctuation">,</span> lines<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> interactive<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16">                <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>scale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">                    <span class="token comment"># 评分区域</span>
</span><span class="code-line line-number" line="18">                    correctness_slider <span class="token operator">=</span> gr<span class="token punctuation">.</span>Slider<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"正确性"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">                    clarity_slider <span class="token operator">=</span> gr<span class="token punctuation">.</span>Slider<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"清晰度"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">                    difficulty_slider <span class="token operator">=</span> gr<span class="token punctuation">.</span>Slider<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"难度匹配"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">                    completeness_slider <span class="token operator">=</span> gr<span class="token punctuation">.</span>Slider<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> value<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> step<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"完整性"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">                    <span class="token comment"># 状态选择</span>
</span><span class="code-line line-number" line="24">                    status_radio <span class="token operator">=</span> gr<span class="token punctuation">.</span>Radio<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="25">                        choices<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"approved"</span><span class="token punctuation">,</span> <span class="token string">"rejected"</span><span class="token punctuation">,</span> <span class="token string">"needs_revision"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">                        value<span class="token operator">=</span><span class="token string">"approved"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="27">                        label<span class="token operator">=</span><span class="token string">"状态"</span>
</span><span class="code-line line-number" line="28">                    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">                    <span class="token comment"># 验证按钮</span>
</span><span class="code-line line-number" line="31">                    verify_btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">"✅ 提交验证"</span><span class="token punctuation">,</span> variant<span class="token operator">=</span><span class="token string">"primary"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">
</span><span class="code-line line-number" line="33">            demo<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>share<span class="token operator">=</span>share<span class="token punctuation">,</span> server_name<span class="token operator">=</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> server_port<span class="token operator">=</span><span class="token number">7860</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>使用方法</strong>：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 启动人工验证界面</span>
</span><span class="code-line line-number" line="2">python data_generation/human_verification_ui.py data_generation/generated_data/aime_generated_XXXXXX.json
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 打开浏览器访问</span>
</span><span class="code-line line-number" line="5">http://127.0.0.1:7860
</span></code></pre>
<p>最终效果可以参考图 12.7 所示，对于题目的正确性，最好人工打标 Review：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/12-figures/12-7.png" alt="" width="85%">
  <p>图 12.7 AIME 试题人工验证页面</p>
</div>
<p><strong>验证流程</strong>：</p>
<ol>
<li>浏览器打开验证界面</li>
<li>阅读题目、答案、解答</li>
<li>从 4 个维度评分（1-5 分）</li>
<li>选择验证状态（approved/rejected/needs_revision）</li>
<li>添加评论（可选）</li>
<li>点击"提交验证"</li>
<li>查看下一题</li>
</ol>
<p><strong>验证结果保存</strong>：</p>
<p>验证结果自动保存为 <code>&lt;data_path&gt;_verifications.json</code>：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"gen_aime_1"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token property">"problem_id"</span><span class="token operator">:</span> <span class="token string">"gen_aime_1"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token property">"scores"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">      <span class="token property">"correctness"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">      <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">      <span class="token property">"difficulty_match"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">      <span class="token property">"completeness"</span><span class="token operator">:</span> <span class="token number">5</span>
</span><span class="code-line line-number" line="9">    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    <span class="token property">"total_score"</span><span class="token operator">:</span> <span class="token number">4.5</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    <span class="token property">"status"</span><span class="token operator">:</span> <span class="token string">"approved"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    <span class="token property">"comments"</span><span class="token operator">:</span> <span class="token string">"题目质量很好，逻辑严谨"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    <span class="token property">"verified_at"</span><span class="token operator">:</span> <span class="token string">"2025-01-10T12:00:00"</span>
</span><span class="code-line line-number" line="14">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="15"><span class="token punctuation">}</span>
</span></code></pre>
<h3>12.4.7 完整评估流程</h3>
<p>将所有评估方法整合到一个完整的流程中。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">run_complete_evaluation</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    num_problems<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    delay_seconds<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">3.0</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">    <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    运行完整评估流程
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">    Args:
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">        num_problems: 生成题目数量
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">        delay_seconds: 每次生成之间的延迟（秒），避免API速率限制
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="12">    <span class="token comment"># 步骤1: 生成AIME题目</span>
</span><span class="code-line line-number" line="13">    generator <span class="token operator">=</span> AIMEGenerator<span class="token punctuation">(</span>delay_seconds<span class="token operator">=</span>delay_seconds<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">    generated_data_path <span class="token operator">=</span> generator<span class="token punctuation">.</span>generate_and_save<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="15">        num_problems<span class="token operator">=</span>num_problems<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        output_dir<span class="token operator">=</span><span class="token string">"data_generation/generated_data"</span>
</span><span class="code-line line-number" line="17">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token comment"># 步骤2: 评估</span>
</span><span class="code-line line-number" line="20">    <span class="token comment"># 创建评估结果目录</span>
</span><span class="code-line line-number" line="21">    timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y%m%d_%H%M%S"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">    evaluation_dir <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"data_generation/evaluation_results/</span><span class="token interpolation"><span class="token punctuation">{</span>timestamp<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="23">    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>evaluation_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>evaluation_dir<span class="token punctuation">,</span> <span class="token string">"llm_judge"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>evaluation_dir<span class="token punctuation">,</span> <span class="token string">"win_rate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">    <span class="token comment"># 创建LLM</span>
</span><span class="code-line line-number" line="28">    llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">    <span class="token comment"># 步骤2.1: LLM Judge评估</span>
</span><span class="code-line line-number" line="31">    llm_judge_result <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="32">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">        llm_judge_tool <span class="token operator">=</span> LLMJudgeTool<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">        llm_judge_result_json <span class="token operator">=</span> llm_judge_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="35">            <span class="token string">"generated_data_path"</span><span class="token punctuation">:</span> generated_data_path<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">            <span class="token string">"reference_year"</span><span class="token punctuation">:</span> <span class="token number">2025</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">            <span class="token string">"max_samples"</span><span class="token punctuation">:</span> num_problems<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="38">            <span class="token string">"output_dir"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>evaluation_dir<span class="token punctuation">,</span> <span class="token string">"llm_judge"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="39">            <span class="token string">"judge_model"</span><span class="token punctuation">:</span> <span class="token string">"gpt-4o"</span>
</span><span class="code-line line-number" line="40">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">        llm_judge_result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>llm_judge_result_json<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="43">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ LLM Judge评估失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45">    <span class="token comment"># 步骤2.2: Win Rate评估</span>
</span><span class="code-line line-number" line="46">    win_rate_result <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="47">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="48">        win_rate_tool <span class="token operator">=</span> WinRateTool<span class="token punctuation">(</span>llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">        win_rate_result_json <span class="token operator">=</span> win_rate_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="50">            <span class="token string">"generated_data_path"</span><span class="token punctuation">:</span> generated_data_path<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="51">            <span class="token string">"reference_year"</span><span class="token punctuation">:</span> <span class="token number">2025</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="52">            <span class="token string">"num_comparisons"</span><span class="token punctuation">:</span> <span class="token builtin">min</span><span class="token punctuation">(</span>num_problems<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="53">            <span class="token string">"output_dir"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>evaluation_dir<span class="token punctuation">,</span> <span class="token string">"win_rate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="54">            <span class="token string">"judge_model"</span><span class="token punctuation">:</span> <span class="token string">"gpt-4o"</span>
</span><span class="code-line line-number" line="55">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="56">        win_rate_result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>win_rate_result_json<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="58">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ Win Rate评估失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="59">
</span><span class="code-line line-number" line="60">    <span class="token comment"># 步骤3: 生成综合报告</span>
</span><span class="code-line line-number" line="61">    comprehensive_report_path <span class="token operator">=</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="62">    <span class="token keyword">if</span> llm_judge_result <span class="token keyword">or</span> win_rate_result<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="63">        comprehensive_report_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>evaluation_dir<span class="token punctuation">,</span> <span class="token string">"comprehensive_report.md"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="64">        report <span class="token operator">=</span> generate_comprehensive_report<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="65">            generated_data_path<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="66">            llm_judge_result<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="67">            win_rate_result
</span><span class="code-line line-number" line="68">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="69">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>comprehensive_report_path<span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="70">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>report<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="71">
</span><span class="code-line line-number" line="72">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="73">        <span class="token string">"generated_data_path"</span><span class="token punctuation">:</span> generated_data_path<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="74">        <span class="token string">"llm_judge_result"</span><span class="token punctuation">:</span> llm_judge_result<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="75">        <span class="token string">"win_rate_result"</span><span class="token punctuation">:</span> win_rate_result<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="76">        <span class="token string">"comprehensive_report_path"</span><span class="token punctuation">:</span> comprehensive_report_path
</span><span class="code-line line-number" line="77">    <span class="token punctuation">}</span>
</span></code></pre>
<p><strong>运行方法</strong>：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 基本用法（默认3秒延迟）</span>
</span><span class="code-line line-number" line="2">python data_generation/run_complete_evaluation.py <span class="token number">30</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 自定义延迟（推荐3-5秒，避免API速率限制）</span>
</span><span class="code-line line-number" line="5">python data_generation/run_complete_evaluation.py <span class="token number">30</span> <span class="token number">3.0</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 参数说明：</span>
</span><span class="code-line line-number" line="8"><span class="token comment"># - 30: 生成题目数量</span>
</span><span class="code-line line-number" line="9"><span class="token comment"># - 3.0: 每次生成之间的延迟（秒）</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 说明：</span>
</span><span class="code-line line-number" line="12"><span class="token comment"># - 生成阶段：从900+道AIME真题（1983-2025）中随机选择参考样例</span>
</span><span class="code-line line-number" line="13"><span class="token comment"># - 评估阶段：与AIME 2025年真题进行质量对比</span>
</span><span class="code-line line-number" line="14"><span class="token comment"># - 数据集来源：math-ai/aime25（JSONL格式）</span>
</span></code></pre>
<p><strong>输出示例</strong>：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">================================================================================
</span><span class="code-line line-number" line="2">🚀 AIME数据生成与评估完整流程
</span><span class="code-line line-number" line="3">================================================================================
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">配置信息:
</span><span class="code-line line-number" line="6">  - 生成题目数量: 30
</span><span class="code-line line-number" line="7">  - API延迟: 3.0秒/题
</span><span class="code-line line-number" line="8">  - 生成参考数据: TianHongZXY/aime-1983-2025（900+道题）
</span><span class="code-line line-number" line="9">  - 评估参考: AIME 2025真题
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">================================================================================
</span><span class="code-line line-number" line="12">📝 步骤1: 生成AIME题目
</span><span class="code-line line-number" line="13">================================================================================
</span><span class="code-line line-number" line="14">📚 加载AIME真题数据集: TianHongZXY/aime-1983-2025
</span><span class="code-line line-number" line="15">   ✓ 已加载 963 道参考题目
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">🎯 开始生成AIME题目
</span><span class="code-line line-number" line="18">   目标数量: 30
</span><span class="code-line line-number" line="19">   生成模型: gpt-4o
</span><span class="code-line line-number" line="20">   延迟设置: 3.0秒/题
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">生成AIME题目:  100%|██████████| 30/30 [01:30&lt;00:00, 3.00s/题, 主题=Algebra, 答案=123, 耗时=3.0s]
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">✅ 步骤1完成！生成数据保存在: data_generation/generated_data/aime_generated_20250110_120000.json
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">🎯 步骤2.1: LLM Judge评估 (vs AIME 2025)
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">✅ LLM Judge评估完成！
</span><span class="code-line line-number" line="29">   平均总分: 4.2/5.0
</span><span class="code-line line-number" line="30">   通过率: 85.0%
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32">🏆 步骤2.2: Win Rate评估 (vs AIME 2025)
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">✅ Win Rate评估完成！
</span><span class="code-line line-number" line="35">   Win Rate: 45.0%
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">================================================================================
</span><span class="code-line line-number" line="38">📊 步骤3: 生成综合报告
</span><span class="code-line line-number" line="39">================================================================================
</span><span class="code-line line-number" line="40">
</span><span class="code-line line-number" line="41">✅ 综合报告已保存: data_generation/evaluation_results/20250110_120000/comprehensive_report.md
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43">================================================================================
</span><span class="code-line line-number" line="44">🎉 完整评估流程完成！
</span><span class="code-line line-number" line="45">================================================================================
</span><span class="code-line line-number" line="46">
</span><span class="code-line line-number" line="47">📁 输出文件:
</span><span class="code-line line-number" line="48">   - 生成数据: data_generation/generated_data/aime_generated_20250110_120000.json
</span><span class="code-line line-number" line="49">   - 评估结果目录: data_generation/evaluation_results/20250110_120000
</span><span class="code-line line-number" line="50">   - LLM Judge报告: data_generation/evaluation_results/20250110_120000/llm_judge/llm_judge_report_20250110_120000.md
</span><span class="code-line line-number" line="51">   - Win Rate报告: data_generation/evaluation_results/20250110_120000/win_rate/win_rate_report_20250110_120000.md
</span><span class="code-line line-number" line="52">   - 综合报告: data_generation/evaluation_results/20250110_120000/comprehensive_report.md
</span><span class="code-line line-number" line="53">
</span><span class="code-line line-number" line="54">💡 下一步:
</span><span class="code-line line-number" line="55">   1. 查看综合报告: data_generation/evaluation_results/20250110_120000/comprehensive_report.md
</span><span class="code-line line-number" line="56">   2. 运行人工验证: python data_generation/human_verification_ui.py data_generation/generated_data/aime_generated_20250110_120000.json
</span></code></pre>
<h3>12.4.8 综合评估报告</h3>
<p>系统自动生成综合评估报告，汇总所有评估结果。以下是示例报告：</p>
<pre class="language-markdown"><code class="language-markdown code-highlight"><span class="code-line line-number" line="1"><span class="token title important"><span class="token punctuation">#</span> AIME数据生成与评估综合报告</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token title important"><span class="token punctuation">##</span> 1. 基本信息</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>生成时间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 2025-01-10 12:00:00
</span><span class="code-line line-number" line="6"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>生成题目数量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 30
</span><span class="code-line line-number" line="7"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>参考AIME年份<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 2025
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token title important"><span class="token punctuation">##</span> 2. 数据生成统计</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token title important"><span class="token punctuation">###</span> 主题分布</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 主题 </span><span class="token punctuation">|</span><span class="token table-header important"> 数量 </span><span class="token punctuation">|</span><span class="token table-header important"> 占比 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="14"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="15"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 代数 </span><span class="token punctuation">|</span><span class="token table-data"> 10 </span><span class="token punctuation">|</span><span class="token table-data"> 33.3% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="16"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 几何 </span><span class="token punctuation">|</span><span class="token table-data"> 8 </span><span class="token punctuation">|</span><span class="token table-data"> 26.7% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="17"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 数论 </span><span class="token punctuation">|</span><span class="token table-data"> 7 </span><span class="token punctuation">|</span><span class="token table-data"> 23.3% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="18"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 组合 </span><span class="token punctuation">|</span><span class="token table-data"> 3 </span><span class="token punctuation">|</span><span class="token table-data"> 10.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="19"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 概率 </span><span class="token punctuation">|</span><span class="token table-data"> 2 </span><span class="token punctuation">|</span><span class="token table-data"> 6.7% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="20"><span class="token table"><span class="token table-data-rows"></span></span>
</span><span class="code-line line-number" line="21"><span class="token title important"><span class="token punctuation">##</span> 3. LLM Judge评估结果</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token title important"><span class="token punctuation">###</span> 总体评分</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>平均总分<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 4.2/5.0
</span><span class="code-line line-number" line="26"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>通过率<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 85.0% (≥3.5分)
</span><span class="code-line line-number" line="27"><span class="token list punctuation">-</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>优秀率<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 40.0% (≥4.5分)
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29"><span class="token title important"><span class="token punctuation">###</span> 各维度评分</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 维度 </span><span class="token punctuation">|</span><span class="token table-header important"> 平均分 </span><span class="token punctuation">|</span><span class="token table-header important"> 评级 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="32"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">--------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="33"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 正确性 </span><span class="token punctuation">|</span><span class="token table-data"> 4.3/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="34"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 清晰度 </span><span class="token punctuation">|</span><span class="token table-data"> 4.1/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="35"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 难度匹配 </span><span class="token punctuation">|</span><span class="token table-data"> 4.0/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="36"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 完整性 </span><span class="token punctuation">|</span><span class="token table-data"> 4.4/5.0 </span><span class="token punctuation">|</span><span class="token table-data"> 良好 ⭐⭐⭐⭐ </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="37"><span class="token table"><span class="token table-data-rows"></span></span>
</span><span class="code-line line-number" line="38"><span class="token title important"><span class="token punctuation">##</span> 4. Win Rate评估结果</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40"><span class="token title important"><span class="token punctuation">###</span> 胜率统计</span>
</span><span class="code-line line-number" line="41">
</span><span class="code-line line-number" line="42"><span class="token table"><span class="token table-header-row"><span class="token punctuation">|</span><span class="token table-header important"> 指标 </span><span class="token punctuation">|</span><span class="token table-header important"> 数值 </span><span class="token punctuation">|</span><span class="token table-header important"> 百分比 </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="43"><span class="token table"><span class="token table-header-row"></span><span class="token table-line"><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">------</span><span class="token punctuation">|</span><span class="token punctuation">--------</span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="44"><span class="token table"><span class="token table-line"></span><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 生成数据胜出 </span><span class="token punctuation">|</span><span class="token table-data"> 9次 </span><span class="token punctuation">|</span><span class="token table-data"> 45.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="45"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> AIME真题胜出 </span><span class="token punctuation">|</span><span class="token table-data"> 8次 </span><span class="token punctuation">|</span><span class="token table-data"> 40.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="46"><span class="token table"><span class="token table-data-rows"><span class="token punctuation">|</span><span class="token table-data"> 平局 </span><span class="token punctuation">|</span><span class="token table-data"> 3次 </span><span class="token punctuation">|</span><span class="token table-data"> 15.0% </span><span class="token punctuation">|</span>
</span></span></span><span class="code-line line-number" line="47"><span class="token table"><span class="token table-data-rows"></span></span>
</span><span class="code-line line-number" line="48"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>Win Rate<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 45.0%
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50">✅ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>良好<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 生成数据质量接近参考数据（差距&lt;10%）。
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52"><span class="token title important"><span class="token punctuation">##</span> 5. 综合结论</span>
</span><span class="code-line line-number" line="53">
</span><span class="code-line line-number" line="54">基于LLM Judge和Win Rate两种评估方法的结果：
</span><span class="code-line line-number" line="55">
</span><span class="code-line line-number" line="56"><span class="token list punctuation">1.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>LLM Judge评估<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 生成数据的平均质量为 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>4.2/5.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
</span><span class="code-line line-number" line="57"><span class="token list punctuation">2.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>Win Rate评估<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 生成数据相对于AIME 2025真题的胜率为 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>45.0%<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>
</span><span class="code-line line-number" line="58">
</span><span class="code-line line-number" line="59">✅ <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>结论<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 生成数据质量<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>优秀<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>，达到或超过AIME真题水平。可以用于实际应用。
</span><span class="code-line line-number" line="60">
</span><span class="code-line line-number" line="61"><span class="token title important"><span class="token punctuation">##</span> 6. 改进建议</span>
</span><span class="code-line line-number" line="62">
</span><span class="code-line line-number" line="63"><span class="token list punctuation">-</span> ✅ 继续保持当前的生成策略
</span><span class="code-line line-number" line="64"><span class="token list punctuation">-</span> ✅ 可以考虑增加生成数量
</span><span class="code-line line-number" line="65"><span class="token list punctuation">-</span> ✅ 建议进行人工验证以确保质量
</span><span class="code-line line-number" line="66">
</span><span class="code-line line-number" line="67"><span class="token title important"><span class="token punctuation">##</span> 7. 下一步行动</span>
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69"><span class="token list punctuation">1.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>人工验证<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 运行 <span class="token code-snippet code keyword">`python data_generation/human_verification_ui.py &lt;data_path&gt;`</span> 进行人工验证
</span><span class="code-line line-number" line="70"><span class="token list punctuation">2.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>查看详细结果<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>:
</span><span class="code-line line-number" line="71">   <span class="token list punctuation">-</span> LLM Judge详细报告
</span><span class="code-line line-number" line="72">   <span class="token list punctuation">-</span> Win Rate详细报告
</span><span class="code-line line-number" line="73"><span class="token list punctuation">3.</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>数据使用<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span>: 如果质量满意，可以将生成的数据用于训练或测试
</span></code></pre>
<p>基于实际使用经验，总结以下内容：</p>
<p>在数据生成方面，应该使用合适的延迟时间（2-3 秒）避免 API 速率限制，启用检查点保存以避免中断损失，先小批量测试（10 个）确认无问题后再大批量生成，并定期检查生成质量及时调整提示词。在评估策略上，建议结合 LLM Judge 和 Win Rate 两种方法，其中 LLM Judge 用于绝对质量评估，Win Rate 用于相对质量对比，人工验证用于最终质量把关。质量标准方面，建议 LLM Judge 平均分达到 4.0/5.0 以上，Win Rate 达到 45%以上（接近 50%），通过率达到 80%以上，人工验证通过率达到 90%以上。在迭代优化过程中，应根据评估结果调整生成提示词，分析低分题目的共同问题，参考高分题目的优点，持续改进生成策略。</p>
<p>通过本节的学习，我们掌握了如何使用 HelloAgents 框架进行数据生成质量评估，包括 LLM Judge 评估、Win Rate 评估和人工验证三种方法。这套完整的评估体系可以确保生成数据的高质量，为 AI 系统的训练和测试提供可靠的数据支持。</p>
<p>对于 LLM Judge 和 Win Rate 评估，HelloAgents 也进行了工具集成，并提供了完整的示例代码。如果你对这两种评估方法的具体实现细节感兴趣，同样可以参考示例代码。</p>
<h2>12.5 本章小结</h2>
<p>在本章中，我们为 HelloAgents 框架构建了一个完整的性能评估系统。让我们回顾一下学到的核心内容：</p>
<p><strong>（1）评估体系概览</strong></p>
<p>我们建立了一个三层评估体系，全面覆盖智能体的不同能力维度。首先是工具调用能力评估（BFCL），专注于评估智能体的函数调用准确性，包含 simple、multiple、parallel、irrelevance 四个类别，使用 AST 匹配技术进行精确评估。其次是通用能力评估（GAIA），评估智能体的综合问题解决能力，包含三个难度级别共 466 个真实世界问题，关注多步推理、工具使用、文件处理等能力。第三是数据生成质量评估（AIME），评估 LLM 生成数据的质量，使用 LLM Judge 和 Win Rate 两种方法，支持人工验证和综合报告生成，确保生成数据达到参考数据的质量标准。</p>
<p><strong>（2）核心技术要点</strong></p>
<p>在技术实现上，我们采用了六个核心技术要点。首先是模块化设计，评估系统采用三层架构：数据层（Dataset 负责数据加载和管理）、评估层（Evaluator 负责执行评估流程）和指标层（Metrics 负责计算各种评估指标）。其次是工具化封装，所有评估功能都封装成 Tool，可以被智能体直接调用、集成到工作流中或通过统一接口使用。第三是 AST 匹配技术，使用抽象语法树匹配函数调用，比简单字符串匹配更智能，能够忽略参数顺序、识别等价表达式和忽略格式差异。第四是多模态支持，GAIA 评估支持文本问题、附件文件和图片输入等多模态数据。第五是 LLM Judge 评估，使用 LLM 作为评委评估生成数据质量，提供多维度评分（正确性、清晰度、难度匹配、完整性）、自动化评估流程、详细评估报告，并支持自定义评估维度和标准。第六是 Win Rate 对比评估，通过成对对比评估生成质量（生成数据 vs 参考数据），由 LLM 判断哪个更好并计算胜率统计，接近 50%表示质量相当。</p>
<p><strong>（3）扩展方向</strong></p>
<p>基于本章的评估系统，你可以在四个方向上进行扩展。首先是添加新的评估基准，可以参考 BFCL 和 GAIA 的实现模式，实现 Dataset、Evaluator、Metrics 三个组件，并封装成 Tool 供使用。其次是自定义评估指标，在 Metrics 类中添加新的指标计算方法，根据具体应用场景设计指标。第三是集成到 CI/CD 流程，在代码提交时自动运行评估，设置性能阈值防止性能退化，生成评估报告并归档。第四是扩展数据生成评估，支持更多数据类型（代码、对话、文档等），添加更多评估维度（创新性、多样性等），集成更多参考数据集，支持多模型对比评估。</p>
<p><strong>恭喜你完成了第十二章的学习！</strong> 🎉</p>
<p>评估是智能体开发的重要环节，它让我们能够：</p>
<ul>
<li>客观衡量智能体的能力</li>
<li>发现和修复问题</li>
<li>持续改进系统</li>
</ul>
<p>在下一章中，我们将探讨如何将 HelloAgents 框架应用于实际项目中。</p>
<p><strong>继续加油！</strong> 💪</p>
<h2>习题</h2>
<blockquote>
<p><strong>提示</strong>：部分习题没有标准答案，重点在于培养学习者对智能体性能评估的综合理解和实践能力。</p>
</blockquote>
<ol>
<li>
<p>本章介绍了多个智能体评估基准。请分析：</p>
<ul>
<li>在 12.1.2 节中介绍了 BFCL、GAIA、AgentBench 等评估基准。请对比 BFCL 和 GAIA：它们分别评估智能体的哪些核心能力？为什么 BFCL 使用 AST 匹配算法，而 GAIA 使用准精确匹配（Quasi Exact Match）？这两种评估方法各有什么优缺点？</li>
<li>假设你要构建一个"智能客服系统"，需要评估以下能力：（1）理解用户意图的准确性；（2）调用后台 API 的正确性；（3）回答的友好性和专业性；（4）处理异常情况的鲁棒性。请为每个能力选择或设计合适的评估指标和方法。</li>
<li>在 12.1.1 节中提到，智能体评估面临"输出不确定性"、"评估标准多样性"、"评估成本高昂"三大挑战。请针对每个挑战提出具体的解决方案，并分析方案的可行性和局限性。</li>
</ul>
</li>
<li>
<p>BFCL（Berkeley Function Calling Leaderboard）是评估工具调用能力的重要基准。基于 12.2 节的内容，请深入思考：</p>
<blockquote>
<p><strong>提示</strong>：这是一道动手实践题，建议实际操作</p>
</blockquote>
<ul>
<li>在 12.2.3 节的 AST 匹配算法中，我们通过比较抽象语法树来判断函数调用是否正确。请分析：为什么 AST 匹配比简单的字符串匹配更合适？在什么情况下 AST 匹配可能会产生误判（假阳性或假阴性）？如何改进 AST 匹配算法来提高准确性？</li>
<li>BFCL 数据集包含 simple、multiple、parallel、irrelevance 四个类别。请为每个类别设计 2-3 个新的测试样本，要求能够测试智能体在该类别下的边界情况或容易出错的场景。</li>
<li>请基于 12.2.4 节的代码，扩展 BFCL 评估器，添加以下功能：（1）支持评估工具调用的执行顺序（对于有依赖关系的多个工具调用）；（2）评估工具调用的效率（如是否使用了最少的调用次数）；（3）生成详细的错误分析报告（如哪些类型的错误最常见）。</li>
</ul>
</li>
<li>
<p>GAIA（General AI Assistants）评估智能体的综合能力。基于 12.3 节的内容，请完成以下扩展实践：</p>
<blockquote>
<p><strong>提示</strong>：这是一道动手实践题，建议实际操作</p>
</blockquote>
<ul>
<li>在 12.3.2 节中介绍了 GAIA 的三个难度级别（Level 1/2/3）。请分析：这三个级别在任务复杂度、所需能力、评估标准等方面有什么差异？如果要设计 Level 4（超高难度），应该包含什么类型的任务？</li>
<li>GAIA 使用"准精确匹配"算法来评估答案的正确性。请分析：这种方法如何处理答案的多样性（如"42"、"四十二"、"42.0"都应该被认为是正确的）？在什么情况下准精确匹配可能不够用？请设计一个更智能的答案匹配算法，能够处理语义等价的答案。</li>
<li>请基于 12.3.4 节的代码，实现一个"自定义 GAIA 评估集"：选择一个特定领域（如医疗、法律、金融），设计 10 个真实世界问题，并实现完整的评估流程。要求问题涵盖不同难度级别，并提供标准答案和评分标准。</li>
</ul>
</li>
<li>
<p>LLM Judge 是使用大语言模型进行评估的新兴方法。基于 12.4 节的内容，请深入分析：</p>
<ul>
<li>在 12.4.2 节中，我们使用 GPT-4 作为评判者来评估智能体的回答质量。请分析：LLM Judge 相比传统的规则匹配或指标计算有什么优势？它存在哪些潜在的偏见或局限性（如对某些回答风格的偏好、对长度的敏感性）？</li>
<li>LLM Judge 的评分标准设计至关重要。请为以下三个不同的评估场景设计详细的评分标准（包括评分维度、权重、示例）：（1）代码生成质量评估；（2）创意写作质量评估；（3）技术文档质量评估。</li>
<li>在 12.4.3 节中提到，可以使用多个 LLM Judge 进行"评审团"式评估。请设计一个"多评委评估系统"：使用 3-5 个不同的 LLM（如 GPT-4、Claude、Qwen）作为评委，如何聚合它们的评分？如何处理评委之间的分歧？如何检测和过滤异常评分？</li>
</ul>
</li>
<li>
<p>智能体评估的实践应用需要考虑多个方面。请思考：</p>
<ul>
<li>在实际项目中，评估往往需要在"评估成本"和"评估质量"之间权衡。请设计一个"分层评估策略"：（1）快速评估（低成本，用于日常开发迭代）；（2）标准评估（中等成本，用于版本发布前）；（3）全面评估（高成本，用于重大更新或对外发布）。每层应该包含哪些评估项目？如何设计评估流程？</li>
<li>智能体的性能可能随时间变化（如依赖的外部 API 变化、用户需求变化）。请设计一个"持续评估系统"：能够定期自动运行评估，监控智能体性能的变化趋势，并在性能下降时及时告警。这个系统应该包含哪些组件？如何设计告警规则？</li>
<li>评估结果需要以清晰的方式呈现给不同的受众（如开发者、产品经理、用户）。请设计一个"评估报告生成系统"：能够根据受众类型自动生成不同详细程度的报告。开发者报告应该包含哪些技术细节？产品经理报告应该突出哪些业务指标？用户报告应该如何简化和可视化？</li>
</ul>
</li>
</ol>
<h2>参考文献</h2>
<p>[1] Patil, S. G., Zhang, T., Wang, X., &amp; Gonzalez, J. E. (2023). Gorilla: Large Language Model Connected with Massive APIs. arXiv preprint arXiv:2305.15334.</p>
<p>[2] Qin, Y., Liang, S., Ye, Y., Zhu, K., Yan, L., Lu, Y., ... &amp; Sun, M. (2023). ToolLLM: Facilitating Large Language Models to Master 16000+ Real-world APIs. arXiv preprint arXiv:2307.16789.</p>
<p>[3] Li, M., Zhao, Y., Yu, B., Song, F., Li, H., Yu, H., ... &amp; Li, Y. (2023). Api-bank: A comprehensive benchmark for tool-augmented llms. arXiv preprint arXiv:2304.08244.</p>
<p>[4] Mialon, G., Dessì, R., Lomeli, M., Nalmpantis, C., Pasunuru, R., Raileanu, R., ... &amp; Scialom, T. (2023). GAIA: a benchmark for General AI Assistants. arXiv preprint arXiv:2311.12983.</p>
<p>[5] Liu, X., Yu, H., Zhang, H., Xu, Y., Lei, X., Lai, H., ... &amp; Zhang, D. (2023). AgentBench: Evaluating LLMs as Agents. arXiv preprint arXiv:2308.03688.</p>
<p>[6] Zhou, S., Xu, F. F., Zhu, H., Zhou, X., Lo, R., Sridhar, A., ... &amp; Neubig, G. (2023). WebArena: A Realistic Web Environment for Building Autonomous Agents. arXiv preprint arXiv:2307.13854.</p>
<p>[7] Chan, C. M., Chen, W., Su, Y., Yu, J., Xue, W., Zhang, S., ... &amp; Liu, Z. (2023). ChatEval: Towards Better LLM-based Evaluators through Multi-Agent Debate. arXiv preprint arXiv:2308.07201.</p>
<p>[8] Zhou, X., Zhu, H., Mathur, L., Zhang, R., Yu, H., Qi, Z., ... &amp; Neubig, G. (2023). SOTOPIA: Interactive Evaluation for Social Intelligence in Language Agents. arXiv preprint arXiv:2310.11667.</p>
<p>[9] Mathematical Association of America. (2024). American Invitational Mathematics Examination (AIME). Retrieved from <a href="https://www.maa.org/math-competitions/invitational-competitions/aime">https://www.maa.org/math-competitions/invitational-competitions/aime</a></p>