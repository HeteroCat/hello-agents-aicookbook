<h1>第十章 智能体通信协议</h1>
<p>在前面的章节中，我们构建了功能完备的单体智能体，它们具备推理、工具调用和记忆能力。然而，当我们尝试构建更复杂的 AI 系统时，自然会有疑问：<strong>如何让智能体与外部世界高效交互？如何让多个智能体相互协作？</strong></p>
<p>这正是智能体通信协议要解决的核心问题。本章将为 HelloAgents 框架引入三种通信协议：<strong>MCP（Model Context Protocol）</strong>用于智能体与工具的标准化通信，<strong>A2A（Agent-to-Agent Protocol）</strong>用于智能体间的点对点协作，<strong>ANP（Agent Network Protocol）</strong>用于构建大规模智能体网络。这三种协议共同构成了智能体通信的基础设施层。</p>
<p>通过本章的学习，您将掌握智能体通信协议的设计理念和实践技能，理解三种主流协议的设计差异，学会如何选择合适的协议来解决实际问题。</p>
<h2>10.1 智能体通信协议基础</h2>
<h3>10.1.1 为何需要通信协议</h3>
<p>回顾我们在第七章构建的 ReAct 智能体，它已经具备了强大的推理和工具调用能力。让我们看一个典型的使用场景：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> ReActAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> CalculatorTool<span class="token punctuation">,</span> SearchTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">agent <span class="token operator">=</span> ReActAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"AI助手"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>CalculatorTool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>SearchTool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 智能体可以独立完成任务</span>
</span><span class="code-line line-number" line="10">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"搜索最新的AI新闻，并计算相关公司的市值总和"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这个智能体工作得很好，但它面临着三个根本性的限制。首先是<strong>工具集成的困境</strong>：每当需要访问新的外部服务（如 GitHub API、数据库、文件系统），我们都必须编写专门的 Tool 类。这不仅工作量大，而且不同开发者编写的工具无法互相兼容。其次是<strong>能力扩展的瓶颈</strong>：智能体的能力被限制在预先定义的工具集内，无法动态发现和使用新的服务。最后是<strong>协作的缺失</strong>：当任务复杂到需要多个专业智能体协作时（如研究员+撰写员+编辑），我们只能通过手动编排来协调它们的工作。</p>
<p>让我们通过一个更具体的例子来理解这些限制。假设你要构建一个智能研究助手，它需要：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 传统方式：手动集成每个服务</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">class</span> <span class="token class-name">GitHubTool</span><span class="token punctuation">(</span>BaseTool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">    <span class="token triple-quoted-string string">"""需要手写GitHub API适配器"""</span>
</span><span class="code-line line-number" line="4">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> repo_url<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token comment"># 大量的API调用代码...</span>
</span><span class="code-line line-number" line="6">        <span class="token keyword">pass</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">class</span> <span class="token class-name">DatabaseTool</span><span class="token punctuation">(</span>BaseTool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">    <span class="token triple-quoted-string string">"""需要手写数据库适配器"""</span>
</span><span class="code-line line-number" line="10">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">        <span class="token comment"># 数据库连接和查询代码...</span>
</span><span class="code-line line-number" line="12">        <span class="token keyword">pass</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token keyword">class</span> <span class="token class-name">WeatherTool</span><span class="token punctuation">(</span>BaseTool<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">    <span class="token triple-quoted-string string">"""需要手写天气API适配器"""</span>
</span><span class="code-line line-number" line="16">    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> location<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">        <span class="token comment"># 天气API调用代码...</span>
</span><span class="code-line line-number" line="18">        <span class="token keyword">pass</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token comment"># 每个新服务都需要重复这个过程</span>
</span><span class="code-line line-number" line="21">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>GitHubTool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>DatabaseTool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>WeatherTool<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这种方式存在明显的问题：代码重复（每个工具都要处理 HTTP 请求、错误处理、认证等），难以维护（API 变更需要修改所有相关工具），无法复用（其他开发者的工具无法直接使用），扩展性差（添加新服务需要大量编码工作）。</p>
<p><strong>通信协议的核心价值</strong>正是解决这些问题。它提供了一套标准化的接口规范，让智能体能够以统一的方式访问各种外部服务，而无需为每个服务编写专门的适配器。这就像互联网的 TCP/IP 协议，它让不同的设备能够相互通信，而不需要为每种设备编写专门的通信代码。</p>
<p>有了通信协议，上面的代码可以简化为：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 连接到MCP服务器，自动获得所有工具</span>
</span><span class="code-line line-number" line="4">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 内置服务器提供基础工具</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 或者连接到专业的MCP服务器</span>
</span><span class="code-line line-number" line="7">github_mcp <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-github"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">database_mcp <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"database_mcp_server.py"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 智能体自动获得所有能力，无需手写适配器</span>
</span><span class="code-line line-number" line="11">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>mcp_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>github_mcp<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>database_mcp<span class="token punctuation">)</span>
</span></code></pre>
<p>通信协议带来的改变是根本性的：<strong>标准化接口</strong>让不同服务提供统一的访问方式，<strong>互操作性</strong>使得不同开发者的工具可以无缝集成，<strong>动态发现</strong>允许智能体在运行时发现新的服务和能力，<strong>可扩展性</strong>让系统能够轻松添加新的功能模块。</p>
<h3>10.1.2 三种协议设计理念比较</h3>
<p>智能体通信协议并非单一的解决方案，而是针对不同通信场景设计的一系列标准。在本章以目前业界主流的三种协议 MCP、A2A 和 ANP 为例进行实践，下面是一个总览的比较。</p>
<p><strong>（1）MCP：智能体与工具的桥梁</strong></p>
<p>MCP（Model Context Protocol）由 Anthropic 团队提出<sup>[1]</sup>，其核心设计理念是<strong>标准化智能体与外部工具/资源的通信方式</strong>。想象一下，你的智能体需要访问文件系统、数据库、GitHub、Slack 等各种服务。传统做法是为每个服务编写专门的适配器，这不仅工作量大，而且难以维护。MCP 通过定义统一的协议规范，让所有服务都能以相同的方式被访问。</p>
<p>MCP 的设计哲学是"上下文共享"。它不仅仅是一个 RPC（远程过程调用）协议，更重要的是它允许智能体和工具之间共享丰富的上下文信息。如图 10.1 所示，当智能体访问一个代码仓库时，MCP 服务器不仅能提供文件内容，还能提供代码结构、依赖关系、提交历史等上下文信息，让智能体能够做出更智能的决策。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-1.png" alt="" width="85%">
  <p>图 10.1 MCP 设计思想</p>
</div>
<p><strong>（2）A2A：智能体间的对话</strong></p>
<p>A2A（Agent-to-Agent Protocol）协议由 Google 团队提出<sup>2</sup>，其核心设计理念是<strong>实现智能体之间的点对点通信</strong>。与 MCP 关注智能体与工具的通信不同，A2A 关注的是智能体之间如何相互协作。这种设计让智能体能够像人类团队一样进行对话、协商和协作。</p>
<p>A2A 的设计哲学是"对等通信"。如图 10.2 所示，在 A2A 网络中，每个智能体既是服务提供者，也是服务消费者。智能体可以主动发起请求，也可以响应其他智能体的请求。这种对等的设计避免了中心化协调器的瓶颈，让智能体网络更加灵活和可扩展。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-2.png" alt="" width="85%">
  <p>图 10.2 A2A 设计思想</p>
</div>
<p><strong>（3）ANP：智能体网络的基础设施</strong></p>
<p>ANP（Agent Network Protocol）是一个概念性的协议框架<sup>3</sup>，目前由开源社区维护，还没有成熟的生态，其核心设计理念是<strong>构建大规模智能体网络的基础设施</strong>。如果说 MCP 解决的是"如何访问工具"，A2A 解决的是"如何与其他智能体对话"，那么 ANP 解决的是"如何在大规模网络中发现和连接智能体"。</p>
<p>ANP 的设计哲学是"去中心化服务发现"。在一个包含成百上千个智能体的网络中，如何让智能体能够找到它需要的服务？如图 10.3 所示，ANP 提供了服务注册、发现和路由机制，让智能体能够动态地发现网络中的其他服务，而不需要预先配置所有的连接关系。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-3.png" alt="" width="85%">
  <p>图 10.3 ANP 设计思想</p>
</div>
<p>最后在表 10.1 中，让我们通过一个对比表格来更清晰地理解这三种协议的差异：</p>
<div align="center">
  <p>表 10.1 三种协议对比</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-1.png" alt="" width="85%">
</div>
<p><strong>（4）如何选择合适的协议？</strong></p>
<p>目前的协议还处于发展早期，MCP 的生态相对成熟，不过各种工具的时效性取决于维护者，更推荐选择大公司背书的 MCP 工具。</p>
<p>选择协议的关键在于理解你的需求：</p>
<ul>
<li>如果你的智能体需要访问外部服务（文件、数据库、API），选择<strong>MCP</strong></li>
<li>如果你需要多个智能体相互协作完成任务，选择<strong>A2A</strong></li>
<li>如果你要构建大规模的智能体生态系统，考虑<strong>ANP</strong></li>
</ul>
<h3>10.1.3 HelloAgents 通信协议架构设计</h3>
<p>在理解了三种协议的设计理念后，让我们看看如何在 HelloAgents 框架中实现和使用它们。我们的设计目标是：<strong>让学习者能够以最简单的方式使用这些协议，同时保持足够的灵活性以应对复杂场景</strong>。</p>
<p>如图 10.4 所示，HelloAgents 的通信协议架构采用三层设计，从底层到上层分别是：协议实现层、工具封装层和智能体集成层。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-4.png" alt="" width="85%">
  <p>图 10.4 HelloAgents 通信协议设计</p>
</div>
<p><strong>（1）协议实现层</strong>：这一层包含了三种协议的具体实现。MCP 基于 FastMCP 库实现，提供客户端和服务器功能；A2A 基于 Google 官方的 a2a-sdk 实现；ANP 是我们自研的轻量级实现，提供服务发现和网络管理功能，当然目前也有官方的<a href="https://github.com/agent-network-protocol/AgentConnect">实现</a>，考虑到后期的迭代，因此这里只做概念的模拟。</p>
<p><strong>（2）工具封装层</strong>：这一层将协议实现封装成统一的 Tool 接口。MCPTool、A2ATool 和 ANPTool 都继承自 BaseTool，提供一致的<code>run()</code>方法。这种设计让智能体能够以相同的方式使用不同的协议。</p>
<p><strong>（3）智能体集成层</strong>：这一层是智能体与协议的集成点。所有的智能体（ReActAgent、SimpleAgent 等）都通过 Tool System 来使用协议工具，无需关心底层的协议细节。</p>
<h3>10.1.4 本章学习目标与快速体验</h3>
<p>让我们先看看第十章的学习内容：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">hello_agents/
</span><span class="code-line line-number" line="2">├── protocols/                          # 通信协议模块
</span><span class="code-line line-number" line="3">│   ├── mcp/                            # MCP协议实现（Model Context Protocol）
</span><span class="code-line line-number" line="4">│   │   ├── client.py                   # MCP客户端（支持5种传输方式）
</span><span class="code-line line-number" line="5">│   │   ├── server.py                   # MCP服务器（FastMCP封装）
</span><span class="code-line line-number" line="6">│   │   └── utils.py                    # 工具函数（create_context/parse_context）
</span><span class="code-line line-number" line="7">│   ├── a2a/                            # A2A协议实现（Agent-to-Agent Protocol）
</span><span class="code-line line-number" line="8">│   │   └── implementation.py           # A2A服务器/客户端（基于a2a-sdk，可选依赖）
</span><span class="code-line line-number" line="9">│   └── anp/                            # ANP协议实现（Agent Network Protocol）
</span><span class="code-line line-number" line="10">│       └── implementation.py           # ANP服务发现/注册（概念性实现）
</span><span class="code-line line-number" line="11">└── tools/builtin/                      # 内置工具模块
</span><span class="code-line line-number" line="12">    └── protocol_tools.py               # 协议工具包装器（MCPTool/A2ATool/ANPTool）
</span></code></pre>
<p>对于这一章的内容，主要是应用为主，学习目标是能拥有在自己项目中应用协议的能力。并且协议目前发展处于早期，所以无需花费太多精力去造轮子。在开始实战之前，让我们先准备好开发环境：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 安装HelloAgents框架（第10章版本）</span>
</span><span class="code-line line-number" line="2">pip <span class="token function">install</span> <span class="token string">"hello-agents[protocol]==0.2.2"</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 安装NodeJS, 可以参考Additional-Chapter中的文档</span>
</span></code></pre>
<p>让我们用最简单的代码体验一下三种协议的基本功能：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool<span class="token punctuation">,</span> A2ATool<span class="token punctuation">,</span> ANPTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 1. MCP：访问工具</span>
</span><span class="code-line line-number" line="4">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">result <span class="token operator">=</span> mcp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"call_tool"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    <span class="token string">"tool_name"</span><span class="token punctuation">:</span> <span class="token string">"add"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    <span class="token string">"arguments"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"MCP计算结果: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>  <span class="token comment"># 输出: 30.0</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># 2. ANP：服务发现</span>
</span><span class="code-line line-number" line="13">anp_tool <span class="token operator">=</span> ANPTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">anp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"register_service"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    <span class="token string">"service_id"</span><span class="token punctuation">:</span> <span class="token string">"calculator"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    <span class="token string">"service_type"</span><span class="token punctuation">:</span> <span class="token string">"math"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">    <span class="token string">"endpoint"</span><span class="token punctuation">:</span> <span class="token string">"http://localhost:8080"</span>
</span><span class="code-line line-number" line="19"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">services <span class="token operator">=</span> anp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"discover_services"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"发现的服务: </span><span class="token interpolation"><span class="token punctuation">{</span>services<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token comment"># 3. A2A：智能体通信</span>
</span><span class="code-line line-number" line="24">a2a_tool <span class="token operator">=</span> A2ATool<span class="token punctuation">(</span><span class="token string">"http://localhost:5000"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"A2A工具创建成功"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这个简单的示例展示了三种协议的核心功能。在接下来的章节中，我们将深入学习每种协议的详细用法和最佳实践。</p>
<h2>10.2 MCP 协议实战</h2>
<p>现在，让我们深入学习 MCP，掌握如何让智能体访问外部工具和资源。</p>
<h3>10.2.1 MCP 协议概念介绍</h3>
<p><strong>（1）MCP：智能体的"USB-C"</strong></p>
<p>想象一下，你的智能体可能需要同时做很多事情，例如：</p>
<ul>
<li>读取本地文件系统的文档</li>
<li>查询 PostgreSQL 数据库</li>
<li>搜索 GitHub 上的代码</li>
<li>发送 Slack 消息</li>
<li>访问 Google Drive</li>
</ul>
<p>传统方式下，你需要为每个服务编写适配器代码，处理不同的 API、认证方式、错误处理等。这不仅工作量大，而且难以维护。更重要的是，不同 LLM 平台的 function call 实现差异巨大，切换模型时需要重写大量代码。</p>
<p>MCP 的出现改变了这一切。它就像 USB-C 统一了各种设备的连接方式一样，<strong>MCP 统一了智能体与外部工具的交互方式</strong>。无论你使用 Claude、GPT 还是其他模型，只要它们支持 MCP 协议，就能无缝访问相同的工具和资源。</p>
<p><strong>（2）MCP 架构</strong></p>
<p>MCP 协议采用 Host、Client、Servers 三层架构设计，让我们通过图 10.5 的场景来理解这些组件如何协同工作。</p>
<p>假设你正在使用 Claude Desktop 询问："我桌面上有哪些文档？"</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-5.png" alt="" width="85%">
  <p>图 10.5 MCP 案例演示</p>
</div>
<p><strong>三层架构的职责：</strong></p>
<ol>
<li>
<p><strong>Host（宿主层）</strong>：Claude Desktop 作为 Host，负责接收用户提问并与 Claude 模型交互。Host 是用户直接交互的界面，它管理整个对话流程。</p>
</li>
<li>
<p><strong>Client（客户端层）</strong>：当 Claude 模型决定需要访问文件系统时，Host 中内置的 MCP Client 被激活。Client 负责与适当的 MCP Server 建立连接，发送请求并接收响应。</p>
</li>
<li>
<p><strong>Server（服务器层）</strong>：文件系统 MCP Server 被调用，执行实际的文件扫描操作，访问桌面目录，并返回找到的文档列表。</p>
</li>
</ol>
<p><strong>完整的交互流程：</strong>用户问题 → Claude Desktop(Host) → Claude 模型分析 → 需要文件信息 → MCP Client 连接 → 文件系统 MCP Server → 执行操作 → 返回结果 → Claude 生成回答 → 显示在 Claude Desktop 上</p>
<p>这种架构设计的优势在于<strong>关注点分离</strong>：Host 专注于用户体验，Client 专注于协议通信，Server 专注于具体功能实现。开发者只需专注于开发对应的 MCP Server，无需关心 Host 和 Client 的实现细节。</p>
<p><strong>（3）MCP 的核心能力</strong></p>
<p>如表 10.2 所示，MCP 协议提供了三大核心能力，构成完整的工具访问框架：</p>
<div align="center">
  <p>表 10.2 MCP 核心能力</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-2.png" alt="" width="85%">
</div>
<p>这三种能力的区别在于：<strong>Tools 是主动的</strong>（执行操作），<strong>Resources 是被动的</strong>（提供数据），<strong>Prompts 是指导性的</strong>（提供模板）。</p>
<p><strong>（4）MCP 的工作流程</strong></p>
<p>让我们通过一个具体例子来理解 MCP 的完整工作流程，如图 10.6 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-6.png" alt="" width="85%">
  <p>图 10.6 MCP 案例演示</p>
</div>
<p>一个关键问题是：<strong>Claude（或其他 LLM）是如何决定使用哪些工具的？</strong></p>
<p>当用户提出问题时，完整的工具选择流程如下：</p>
<ol>
<li>
<p><strong>工具发现阶段</strong>：MCP Client 连接到 Server 后，首先调用<code>list_tools()</code>获取所有可用工具的描述信息（包括工具名称、功能说明、参数定义）</p>
</li>
<li>
<p><strong>上下文构建</strong>：Client 将工具列表转换为 LLM 能理解的格式，添加到系统提示词中。例如：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">你可以使用以下工具：
</span><span class="code-line line-number" line="2">- read_file(path: str): 读取指定路径的文件内容
</span><span class="code-line line-number" line="3">- search_code(query: str, language: str): 在代码库中搜索
</span></code></pre>
</li>
<li>
<p><strong>模型推理</strong>：LLM 分析用户问题和可用工具，决定是否需要调用工具以及调用哪个工具。这个决策基于工具的描述和当前对话上下文</p>
</li>
<li>
<p><strong>工具执行</strong>：如果 LLM 决定使用工具，Client 通过 MCP Server 执行所选工具，获取结果</p>
</li>
<li>
<p><strong>结果整合</strong>：工具执行结果被送回给 LLM，LLM 结合结果生成最终回答</p>
</li>
</ol>
<p>这个过程是<strong>完全自动化</strong>的，LLM 会根据工具描述的质量来决定是否使用以及如何使用工具。因此，编写清晰、准确的工具描述至关重要。</p>
<p><strong>（5）MCP 与 Function Calling 的差异</strong></p>
<p>很多开发者会问：<strong>我已经在用 Function Calling 了，为什么还需要 MCP？</strong> 让我们通过表 10.3 来理解它们的区别。</p>
<div align="center">
  <p>表 10.3 Function Calling 与 MCP 对比</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-3.png" alt="" width="85%">
</div>
<p>这里我们以智能体需要访问 GitHub 仓库和本地文件系统为例子来详细对比同一个任务的两种实现</p>
<p><strong>方式 1：使用 Function Calling</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 步骤1：为每个LLM提供商定义函数</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># OpenAI格式</span>
</span><span class="code-line line-number" line="3">openai_tools <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="4">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"function"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">        <span class="token string">"function"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">            <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"search_github"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"搜索GitHub仓库"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">            <span class="token string">"parameters"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">                    <span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"搜索关键词"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13">                <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">                <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="15">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="16">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="17">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token comment"># Claude格式</span>
</span><span class="code-line line-number" line="21">claude_tools <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="22">    <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"search_github"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"搜索GitHub仓库"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">        <span class="token string">"input_schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>  <span class="token comment"># 注意：不是parameters</span>
</span><span class="code-line line-number" line="26">            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="27">            <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="28">                <span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"搜索关键词"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="29">            <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="30">            <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"query"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="32">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="33"><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35"><span class="token comment"># 步骤2：自己实现工具函数</span>
</span><span class="code-line line-number" line="36"><span class="token keyword">def</span> <span class="token function">search_github</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="37">    <span class="token keyword">import</span> requests
</span><span class="code-line line-number" line="38">    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="39">        <span class="token string">"https://api.github.com/search/repositories"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="40">        params<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="41">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">    <span class="token keyword">return</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44"><span class="token comment"># 步骤3：处理不同模型的响应格式</span>
</span><span class="code-line line-number" line="45"><span class="token comment"># OpenAI的响应</span>
</span><span class="code-line line-number" line="46"><span class="token keyword">if</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="47">    tool_call <span class="token operator">=</span> response<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>tool_calls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="48">    result <span class="token operator">=</span> search_github<span class="token punctuation">(</span><span class="token operator">**</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>tool_call<span class="token punctuation">.</span>function<span class="token punctuation">.</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">
</span><span class="code-line line-number" line="50"><span class="token comment"># Claude的响应</span>
</span><span class="code-line line-number" line="51"><span class="token keyword">if</span> response<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_use"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="52">    tool_use <span class="token operator">=</span> response<span class="token punctuation">.</span>content<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="53">    result <span class="token operator">=</span> search_github<span class="token punctuation">(</span><span class="token operator">**</span>tool_use<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>方式 2：使用 MCP</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> MCPClient
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 步骤1：连接到社区提供的MCP服务器（无需自己实现）</span>
</span><span class="code-line line-number" line="4">github_client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-github"</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">fs_client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span>
</span><span class="code-line line-number" line="9">    <span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># 步骤2：统一的调用方式（与模型无关）</span>
</span><span class="code-line line-number" line="13"><span class="token keyword">async</span> <span class="token keyword">with</span> github_client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">    <span class="token comment"># 自动发现工具</span>
</span><span class="code-line line-number" line="15">    tools <span class="token operator">=</span> <span class="token keyword">await</span> github_client<span class="token punctuation">.</span>list_tools<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">    <span class="token comment"># 调用工具（标准化接口）</span>
</span><span class="code-line line-number" line="18">    result <span class="token operator">=</span> <span class="token keyword">await</span> github_client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">        <span class="token string">"search_repositories"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        <span class="token punctuation">{</span><span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token string">"AI agents"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="21">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token comment"># 步骤3：任何支持MCP的模型都能使用</span>
</span><span class="code-line line-number" line="24"><span class="token comment"># OpenAI、Claude、Llama等都使用相同的MCP客户端</span>
</span></code></pre>
<p>首先需要明确的是，Function Calling 与 MCP 并非竞争关系，而是相辅相成的。Function Calling 是大语言模型的一项核心能力，它体现了模型内在的智能，使模型能够理解何时需要调用函数，并精准生成相应的调用参数。相对地，MCP 则扮演着基础设施协议的角色，它在工程层面解决了工具与模型如何连接的问题，通过标准化的方式来描述和调用工具。</p>
<p>我们可以用一个简单的类比来理解：Function Calling 相当于你学会了“如何打电话”这项技能，包括何时拨号、如何与对方沟通、何时挂断。而 MCP 则是那个全球统一的“电话通信标准”，确保了任何一部电话都能顺利地拨通另一部。</p>
<p>了解了它们之间的互补关系后，我们接下来看看如何在 HelloAgents 中使用 MCP 协议。</p>
<h3>10.2.2 使用 MCP 客户端</h3>
<p>HelloAgents 基于 FastMCP 2.0 实现了完整的 MCP 客户端功能。我们提供了异步和同步两种 API，以适应不同的使用场景。对于大多数应用，推荐使用异步 API，它能更好地处理并发请求和长时间运行的操作。下面我们将提供一个拆解的操作演示。</p>
<p><strong>（1）连接到 MCP 服务器</strong></p>
<p>MCP 客户端支持多种连接方式，最常用的是 Stdio 模式（通过标准输入输出与本地进程通信）：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> asyncio
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> MCPClient
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect_to_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">    <span class="token comment"># 方式1：连接到社区提供的文件系统服务器</span>
</span><span class="code-line line-number" line="6">    <span class="token comment"># npx会自动下载并运行@modelcontextprotocol/server-filesystem包</span>
</span><span class="code-line line-number" line="7">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span>
</span><span class="code-line line-number" line="8">        <span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">        <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">        <span class="token string">"."</span>  <span class="token comment"># 指定根目录</span>
</span><span class="code-line line-number" line="11">    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">    <span class="token comment"># 使用async with确保连接正确关闭</span>
</span><span class="code-line line-number" line="14">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># 在这里使用client</span>
</span><span class="code-line line-number" line="16">        tools <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>list_tools<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"可用工具: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">[</span>t<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> tools<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">    <span class="token comment"># 方式2：连接到自定义的Python MCP服务器</span>
</span><span class="code-line line-number" line="20">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"my_mcp_server.py"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="22">        <span class="token comment"># 使用client...</span>
</span><span class="code-line line-number" line="23">        <span class="token keyword">pass</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token comment"># 运行异步函数</span>
</span><span class="code-line line-number" line="26">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>connect_to_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（2）发现可用工具</strong></p>
<p>连接成功后，第一步通常是查询服务器提供了哪些工具：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">discover_tools</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token comment"># 获取所有可用工具</span>
</span><span class="code-line line-number" line="6">        tools <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>list_tools<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"服务器提供了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个工具："</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">        <span class="token keyword">for</span> tool <span class="token keyword">in</span> tools<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n工具名称: </span><span class="token interpolation"><span class="token punctuation">{</span>tool<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"描述: </span><span class="token interpolation"><span class="token punctuation">{</span>tool<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'description'</span><span class="token punctuation">,</span> <span class="token string">'无描述'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">            <span class="token comment"># 打印参数信息</span>
</span><span class="code-line line-number" line="14">            <span class="token keyword">if</span> <span class="token string">'inputSchema'</span> <span class="token keyword">in</span> tool<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">                schema <span class="token operator">=</span> tool<span class="token punctuation">[</span><span class="token string">'inputSchema'</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="16">                <span class="token keyword">if</span> <span class="token string">'properties'</span> <span class="token keyword">in</span> schema<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"参数:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">                    <span class="token keyword">for</span> param_name<span class="token punctuation">,</span> param_info <span class="token keyword">in</span> schema<span class="token punctuation">[</span><span class="token string">'properties'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">                        param_type <span class="token operator">=</span> param_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'type'</span><span class="token punctuation">,</span> <span class="token string">'any'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">                        param_desc <span class="token operator">=</span> param_info<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'description'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  - </span><span class="token interpolation"><span class="token punctuation">{</span>param_name<span class="token punctuation">}</span></span><span class="token string"> (</span><span class="token interpolation"><span class="token punctuation">{</span>param_type<span class="token punctuation">}</span></span><span class="token string">): </span><span class="token interpolation"><span class="token punctuation">{</span>param_desc<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>discover_tools<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token comment"># 输出示例：</span>
</span><span class="code-line line-number" line="26"><span class="token comment"># 服务器提供了 5 个工具：</span>
</span><span class="code-line line-number" line="27"><span class="token comment">#</span>
</span><span class="code-line line-number" line="28"><span class="token comment"># 工具名称: read_file</span>
</span><span class="code-line line-number" line="29"><span class="token comment"># 描述: 读取文件内容</span>
</span><span class="code-line line-number" line="30"><span class="token comment"># 参数:</span>
</span><span class="code-line line-number" line="31"><span class="token comment">#   - path (string): 文件路径</span>
</span><span class="code-line line-number" line="32"><span class="token comment">#</span>
</span><span class="code-line line-number" line="33"><span class="token comment"># 工具名称: write_file</span>
</span><span class="code-line line-number" line="34"><span class="token comment"># 描述: 写入文件内容</span>
</span><span class="code-line line-number" line="35"><span class="token comment"># 参数:</span>
</span><span class="code-line line-number" line="36"><span class="token comment">#   - path (string): 文件路径</span>
</span><span class="code-line line-number" line="37"><span class="token comment">#   - content (string): 文件内容</span>
</span></code></pre>
<p><strong>（3）调用工具</strong></p>
<p>调用工具时，只需提供工具名称和符合 JSON Schema 的参数：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">use_tools</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token comment"># 读取文件</span>
</span><span class="code-line line-number" line="6">        result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"read_file"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"my_README.md"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"文件内容：\n</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">        <span class="token comment"># 列出目录</span>
</span><span class="code-line line-number" line="10">        result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"list_directory"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"."</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"当前目录文件：</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">        <span class="token comment"># 写入文件</span>
</span><span class="code-line line-number" line="14">        result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"write_file"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">            <span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"output.txt"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">            <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"Hello from MCP!"</span>
</span><span class="code-line line-number" line="17">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"写入结果：</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>use_tools<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p>在这里提供一种更为安全的方式来调用 MCP 服务，可供参考：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">safe_tool_call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">            <span class="token comment"># 尝试读取可能不存在的文件</span>
</span><span class="code-line line-number" line="7">            result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"read_file"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"nonexistent.txt"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">            <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"工具调用失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">            <span class="token comment"># 可以选择重试、使用默认值或向用户报告错误</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>safe_tool_call<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（4）访问资源</strong></p>
<p>除了工具，MCP 服务器还可以提供资源（Resources）：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 列出可用资源</span>
</span><span class="code-line line-number" line="2">resources <span class="token operator">=</span> client<span class="token punctuation">.</span>list_resources<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"可用资源：</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">[</span>r<span class="token punctuation">[</span><span class="token string">'uri'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> r <span class="token keyword">in</span> resources<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 读取资源</span>
</span><span class="code-line line-number" line="6">resource_content <span class="token operator">=</span> client<span class="token punctuation">.</span>read_resource<span class="token punctuation">(</span><span class="token string">"file:///path/to/resource"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"资源内容：</span><span class="token interpolation"><span class="token punctuation">{</span>resource_content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（5）使用提示模板</strong></p>
<p>MCP 服务器可以提供预定义的提示模板（Prompts）：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 列出可用提示</span>
</span><span class="code-line line-number" line="2">prompts <span class="token operator">=</span> client<span class="token punctuation">.</span>list_prompts<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"可用提示：</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> prompts<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 获取提示内容</span>
</span><span class="code-line line-number" line="6">prompt <span class="token operator">=</span> client<span class="token punctuation">.</span>get_prompt<span class="token punctuation">(</span><span class="token string">"code_review"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"language"</span><span class="token punctuation">:</span> <span class="token string">"python"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"提示内容：</span><span class="token interpolation"><span class="token punctuation">{</span>prompt<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（6）完整示例：使用 GitHub MCP 服务</strong></p>
<p>让我们通过一个完整的例子来看如何使用社区提供的 GitHub MCP 服务，我们将采用封装好的 MCP Tools 来：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">GitHub MCP 服务示例
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">注意：需要设置环境变量
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">    Windows: $env:GITHUB_PERSONAL_ACCESS_TOKEN="your_token_here"
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">    Linux/macOS: export GITHUB_PERSONAL_ACCESS_TOKEN="your_token_here"
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 创建 GitHub MCP 工具</span>
</span><span class="code-line line-number" line="12">github_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="13">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-github"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="14"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token comment"># 1. 列出可用工具</span>
</span><span class="code-line line-number" line="17"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📋 可用工具："</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">result <span class="token operator">=</span> github_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"list_tools"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19"><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 2. 搜索仓库</span>
</span><span class="code-line line-number" line="22"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n🔍 搜索仓库："</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">result <span class="token operator">=</span> github_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="24">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"call_tool"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">    <span class="token string">"tool_name"</span><span class="token punctuation">:</span> <span class="token string">"search_repositories"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">    <span class="token string">"arguments"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="27">        <span class="token string">"query"</span><span class="token punctuation">:</span> <span class="token string">"AI agents language:python"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="28">        <span class="token string">"page"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="29">        <span class="token string">"perPage"</span><span class="token punctuation">:</span> <span class="token number">3</span>
</span><span class="code-line line-number" line="30">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="31"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32"><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">
</span></code></pre>
<h3>10.2.3 MCP 传输方式详解</h3>
<p>MCP 协议的一个重要特性是<strong>传输层无关性</strong>（Transport Agnostic）。这意味着 MCP 协议本身不依赖于特定的传输方式，可以在不同的通信通道上运行。HelloAgents 基于 FastMCP 2.0，提供了完整的传输方式支持，让你可以根据实际场景选择最合适的传输模式。</p>
<p><strong>（1）传输方式概览</strong></p>
<p>HelloAgents 的<code>MCPClient</code>支持五种传输方式，每种都有不同的使用场景，如表 10.4 所示：</p>
<div align="center">
  <p>表 10.4 MCP 传输方式对比</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-4.png" alt="" width="85%">
</div>
<p><strong>（2）传输方式使用示例</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 1. Memory Transport - 内存传输（用于测试）</span>
</span><span class="code-line line-number" line="4"><span class="token comment"># 不指定任何参数，使用内置演示服务器</span>
</span><span class="code-line line-number" line="5">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 2. Stdio Transport - 标准输入输出传输（本地开发）</span>
</span><span class="code-line line-number" line="8"><span class="token comment"># 使用命令列表启动本地服务器</span>
</span><span class="code-line line-number" line="9">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"examples/mcp_example_server.py"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 3. Stdio Transport with Args - 带参数的命令传输</span>
</span><span class="code-line line-number" line="12"><span class="token comment"># 可以传递额外参数</span>
</span><span class="code-line line-number" line="13">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"examples/mcp_example_server.py"</span><span class="token punctuation">,</span> <span class="token string">"--debug"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token comment"># 4. Stdio Transport - 社区服务器（npx方式）</span>
</span><span class="code-line line-number" line="16"><span class="token comment"># 使用npx启动社区MCP服务器</span>
</span><span class="code-line line-number" line="17">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token comment"># 5. HTTP/SSE/StreamableHTTP Transport</span>
</span><span class="code-line line-number" line="20"><span class="token comment"># 注意：MCPTool主要用于Stdio和Memory传输</span>
</span><span class="code-line line-number" line="21"><span class="token comment"># 对于HTTP/SSE等远程传输，建议直接使用MCPClient</span>
</span></code></pre>
<p><strong>（3）Memory Transport - 内存传输</strong></p>
<p>适用场景：单元测试、快速原型开发</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 使用内置演示服务器（Memory传输）</span>
</span><span class="code-line line-number" line="4">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 列出可用工具</span>
</span><span class="code-line line-number" line="7">result <span class="token operator">=</span> mcp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"list_tools"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 调用工具</span>
</span><span class="code-line line-number" line="11">result <span class="token operator">=</span> mcp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"call_tool"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    <span class="token string">"tool_name"</span><span class="token punctuation">:</span> <span class="token string">"add"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    <span class="token string">"arguments"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"a"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">"b"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="15"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16"><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（4）Stdio Transport - 标准输入输出传输</strong></p>
<p>适用场景：本地开发、调试、Python 脚本服务器</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 方式1：使用自定义Python服务器</span>
</span><span class="code-line line-number" line="4">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"my_mcp_server.py"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 方式2：使用社区服务器（文件系统）</span>
</span><span class="code-line line-number" line="7">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9"><span class="token comment"># 列出工具</span>
</span><span class="code-line line-number" line="10">result <span class="token operator">=</span> mcp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"list_tools"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11"><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token comment"># 调用工具</span>
</span><span class="code-line line-number" line="14">result <span class="token operator">=</span> mcp_tool<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">    <span class="token string">"action"</span><span class="token punctuation">:</span> <span class="token string">"call_tool"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    <span class="token string">"tool_name"</span><span class="token punctuation">:</span> <span class="token string">"read_file"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    <span class="token string">"arguments"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"path"</span><span class="token punctuation">:</span> <span class="token string">"README.md"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19"><span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（5）HTTP Transport - HTTP 传输</strong></p>
<p>适用场景：生产环境、远程服务、微服务架构</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 注意：MCPTool 主要用于 Stdio 和 Memory 传输</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># 对于 HTTP/SSE 等远程传输，建议使用底层的 MCPClient</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> asyncio
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> MCPClient
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_http_transport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token comment"># 连接到远程 HTTP MCP 服务器</span>
</span><span class="code-line line-number" line="9">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token string">"http://api.example.com/mcp"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">        <span class="token comment"># 获取服务器信息</span>
</span><span class="code-line line-number" line="13">        tools <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>list_tools<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"远程服务器工具: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16">        <span class="token comment"># 调用远程工具</span>
</span><span class="code-line line-number" line="17">        result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"process_data"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">            <span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token string">"Hello, World!"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">            <span class="token string">"operation"</span><span class="token punctuation">:</span> <span class="token string">"uppercase"</span>
</span><span class="code-line line-number" line="20">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"远程处理结果: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token comment"># 注意：需要实际的 HTTP MCP 服务器</span>
</span><span class="code-line line-number" line="24"><span class="token comment"># asyncio.run(test_http_transport())</span>
</span></code></pre>
<p><strong>（6）SSE Transport - Server-Sent Events 传输</strong></p>
<p>适用场景：实时通信、流式处理、长连接</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 注意：MCPTool 主要用于 Stdio 和 Memory 传输</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># 对于 SSE 传输，建议使用底层的 MCPClient</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> asyncio
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> MCPClient
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_sse_transport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token comment"># 连接到 SSE MCP 服务器</span>
</span><span class="code-line line-number" line="9">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="10">        <span class="token string">"http://localhost:8080/sse"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">        transport_type<span class="token operator">=</span><span class="token string">"sse"</span>
</span><span class="code-line line-number" line="12">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># SSE 特别适合流式处理</span>
</span><span class="code-line line-number" line="16">        result <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"stream_process"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">            <span class="token string">"input"</span><span class="token punctuation">:</span> <span class="token string">"大量数据处理请求"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">            <span class="token string">"stream"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
</span><span class="code-line line-number" line="19">        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"流式处理结果: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22"><span class="token comment"># 注意：需要支持 SSE 的 MCP 服务器</span>
</span><span class="code-line line-number" line="23"><span class="token comment"># asyncio.run(test_sse_transport())</span>
</span></code></pre>
<p><strong>（7）StreamableHTTP Transport - 流式 HTTP 传输</strong></p>
<p>适用场景：需要双向流式通信的 HTTP 场景</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 注意：MCPTool 主要用于 Stdio 和 Memory 传输</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># 对于 StreamableHTTP 传输，建议使用底层的 MCPClient</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> asyncio
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> MCPClient
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_streamable_http_transport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token comment"># 连接到 StreamableHTTP MCP 服务器</span>
</span><span class="code-line line-number" line="9">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="10">        <span class="token string">"http://localhost:8080/mcp"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">        transport_type<span class="token operator">=</span><span class="token string">"streamable_http"</span>
</span><span class="code-line line-number" line="12">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">    <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">        <span class="token comment"># 支持双向流式通信</span>
</span><span class="code-line line-number" line="16">        tools <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span>list_tools<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"StreamableHTTP 服务器工具: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>tools<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token comment"># 注意：需要支持 StreamableHTTP 的 MCP 服务器</span>
</span><span class="code-line line-number" line="20"><span class="token comment"># asyncio.run(test_streamable_http_transport())</span>
</span></code></pre>
<h3>10.2.4 在智能体中使用 MCP 工具</h3>
<p>前面我们学习了如何直接使用 MCP 客户端。但在实际应用中，我们更希望让智能体<strong>自动</strong>调用 MCP 工具，而不是手动编写调用代码。HelloAgents 提供了<code>MCPTool</code>包装器，让 MCP 服务器无缝集成到智能体的工具链中。</p>
<p><strong>（1）MCP 工具的自动展开机制</strong></p>
<p>HelloAgents 的<code>MCPTool</code>有一个特性：<strong>自动展开</strong>。当你添加一个 MCP 工具到 Agent 时，它会自动将 MCP 服务器提供的所有工具展开为独立的工具，让 Agent 可以像调用普通工具一样调用它们。</p>
<p><strong>方式 1：使用内置演示服务器</strong></p>
<p>我们在之前实现过计算器的工具函数，在这里将他转化为 MCP 的服务。这是最简单的使用方式。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"助手"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 无需任何配置，自动使用内置演示服务器</span>
</span><span class="code-line line-number" line="7">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"calculator"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>mcp_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9"><span class="token comment"># ✅ MCP工具 'calculator' 已展开为 6 个独立工具</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 智能体可以直接使用展开后的工具</span>
</span><span class="code-line line-number" line="12">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"计算 25 乘以 16"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>  <span class="token comment"># 输出：25 乘以 16 的结果是 400</span>
</span></code></pre>
<p><strong>自动展开后的工具</strong>：</p>
<ul>
<li><code>calculator_add</code> - 加法计算器</li>
<li><code>calculator_subtract</code> - 减法计算器</li>
<li><code>calculator_multiply</code> - 乘法计算器</li>
<li><code>calculator_divide</code> - 除法计算器</li>
<li><code>calculator_greet</code> - 友好问候</li>
<li><code>calculator_get_system_info</code> - 获取系统信息</li>
</ul>
<p>Agent 调用时只需提供参数，例如：<code>[TOOL_CALL:calculator_multiply:a=25,b=16]</code>，系统会自动处理类型转换和 MCP 调用。</p>
<p><strong>方式 2：连接外部 MCP 服务器</strong></p>
<p>在实际项目中，你需要连接到功能更强大的 MCP 服务器。这些服务器可以是：</p>
<ul>
<li><strong>社区提供的官方服务器</strong>（如文件系统、GitHub、数据库等）</li>
<li><strong>你自己编写的自定义服务器</strong>（封装业务逻辑）</li>
</ul>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"文件助手"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 示例1：连接到社区提供的文件系统服务器</span>
</span><span class="code-line line-number" line="7">fs_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="8">    name<span class="token operator">=</span><span class="token string">"filesystem"</span><span class="token punctuation">,</span>  <span class="token comment"># 指定唯一名称</span>
</span><span class="code-line line-number" line="9">    description<span class="token operator">=</span><span class="token string">"访问本地文件系统"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>fs_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token comment"># 示例2：连接到自定义的 Python MCP 服务器</span>
</span><span class="code-line line-number" line="15"><span class="token comment"># 关于如何编写自定义MCP服务器，请参考10.5章节</span>
</span><span class="code-line line-number" line="16">custom_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="17">    name<span class="token operator">=</span><span class="token string">"custom_server"</span><span class="token punctuation">,</span>  <span class="token comment"># 使用不同的名称</span>
</span><span class="code-line line-number" line="18">    description<span class="token operator">=</span><span class="token string">"自定义业务逻辑服务器"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"my_mcp_server.py"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="20"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>custom_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token comment"># Agent现在可以自动使用这些工具！</span>
</span><span class="code-line line-number" line="24">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"请读取my_README.md文件，并总结其中的主要内容"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span></code></pre>
<p>当使用多个 MCP 服务器时，务必为每个 MCPTool 指定不同的 name，这个 name 会作为前缀添加到展开的工具名前，避免冲突。例如：<code>name="fs"</code> 会展开为 <code>fs_read_file</code>、<code>fs_write_file</code> 等。如果你需要编写自己的 MCP 服务器来封装特定的业务逻辑，请参考 10.5 节内容。</p>
<p><strong>（2）MCP 工具自动展开的工作原理</strong></p>
<p>理解自动展开机制有助于你更好地使用 MCP 工具。让我们深入了解它是如何工作的：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 用户代码</span>
</span><span class="code-line line-number" line="2">fs_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"fs"</span><span class="token punctuation">,</span> server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>fs_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 内部发生的事情：</span>
</span><span class="code-line line-number" line="6"><span class="token comment"># 1. MCPTool连接到服务器，发现14个工具</span>
</span><span class="code-line line-number" line="7"><span class="token comment"># 2. 为每个工具创建包装器：</span>
</span><span class="code-line line-number" line="8"><span class="token comment">#    - fs_read_text_file (参数: path, tail, head)</span>
</span><span class="code-line line-number" line="9"><span class="token comment">#    - fs_write_file (参数: path, content)</span>
</span><span class="code-line line-number" line="10"><span class="token comment">#    - ...</span>
</span><span class="code-line line-number" line="11"><span class="token comment"># 3. 注册到Agent的工具注册表</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token comment"># Agent调用</span>
</span><span class="code-line line-number" line="14">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"读取README.md"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token comment"># Agent内部：</span>
</span><span class="code-line line-number" line="17"><span class="token comment"># 1. 识别需要调用 fs_read_text_file</span>
</span><span class="code-line line-number" line="18"><span class="token comment"># 2. 生成参数：path=README.md</span>
</span><span class="code-line line-number" line="19"><span class="token comment"># 3. 包装器转换为MCP格式：</span>
</span><span class="code-line line-number" line="20"><span class="token comment">#    {"action": "call_tool", "tool_name": "read_text_file", "arguments": {"path": "README.md"}}</span>
</span><span class="code-line line-number" line="21"><span class="token comment"># 4. 调用MCP服务器</span>
</span><span class="code-line line-number" line="22"><span class="token comment"># 5. 返回文件内容</span>
</span></code></pre>
<p>系统会根据工具的参数定义自动转换类型：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Agent调用计算器</span>
</span><span class="code-line line-number" line="2">agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"计算 25 乘以 16"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># Agent生成：a=25,b=16 (字符串)</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># 系统自动转换为：{"a": 25.0, "b": 16.0} (数字)</span>
</span><span class="code-line line-number" line="6"><span class="token comment"># MCP服务器接收到正确的数字类型</span>
</span></code></pre>
<p><strong>（3）实战案例：智能文档助手</strong></p>
<p>让我们构建一个完整的智能文档助手，这里我们用一个简单的多智能体编排进行演示：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">多Agent协作的智能文档助手
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">使用两个SimpleAgent分工协作：
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">- Agent1：GitHub搜索专家
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">- Agent2：文档生成专家
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="8"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="9"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="10"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># 加载.env文件中的环境变量</span>
</span><span class="code-line line-number" line="13">load_dotenv<span class="token punctuation">(</span>dotenv_path<span class="token operator">=</span><span class="token string">"../HelloAgents/.env"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"多Agent协作的智能文档助手"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token comment"># ============================================================</span>
</span><span class="code-line line-number" line="20"><span class="token comment"># Agent 1: GitHub搜索专家</span>
</span><span class="code-line line-number" line="21"><span class="token comment"># ============================================================</span>
</span><span class="code-line line-number" line="22"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【步骤1】创建GitHub搜索专家..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">github_searcher <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="25">    name<span class="token operator">=</span><span class="token string">"GitHub搜索专家"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">    llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="27">    system_prompt<span class="token operator">=</span><span class="token triple-quoted-string string">"""你是一个GitHub搜索专家。
</span></span><span class="code-line line-number" line="28"><span class="token triple-quoted-string string">你的任务是搜索GitHub仓库并返回结果。
</span></span><span class="code-line line-number" line="29"><span class="token triple-quoted-string string">请返回清晰、结构化的搜索结果，包括：
</span></span><span class="code-line line-number" line="30"><span class="token triple-quoted-string string">- 仓库名称
</span></span><span class="code-line line-number" line="31"><span class="token triple-quoted-string string">- 简短描述
</span></span><span class="code-line line-number" line="32"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="33"><span class="token triple-quoted-string string">保持简洁，不要添加额外的解释。"""</span>
</span><span class="code-line line-number" line="34"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">
</span><span class="code-line line-number" line="36"><span class="token comment"># 添加GitHub工具</span>
</span><span class="code-line line-number" line="37">github_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="38">    name<span class="token operator">=</span><span class="token string">"gh"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="39">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-github"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="40"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">github_searcher<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>github_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43"><span class="token comment"># ============================================================</span>
</span><span class="code-line line-number" line="44"><span class="token comment"># Agent 2: 文档生成专家</span>
</span><span class="code-line line-number" line="45"><span class="token comment"># ============================================================</span>
</span><span class="code-line line-number" line="46"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【步骤2】创建文档生成专家..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">
</span><span class="code-line line-number" line="48">document_writer <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="49">    name<span class="token operator">=</span><span class="token string">"文档生成专家"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="50">    llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="51">    system_prompt<span class="token operator">=</span><span class="token triple-quoted-string string">"""你是一个文档生成专家。
</span></span><span class="code-line line-number" line="52"><span class="token triple-quoted-string string">你的任务是根据提供的信息生成结构化的Markdown报告。
</span></span><span class="code-line line-number" line="53"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="54"><span class="token triple-quoted-string string">报告应该包括：
</span></span><span class="code-line line-number" line="55"><span class="token triple-quoted-string string">- 标题
</span></span><span class="code-line line-number" line="56"><span class="token triple-quoted-string string">- 简介
</span></span><span class="code-line line-number" line="57"><span class="token triple-quoted-string string">- 主要内容（分点列出，包括项目名称、描述等）
</span></span><span class="code-line line-number" line="58"><span class="token triple-quoted-string string">- 总结
</span></span><span class="code-line line-number" line="59"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="60"><span class="token triple-quoted-string string">请直接输出完整的Markdown格式报告内容，不要使用工具保存。"""</span>
</span><span class="code-line line-number" line="61"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="62">
</span><span class="code-line line-number" line="63"><span class="token comment"># 添加文件系统工具</span>
</span><span class="code-line line-number" line="64">fs_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="65">    name<span class="token operator">=</span><span class="token string">"fs"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="66">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@modelcontextprotocol/server-filesystem"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="67"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="68">document_writer<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>fs_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="69">
</span><span class="code-line line-number" line="70"><span class="token comment"># ============================================================</span>
</span><span class="code-line line-number" line="71"><span class="token comment"># 执行任务</span>
</span><span class="code-line line-number" line="72"><span class="token comment"># ============================================================</span>
</span><span class="code-line line-number" line="73"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="74"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"开始执行任务..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="75"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="76">
</span><span class="code-line line-number" line="77"><span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="78">    <span class="token comment"># 步骤1：GitHub搜索</span>
</span><span class="code-line line-number" line="79">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【步骤3】Agent1 搜索GitHub..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="80">    search_task <span class="token operator">=</span> <span class="token string">"搜索关于'AI agent'的GitHub仓库，返回前5个最相关的结果"</span>
</span><span class="code-line line-number" line="81">    
</span><span class="code-line line-number" line="82">    search_results <span class="token operator">=</span> github_searcher<span class="token punctuation">.</span>run<span class="token punctuation">(</span>search_task<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="83">    
</span><span class="code-line line-number" line="84">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n搜索结果:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="85">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="86">    <span class="token keyword">print</span><span class="token punctuation">(</span>search_results<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="87">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="88">    
</span><span class="code-line line-number" line="89">    <span class="token comment"># 步骤2：生成报告</span>
</span><span class="code-line line-number" line="90">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【步骤4】Agent2 生成报告..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="91">    report_task <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"""
</span></span></span><span class="code-line line-number" line="92"><span class="token string-interpolation"><span class="token string">根据以下GitHub搜索结果，生成一份Markdown格式的研究报告：
</span></span></span><span class="code-line line-number" line="93"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="94"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>search_results<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="95"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="96"><span class="token string-interpolation"><span class="token string">报告要求：
</span></span></span><span class="code-line line-number" line="97"><span class="token string-interpolation"><span class="token string">1. 标题：# AI Agent框架研究报告
</span></span></span><span class="code-line line-number" line="98"><span class="token string-interpolation"><span class="token string">2. 简介：说明这是关于AI Agent的GitHub项目调研
</span></span></span><span class="code-line line-number" line="99"><span class="token string-interpolation"><span class="token string">3. 主要发现：列出找到的项目及其特点（包括名称、描述等）
</span></span></span><span class="code-line line-number" line="100"><span class="token string-interpolation"><span class="token string">4. 总结：总结这些项目的共同特点
</span></span></span><span class="code-line line-number" line="101"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="102"><span class="token string-interpolation"><span class="token string">请直接输出完整的Markdown格式报告。
</span></span></span><span class="code-line line-number" line="103"><span class="token string-interpolation"><span class="token string">"""</span></span>
</span><span class="code-line line-number" line="104">
</span><span class="code-line line-number" line="105">    report_content <span class="token operator">=</span> document_writer<span class="token punctuation">.</span>run<span class="token punctuation">(</span>report_task<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="106">
</span><span class="code-line line-number" line="107">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n报告内容:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="108">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="109">    <span class="token keyword">print</span><span class="token punctuation">(</span>report_content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="110">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="111">
</span><span class="code-line line-number" line="112">    <span class="token comment"># 步骤3：保存报告</span>
</span><span class="code-line line-number" line="113">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n【步骤5】保存报告到文件..."</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="114">    <span class="token keyword">import</span> os
</span><span class="code-line line-number" line="115">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="116">        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"report.md"</span><span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="117">            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>report_content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="118">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 报告已保存到 report.md"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="119">
</span><span class="code-line line-number" line="120">        <span class="token comment"># 验证文件</span>
</span><span class="code-line line-number" line="121">        file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span><span class="token string">"report.md"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="122">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 文件大小: </span><span class="token interpolation"><span class="token punctuation">{</span>file_size<span class="token punctuation">}</span></span><span class="token string"> 字节"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="123">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="124">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ 保存失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="125">    
</span><span class="code-line line-number" line="126">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="127">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"任务完成！"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="128">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span><span class="token operator">*</span><span class="token number">70</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="129">    
</span><span class="code-line line-number" line="130"><span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="131">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n❌ 错误: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="132">    <span class="token keyword">import</span> traceback
</span><span class="code-line line-number" line="133">    traceback<span class="token punctuation">.</span>print_exc<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="134">
</span></code></pre>
<p><code>github_searcher</code>会在这个过程中调用<code>gh_search_repositories</code>搜索 GitHub 项目。得到的结果会返回给<code>document_writer</code>当做输入，进一步指导报告的生成，最后保存报告到 report.md。</p>
<h3>10.2.5 MCP 社区生态</h3>
<p>MCP 协议的一个巨大优势是<strong>丰富的社区生态</strong>。Anthropic 和社区开发者已经创建了大量现成的 MCP 服务器，涵盖文件系统、数据库、API 服务等各种场景。这意味着你不需要从零开始编写工具适配器，可以直接使用这些经过验证的服务器。</p>
<p>这里给出 MCP 社区的三个资源库：</p>
<ol>
<li>
<p><strong>Awesome MCP Servers</strong> (<a href="https://github.com/punkpeye/awesome-mcp-servers">https://github.com/punkpeye/awesome-mcp-servers</a>)</p>
<ul>
<li>社区维护的 MCP 服务器精选列表</li>
<li>包含各种第三方服务器</li>
<li>按功能分类，易于查找</li>
</ul>
</li>
<li>
<p><strong>MCP Servers Website</strong> (<a href="https://mcpservers.org/">https://mcpservers.org/</a>)</p>
<ul>
<li>官方 MCP 服务器目录网站</li>
<li>提供搜索和筛选功能</li>
<li>包含使用说明和示例</li>
</ul>
</li>
<li>
<p><strong>Official MCP Servers</strong> (<a href="https://github.com/modelcontextprotocol/servers">https://github.com/modelcontextprotocol/servers</a>)</p>
<ul>
<li>Anthropic 官方维护的服务器</li>
<li>质量最高、文档最完善</li>
<li>包含常用服务的实现</li>
</ul>
</li>
</ol>
<p>表 10.5 和 10.6 给出常用的官方 MCP 服务器和社区热门 MCP 服务器：</p>
<div align="center">
  <p>表 10.5 常用官方 MCP 服务器</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-5.png" alt="" width="85%">
</div>
<div align="center">
  <p>表 10.6 社区热门 MCP 服务器</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-6.png" alt="" width="85%">
</div>
<p>以下是一些特别有趣的案例 TODO 可供参考：</p>
<ol>
<li>
<p><strong>自动化网页测试（Playwright）</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Agent可以自动：</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># - 打开浏览器访问网站</span>
</span><span class="code-line line-number" line="3"><span class="token comment"># - 填写表单并提交</span>
</span><span class="code-line line-number" line="4"><span class="token comment"># - 截图验证结果</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># - 生成测试报告</span>
</span><span class="code-line line-number" line="6">playwright_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="7">    name<span class="token operator">=</span><span class="token string">"playwright"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"npx"</span><span class="token punctuation">,</span> <span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@playwright/mcp"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">)</span>
</span></code></pre>
</li>
<li>
<p><strong>智能笔记助手（Obsidian + Perplexity）</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Agent可以：</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># - 搜索最新技术资讯（Perplexity）</span>
</span><span class="code-line line-number" line="3"><span class="token comment"># - 整理成结构化笔记</span>
</span><span class="code-line line-number" line="4"><span class="token comment"># - 保存到Obsidian知识库</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># - 自动建立笔记间的链接</span>
</span></code></pre>
</li>
<li>
<p><strong>项目管理自动化（Jira + GitHub）</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Agent可以：</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># - 从GitHub Issue创建Jira任务</span>
</span><span class="code-line line-number" line="3"><span class="token comment"># - 同步代码提交到Jira</span>
</span><span class="code-line line-number" line="4"><span class="token comment"># - 自动更新Sprint进度</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># - 生成项目报告</span>
</span></code></pre>
</li>
<li>
<p><strong>内容创作工作流（YouTube + Notion + Spotify）</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Agent可以：</span>
</span><span class="code-line line-number" line="2"><span class="token comment"># - 获取YouTube视频字幕</span>
</span><span class="code-line line-number" line="3"><span class="token comment"># - 生成内容摘要</span>
</span><span class="code-line line-number" line="4"><span class="token comment"># - 保存到Notion数据库</span>
</span><span class="code-line line-number" line="5"><span class="token comment"># - 播放背景音乐（Spotify）</span>
</span></code></pre>
</li>
</ol>
<p>通过这一节内容的讲解，希望你能探索更多 MCP 的实现案例，也欢迎投稿至 Helloagents！接下来，让我们学习 A2A 协议。</p>
<h2>10.3 A2A 协议实战</h2>
<p>A2A（Agent-to-Agent）是一种支持智能体之间直接通信与协作的协议。</p>
<h3>10.3.1 协议设计动机</h3>
<p>MCP 协议解决了智能体与工具的交互，而 A2A 协议则解决智能体之间的协作问题。在一个需要多智能体（如研究员、撰写员、编辑）协作的任务中，它们需要通信、委托任务、协商能力和同步状态。</p>
<p>传统的中央协调器（星型拓扑）方案存在三个主要问题：</p>
<ul>
<li><strong>单点故障</strong>：协调器失效导致系统整体瘫痪。</li>
<li><strong>性能瓶颈</strong>：所有通信都经过中心节点，限制了并发。</li>
<li><strong>扩展困难</strong>：增加或修改智能体需要改动中心逻辑。</li>
</ul>
<p>A2A 协议采用点对点（P2P）架构（网状拓拓），允许智能体直接通信，从根本上解决了上述问题。它的核心是<strong>任务（Task）</strong>和<strong>工件（Artifact）</strong>这两个抽象概念，这是它与 MCP 最大的区别，如表 10.7 所示。</p>
<div align="center">
  <p>表 10.7 A2A 核心概念</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-7.png" alt="" width="85%">
</div>
<p>为实现对协作过程的管理，A2A 为任务定义了标准化的生命周期，包括创建、协商、代理、执行中、完成、失败等状态，可见图 10.7。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-7.png" alt="" width="85%">
  <p>图 10.7 A2A 任务周期</p>
</div>
<p>该机制使智能体可以进行任务协商、进度跟踪和异常处理。</p>
<p>A2A 请求生命周期是一个序列，详细说明了请求遵循的四个主要步骤：代理发现、身份验证、发送消息 API 和发送消息流 API。下图 10.8 借鉴了官网的流程图，用来展示了操作流程，说明了客户端、A2A 服务器和身份验证服务器之间的交互。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-8.png" alt="" width="85%">
  <p>图 10.8 A2A 请求生命周期</p>
</div>
<h3>10.3.2 使用 A2A 协议实战</h3>
<p>A2A 现有实现大部分为<code>Sample Code</code>，并且即使有 Python 的实现也较为繁琐，因此这里我们只采用模拟协议思想的方式，通过 A2A-SDK 来继承部分功能实现。</p>
<p><strong>（2）创建简单的 A2A 智能体</strong></p>
<p>让我们创建一个 A2A 的智能体，同样是计算器案例作为演示：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols<span class="token punctuation">.</span>a2a<span class="token punctuation">.</span>implementation <span class="token keyword">import</span> A2AServer<span class="token punctuation">,</span> A2A_AVAILABLE
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">def</span> <span class="token function">create_calculator_agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    <span class="token triple-quoted-string string">"""创建一个计算器智能体"""</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword">if</span> <span class="token keyword">not</span> A2A_AVAILABLE<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"❌ A2A SDK 未安装，请运行: pip install a2a-sdk"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">        <span class="token keyword">return</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"🧮 创建计算器智能体"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token comment"># 创建 A2A 服务器</span>
</span><span class="code-line line-number" line="12">    calculator <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="13">        name<span class="token operator">=</span><span class="token string">"calculator-agent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        description<span class="token operator">=</span><span class="token string">"专业的数学计算智能体"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">        version<span class="token operator">=</span><span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        capabilities<span class="token operator">=</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">            <span class="token string">"math"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"addition"</span><span class="token punctuation">,</span> <span class="token string">"subtraction"</span><span class="token punctuation">,</span> <span class="token string">"multiplication"</span><span class="token punctuation">,</span> <span class="token string">"division"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">            <span class="token string">"advanced"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"power"</span><span class="token punctuation">,</span> <span class="token string">"sqrt"</span><span class="token punctuation">,</span> <span class="token string">"factorial"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="19">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="20">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token comment"># 添加基础计算技能</span>
</span><span class="code-line line-number" line="23">    <span class="token decorator annotation punctuation">@calculator<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"add"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">    <span class="token keyword">def</span> <span class="token function">add_numbers</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="25">        <span class="token triple-quoted-string string">"""加法计算"""</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="27">            <span class="token comment"># 简单解析 "计算 5 + 3" 格式</span>
</span><span class="code-line line-number" line="28">            parts <span class="token operator">=</span> query<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"计算"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"加"</span><span class="token punctuation">,</span> <span class="token string">"+"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"加上"</span><span class="token punctuation">,</span> <span class="token string">"+"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">            <span class="token keyword">if</span> <span class="token string">"+"</span> <span class="token keyword">in</span> parts<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="30">                numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> parts<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"+"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="31">                result <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>numbers<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"计算结果: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">' + '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> numbers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="33">            <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="34">                <span class="token keyword">return</span> <span class="token string">"请使用格式: 计算 5 + 3"</span>
</span><span class="code-line line-number" line="35">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="36">            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"计算错误: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38">    <span class="token decorator annotation punctuation">@calculator<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"multiply"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">    <span class="token keyword">def</span> <span class="token function">multiply_numbers</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="40">        <span class="token triple-quoted-string string">"""乘法计算"""</span>
</span><span class="code-line line-number" line="41">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="42">            parts <span class="token operator">=</span> query<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"计算"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"乘以"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"×"</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">            <span class="token keyword">if</span> <span class="token string">"*"</span> <span class="token keyword">in</span> parts<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="44">                numbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> parts<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="45">                result <span class="token operator">=</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="46">                <span class="token keyword">for</span> num <span class="token keyword">in</span> numbers<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="47">                    result <span class="token operator">*=</span> num
</span><span class="code-line line-number" line="48">                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"计算结果: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">' × '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">,</span> numbers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="49">            <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="50">                <span class="token keyword">return</span> <span class="token string">"请使用格式: 计算 5 * 3"</span>
</span><span class="code-line line-number" line="51">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="52">            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"计算错误: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="53">
</span><span class="code-line line-number" line="54">    <span class="token decorator annotation punctuation">@calculator<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"info"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="55">    <span class="token keyword">def</span> <span class="token function">get_info</span><span class="token punctuation">(</span>query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="56">        <span class="token triple-quoted-string string">"""获取智能体信息"""</span>
</span><span class="code-line line-number" line="57">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"我是 </span><span class="token interpolation"><span class="token punctuation">{</span>calculator<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">，可以进行基础数学计算。支持的技能: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>skills<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="58">
</span><span class="code-line line-number" line="59">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 计算器智能体创建成功，支持技能: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">list</span><span class="token punctuation">(</span>calculator<span class="token punctuation">.</span>skills<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="60">    <span class="token keyword">return</span> calculator
</span><span class="code-line line-number" line="61">
</span><span class="code-line line-number" line="62"><span class="token comment"># 创建智能体</span>
</span><span class="code-line line-number" line="63">calc_agent <span class="token operator">=</span> create_calculator_agent<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="64"><span class="token keyword">if</span> calc_agent<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="65">    <span class="token comment"># 测试技能</span>
</span><span class="code-line line-number" line="66">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n🧪 测试智能体技能:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="67">    test_queries <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="68">        <span class="token string">"获取信息"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="69">        <span class="token string">"计算 10 + 5"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="70">        <span class="token string">"计算 6 * 7"</span>
</span><span class="code-line line-number" line="71">    <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="72">
</span><span class="code-line line-number" line="73">    <span class="token keyword">for</span> query <span class="token keyword">in</span> test_queries<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="74">        <span class="token keyword">if</span> <span class="token string">"信息"</span> <span class="token keyword">in</span> query<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="75">            result <span class="token operator">=</span> calc_agent<span class="token punctuation">.</span>skills<span class="token punctuation">[</span><span class="token string">"info"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="76">        <span class="token keyword">elif</span> <span class="token string">"+"</span> <span class="token keyword">in</span> query<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="77">            result <span class="token operator">=</span> calc_agent<span class="token punctuation">.</span>skills<span class="token punctuation">[</span><span class="token string">"add"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="78">        <span class="token keyword">elif</span> <span class="token string">"*"</span> <span class="token keyword">in</span> query <span class="token keyword">or</span> <span class="token string">"×"</span> <span class="token keyword">in</span> query<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="79">            result <span class="token operator">=</span> calc_agent<span class="token punctuation">.</span>skills<span class="token punctuation">[</span><span class="token string">"multiply"</span><span class="token punctuation">]</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="80">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="81">            result <span class="token operator">=</span> <span class="token string">"未知查询类型"</span>
</span><span class="code-line line-number" line="82">
</span><span class="code-line line-number" line="83">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  📝 查询: </span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="84">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  🤖 回复: </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="85">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（2）自定义 A2A 智能体</strong></p>
<p>你也可以创建自己的 A2A 智能体，这里只是进行简单演示：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols<span class="token punctuation">.</span>a2a<span class="token punctuation">.</span>implementation <span class="token keyword">import</span> A2AServer<span class="token punctuation">,</span> A2A_AVAILABLE
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">def</span> <span class="token function">create_custom_agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    <span class="token triple-quoted-string string">"""创建自定义智能体"""</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword">if</span> <span class="token keyword">not</span> A2A_AVAILABLE<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="6">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"请先安装 A2A SDK: pip install a2a-sdk"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">        <span class="token keyword">return</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">    <span class="token comment"># 创建智能体</span>
</span><span class="code-line line-number" line="10">    agent <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="11">        name<span class="token operator">=</span><span class="token string">"my-custom-agent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">        description<span class="token operator">=</span><span class="token string">"我的自定义智能体"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        capabilities<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"custom"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"skill1"</span><span class="token punctuation">,</span> <span class="token string">"skill2"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16">    <span class="token comment"># 添加技能</span>
</span><span class="code-line line-number" line="17">    <span class="token decorator annotation punctuation">@agent<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"greet"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">    <span class="token keyword">def</span> <span class="token function">greet_user</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">        <span class="token triple-quoted-string string">"""问候用户"""</span>
</span><span class="code-line line-number" line="20">        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"你好，</span><span class="token interpolation"><span class="token punctuation">{</span>name<span class="token punctuation">}</span></span><span class="token string">！我是自定义智能体。"</span></span>
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22">    <span class="token decorator annotation punctuation">@agent<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"calculate"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    <span class="token keyword">def</span> <span class="token function">simple_calculate</span><span class="token punctuation">(</span>expression<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        <span class="token triple-quoted-string string">"""简单计算"""</span>
</span><span class="code-line line-number" line="25">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="26">            <span class="token comment"># 安全的计算（仅支持基本运算）</span>
</span><span class="code-line line-number" line="27">            allowed_chars <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token string">'0123456789+-*/(). '</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">            <span class="token keyword">if</span> <span class="token builtin">all</span><span class="token punctuation">(</span>c <span class="token keyword">in</span> allowed_chars <span class="token keyword">for</span> c <span class="token keyword">in</span> expression<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">                result <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>expression<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"计算结果: </span><span class="token interpolation"><span class="token punctuation">{</span>expression<span class="token punctuation">}</span></span><span class="token string"> = </span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="31">            <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">                <span class="token keyword">return</span> <span class="token string">"错误: 只支持基本数学运算"</span>
</span><span class="code-line line-number" line="33">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="34">            <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"计算错误: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="35">
</span><span class="code-line line-number" line="36">    <span class="token keyword">return</span> agent
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38"><span class="token comment"># 创建并测试自定义智能体</span>
</span><span class="code-line line-number" line="39">custom_agent <span class="token operator">=</span> create_custom_agent<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40"><span class="token keyword">if</span> custom_agent<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="41">    <span class="token comment"># 测试技能</span>
</span><span class="code-line line-number" line="42">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"测试问候技能:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">    result1 <span class="token operator">=</span> custom_agent<span class="token punctuation">.</span>skills<span class="token punctuation">[</span><span class="token string">"greet"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">    <span class="token keyword">print</span><span class="token punctuation">(</span>result1<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="45">
</span><span class="code-line line-number" line="46">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n测试计算技能:"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="47">    result2 <span class="token operator">=</span> custom_agent<span class="token punctuation">.</span>skills<span class="token punctuation">[</span><span class="token string">"calculate"</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token string">"10 + 5 * 2"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="48">    <span class="token keyword">print</span><span class="token punctuation">(</span>result2<span class="token punctuation">)</span>
</span></code></pre>
<h3>10.3.3 使用 HelloAgents A2A 工具</h3>
<p>HelloAgents 提供了统一的 A2A 工具接口。</p>
<p><strong>（1）创建 A2A Agent 服务端</strong></p>
<p>首先，让我们创建一个 Agent 服务端：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> A2AServer
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> threading
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 创建研究员Agent服务</span>
</span><span class="code-line line-number" line="5">researcher <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="6">    name<span class="token operator">=</span><span class="token string">"researcher"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">    description<span class="token operator">=</span><span class="token string">"负责搜索和分析资料的Agent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    version<span class="token operator">=</span><span class="token string">"1.0.0"</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 定义技能</span>
</span><span class="code-line line-number" line="12"><span class="token decorator annotation punctuation">@researcher<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"research"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13"><span class="token keyword">def</span> <span class="token function">handle_research</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">    <span class="token triple-quoted-string string">"""处理研究请求"""</span>
</span><span class="code-line line-number" line="15">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="16">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'research\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">    topic <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="18">    
</span><span class="code-line line-number" line="19">    <span class="token comment"># 实际的研究逻辑（这里简化）</span>
</span><span class="code-line line-number" line="20">    result <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">        <span class="token string">"topic"</span><span class="token punctuation">:</span> topic<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">        <span class="token string">"findings"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"关于</span><span class="token interpolation"><span class="token punctuation">{</span>topic<span class="token punctuation">}</span></span><span class="token string">的研究结果..."</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">        <span class="token string">"sources"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"来源1"</span><span class="token punctuation">,</span> <span class="token string">"来源2"</span><span class="token punctuation">,</span> <span class="token string">"来源3"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="24">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="25">    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27"><span class="token comment"># 在后台启动服务</span>
</span><span class="code-line line-number" line="28"><span class="token keyword">def</span> <span class="token function">start_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">    researcher<span class="token punctuation">.</span>run<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">    server_thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>start_server<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">    server_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">    
</span><span class="code-line line-number" line="35">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 研究员Agent服务已启动在 http://localhost:5000"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36">    
</span><span class="code-line line-number" line="37">    <span class="token comment"># 保持程序运行</span>
</span><span class="code-line line-number" line="38">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="39">        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="40">            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="42">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n服务已停止"</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（2）创建 A2A Agent 客户端</strong></p>
<p>现在，让我们创建一个客户端来与服务端通信：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> A2AClient
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 创建客户端连接到研究员Agent</span>
</span><span class="code-line line-number" line="4">client <span class="token operator">=</span> A2AClient<span class="token punctuation">(</span><span class="token string">"http://localhost:5000"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 发送研究请求</span>
</span><span class="code-line line-number" line="7">response <span class="token operator">=</span> client<span class="token punctuation">.</span>execute_skill<span class="token punctuation">(</span><span class="token string">"research"</span><span class="token punctuation">,</span> <span class="token string">"research AI在医疗领域的应用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"收到响应：</span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 输出：</span>
</span><span class="code-line line-number" line="11"><span class="token comment"># 收到响应：{'topic': 'AI在医疗领域的应用', 'findings': '关于AI在医疗领域的应用的研究结果...', 'sources': ['来源1', '来源2', '来源3']}</span>
</span></code></pre>
<p><strong>（3）创建 Agent 网络</strong></p>
<p>对于多个 Agent 的协作，我们可以让多个 Agent 相互连接：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> A2AServer<span class="token punctuation">,</span> A2AClient
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> threading
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> time
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 1. 创建多个Agent服务</span>
</span><span class="code-line line-number" line="6">researcher <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="7">    name<span class="token operator">=</span><span class="token string">"researcher"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    description<span class="token operator">=</span><span class="token string">"研究员"</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token decorator annotation punctuation">@researcher<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"research"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12"><span class="token keyword">def</span> <span class="token function">do_research</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="14">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'research\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">    topic <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="16">    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"topic"</span><span class="token punctuation">:</span> topic<span class="token punctuation">,</span> <span class="token string">"findings"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>topic<span class="token punctuation">}</span></span><span class="token string">的研究结果"</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">
</span><span class="code-line line-number" line="18">writer <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="19">    name<span class="token operator">=</span><span class="token string">"writer"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">    description<span class="token operator">=</span><span class="token string">"撰写员"</span>
</span><span class="code-line line-number" line="21"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23"><span class="token decorator annotation punctuation">@writer<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24"><span class="token keyword">def</span> <span class="token function">write_article</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="25">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="26">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'write\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">    content <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="28">    
</span><span class="code-line line-number" line="29">    <span class="token comment"># 尝试解析研究数据</span>
</span><span class="code-line line-number" line="30">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">        data <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">        topic <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token string">"未知主题"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">        findings <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"findings"</span><span class="token punctuation">,</span> <span class="token string">"无研究结果"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">    <span class="token keyword">except</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="35">        topic <span class="token operator">=</span> <span class="token string">"未知主题"</span>
</span><span class="code-line line-number" line="36">        findings <span class="token operator">=</span> content
</span><span class="code-line line-number" line="37">    
</span><span class="code-line line-number" line="38">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"# </span><span class="token interpolation"><span class="token punctuation">{</span>topic<span class="token punctuation">}</span></span><span class="token string">\n\n基于研究：</span><span class="token interpolation"><span class="token punctuation">{</span>findings<span class="token punctuation">}</span></span><span class="token string">\n\n文章内容..."</span></span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">editor <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="41">    name<span class="token operator">=</span><span class="token string">"editor"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="42">    description<span class="token operator">=</span><span class="token string">"编辑"</span>
</span><span class="code-line line-number" line="43"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">
</span><span class="code-line line-number" line="45"><span class="token decorator annotation punctuation">@editor<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"edit"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46"><span class="token keyword">def</span> <span class="token function">edit_article</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="47">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="48">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'edit\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">    article <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="50">    
</span><span class="code-line line-number" line="51">    result <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="52">        <span class="token string">"article"</span><span class="token punctuation">:</span> article <span class="token operator">+</span> <span class="token string">"\n\n[已编辑优化]"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="53">        <span class="token string">"feedback"</span><span class="token punctuation">:</span> <span class="token string">"文章质量良好"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="54">        <span class="token string">"approved"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
</span><span class="code-line line-number" line="55">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="56">    <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">
</span><span class="code-line line-number" line="58"><span class="token comment"># 2. 启动所有服务</span>
</span><span class="code-line line-number" line="59">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> researcher<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="60">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> writer<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">5001</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="61">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> editor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">5002</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="62">time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 等待服务启动</span>
</span><span class="code-line line-number" line="63">
</span><span class="code-line line-number" line="64"><span class="token comment"># 3. 创建客户端连接到各个Agent</span>
</span><span class="code-line line-number" line="65">researcher_client <span class="token operator">=</span> A2AClient<span class="token punctuation">(</span><span class="token string">"http://localhost:5000"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="66">writer_client <span class="token operator">=</span> A2AClient<span class="token punctuation">(</span><span class="token string">"http://localhost:5001"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="67">editor_client <span class="token operator">=</span> A2AClient<span class="token punctuation">(</span><span class="token string">"http://localhost:5002"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69"><span class="token comment"># 4. 协作流程</span>
</span><span class="code-line line-number" line="70"><span class="token keyword">def</span> <span class="token function">create_content</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="71">    <span class="token comment"># 步骤1：研究</span>
</span><span class="code-line line-number" line="72">    research <span class="token operator">=</span> researcher_client<span class="token punctuation">.</span>execute_skill<span class="token punctuation">(</span><span class="token string">"research"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"research </span><span class="token interpolation"><span class="token punctuation">{</span>topic<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="73">    research_data <span class="token operator">=</span> research<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="74">    
</span><span class="code-line line-number" line="75">    <span class="token comment"># 步骤2：撰写</span>
</span><span class="code-line line-number" line="76">    article <span class="token operator">=</span> writer_client<span class="token punctuation">.</span>execute_skill<span class="token punctuation">(</span><span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"write </span><span class="token interpolation"><span class="token punctuation">{</span>research_data<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="77">    article_content <span class="token operator">=</span> article<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="78">    
</span><span class="code-line line-number" line="79">    <span class="token comment"># 步骤3：编辑</span>
</span><span class="code-line line-number" line="80">    final <span class="token operator">=</span> editor_client<span class="token punctuation">.</span>execute_skill<span class="token punctuation">(</span><span class="token string">"edit"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"edit </span><span class="token interpolation"><span class="token punctuation">{</span>article_content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="81">    <span class="token keyword">return</span> final<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'result'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="82">
</span><span class="code-line line-number" line="83"><span class="token comment"># 使用</span>
</span><span class="code-line line-number" line="84">result <span class="token operator">=</span> create_content<span class="token punctuation">(</span><span class="token string">"AI在医疗领域的应用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="85"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n最终结果：\n</span><span class="token interpolation"><span class="token punctuation">{</span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<h3>10.3.4 在智能体中使用 A2A 工具</h3>
<p>现在让我们看看如何将 A2A 集成到 HelloAgents 的智能体中。</p>
<p><strong>（1）使用 A2ATool 包装器</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> A2ATool
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 假设已经有一个研究员Agent服务运行在 http://localhost:5000</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 创建协调者Agent</span>
</span><span class="code-line line-number" line="11">coordinator <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"协调者"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>llm<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token comment"># 添加A2A工具，连接到研究员Agent</span>
</span><span class="code-line line-number" line="14">researcher_tool <span class="token operator">=</span> A2ATool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="15">    name<span class="token operator">=</span><span class="token string">"researcher"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    description<span class="token operator">=</span><span class="token string">"研究员Agent，可以搜索和分析资料"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    agent_url<span class="token operator">=</span><span class="token string">"http://localhost:5000"</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">coordinator<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>researcher_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21"><span class="token comment"># 协调者可以调用研究员Agent</span>
</span><span class="code-line line-number" line="22">response <span class="token operator">=</span> coordinator<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"请让研究员帮我研究AI在教育领域的应用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23"><span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（2）实战案例：智能客服系统</strong></p>
<p>让我们构建一个完整的智能客服系统，包含三个 Agent：</p>
<ul>
<li><strong>接待员</strong>：分析客户问题类型</li>
<li><strong>技术专家</strong>：回答技术问题</li>
<li><strong>销售顾问</strong>：回答销售问题</li>
</ul>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> A2ATool
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> A2AServer
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> threading
</span><span class="code-line line-number" line="5"><span class="token keyword">import</span> time
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 1. 创建技术专家Agent服务</span>
</span><span class="code-line line-number" line="12">tech_expert <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="13">    name<span class="token operator">=</span><span class="token string">"tech_expert"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    description<span class="token operator">=</span><span class="token string">"技术专家，回答技术问题"</span>
</span><span class="code-line line-number" line="15"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17"><span class="token decorator annotation punctuation">@tech_expert<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"answer"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18"><span class="token keyword">def</span> <span class="token function">answer_tech_question</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="20">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'answer\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">    question <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="22">    <span class="token comment"># 实际应用中，这里会调用LLM或知识库</span>
</span><span class="code-line line-number" line="23">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"技术回答：关于'</span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">'，我建议您查看我们的技术文档..."</span></span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token comment"># 2. 创建销售顾问Agent服务</span>
</span><span class="code-line line-number" line="26">sales_advisor <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="27">    name<span class="token operator">=</span><span class="token string">"sales_advisor"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="28">    description<span class="token operator">=</span><span class="token string">"销售顾问，回答销售问题"</span>
</span><span class="code-line line-number" line="29"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31"><span class="token decorator annotation punctuation">@sales_advisor<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"answer"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32"><span class="token keyword">def</span> <span class="token function">answer_sales_question</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="33">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="34">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'answer\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">    question <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="36">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"销售回答：关于'</span><span class="token interpolation"><span class="token punctuation">{</span>question<span class="token punctuation">}</span></span><span class="token string">'，我们有特别优惠..."</span></span>
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38"><span class="token comment"># 3. 启动服务</span>
</span><span class="code-line line-number" line="39">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> tech_expert<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> sales_advisor<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">6001</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43"><span class="token comment"># 4. 创建接待员Agent（使用HelloAgents的SimpleAgent）</span>
</span><span class="code-line line-number" line="44">receptionist <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="45">    name<span class="token operator">=</span><span class="token string">"接待员"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="46">    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="47">    system_prompt<span class="token operator">=</span><span class="token triple-quoted-string string">"""你是客服接待员，负责：
</span></span><span class="code-line line-number" line="48"><span class="token triple-quoted-string string">1. 分析客户问题类型（技术问题 or 销售问题）
</span></span><span class="code-line line-number" line="49"><span class="token triple-quoted-string string">2. 将问题转发给相应的专家
</span></span><span class="code-line line-number" line="50"><span class="token triple-quoted-string string">3. 整理专家的回答并返回给客户
</span></span><span class="code-line line-number" line="51"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="52"><span class="token triple-quoted-string string">请保持礼貌和专业。"""</span>
</span><span class="code-line line-number" line="53"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="54">
</span><span class="code-line line-number" line="55"><span class="token comment"># 添加技术专家工具</span>
</span><span class="code-line line-number" line="56">tech_tool <span class="token operator">=</span> A2ATool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="57">    agent_url<span class="token operator">=</span><span class="token string">"http://localhost:6000"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="58">    name<span class="token operator">=</span><span class="token string">"tech_expert"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="59">    description<span class="token operator">=</span><span class="token string">"技术专家，回答技术相关问题"</span>
</span><span class="code-line line-number" line="60"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="61">receptionist<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>tech_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="62">
</span><span class="code-line line-number" line="63"><span class="token comment"># 添加销售顾问工具</span>
</span><span class="code-line line-number" line="64">sales_tool <span class="token operator">=</span> A2ATool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="65">    agent_url<span class="token operator">=</span><span class="token string">"http://localhost:6001"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="66">    name<span class="token operator">=</span><span class="token string">"sales_advisor"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="67">    description<span class="token operator">=</span><span class="token string">"销售顾问，回答价格、购买相关问题"</span>
</span><span class="code-line line-number" line="68"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="69">receptionist<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>sales_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="70">
</span><span class="code-line line-number" line="71"><span class="token comment"># 5. 处理客户咨询</span>
</span><span class="code-line line-number" line="72"><span class="token keyword">def</span> <span class="token function">handle_customer_query</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="73">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n客户咨询：</span><span class="token interpolation"><span class="token punctuation">{</span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="74">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="75">    response <span class="token operator">=</span> receptionist<span class="token punctuation">.</span>run<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="76">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n客服回复：</span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="77">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="78">
</span><span class="code-line line-number" line="79"><span class="token comment"># 测试不同类型的问题</span>
</span><span class="code-line line-number" line="80"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="81">    handle_customer_query<span class="token punctuation">(</span><span class="token string">"你们的API如何调用？"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="82">    handle_customer_query<span class="token punctuation">(</span><span class="token string">"企业版的价格是多少？"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="83">    handle_customer_query<span class="token punctuation">(</span><span class="token string">"如何集成到我的Python项目中？"</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（3）高级用法：Agent 间协商</strong></p>
<p>A2A 协议还支持 Agent 间的协商机制：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> A2AServer<span class="token punctuation">,</span> A2AClient
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> threading
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> time
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># 创建两个需要协商的Agent</span>
</span><span class="code-line line-number" line="6">agent1 <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="7">    name<span class="token operator">=</span><span class="token string">"agent1"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">    description<span class="token operator">=</span><span class="token string">"Agent 1"</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token decorator annotation punctuation">@agent1<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"propose"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12"><span class="token keyword">def</span> <span class="token function">handle_proposal</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">    <span class="token triple-quoted-string string">"""处理协商提案"""</span>
</span><span class="code-line line-number" line="14">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="15">    
</span><span class="code-line line-number" line="16">    <span class="token comment"># 解析提案</span>
</span><span class="code-line line-number" line="17">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'propose\s+(.+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">    proposal_str <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">match</span> <span class="token keyword">else</span> text
</span><span class="code-line line-number" line="19">    
</span><span class="code-line line-number" line="20">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">        proposal <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>proposal_str<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">        task <span class="token operator">=</span> proposal<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"task"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">        deadline <span class="token operator">=</span> proposal<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"deadline"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">        
</span><span class="code-line line-number" line="25">        <span class="token comment"># 评估提案</span>
</span><span class="code-line line-number" line="26">        <span class="token keyword">if</span> deadline <span class="token operator">&gt;=</span> <span class="token number">7</span><span class="token punctuation">:</span>  <span class="token comment"># 至少需要7天</span>
</span><span class="code-line line-number" line="27">            result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"accepted"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"接受提案"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="28">        <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="29">            result <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="30">                <span class="token string">"accepted"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="31">                <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"时间太紧"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="32">                <span class="token string">"counter_proposal"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"deadline"</span><span class="token punctuation">:</span> <span class="token number">7</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="33">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="34">        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">    <span class="token keyword">except</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="36">        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"accepted"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"无效的提案格式"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">
</span><span class="code-line line-number" line="38">agent2 <span class="token operator">=</span> A2AServer<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="39">    name<span class="token operator">=</span><span class="token string">"agent2"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="40">    description<span class="token operator">=</span><span class="token string">"Agent 2"</span>
</span><span class="code-line line-number" line="41"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43"><span class="token decorator annotation punctuation">@agent2<span class="token punctuation">.</span>skill</span><span class="token punctuation">(</span><span class="token string">"negotiate"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44"><span class="token keyword">def</span> <span class="token function">negotiate_task</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="45">    <span class="token triple-quoted-string string">"""发起协商"""</span>
</span><span class="code-line line-number" line="46">    <span class="token keyword">import</span> re
</span><span class="code-line line-number" line="47">    
</span><span class="code-line line-number" line="48">    <span class="token comment"># 解析任务和截止日期</span>
</span><span class="code-line line-number" line="49">    <span class="token keyword">match</span> <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r'negotiate\s+task:(.+?)\s+deadline:(\d+)'</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>IGNORECASE<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="50">    <span class="token keyword">if</span> <span class="token keyword">match</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="51">        task <span class="token operator">=</span> <span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="52">        deadline <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token keyword">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="53">        
</span><span class="code-line line-number" line="54">        <span class="token comment"># 向agent1发送提案</span>
</span><span class="code-line line-number" line="55">        proposal <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"task"</span><span class="token punctuation">:</span> task<span class="token punctuation">,</span> <span class="token string">"deadline"</span><span class="token punctuation">:</span> deadline<span class="token punctuation">}</span>
</span><span class="code-line line-number" line="56">        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"negotiating"</span><span class="token punctuation">,</span> <span class="token string">"proposal"</span><span class="token punctuation">:</span> proposal<span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="58">        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"status"</span><span class="token punctuation">:</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"无效的协商请求"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="59">
</span><span class="code-line line-number" line="60"><span class="token comment"># 启动服务</span>
</span><span class="code-line line-number" line="61">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> agent1<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">7000</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="62">threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token keyword">lambda</span><span class="token punctuation">:</span> agent2<span class="token punctuation">.</span>run<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">7001</span><span class="token punctuation">)</span><span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<h2>10.4 ANP 协议实战</h2>
<p>在 MCP 协议解决了工具调用、A2A 协议解决点对点智能体协作之后，ANP 协议则专注于解决大规模、开放网络环境下的智能体管理问题。</p>
<p>在 10.2 和 10.3 节中，我们学习了 MCP（工具访问）和 A2A（智能体协作）。现在，让我们学习 ANP（Agent Network Protocol）协议，它专注于构建<strong>大规模、开放的智能体网络</strong>。</p>
<h3>10.4.1 协议目标</h3>
<p>当一个网络中存在大量功能各异的智能体（例如，自然语言处理、图像识别、数据分析等）时，系统会面临一系列挑战：</p>
<ul>
<li><strong>服务发现</strong>：当新任务到达时，如何快速找到能够处理该任务的智能体？</li>
<li><strong>智能路由</strong>：如果多个智能体都能处理同一任务，如何选择最合适的一个（如根据负载、成本等）并向其分派任务？</li>
<li><strong>动态扩展</strong>：如何让新加入网络的智能体被其他成员发现和调用？</li>
</ul>
<p>ANP 的设计目标就是提供一套标准化的机制，来解决上述的服务发现、路由选择和网络扩展性问题。</p>
<p>为实现其设计目标，ANP 定义了以下几个核心概念，如表 10.8 所示：</p>
<div align="center">
  <p>表 10.8 ANP 核心概念</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-table-8.png" alt="" width="85%">
</div>
<p>我们同样借用官方的<a href="https://github.com/agent-network-protocol/AgentNetworkProtocol/blob/main/docs/chinese/ANP%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97.md">入门指南</a>来介绍 ANP 的架构设计，如图 10.9 所示</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-9.png" alt="" width="85%">
  <p>图 10.9 ANP 整体流程</p>
</div>
<p>在这个流程图里，主要包括以下几个步骤：</p>
<p><strong>1. 服务的发现与匹配：</strong>首先，智能体 A 通过一个公开的发现服务，基于语义或功能描述进行查询，以定位到符合其任务需求的智能体 B。该发现服务通过预先爬取各智能体对外暴露的标准端点（<code>.well-known/agent-descriptions</code>）来建立索引，从而实现服务需求方与提供方的动态匹配。</p>
<p><strong>2. 基于 DID 的身份验证：</strong>在交互开始时，智能体 A 使用其私钥对包含自身 DID 的请求进行签名。智能体 B 收到后，通过解析该 DID 获取对应的公钥，并以此验证签名的真实性与请求的完整性，从而建立起双方的可信通信。</p>
<p><strong>3. 标准化的服务执行：</strong>身份验证通过后，智能体 B 响应请求，双方依据预定义的标准接口和数据格式进行数据交换或服务调用（如预订、查询等）。标准化的交互流程是实现跨平台、跨系统互操作性的基础。</p>
<p>总而言之，该机制的核心是利用 DID 构建了一个去中心化的信任根基，并借助标准化的描述协议实现了服务的动态发现。这套方法使得智能体能够在无需中央协调的前提下，安全、高效地在互联网上形成协作网络。</p>
<h3>10.4.2 使用 ANP 服务发现</h3>
<p><strong>（1）创建服务发现中心</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> ANPDiscovery<span class="token punctuation">,</span> register_service
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 创建服务发现中心</span>
</span><span class="code-line line-number" line="4">discovery <span class="token operator">=</span> ANPDiscovery<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 注册Agent服务</span>
</span><span class="code-line line-number" line="7">register_service<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="8">    discovery<span class="token operator">=</span>discovery<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    service_id<span class="token operator">=</span><span class="token string">"nlp_agent_1"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    service_name<span class="token operator">=</span><span class="token string">"NLP处理专家A"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    service_type<span class="token operator">=</span><span class="token string">"nlp"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    capabilities<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"text_analysis"</span><span class="token punctuation">,</span> <span class="token string">"sentiment_analysis"</span><span class="token punctuation">,</span> <span class="token string">"ner"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    endpoint<span class="token operator">=</span><span class="token string">"http://localhost:8001"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"load"</span><span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="15"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">register_service<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="18">    discovery<span class="token operator">=</span>discovery<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">    service_id<span class="token operator">=</span><span class="token string">"nlp_agent_2"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">    service_name<span class="token operator">=</span><span class="token string">"NLP处理专家B"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">    service_type<span class="token operator">=</span><span class="token string">"nlp"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">    capabilities<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"text_analysis"</span><span class="token punctuation">,</span> <span class="token string">"translation"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="23">    endpoint<span class="token operator">=</span><span class="token string">"http://localhost:8002"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"load"</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">0.02</span><span class="token punctuation">,</span> <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.1.0"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="25"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"✅ 服务注册完成"</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（2）发现服务</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> discover_service
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 按类型查找</span>
</span><span class="code-line line-number" line="4">nlp_services <span class="token operator">=</span> discover_service<span class="token punctuation">(</span>discovery<span class="token punctuation">,</span> service_type<span class="token operator">=</span><span class="token string">"nlp"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"找到 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>nlp_services<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个NLP服务"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 选择负载最低的服务</span>
</span><span class="code-line line-number" line="8">best_service <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>nlp_services<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"最佳服务：</span><span class="token interpolation"><span class="token punctuation">{</span>best_service<span class="token punctuation">.</span>service_name<span class="token punctuation">}</span></span><span class="token string"> (负载: </span><span class="token interpolation"><span class="token punctuation">{</span>best_service<span class="token punctuation">.</span>metadata<span class="token punctuation">[</span><span class="token string">'load'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（3）构建 Agent 网络</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> ANPNetwork
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment"># 创建网络</span>
</span><span class="code-line line-number" line="4">network <span class="token operator">=</span> ANPNetwork<span class="token punctuation">(</span>network_id<span class="token operator">=</span><span class="token string">"ai_cluster"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 添加节点</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">for</span> service <span class="token keyword">in</span> discovery<span class="token punctuation">.</span>list_all_services<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    network<span class="token punctuation">.</span>add_node<span class="token punctuation">(</span>service<span class="token punctuation">.</span>service_id<span class="token punctuation">,</span> service<span class="token punctuation">.</span>endpoint<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 建立连接（根据能力匹配）</span>
</span><span class="code-line line-number" line="11">network<span class="token punctuation">.</span>connect_nodes<span class="token punctuation">(</span><span class="token string">"nlp_agent_1"</span><span class="token punctuation">,</span> <span class="token string">"nlp_agent_2"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">stats <span class="token operator">=</span> network<span class="token punctuation">.</span>get_network_stats<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 网络构建完成，共 </span><span class="token interpolation"><span class="token punctuation">{</span>stats<span class="token punctuation">[</span><span class="token string">'total_nodes'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> 个节点"</span></span><span class="token punctuation">)</span>
</span></code></pre>
<h3>10.4.3 实战案例</h3>
<p>让我们构建一个完整的分布式任务调度系统：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> ANPDiscovery<span class="token punctuation">,</span> register_service
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>builtin <span class="token keyword">import</span> ANPTool
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> random
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7">load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment"># 1. 创建服务发现中心</span>
</span><span class="code-line line-number" line="11">discovery <span class="token operator">=</span> ANPDiscovery<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token comment"># 2. 注册多个计算节点</span>
</span><span class="code-line line-number" line="14"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">    register_service<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="16">        discovery<span class="token operator">=</span>discovery<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">        service_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"compute_node_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">        service_name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"计算节点</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">        service_type<span class="token operator">=</span><span class="token string">"compute"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        capabilities<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"data_processing"</span><span class="token punctuation">,</span> <span class="token string">"ml_training"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">        endpoint<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"http://node</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">:8000"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">        metadata<span class="token operator">=</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="23">            <span class="token string">"load"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="24">            <span class="token string">"cpu_cores"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">            <span class="token string">"memory_gb"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">            <span class="token string">"gpu"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">        <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="28">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ 注册了 </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>discovery<span class="token punctuation">.</span>list_services<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> 个计算节点"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32"><span class="token comment"># 3. 创建任务调度Agent</span>
</span><span class="code-line line-number" line="33">scheduler <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="34">    name<span class="token operator">=</span><span class="token string">"任务调度器"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="35">    llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">    system_prompt<span class="token operator">=</span><span class="token triple-quoted-string string">"""你是一个智能任务调度器，负责：
</span></span><span class="code-line line-number" line="37"><span class="token triple-quoted-string string">1. 分析任务需求
</span></span><span class="code-line line-number" line="38"><span class="token triple-quoted-string string">2. 选择最合适的计算节点
</span></span><span class="code-line line-number" line="39"><span class="token triple-quoted-string string">3. 分配任务
</span></span><span class="code-line line-number" line="40"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="41"><span class="token triple-quoted-string string">选择节点时考虑：负载、CPU核心数、内存、GPU等因素。"""</span>
</span><span class="code-line line-number" line="42"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44"><span class="token comment"># 添加ANP工具</span>
</span><span class="code-line line-number" line="45">anp_tool <span class="token operator">=</span> ANPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="46">    name<span class="token operator">=</span><span class="token string">"service_discovery"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="47">    description<span class="token operator">=</span><span class="token string">"服务发现工具，可以查找和选择计算节点"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="48">    discovery<span class="token operator">=</span>discovery
</span><span class="code-line line-number" line="49"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="50">scheduler<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>anp_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52"><span class="token comment"># 4. 智能任务分配</span>
</span><span class="code-line line-number" line="53"><span class="token keyword">def</span> <span class="token function">assign_task</span><span class="token punctuation">(</span>task_description<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="54">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n任务：</span><span class="token interpolation"><span class="token punctuation">{</span>task_description<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="55">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="56">
</span><span class="code-line line-number" line="57">    <span class="token comment"># 让Agent智能选择节点</span>
</span><span class="code-line line-number" line="58">    response <span class="token operator">=</span> scheduler<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"""
</span></span></span><span class="code-line line-number" line="59"><span class="token string-interpolation"><span class="token string">    请为以下任务选择最合适的计算节点：
</span></span></span><span class="code-line line-number" line="60"><span class="token string-interpolation"><span class="token string">    </span><span class="token interpolation"><span class="token punctuation">{</span>task_description<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="61"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="62"><span class="token string-interpolation"><span class="token string">    要求：
</span></span></span><span class="code-line line-number" line="63"><span class="token string-interpolation"><span class="token string">    1. 列出所有可用节点
</span></span></span><span class="code-line line-number" line="64"><span class="token string-interpolation"><span class="token string">    2. 分析每个节点的特点
</span></span></span><span class="code-line line-number" line="65"><span class="token string-interpolation"><span class="token string">    3. 选择最合适的节点
</span></span></span><span class="code-line line-number" line="66"><span class="token string-interpolation"><span class="token string">    4. 说明选择理由
</span></span></span><span class="code-line line-number" line="67"><span class="token string-interpolation"><span class="token string">    """</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69">    <span class="token keyword">print</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="70">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="71">
</span><span class="code-line line-number" line="72"><span class="token comment"># 测试不同类型的任务</span>
</span><span class="code-line line-number" line="73">assign_task<span class="token punctuation">(</span><span class="token string">"训练一个大型深度学习模型，需要GPU支持"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="74">assign_task<span class="token punctuation">(</span><span class="token string">"处理大量文本数据，需要高内存"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="75">assign_task<span class="token punctuation">(</span><span class="token string">"运行轻量级数据分析任务"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这是一个负载均衡示例</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> ANPDiscovery<span class="token punctuation">,</span> register_service
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> random
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 创建服务发现中心</span>
</span><span class="code-line line-number" line="5">discovery <span class="token operator">=</span> ANPDiscovery<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 注册多个相同类型的服务</span>
</span><span class="code-line line-number" line="8"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">    register_service<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="10">        discovery<span class="token operator">=</span>discovery<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">        service_id<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"api_server_</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">        service_name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"API服务器</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">        service_type<span class="token operator">=</span><span class="token string">"api"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">        capabilities<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"rest_api"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">        endpoint<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"http://api</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">:8000"</span></span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">        metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"load"</span><span class="token punctuation">:</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.9</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="17">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token comment"># 负载均衡函数</span>
</span><span class="code-line line-number" line="20"><span class="token keyword">def</span> <span class="token function">get_best_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">    <span class="token triple-quoted-string string">"""选择负载最低的服务器"""</span>
</span><span class="code-line line-number" line="22">    servers <span class="token operator">=</span> discovery<span class="token punctuation">.</span>discover_services<span class="token punctuation">(</span>service_type<span class="token operator">=</span><span class="token string">"api"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    <span class="token keyword">if</span> <span class="token keyword">not</span> servers<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="24">        <span class="token keyword">return</span> <span class="token boolean">None</span>
</span><span class="code-line line-number" line="25">
</span><span class="code-line line-number" line="26">    best <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword">lambda</span> s<span class="token punctuation">:</span> s<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"load"</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">    <span class="token keyword">return</span> best
</span><span class="code-line line-number" line="28">
</span><span class="code-line line-number" line="29"><span class="token comment"># 模拟请求分配</span>
</span><span class="code-line line-number" line="30"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="31">    server <span class="token operator">=</span> get_best_server<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"请求 </span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string"> -&gt; </span><span class="token interpolation"><span class="token punctuation">{</span>server<span class="token punctuation">.</span>service_name<span class="token punctuation">}</span></span><span class="token string"> (负载: </span><span class="token interpolation"><span class="token punctuation">{</span>server<span class="token punctuation">.</span>metadata<span class="token punctuation">[</span><span class="token string">'load'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">)"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="33">
</span><span class="code-line line-number" line="34">    <span class="token comment"># 更新负载（模拟）</span>
</span><span class="code-line line-number" line="35">    server<span class="token punctuation">.</span>metadata<span class="token punctuation">[</span><span class="token string">"load"</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">0.1</span>
</span></code></pre>
<h2>10.5 构建自定义 MCP 服务器</h2>
<p>在前面的章节中，我们学习了如何使用现有的 MCP 服务。并且也了解到了不同协议的特点。现在，让我们学习如何构建自己的 MCP 服务器。</p>
<h3>10.5.1 创建你的第一个 MCP 服务器</h3>
<p><strong>（1）为什么要构建自定义 MCP 服务器？</strong></p>
<p>虽然可以直接使用公开的 MCP 服务，但在许多实际应用场景中，需要构建自定义的 MCP 服务器以满足特定需求。</p>
<p>主要动机包括以下几点：</p>
<ul>
<li><strong>封装业务逻辑</strong>：将企业内部特有的业务流程或复杂操作封装为标准化的 MCP 工具，供智能体统一调用。</li>
<li><strong>访问私有数据</strong>：创建一个安全可控的接口或代理，用于访问内部数据库、API 或其他无法对公网暴露的私有数据源。</li>
<li><strong>性能专项优化</strong>：针对高频调用或对响应延迟有严苛要求的应用场景，进行深度优化。</li>
<li><strong>功能定制扩展</strong>：实现标准 MCP 服务未提供的特定功能，例如集成专有算法模型或连接特定的硬件设备。</li>
</ul>
<p><strong>（2）教学案例：天气查询 MCP 服务器</strong></p>
<p>让我们从一个简单的天气查询服务器开始，逐步学习 MCP 服务器开发：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment">#!/usr/bin/env python3</span>
</span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">"""天气查询 MCP 服务器"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="5"><span class="token keyword">import</span> requests
</span><span class="code-line line-number" line="6"><span class="token keyword">import</span> os
</span><span class="code-line line-number" line="7"><span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
</span><span class="code-line line-number" line="8"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> Any
</span><span class="code-line line-number" line="9"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols <span class="token keyword">import</span> MCPServer
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 创建 MCP 服务器</span>
</span><span class="code-line line-number" line="12">weather_server <span class="token operator">=</span> MCPServer<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"weather-server"</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"真实天气查询服务"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">CITY_MAP <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">    <span class="token string">"北京"</span><span class="token punctuation">:</span> <span class="token string">"Beijing"</span><span class="token punctuation">,</span> <span class="token string">"上海"</span><span class="token punctuation">:</span> <span class="token string">"Shanghai"</span><span class="token punctuation">,</span> <span class="token string">"广州"</span><span class="token punctuation">:</span> <span class="token string">"Guangzhou"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    <span class="token string">"深圳"</span><span class="token punctuation">:</span> <span class="token string">"Shenzhen"</span><span class="token punctuation">,</span> <span class="token string">"杭州"</span><span class="token punctuation">:</span> <span class="token string">"Hangzhou"</span><span class="token punctuation">,</span> <span class="token string">"成都"</span><span class="token punctuation">:</span> <span class="token string">"Chengdu"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    <span class="token string">"重庆"</span><span class="token punctuation">:</span> <span class="token string">"Chongqing"</span><span class="token punctuation">,</span> <span class="token string">"武汉"</span><span class="token punctuation">:</span> <span class="token string">"Wuhan"</span><span class="token punctuation">,</span> <span class="token string">"西安"</span><span class="token punctuation">:</span> <span class="token string">"Xi'an"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">    <span class="token string">"南京"</span><span class="token punctuation">:</span> <span class="token string">"Nanjing"</span><span class="token punctuation">,</span> <span class="token string">"天津"</span><span class="token punctuation">:</span> <span class="token string">"Tianjin"</span><span class="token punctuation">,</span> <span class="token string">"苏州"</span><span class="token punctuation">:</span> <span class="token string">"Suzhou"</span>
</span><span class="code-line line-number" line="19"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="20">
</span><span class="code-line line-number" line="21">
</span><span class="code-line line-number" line="22"><span class="token keyword">def</span> <span class="token function">get_weather_data</span><span class="token punctuation">(</span>city<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">    <span class="token triple-quoted-string string">"""从 wttr.in 获取天气数据"""</span>
</span><span class="code-line line-number" line="24">    city_en <span class="token operator">=</span> CITY_MAP<span class="token punctuation">.</span>get<span class="token punctuation">(</span>city<span class="token punctuation">,</span> city<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"https://wttr.in/</span><span class="token interpolation"><span class="token punctuation">{</span>city_en<span class="token punctuation">}</span></span><span class="token string">?format=j1"</span></span>
</span><span class="code-line line-number" line="26">    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">    response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">    current <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"current_condition"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">    <span class="token keyword">return</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="32">        <span class="token string">"city"</span><span class="token punctuation">:</span> city<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="33">        <span class="token string">"temperature"</span><span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span>current<span class="token punctuation">[</span><span class="token string">"temp_C"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="34">        <span class="token string">"feels_like"</span><span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span>current<span class="token punctuation">[</span><span class="token string">"FeelsLikeC"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="35">        <span class="token string">"humidity"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>current<span class="token punctuation">[</span><span class="token string">"humidity"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">        <span class="token string">"condition"</span><span class="token punctuation">:</span> current<span class="token punctuation">[</span><span class="token string">"weatherDesc"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">        <span class="token string">"wind_speed"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>current<span class="token punctuation">[</span><span class="token string">"windspeedKmph"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3.6</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="38">        <span class="token string">"visibility"</span><span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">(</span>current<span class="token punctuation">[</span><span class="token string">"visibility"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="39">        <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="40">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="41">
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43"><span class="token comment"># 定义工具函数</span>
</span><span class="code-line line-number" line="44"><span class="token keyword">def</span> <span class="token function">get_weather</span><span class="token punctuation">(</span>city<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="45">    <span class="token triple-quoted-string string">"""获取指定城市的当前天气"""</span>
</span><span class="code-line line-number" line="46">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="47">        weather_data <span class="token operator">=</span> get_weather_data<span class="token punctuation">(</span>city<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="48">        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>weather_data<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="50">        <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"city"</span><span class="token punctuation">:</span> city<span class="token punctuation">}</span><span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52">
</span><span class="code-line line-number" line="53"><span class="token keyword">def</span> <span class="token function">list_supported_cities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="54">    <span class="token triple-quoted-string string">"""列出所有支持的中文城市"""</span>
</span><span class="code-line line-number" line="55">    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"cities"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>CITY_MAP<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>CITY_MAP<span class="token punctuation">)</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="56">    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="57">
</span><span class="code-line line-number" line="58">
</span><span class="code-line line-number" line="59"><span class="token keyword">def</span> <span class="token function">get_server_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="60">    <span class="token triple-quoted-string string">"""获取服务器信息"""</span>
</span><span class="code-line line-number" line="61">    info <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="62">        <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"Weather MCP Server"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="63">        <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0.0"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="64">        <span class="token string">"tools"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get_weather"</span><span class="token punctuation">,</span> <span class="token string">"list_supported_cities"</span><span class="token punctuation">,</span> <span class="token string">"get_server_info"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="65">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="66">    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>info<span class="token punctuation">,</span> ensure_ascii<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="67">
</span><span class="code-line line-number" line="68">
</span><span class="code-line line-number" line="69"><span class="token comment"># 注册工具到服务器</span>
</span><span class="code-line line-number" line="70">weather_server<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>get_weather<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="71">weather_server<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>list_supported_cities<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="72">weather_server<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>get_server_info<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="73">
</span><span class="code-line line-number" line="74">
</span><span class="code-line line-number" line="75"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="76">    weather_server<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（3）测试自定义 MCP 服务器</strong></p>
<p>然后创建测试脚本：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment">#!/usr/bin/env python3</span>
</span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">"""测试天气查询 MCP 服务器"""</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> asyncio
</span><span class="code-line line-number" line="5"><span class="token keyword">import</span> json
</span><span class="code-line line-number" line="6"><span class="token keyword">import</span> sys
</span><span class="code-line line-number" line="7"><span class="token keyword">import</span> os
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'HelloAgents'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>protocols<span class="token punctuation">.</span>mcp<span class="token punctuation">.</span>client <span class="token keyword">import</span> MCPClient
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">test_weather_server</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">    server_script <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"14_weather_mcp_server.py"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">    client <span class="token operator">=</span> MCPClient<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> server_script<span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">
</span><span class="code-line line-number" line="17">    <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="18">        <span class="token keyword">async</span> <span class="token keyword">with</span> client<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">            <span class="token comment"># 测试1: 获取服务器信息</span>
</span><span class="code-line line-number" line="20">            info <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span><span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"get_server_info"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"服务器: </span><span class="token interpolation"><span class="token punctuation">{</span>info<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> v</span><span class="token interpolation"><span class="token punctuation">{</span>info<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">            <span class="token comment"># 测试2: 列出支持的城市</span>
</span><span class="code-line line-number" line="24">            cities <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span><span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"list_supported_cities"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"支持城市: </span><span class="token interpolation"><span class="token punctuation">{</span>cities<span class="token punctuation">[</span><span class="token string">'count'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> 个"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27">            <span class="token comment"># 测试3: 查询北京天气</span>
</span><span class="code-line line-number" line="28">            weather <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span><span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"get_weather"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"北京"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">            <span class="token keyword">if</span> <span class="token string">"error"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> weather<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="30">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n北京天气: </span><span class="token interpolation"><span class="token punctuation">{</span>weather<span class="token punctuation">[</span><span class="token string">'temperature'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">°C, </span><span class="token interpolation"><span class="token punctuation">{</span>weather<span class="token punctuation">[</span><span class="token string">'condition'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="31">
</span><span class="code-line line-number" line="32">            <span class="token comment"># 测试4: 查询深圳天气</span>
</span><span class="code-line line-number" line="33">            weather <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span><span class="token keyword">await</span> client<span class="token punctuation">.</span>call_tool<span class="token punctuation">(</span><span class="token string">"get_weather"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"city"</span><span class="token punctuation">:</span> <span class="token string">"深圳"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">            <span class="token keyword">if</span> <span class="token string">"error"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> weather<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="35">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"深圳天气: </span><span class="token interpolation"><span class="token punctuation">{</span>weather<span class="token punctuation">[</span><span class="token string">'temperature'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">°C, </span><span class="token interpolation"><span class="token punctuation">{</span>weather<span class="token punctuation">[</span><span class="token string">'condition'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36">
</span><span class="code-line line-number" line="37">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n✅ 所有测试完成！"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="40">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ 测试失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="41">
</span><span class="code-line line-number" line="42">
</span><span class="code-line line-number" line="43"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="44">    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>test_weather_server<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>（4）在 Agent 中使用自定义 MCP 服务器</strong></p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token triple-quoted-string string">"""在 Agent 中使用天气 MCP 服务器"""</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">import</span> os
</span><span class="code-line line-number" line="4"><span class="token keyword">from</span> dotenv <span class="token keyword">import</span> load_dotenv
</span><span class="code-line line-number" line="5"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="6"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">load_dotenv<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token keyword">def</span> <span class="token function">create_weather_assistant</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">    <span class="token triple-quoted-string string">"""创建天气助手"""</span>
</span><span class="code-line line-number" line="13">    llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">    assistant <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="16">        name<span class="token operator">=</span><span class="token string">"天气助手"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">        llm<span class="token operator">=</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">        system_prompt<span class="token operator">=</span><span class="token triple-quoted-string string">"""你是天气助手，可以查询城市天气。
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">使用 get_weather 工具查询天气，支持中文城市名。
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">"""</span>
</span><span class="code-line line-number" line="21">    <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">    <span class="token comment"># 添加天气 MCP 工具</span>
</span><span class="code-line line-number" line="24">    server_script <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"14_weather_mcp_server.py"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25">    weather_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"python"</span><span class="token punctuation">,</span> server_script<span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">    assistant<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>weather_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">    <span class="token keyword">return</span> assistant
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31"><span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="32">    <span class="token triple-quoted-string string">"""演示"""</span>
</span><span class="code-line line-number" line="33">    assistant <span class="token operator">=</span> create_weather_assistant<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="34">
</span><span class="code-line line-number" line="35">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n查询北京天气："</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="36">    response <span class="token operator">=</span> assistant<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"北京今天天气怎么样？"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="37">    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"回答: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">}</span></span><span class="token string">\n"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="38">
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40"><span class="token keyword">def</span> <span class="token function">interactive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="41">    <span class="token triple-quoted-string string">"""交互模式"""</span>
</span><span class="code-line line-number" line="42">    assistant <span class="token operator">=</span> create_weather_assistant<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="43">
</span><span class="code-line line-number" line="44">    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="45">        user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"\n你: "</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="46">        <span class="token keyword">if</span> user_input<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'quit'</span><span class="token punctuation">,</span> <span class="token string">'exit'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="47">            <span class="token keyword">break</span>
</span><span class="code-line line-number" line="48">        response <span class="token operator">=</span> assistant<span class="token punctuation">.</span>run<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"助手: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="50">
</span><span class="code-line line-number" line="51">
</span><span class="code-line line-number" line="52"><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="53">    <span class="token keyword">import</span> sys
</span><span class="code-line line-number" line="54">    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">and</span> sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"demo"</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="55">        demo<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="56">    <span class="token keyword">else</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="57">        interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">🔗 连接到 MCP 服务器...
</span><span class="code-line line-number" line="2">✅ 连接成功！
</span><span class="code-line line-number" line="3">🔌 连接已断开
</span><span class="code-line line-number" line="4">✅ 工具 'mcp_get_weather' 已注册。
</span><span class="code-line line-number" line="5">✅ 工具 'mcp_list_supported_cities' 已注册。
</span><span class="code-line line-number" line="6">✅ 工具 'mcp_get_server_info' 已注册。
</span><span class="code-line line-number" line="7">✅ MCP工具 'mcp' 已展开为 3 个独立工具
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">你: 我想查询北京的天气
</span><span class="code-line line-number" line="10">🔗 连接到 MCP 服务器...
</span><span class="code-line line-number" line="11">✅ 连接成功！
</span><span class="code-line line-number" line="12">🔌 连接已断开
</span><span class="code-line line-number" line="13">助手: 当前北京的天气情况如下：
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">- 温度：10.0°C
</span><span class="code-line line-number" line="16">- 体感温度：9.0°C
</span><span class="code-line line-number" line="17">- 湿度：94%
</span><span class="code-line line-number" line="18">- 天气状况：小雨
</span><span class="code-line line-number" line="19">- 风速：1.7米/秒
</span><span class="code-line line-number" line="20">- 能见度：10.0公里
</span><span class="code-line line-number" line="21">- 时间戳：2025年10月9日 13:46:40
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">请注意携带雨具，并根据天气变化适当调整着装。
</span></code></pre>
<h3>10.5.2 上传 MCP 服务器</h3>
<p>我们创建了一个真实的天气查询 MCP 服务器。现在，让我们将它发布到 Smithery 平台，让全世界的开发者都能使用我们的服务。</p>
<p>（1）什么是 Smithery？</p>
<p><a href="https://smithery.ai/">Smithery</a> 是 MCP 服务器的官方发布平台，类似于 Python 的 PyPI 或 Node.js 的 npm。通过 Smithery，用户可以：</p>
<ul>
<li>🔍 发现和搜索 MCP 服务器</li>
<li>📦 一键安装 MCP 服务器</li>
<li>📊 查看服务器的使用统计和评价</li>
<li>🔄 自动获取服务器更新</li>
</ul>
<p>（2）准备发布
首先，我们需要将项目整理成标准的发布格式，这个文件夹已经在<code>code</code>目录下整理好，可供大家参考：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">weather-mcp-server/
</span><span class="code-line line-number" line="2">├── README.md           # 项目说明文档
</span><span class="code-line line-number" line="3">├── LICENSE            # 开源许可证
</span><span class="code-line line-number" line="4">├── Dockerfile         # Docker 构建配置（推荐）
</span><span class="code-line line-number" line="5">├── pyproject.toml     # Python 项目配置（必需）
</span><span class="code-line line-number" line="6">├── requirements.txt   # Python 依赖
</span><span class="code-line line-number" line="7">├── smithery.yaml      # Smithery 配置文件（必需）
</span><span class="code-line line-number" line="8">└── server.py          # MCP 服务器主文件
</span></code></pre>
<p>需要注意的是，<code>smithery.yaml</code>是 Smithery 平台的配置文件：</p>
<pre class="language-yaml"><code class="language-yaml code-highlight"><span class="code-line line-number" line="1"><span class="token key atrule">name</span><span class="token punctuation">:</span> weather<span class="token punctuation">-</span>mcp<span class="token punctuation">-</span>server
</span><span class="code-line line-number" line="2"><span class="token key atrule">displayName</span><span class="token punctuation">:</span> Weather MCP Server
</span><span class="code-line line-number" line="3"><span class="token key atrule">description</span><span class="token punctuation">:</span> Real<span class="token punctuation">-</span>time weather query MCP server based on HelloAgents framework
</span><span class="code-line line-number" line="4"><span class="token key atrule">version</span><span class="token punctuation">:</span> 1.0.0
</span><span class="code-line line-number" line="5"><span class="token key atrule">author</span><span class="token punctuation">:</span> HelloAgents Team
</span><span class="code-line line-number" line="6"><span class="token key atrule">homepage</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//github.com/yourusername/weather<span class="token punctuation">-</span>mcp<span class="token punctuation">-</span>server
</span><span class="code-line line-number" line="7"><span class="token key atrule">license</span><span class="token punctuation">:</span> MIT
</span><span class="code-line line-number" line="8"><span class="token key atrule">categories</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">  <span class="token punctuation">-</span> weather
</span><span class="code-line line-number" line="10">  <span class="token punctuation">-</span> data
</span><span class="code-line line-number" line="11"><span class="token key atrule">tags</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">  <span class="token punctuation">-</span> weather
</span><span class="code-line line-number" line="13">  <span class="token punctuation">-</span> real<span class="token punctuation">-</span>time
</span><span class="code-line line-number" line="14">  <span class="token punctuation">-</span> helloagents
</span><span class="code-line line-number" line="15">  <span class="token punctuation">-</span> wttr
</span><span class="code-line line-number" line="16"><span class="token key atrule">runtime</span><span class="token punctuation">:</span> container
</span><span class="code-line line-number" line="17"><span class="token key atrule">build</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="18">  <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
</span><span class="code-line line-number" line="19">  <span class="token key atrule">dockerBuildPath</span><span class="token punctuation">:</span> .
</span><span class="code-line line-number" line="20"><span class="token key atrule">startCommand</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="21">  <span class="token key atrule">type</span><span class="token punctuation">:</span> http
</span><span class="code-line line-number" line="22"><span class="token key atrule">tools</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="23">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> get_weather
</span><span class="code-line line-number" line="24">    <span class="token key atrule">description</span><span class="token punctuation">:</span> Get current weather for a city
</span><span class="code-line line-number" line="25">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> list_supported_cities
</span><span class="code-line line-number" line="26">    <span class="token key atrule">description</span><span class="token punctuation">:</span> List all supported cities
</span><span class="code-line line-number" line="27">  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> get_server_info
</span><span class="code-line line-number" line="28">    <span class="token key atrule">description</span><span class="token punctuation">:</span> Get server information
</span></code></pre>
<p>配置说明：</p>
<ul>
<li><code>name</code>: 服务器的唯一标识符（小写，用连字符分隔）</li>
<li><code>displayName</code>: 显示名称</li>
<li><code>description</code>: 简短描述</li>
<li><code>version</code>: 版本号（遵循语义化版本）</li>
<li><code>runtime</code>: 运行时环境（python/node）</li>
<li><code>entrypoint</code>: 入口文件</li>
<li><code>tools</code>: 工具列表</li>
</ul>
<p><code>pyproject.toml</code>是 Python 项目的标准配置文件，Smithery 要求必须包含此文件，因为后续会打包成一个 server：</p>
<pre class="language-toml"><code class="language-toml code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">[</span><span class="token table class-name">build-system</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="2"><span class="token key property">requires</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"setuptools&gt;=61.0"</span><span class="token punctuation">,</span> <span class="token string">"wheel"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="3"><span class="token key property">build-backend</span> <span class="token punctuation">=</span> <span class="token string">"setuptools.build_meta"</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token punctuation">[</span><span class="token table class-name">project</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="6"><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"weather-mcp-server"</span>
</span><span class="code-line line-number" line="7"><span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">"1.0.0"</span>
</span><span class="code-line line-number" line="8"><span class="token key property">description</span> <span class="token punctuation">=</span> <span class="token string">"Real-time weather query MCP server based on HelloAgents framework"</span>
</span><span class="code-line line-number" line="9"><span class="token key property">readme</span> <span class="token punctuation">=</span> <span class="token string">"README.md"</span>
</span><span class="code-line line-number" line="10"><span class="token key property">license</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span><span class="token key property">text</span> <span class="token punctuation">=</span> <span class="token string">"MIT"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11"><span class="token key property">authors</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="12">    <span class="token punctuation">{</span><span class="token key property">name</span> <span class="token punctuation">=</span> <span class="token string">"HelloAgents Team"</span><span class="token punctuation">,</span> <span class="token key property">email</span> <span class="token punctuation">=</span> <span class="token string">"xxx"</span><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="14"><span class="token key property">requires-python</span> <span class="token punctuation">=</span> <span class="token string">"&gt;=3.10"</span>
</span><span class="code-line line-number" line="15"><span class="token key property">dependencies</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="16">    <span class="token string">"hello-agents&gt;=0.2.1"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="17">    <span class="token string">"requests&gt;=2.31.0"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token punctuation">[</span><span class="token table class-name">project.urls</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="21"><span class="token key property">Homepage</span> <span class="token punctuation">=</span> <span class="token string">"https://github.com/yourusername/weather-mcp-server"</span>
</span><span class="code-line line-number" line="22"><span class="token key property">Repository</span> <span class="token punctuation">=</span> <span class="token string">"https://github.com/yourusername/weather-mcp-server"</span>
</span><span class="code-line line-number" line="23"><span class="token key property">"Bug Tracker"</span> <span class="token punctuation">=</span> <span class="token string">"https://github.com/yourusername/weather-mcp-server/issues"</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25"><span class="token punctuation">[</span><span class="token table class-name">tool.setuptools</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="26"><span class="token key property">py-modules</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span>
</span></code></pre>
<p>配置说明：</p>
<ul>
<li><code>[build-system]</code>: 指定构建工具（setuptools）</li>
<li><code>[project]</code>: 项目元数据
<ul>
<li><code>name</code>: 项目名称</li>
<li><code>version</code>: 版本号（遵循语义化版本）</li>
<li><code>dependencies</code>: 项目依赖列表</li>
<li><code>requires-python</code>: Python 版本要求</li>
</ul>
</li>
<li><code>[project.urls]</code>: 项目相关链接</li>
<li><code>[tool.setuptools]</code>: setuptools 配置</li>
</ul>
<p>虽然 Smithery 会自动生成 Dockerfile，但提供自定义 Dockerfile 可以确保部署成功：</p>
<pre class="language-dockerfile"><code class="language-dockerfile code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># Multi-stage build for weather-mcp-server</span>
</span><span class="code-line line-number" line="2"><span class="token instruction"><span class="token keyword">FROM</span> python:3.12-slim-bookworm <span class="token keyword">as</span> base</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># Set working directory</span>
</span><span class="code-line line-number" line="5"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># Install system dependencies</span>
</span><span class="code-line line-number" line="8"><span class="token instruction"><span class="token keyword">RUN</span> apt-get update &amp;&amp; apt-get install -y <span class="token operator">\</span>
</span></span><span class="code-line line-number" line="9"><span class="token instruction">    --no-install-recommends <span class="token operator">\</span>
</span></span><span class="code-line line-number" line="10"><span class="token instruction">    &amp;&amp; rm -rf /var/lib/apt/lists/*</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># Copy project files</span>
</span><span class="code-line line-number" line="13"><span class="token instruction"><span class="token keyword">COPY</span> pyproject.toml requirements.txt ./</span>
</span><span class="code-line line-number" line="14"><span class="token instruction"><span class="token keyword">COPY</span> server.py ./</span>
</span><span class="code-line line-number" line="15">
</span><span class="code-line line-number" line="16"><span class="token comment"># Install Python dependencies</span>
</span><span class="code-line line-number" line="17"><span class="token instruction"><span class="token keyword">RUN</span> pip install --no-cache-dir --upgrade pip &amp;&amp; <span class="token operator">\</span>
</span></span><span class="code-line line-number" line="18"><span class="token instruction">    pip install --no-cache-dir -r requirements.txt</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20"><span class="token comment"># Set environment variables</span>
</span><span class="code-line line-number" line="21"><span class="token instruction"><span class="token keyword">ENV</span> PYTHONUNBUFFERED=1</span>
</span><span class="code-line line-number" line="22"><span class="token instruction"><span class="token keyword">ENV</span> PORT=8081</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24"><span class="token comment"># Expose port (Smithery uses 8081)</span>
</span><span class="code-line line-number" line="25"><span class="token instruction"><span class="token keyword">EXPOSE</span> 8081</span>
</span><span class="code-line line-number" line="26">
</span><span class="code-line line-number" line="27"><span class="token comment"># Health check</span>
</span><span class="code-line line-number" line="28"><span class="token instruction"><span class="token keyword">HEALTHCHECK</span> <span class="token options"><span class="token property">--interval</span><span class="token punctuation">=</span><span class="token string">30s</span> <span class="token property">--timeout</span><span class="token punctuation">=</span><span class="token string">3s</span> <span class="token property">--start-period</span><span class="token punctuation">=</span><span class="token string">5s</span> <span class="token property">--retries</span><span class="token punctuation">=</span><span class="token string">3</span></span> <span class="token operator">\</span>
</span></span><span class="code-line line-number" line="29"><span class="token instruction">    <span class="token keyword">CMD</span> python -c <span class="token string">"import sys; sys.exit(0)"</span></span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31"><span class="token comment"># Run the MCP server</span>
</span><span class="code-line line-number" line="32"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"python"</span>, <span class="token string">"server.py"</span>]</span>
</span></code></pre>
<p>Dockerfile 配置说明：</p>
<ul>
<li><strong>基础镜像</strong>: <code>python:3.12-slim-bookworm</code> - 轻量级 Python 镜像</li>
<li><strong>工作目录</strong>: <code>/app</code> - 应用程序根目录</li>
<li><strong>端口</strong>: <code>8081</code> - Smithery 平台标准端口</li>
<li><strong>启动命令</strong>: <code>python server.py</code> - 运行 MCP 服务器</li>
</ul>
<p>在这里，我们需要 Fork<code>hello-agents</code>仓库，得到<code>code</code>中的源码，并使用自己的 github 创建一个名为<code>weather-mcp-server</code>的仓库，将<code>yourusername</code>改为自己 github 的 Username。</p>
<p>（3）提交到 Smithery</p>
<p>打开浏览器，访问 <a href="https://smithery.ai/">https://smithery.ai/</a>。使用 GitHub 账号登录 Smithery。点击页面上的 "Publish Server" 按钮，输入你的 GitHub 仓库 URL：<code>https://github.com/yourusername/weather-mcp-server</code>，即可等待发布。</p>
<p>一旦发布完成，可以看到类似这样的页面，如图 10.10 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-10.png" alt="" width="85%">
  <p>图 10.10 Smithery 发布成功页面 </p>
</div>
<p>一旦服务器发布成功，用户可以通过以下方式使用：</p>
<p>方式 1：通过 Smithery CLI</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 安装 Smithery CLI</span>
</span><span class="code-line line-number" line="2"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-g</span> @smithery/cli
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 安装你的服务器</span>
</span><span class="code-line line-number" line="5">smithery <span class="token function">install</span> weather-mcp-server
</span></code></pre>
<p>方式 2：在 Claude Desktop 中配置</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"mcpServers"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token property">"weather"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">      <span class="token property">"command"</span><span class="token operator">:</span> <span class="token string">"smithery"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">      <span class="token property">"args"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"weather-mcp-server"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="6">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="7">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">}</span>
</span></code></pre>
<p>方式 3：在 HelloAgents 中使用</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents <span class="token keyword">import</span> SimpleAgent<span class="token punctuation">,</span> HelloAgentsLLM
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>builtin<span class="token punctuation">.</span>protocol_tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"天气助手"</span><span class="token punctuation">,</span> llm<span class="token operator">=</span>HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 使用 Smithery 安装的服务器</span>
</span><span class="code-line line-number" line="7">weather_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="8">    server_command<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"smithery"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"weather-mcp-server"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="9"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>weather_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12">response <span class="token operator">=</span> agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token string">"北京今天天气怎么样？"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>当然，这里只是举例，还有更多的用法可以自行探索，下图 10.11 展示了当 MCP 工具发布成功会包含的信息，显示服务的名称“天气”，其唯一标识符 <code>@jjyaoao/weather-mcp-server</code>，以及状态信息。Tools 区域就是我们刚刚实现的方法，Connect 区则提供了连接和使用此服务所需的技术信息，包括服务的<strong>接入 URL 地址</strong>和多种语言/环境下的<strong>配置代码片段</strong>。如果想要更加深入了解可以点击这个<a href="https://smithery.ai/server/@jjyaoao/weather-mcp-server">链接</a>。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/10-figures/10-11.png" alt="" width="85%">
  <p>图 10.11 Smithery 发布成功的 MCP 工具 </p>
</div>
<p>现在是时候去创造你的 MCP 服务器了！</p>
<h2>10.6 本章总结</h2>
<p>本章系统性地介绍了智能体通信的三种核心协议：MCP、A2A 与 ANP，并探讨了它们的设计理念、应用场景与实践方法。</p>
<p><strong>协议定位：</strong></p>
<ul>
<li><strong>MCP (Model Context Protocol)</strong>: 作为智能体与工具之间的桥梁，提供统一的工具访问接口，适用于增强单个智能体的能力。</li>
<li><strong>A2A (Agent-to-Agent Protocol)</strong>: 作为智能体之间的对话系统，支持直接通信与任务协商，适用于小规模团队的紧密协作。</li>
<li><strong>ANP (Agent Network Protocol)</strong>: 作为智能体的“互联网”，提供服务发现、路由与负载均衡机制，适用于构建大规模、开放的智能体网络。</li>
</ul>
<p><strong>HelloAgents 的集成方案</strong></p>
<p>在<code>HelloAgents</code>框架中，这三种协议被统一抽象为工具（Tool），实现了无缝集成，允许开发者灵活地为智能体添加不同层级的通信能力：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 统一的Tool接口</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool<span class="token punctuation">,</span> A2ATool<span class="token punctuation">,</span> ANPTool
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 所有协议都可以作为Tool添加到Agent</span>
</span><span class="code-line line-number" line="5">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>MCPTool<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>A2ATool<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>ANPTool<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>实战经验总结</strong></p>
<ul>
<li>优先利用成熟的社区 MCP 服务，以减少不必要的重复开发。</li>
<li>根据系统规模选择合适的协议：小规模协作场景推荐使用 A2A，大规模网络场景则应采用 ANP。</li>
</ul>
<p>完成本章后，建议你：</p>
<ol>
<li><strong>动手实践</strong>：
<ul>
<li>构建自己的 MCP 服务器</li>
<li>利用协议创建多 Agent 协作系统</li>
<li>MCP、A2A 与 ANP 的组合应用策略</li>
</ul>
</li>
<li><strong>深入学习</strong>：
<ul>
<li>阅读 MCP 官方文档：<a href="https://modelcontextprotocol.io">https://modelcontextprotocol.io</a></li>
<li>阅读 A2A 官方文档：<a href="https://a2a-protocol.org/latest/">https://a2a-protocol.org/latest/</a></li>
<li>阅读 ANP 官方文档：<a href="https://agent-network-protocol.com/guide/">https://agent-network-protocol.com/guide/</a></li>
</ul>
</li>
<li><strong>参与社区</strong>：
<ul>
<li>向社区贡献新的 MCP 服务</li>
<li>分享个人开发的智能体实现案例</li>
<li>参与相关协议的技术标准讨论，也可以在 Issue 提问或是直接帮助 Helloagents 支持新的 example 案例</li>
</ul>
</li>
</ol>
<p><strong>恭喜你完成第十章的学习！</strong></p>
<p>你现在已经掌握了智能体通信协议的核心知识。继续加油！🚀</p>
<h2>习题</h2>
<blockquote>
<p><strong>提示</strong>：部分习题没有标准答案，重点在于培养学习者对智能体通信协议的综合理解和实践能力。</p>
</blockquote>
<ol>
<li>
<p>本章介绍了三种智能体通信协议：MCP、A2A 和 ANP。请分析：</p>
<ul>
<li>在 10.1.2 节中对比了三种协议的设计理念。请深入分析：为什么 MCP 强调"上下文共享"，A2A 强调"对话式协作"，而 ANP 强调"网络拓扑"？这些设计理念分别解决了什么核心问题？</li>
<li>假设你要构建一个"智能客服系统"，需要以下功能：（1）访问客户数据库和订单系统；（2）多个专业客服智能体协作处理复杂问题；（3）支持大规模并发用户请求。请为每个功能选择最合适的协议，并说明理由。</li>
<li>三种协议是否可以组合使用？请设计一个实际应用场景，展示如何同时使用 MCP、A2A 和 ANP 来构建一个完整的智能体系统。画出系统架构图并说明各协议的职责。</li>
</ul>
</li>
<li>
<p>MCP（Model Context Protocol）是智能体与工具通信的标准协议。基于 10.2 节的内容，请深入思考：</p>
<blockquote>
<p><strong>提示</strong>：这是一道动手实践题，建议实际操作</p>
</blockquote>
<ul>
<li>在 10.2.3 节的 MCP 服务器实现中，我们定义了<code>list_tools</code>、<code>call_tool</code>等核心方法。请扩展这个实现，添加一个新的 MCP 服务器，提供以下工具：（1）数据库查询工具；（2）数据可视化工具；（3）报表生成工具。要求工具之间能够协作完成复杂的数据分析任务。</li>
<li>MCP 协议支持"资源"（Resources）和"提示"（Prompts）两个重要概念，但本章主要聚焦于"工具"（Tools）。请查阅 MCP 官方文档，了解 Resources 和 Prompts 的设计目的，并设计一个应用场景，展示如何利用这三个核心概念构建更强大的智能体系统。</li>
<li>MCP 使用 JSON-RPC 2.0 作为底层通信协议，通过 stdio 进行进程间通信。请分析：这种设计有什么优势和局限性？如果需要支持远程 MCP 服务器（通过 HTTP/WebSocket 访问），应该如何扩展当前的实现？</li>
</ul>
</li>
<li>
<p>A2A（Agent-to-Agent Protocol）支持智能体间的对话式协作。基于 10.3 节的内容，请完成以下扩展实践：</p>
<blockquote>
<p><strong>提示</strong>：这是一道动手实践题，建议实际操作</p>
</blockquote>
<ul>
<li>在 10.3.4 节的"研究团队"案例中，研究员和撰写员通过 A2A 协议协作完成论文写作。请扩展这个案例，添加第三个智能体"审稿人"（Reviewer），它能够评审论文质量并提出修改建议。设计三个智能体之间的协作流程，并实现完整的代码。</li>
<li>A2A 协议定义了<code>task</code>、<code>task_result</code>等消息类型。请分析：如果协作过程中出现冲突（如两个智能体对同一问题有不同意见），应该如何设计冲突解决机制？请扩展 A2A 协议，添加"协商"（negotiation）和"投票"（voting）等消息类型。</li>
<li>对比 A2A 协议与第六章介绍的 AutoGen、CAMEL 等多智能体框架：A2A 作为标准协议，与这些框架的关系是什么？它们能否互相替代？请设计一个方案，让基于 A2A 协议的智能体能够与 AutoGen 框架中的智能体进行通信。</li>
</ul>
</li>
<li>
<p>ANP（Agent Network Protocol）支持大规模智能体网络。基于 10.4 节的内容，请深入分析：</p>
<ul>
<li>在 10.4.2 节中介绍了 ANP 的网络拓扑设计，包括星型、网状、分层等结构。请分析：在什么场景下应该选择哪种拓扑结构？如果网络规模从 10 个智能体扩展到 1000 个智能体，拓扑结构应该如何演进？</li>
<li>ANP 协议支持"路由"（routing）和"发现"（discovery）机制，让智能体能够动态找到合适的协作伙伴。请设计一个"智能路由算法"：根据任务类型、智能体能力、网络负载等因素，自动选择最优的消息路由路径。</li>
<li>在 10.4.4 节的"智能城市"案例中，多个智能体协作管理城市系统。请思考：如果某个关键智能体（如交通管理智能体）出现故障，整个系统应该如何应对？请设计一个"容错机制"，包括故障检测、备份切换、状态恢复等功能。</li>
</ul>
</li>
<li>
<p>智能体通信协议的安全性和隐私保护是实际应用中的关键问题。请思考：</p>
<ul>
<li>在 10.2.4 节的 MCP 客户端实现中，智能体可以调用 MCP 服务器提供的任何工具。请分析：这种设计存在什么安全风险？如果 MCP 服务器提供了危险操作（如删除文件、执行系统命令），应该如何设计权限控制机制？</li>
<li>A2A 和 ANP 协议涉及多个智能体之间的通信，可能包含敏感信息（如用户隐私数据、商业机密）。请设计一个"端到端加密"方案：确保消息在传输过程中不被窃听或篡改，同时支持智能体身份认证和访问控制。</li>
<li>在大规模智能体网络中，恶意智能体可能会发送虚假信息、发起拒绝服务攻击或窃取其他智能体的数据。请设计一个"信任评估系统"：根据智能体的历史行为、协作质量、社区评价等因素，动态评估每个智能体的可信度，并据此调整通信策略。</li>
</ul>
</li>
</ol>
<h2>参考文献</h2>
<p>[1] Anthropic. (2024). <em>Model Context Protocol</em>. Retrieved October 7, 2025, from <a href="https://modelcontextprotocol.io/">https://modelcontextprotocol.io/</a></p>
<p>[2] The A2A Project. (2025). <em>A2A Protocol: An open protocol for agent-to-agent communication</em>. Retrieved October 7, 2025, from <a href="https://a2a-protocol.org/">https://a2a-protocol.org/</a></p>
<p>[3] Chang, G., Lin, E., Yuan, C., Cai, R., Chen, B., Xie, X., &amp; Zhang, Y. (2025). <em>Agent Network Protocol technical white paper</em>. arXiv. <a href="https://doi.org/10.48550/arXiv.2508.00007">https://doi.org/10.48550/arXiv.2508.00007</a></p>