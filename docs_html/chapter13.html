<h1>第十三章 智能旅行助手</h1>
<p>在前面的章节中，我们从零开始构建了 HelloAgents 框架，实现了多种智能体范式、工具系统、记忆机制、协议通信和性能评估等核心功能。从本章开始，我们将进入一个全新的阶段：<strong>将所学知识融会贯通，构建完整的实用应用。</strong></p>
<p>还记得在第一章中，我们构建的第一个智能体吗？那是一个简单的智能旅行助手，展示了<code>Thought-Action-Observation</code>循环的基本原理。本章的智能旅行助手将是一个完整的项目，包含以下核心功能：</p>
<p><strong>（1）智能行程规划</strong>：用户输入目的地、日期、偏好等信息，系统自动生成包含景点、餐饮、酒店的完整行程计划。</p>
<p><strong>（2）地图可视化</strong>：在地图上标注景点位置、绘制游览路线，让行程一目了然。</p>
<p><strong>（3）预算计算</strong>：自动计算门票、酒店、餐饮、交通费用，显示预算明细。</p>
<p><strong>（4）行程编辑</strong>：支持添加、删除、调整景点，实时更新地图。</p>
<p><strong>（5）导出功能</strong>：支持导出为 PDF 或图片，方便保存和分享。</p>
<h2>13.1 项目概述与架构设计</h2>
<h3>13.1.1 为什么需要智能旅行助手</h3>
<p>规划一次旅行是一件既令人兴奋又令人头疼的事情。你需要在网上搜索景点信息，对比不同的攻略，查看天气预报，预订酒店，计算预算，规划路线。这个过程可能需要花费几个小时甚至几天的时间。而且即使花了这么多时间，你也不确定规划的行程是否合理，是否遗漏了什么重要的景点，预算是否准确。</p>
<p>传统的旅行规划方式有几个痛点。首先是<strong>信息分散</strong>。景点信息在旅游网站上，天气信息在天气网站上，酒店信息在预订网站上，你需要在多个网站之间切换，手动整合这些信息。其次是<strong>缺少个性化</strong>。大部分攻略都是通用的，不考虑你的个人偏好、预算限制、出行时间等因素。最后是<strong>难以调整</strong>。当你想修改行程时，可能需要重新规划整个行程，因为景点的顺序、时间安排、预算都是相互关联的。</p>
<p>AI 技术为解决这些问题提供了新的可能。想象一下，你只需要告诉系统"我想去北京玩 3 天，喜欢历史文化，预算中等"，系统就能自动为你生成一个完整的行程计划，包括每天去哪些景点、在哪里吃饭、住哪个酒店、需要多少预算。而且这个计划是可以调整的，你可以删除不喜欢的景点，调整游览顺序，系统会自动更新地图和预算。</p>
<p>这就是我们要构建的智能旅行助手。它不仅仅是一个技术演示，而是一个真正有用的应用。通过这个项目，你会学到如何将 AI 技术应用到实际问题中，如何设计多智能体系统，如何构建完整的 Web 应用。</p>
<h3>13.1.2 技术架构概览</h3>
<p>系统采用经典的<strong>前后端分离架构</strong>，分为四个层次，如图 13.1 所示：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-1.png" alt="" width="85%">
  <p>图 13.1 智能旅行助手技术架构</p>
</div>
<p><strong>（1）前端层 (Vue3+TypeScript)</strong>：负责用户交互和数据展示，包括表单输入、结果展示、地图可视化。</p>
<p><strong>（2）后端层 (FastAPI)</strong>：负责 API 路由、数据验证、业务逻辑。</p>
<p><strong>（3）智能体层 (HelloAgents)</strong>：负责任务分解、工具调用、结果整合。包含 4 个专门的 Agent。</p>
<p><strong>（4）外部服务层</strong>：提供数据和能力，包括高德地图 API、Unsplash API、LLM API。</p>
<p>数据流转过程如下：用户在前端填写表单 → 后端验证数据 → 调用智能体系统 → 智能体依次调用景点搜索、天气查询、酒店推荐、行程规划 Agent → 每个 Agent 通过 MCP 协议调用外部 API → 整合结果返回前端 → 前端渲染展示。</p>
<p>项目的结构参考如下，提供便于定位源码：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">helloagents-trip-planner/
</span><span class="code-line line-number" line="2">├── backend/                    # 后端代码
</span><span class="code-line line-number" line="3">│   ├── app/
</span><span class="code-line line-number" line="4">│   │   ├── agents/            # 智能体实现
</span><span class="code-line line-number" line="5">│   │   ├── api/               # API路由
</span><span class="code-line line-number" line="6">│   │   ├── models/            # 数据模型
</span><span class="code-line line-number" line="7">│   │   ├── services/          # 服务层
</span><span class="code-line line-number" line="8">│   │   └── config.py          # 配置文件
</span><span class="code-line line-number" line="9">│   └── requirements.txt       # Python依赖
</span><span class="code-line line-number" line="10">│
</span><span class="code-line line-number" line="11">└── frontend/                   # 前端代码
</span><span class="code-line line-number" line="12">    ├── src/
</span><span class="code-line line-number" line="13">    │   ├── views/             # 页面组件
</span><span class="code-line line-number" line="14">    │   ├── services/          # API服务
</span><span class="code-line line-number" line="15">    │   ├── types/             # 类型定义
</span><span class="code-line line-number" line="16">    │   └── router/            # 路由配置
</span><span class="code-line line-number" line="17">    └── package.json           # npm依赖
</span></code></pre>
<p>详细的架构设计和数据流转将在后续章节中介绍。</p>
<h3>13.1.3 快速体验：5 分钟运行项目</h3>
<p>在深入学习实现细节之前，让我们先把项目跑起来，看看最终的效果。这样你会对整个系统有一个直观的认识。</p>
<p><strong>环境要求：</strong></p>
<ul>
<li>Python 3.10 或更高版本</li>
<li>Node.js 16.0 或更高版本</li>
<li>npm 8.0 或更高版本</li>
</ul>
<p><strong>获取 API 密钥：</strong></p>
<p>你需要准备以下 API 密钥：</p>
<ul>
<li>LLM 的 API(OpenAI、DeepSeek 等)</li>
<li>高德地图 Web 服务 Key：访问 <a href="https://console.amap.com/">https://console.amap.com/</a> 注册并创建应用</li>
<li>Unsplash Access Key：访问 <a href="https://unsplash.com/developers">https://unsplash.com/developers</a> 注册并创建应用</li>
</ul>
<p>将所有 API 密钥放入<code>.env</code>文件。</p>
<p>启动后端：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 1. 进入后端目录</span>
</span><span class="code-line line-number" line="2"><span class="token builtin class-name">cd</span> helloagents-trip-planner/backend
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 2. 安装依赖</span>
</span><span class="code-line line-number" line="5">pip <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements.txt
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 3. 配置环境变量</span>
</span><span class="code-line line-number" line="8"><span class="token function">cp</span> .env.example .env
</span><span class="code-line line-number" line="9"><span class="token comment"># 编辑.env文件，填入你的API密钥</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11"><span class="token comment"># 4. 启动后端服务</span>
</span><span class="code-line line-number" line="12">uvicorn app.api.main:app <span class="token parameter variable">--reload</span>
</span><span class="code-line line-number" line="13"><span class="token comment"># 或者</span>
</span><span class="code-line line-number" line="14">python run.py
</span></code></pre>
<p>成功启动后，访问 <a href="http://localhost:8000/docs">http://localhost:8000/docs</a> 可以看到 API 文档。</p>
<p>打开新的终端窗口：</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 1. 进入前端目录</span>
</span><span class="code-line line-number" line="2"><span class="token builtin class-name">cd</span> helloagents-trip-planner/frontend
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment"># 2. 安装依赖</span>
</span><span class="code-line line-number" line="5"><span class="token function">npm</span> <span class="token function">install</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token comment"># 3. 启动前端服务</span>
</span><span class="code-line line-number" line="8"><span class="token function">npm</span> run dev
</span></code></pre>
<p>成功启动后，访问 <a href="http://localhost:5173">http://localhost:5173</a> 即可使用应用。</p>
<p>体验核心功能：</p>
<p>首先需在首页表单中填写目的地城市、旅行日期、偏好、预算、交通及住宿类型等信息。点击“开始规划”按钮后，系统会显示加载进度条，并很快生成结果页面，如图 13.2 所示。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-2.png" alt="" width="85%">
  <p>图 13.2 旅行助手规划进行页面</p>
</div>
<p>随后加载成功，该页面会清晰展示行程概览、预算明细、景点地图、每日行程详情和天气信息，如图 13.3，13.4 所示。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-3.png" alt="" width="85%">
  <p>图 13.3 旅行助手规划完成页面</p>
</div>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-4.png" alt="" width="85%">
  <p>图 13.4 旅行助手规划完成页面</p>
</div>
<p>如果用户需要个性化调整，可以点击“编辑行程”按钮，自由调整景点顺序或删除某个景点，如图 13.5 所示。规划完成后，通过“导出行程”下拉菜单，即可将最终方案轻松保存为图片或 PDF 文件，方便随时查阅。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-5.png" alt="" width="85%">
  <p>图 13.5 旅行助手规划完成页面</p>
</div>
<h2>13.2 数据模型设计</h2>
<h3>13.2.1 Web 应用中的数据流转</h3>
<p>在构建智能旅行助手时，我们需要解决一个核心问题：<strong>如何表示和传递旅行计划数据?</strong></p>
<p>我们需要理解一个完整的 Web 应用中数据是如何流转的。想象一下，当用户在浏览器中点击"开始规划"按钮时，会发生什么？</p>
<p>用户在前端填写的表单数据(目的地、日期、预算等)需要通过 HTTP 请求发送到后端服务器。后端接收到数据后，会调用智能体系统进行处理。智能体又会调用高德地图 API、Unsplash API 等外部服务获取数据。这些外部 API 返回的数据格式各不相同，有的用<code>lng</code>，有的用<code>lon</code>，有的用<code>longitude</code>。最后，后端需要将处理好的数据返回给前端，前端再渲染成用户看到的页面。</p>
<p>在这个过程中，数据经历了多次转换：前端表单 → HTTP 请求 → 后端 Python 对象 → 外部 API 响应 → 后端 Python 对象 → HTTP 响应 → 前端 TypeScript 对象 → 页面展示。如果没有统一的数据格式，每一步转换都可能出错。这就是为什么我们需要<strong>数据模型</strong>。</p>
<h3>13.2.2 从字典到 Pydantic 模型</h3>
<p>让我们从第一章的简单原型开始。在那个原型中，我们使用 Python 字典来表示景点数据：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 第一章的做法：使用字典</span>
</span><span class="code-line line-number" line="2">attraction <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"故宫"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    <span class="token string">"location"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"lng"</span><span class="token punctuation">:</span> <span class="token number">116.397128</span><span class="token punctuation">,</span><span class="token string">"lat"</span><span class="token punctuation">:</span> <span class="token number">39.916527</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">60</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment"># 访问数据</span>
</span><span class="code-line line-number" line="9">lng <span class="token operator">=</span> attraction<span class="token punctuation">[</span><span class="token string">"location"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"lng"</span><span class="token punctuation">]</span>
</span></code></pre>
<p>这种方式在原型阶段很方便，但在实际项目中会遇到很多问题。首先是<strong>字段名不统一</strong>的问题。高德地图 API 返回的位置数据是<code>"116.397128，39.916527"</code>这样的字符串，需要手动分割成经纬度。而 Unsplash API 可能使用<code>longitude</code>和<code>latitude</code>。如果我们在代码中到处都用字典，就需要在每个地方都处理这些差异。</p>
<p>其次是<strong>类型安全</strong>的问题。假设我们不小心把<code>price</code>写成了字符串<code>"60"</code>，在 Python 中这不会立即报错，但在计算总预算时就会出问题。更糟糕的是，这种错误只能在运行时才能发现，而且错误信息可能很难定位。</p>
<p>最后是<strong>维护性</strong>的问题。当我们需要给景点添加新字段(比如<code>rating</code>评分)时，需要在代码的多个地方修改。如果遗漏了某个地方，就会导致数据不一致。</p>
<p>Pydantic 提供了一个解决方案。它是 Python 的数据验证库，可以让我们用类来定义数据结构，并自动处理验证、转换和序列化。让我们看一个简单的例子：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span>Field
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">class</span> <span class="token class-name">Location</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    longitude<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"经度"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    latitude<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"纬度"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">
</span><span class="code-line line-number" line="7"><span class="token keyword">class</span> <span class="token class-name">Attraction</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    name<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="9">    location<span class="token punctuation">:</span> Location
</span><span class="code-line line-number" line="10">    ticket_price<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="11">
</span><span class="code-line line-number" line="12"><span class="token comment"># 创建对象</span>
</span><span class="code-line line-number" line="13">attraction <span class="token operator">=</span> Attraction<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="14">    name<span class="token operator">=</span><span class="token string">"故宫"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="15">    location<span class="token operator">=</span>Location<span class="token punctuation">(</span>longitude<span class="token operator">=</span><span class="token number">116.397128</span><span class="token punctuation">,</span>latitude<span class="token operator">=</span><span class="token number">39.916527</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">    ticket_price<span class="token operator">=</span><span class="token number">60</span>
</span><span class="code-line line-number" line="17"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19"><span class="token comment"># 类型安全的访问</span>
</span><span class="code-line line-number" line="20">lng <span class="token operator">=</span> attraction<span class="token punctuation">.</span>location<span class="token punctuation">.</span>longitude  <span class="token comment"># IDE会提供代码补全</span>
</span></code></pre>
<p>这样做有几个好处。首先，如果我们传入了错误的类型(比如把<code>ticket_price</code>设为字符串)，Pydantic 会立即抛出异常，告诉我们哪里出错了。其次，IDE 可以根据类型定义提供代码补全和类型检查，大大减少了拼写错误。最后，当我们需要修改数据结构时，只需要修改类定义，所有使用这个类的地方都会自动更新。</p>
<h3>13.2.3 Pydantic 的核心概念</h3>
<p>在深入设计我们的数据模型之前，让我们先了解 Pydantic 的几个核心概念。Pydantic 的基础是<code>BaseModel</code>类，所有的数据模型都需要继承这个类。每个字段都可以指定类型，Pydantic 会自动进行类型检查和转换。</p>
<p>字段定义使用<code>Field</code>函数，它可以指定默认值、描述、验证规则等。<code>...</code>表示这个字段是必填的，如果创建对象时没有提供这个字段，Pydantic 会抛出异常。我们也可以使用<code>Optional</code>来表示可选字段，或者直接提供默认值。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> BaseModel<span class="token punctuation">,</span>Field
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span>List
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">class</span> <span class="token class-name">Attraction</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="5">    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"景点名称"</span><span class="token punctuation">)</span>  <span class="token comment"># 必填</span>
</span><span class="code-line line-number" line="6">    rating<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>ge<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>le<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">)</span>  <span class="token comment"># 默认值,范围验证</span>
</span><span class="code-line line-number" line="7">    visit_duration<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">60</span><span class="token punctuation">,</span>gt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 大于0</span>
</span><span class="code-line line-number" line="8">    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 可选字段</span>
</span></code></pre>
<p>Pydantic 还支持嵌套模型和列表。我们可以在一个模型中使用另一个模型作为字段类型,这样就可以构建复杂的数据结构。比如，一个景点包含位置信息，一个行程包含多个景点。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">DayPlan</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    date<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="3">    attractions<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Attraction<span class="token punctuation">]</span>  <span class="token comment"># 景点列表</span>
</span><span class="code-line line-number" line="4">    hotel<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Hotel<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 可选的酒店信息</span>
</span></code></pre>
<p>最强大的功能之一是<strong>自定义验证器</strong>。有时候外部 API 返回的数据格式不符合我们的要求，我们可以使用<code>field_validator</code>装饰器来自定义验证和转换逻辑。比如，高德地图返回的温度是<code>"16°C"</code>这样的字符串，我们需要把它转换成数字：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> pydantic <span class="token keyword">import</span> field_validator
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">class</span> <span class="token class-name">WeatherInfo</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    temperature<span class="token punctuation">:</span> <span class="token builtin">int</span>
</span><span class="code-line line-number" line="5">    
</span><span class="code-line line-number" line="6">    <span class="token decorator annotation punctuation">@field_validator</span><span class="token punctuation">(</span><span class="token string">'temperature'</span><span class="token punctuation">,</span>mode<span class="token operator">=</span><span class="token string">'before'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    <span class="token keyword">def</span> <span class="token function">parse_temperature</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">        <span class="token triple-quoted-string string">"""解析温度字符串："16°C" -&gt; 16"""</span>
</span><span class="code-line line-number" line="9">        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="10">            v <span class="token operator">=</span> v<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'°C'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'℃'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">            <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">        <span class="token keyword">return</span> v
</span></code></pre>
<p>这个验证器会在创建对象之前自动执行，将字符串转换成整数。这样我们就不需要在代码的每个地方都手动处理温度格式了。</p>
<h3>13.2.4 自底向上的模型设计</h3>
<p>现在让我们开始设计智能旅行助手的数据模型。一个好的设计原则是<strong>自底向上</strong>：先定义最基础的模型，然后逐步组合成复杂的结构。这样做的好处是每个模型都很简单，容易理解和维护。</p>
<p>最基础的模型是<strong>位置信息</strong>。无论是景点、酒店还是餐厅，都需要位置信息。我们定义一个<code>Location</code>类来表示经纬度坐标：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">Location</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""位置信息(经纬度坐标)"""</span>
</span><span class="code-line line-number" line="3">    longitude<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"经度"</span><span class="token punctuation">,</span>ge<span class="token operator">=</span><span class="token operator">-</span><span class="token number">180</span><span class="token punctuation">,</span>le<span class="token operator">=</span><span class="token number">180</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    latitude<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"纬度"</span><span class="token punctuation">,</span>ge<span class="token operator">=</span><span class="token operator">-</span><span class="token number">90</span><span class="token punctuation">,</span>le<span class="token operator">=</span><span class="token number">90</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这里我们使用了范围验证(<code>ge</code>表示大于等于，<code>le</code>表示小于等于)，确保经纬度的值在合理范围内。</p>
<p>接下来是<strong>景点信息</strong>。一个景点包含名称、地址、位置、游览时间、描述、评分、图片和门票价格等信息。注意我们使用了<code>Location</code>作为字段类型，这就是嵌套模型：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">Attraction</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""景点信息"""</span>
</span><span class="code-line line-number" line="3">    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"景点名称"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    address<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"地址"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    location<span class="token punctuation">:</span> Location <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"经纬度坐标"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    visit_duration<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"建议游览时间(分钟)"</span><span class="token punctuation">,</span>gt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    description<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"景点描述"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">    category<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">"景点"</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"景点类别"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    rating<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>ge<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>le<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"评分"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">    image_url<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"图片URL"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">    ticket_price<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>ge<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"门票价格(元)"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>类似地，我们定义<strong>餐饮信息</strong>和<strong>酒店信息</strong>。这些模型的结构都很相似，都包含名称、地址、位置和费用等基本信息：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">Meal</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""餐饮信息"""</span>
</span><span class="code-line line-number" line="3">    <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"餐饮类型：breakfast/lunch/dinner/snack"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"餐饮名称"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    address<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"地址"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    location<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Location<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"经纬度坐标"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    description<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"描述"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">    estimated_cost<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"预估费用(元)"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token keyword">class</span> <span class="token class-name">Hotel</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="11">    <span class="token triple-quoted-string string">"""酒店信息"""</span>
</span><span class="code-line line-number" line="12">    name<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"酒店名称"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">    address<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"酒店地址"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">    location<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Location<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"酒店位置"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">    price_range<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"价格范围"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">    rating<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"评分"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">    distance<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"距离景点距离"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">    <span class="token builtin">type</span><span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"酒店类型"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">    estimated_cost<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"预估费用(元/晚)"</span><span class="token punctuation">)</span>
</span></code></pre>
<p><strong>预算信息</strong>是一个特殊的模型，它不包含位置信息，而是包含各项费用的汇总：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">Budget</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""预算信息"""</span>
</span><span class="code-line line-number" line="3">    total_attractions<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"景点门票总费用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    total_hotels<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"酒店总费用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    total_meals<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"餐饮总费用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    total_transportation<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"交通总费用"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    total<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"总费用"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>现在我们可以组合这些基础模型，构建<strong>单日行程</strong>。一个单日行程包含日期、描述、交通方式、住宿安排、酒店、景点列表和餐饮列表：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">DayPlan</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""单日行程"""</span>
</span><span class="code-line line-number" line="3">    date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"日期"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    day_index<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"第几天(从0开始)"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    description<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"当日行程描述"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    transportation<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"交通方式"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    accommodation<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"住宿安排"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">    hotel<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Hotel<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"酒店信息"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    attractions<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Attraction<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"景点列表"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">    meals<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Meal<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"餐饮安排"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>注意这里使用了<code>List[Attraction]</code>来表示景点列表，<code>default_factory=list</code>表示默认值是一个空列表。</p>
<p><strong>天气信息</strong>需要特殊处理，因为高德地图返回的温度格式不规范。我们使用自定义验证器来处理：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">WeatherInfo</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""天气信息"""</span>
</span><span class="code-line line-number" line="3">    date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"日期"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    day_weather<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"白天天气"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    night_weather<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"夜间天气"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    day_temp<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"白天温度(摄氏度)"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    night_temp<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"夜间温度(摄氏度)"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">    wind_direction<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"风向"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    wind_power<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"风力"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">    
</span><span class="code-line line-number" line="11">    <span class="token decorator annotation punctuation">@field_validator</span><span class="token punctuation">(</span><span class="token string">'day_temp'</span><span class="token punctuation">,</span><span class="token string">'night_temp'</span><span class="token punctuation">,</span>mode<span class="token operator">=</span><span class="token string">'before'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">def</span> <span class="token function">parse_temperature</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span>v<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">        <span class="token triple-quoted-string string">"""解析温度字符串："16°C" -&gt; 16"""</span>
</span><span class="code-line line-number" line="14">        <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">            v <span class="token operator">=</span> v<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'°C'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'℃'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'°'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">            <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="17">                <span class="token keyword">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">            <span class="token keyword">except</span> ValueError<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="19">                <span class="token keyword">return</span> <span class="token number">0</span>  <span class="token comment"># 容错处理</span>
</span><span class="code-line line-number" line="20">        <span class="token keyword">return</span> v
</span></code></pre>
<p>最后，我们定义<strong>完整的旅行计划</strong>。这是最顶层的模型，包含了所有的信息：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">TripPlan</span><span class="token punctuation">(</span>BaseModel<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token triple-quoted-string string">"""旅行计划"""</span>
</span><span class="code-line line-number" line="3">    city<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"目的地城市"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">    start_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"开始日期"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    end_date<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"结束日期"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">    days<span class="token punctuation">:</span> List<span class="token punctuation">[</span>DayPlan<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"每日行程"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">    weather_info<span class="token punctuation">:</span> List<span class="token punctuation">[</span>WeatherInfo<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default_factory<span class="token operator">=</span><span class="token builtin">list</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"天气信息"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">    overall_suggestions<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"总体建议"</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">    budget<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Budget<span class="token punctuation">]</span> <span class="token operator">=</span> Field<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>description<span class="token operator">=</span><span class="token string">"预算信息"</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这样，我们就完成了整个数据模型的设计。从最基础的<code>Location</code>，到<code>Attraction</code>、<code>Meal</code>、<code>Hotel</code>，再到<code>DayPlan</code>，最后到<code>TripPlan</code>，形成了一个清晰的层次结构。</p>
<h3>13.2.5 数据模型在 Web 应用中的应用</h3>
<p>现在让我们看看这些数据模型如何在实际的 Web 应用中使用。在 FastAPI 中，Pydantic 模型可以直接用作请求和响应的类型定义。FastAPI 会自动进行数据验证、序列化和文档生成。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> app<span class="token punctuation">.</span>models<span class="token punctuation">.</span>schemas <span class="token keyword">import</span> TripPlanRequest<span class="token punctuation">,</span>TripPlan
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/api/trip/plan"</span><span class="token punctuation">,</span>response_model<span class="token operator">=</span>TripPlan<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_trip_plan</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> TripPlanRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TripPlan<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    创建旅行计划
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">    FastAPI自动：
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">    1. 验证请求数据(TripPlanRequest)
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">    2. 验证响应数据(TripPlan)
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">    3. 生成OpenAPI文档
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">    """</span>
</span><span class="code-line line-number" line="16">    trip_plan <span class="token operator">=</span> <span class="token keyword">await</span> generate_trip_plan<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">    <span class="token keyword">return</span> trip_plan
</span></code></pre>
<p>当用户发送 POST 请求到<code>/api/trip/plan</code>时，FastAPI 会自动将 JSON 数据转换成<code>TripPlanRequest</code>对象。如果数据格式不正确(比如缺少必填字段，或者类型不匹配)，FastAPI 会自动返回 400 错误，并告诉用户哪里出错了。</p>
<p>在前端，我们也需要定义对应的 TypeScript 类型。虽然 TypeScript 和 Python 是不同的语言，但数据结构是一样的：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">interface</span> <span class="token class-name">Location</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  longitude<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="3">  latitude<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token keyword">interface</span> <span class="token class-name">Attraction</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="8">  address<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="9">  location<span class="token operator">:</span> Location<span class="token punctuation">;</span>
</span><span class="code-line line-number" line="10">  visit_duration<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="11">  ticket_price<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="12"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token keyword">interface</span> <span class="token class-name">TripPlan</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="15">  city<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="16">  start_date<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="17">  end_date<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="18">  days<span class="token operator">:</span> DayPlan<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line line-number" line="19"><span class="token punctuation">}</span>
</span></code></pre>
<p>这样，前后端就使用了统一的数据格式。当后端返回<code>TripPlan</code>对象时，前端可以直接使用，不需要任何转换。TypeScript 的类型检查也能帮助我们避免很多错误。</p>
<h2>13.3 多智能体协作设计</h2>
<h3>13.3.1 为何需要多智能体</h3>
<p>在第七章中，我们学习了如何使用 SimpleAgent 来构建智能体。SimpleAgent 的设计理念是简单直接：每次调用<code>run()</code>方法时，Agent 会分析用户的问题，决定是否需要调用工具，然后返回结果。这种设计在处理简单任务时非常有效，但当面对旅行规划这样的任务时，就会遇到一些问题。</p>
<p>如果用单个 Agent 来完成旅行规划。这个 Agent 需要做什么呢？首先，它要搜索景点信息，这需要调用高德地图的 POI 搜索工具。然后，它要查询天气信息，这需要调用天气查询工具。接着，它要搜索酒店信息，这又需要调用 POI 搜索工具。最后，它要把所有这些信息整合起来，生成一个完整的旅行计划。</p>
<p>这听起来很简单，但实际操作时会遇到第一个问题：<strong>工具调用的限制</strong>。SimpleAgent 每次<code>run()</code>调用只能执行一个工具。这意味着我们需要多次调用<code>run()</code>方法，每次调用处理一个任务。但这样做会带来一个新问题：如何在多次调用之间传递信息？第一次调用得到的景点信息，如何传递给第二次调用？我们需要手动管理这些中间结果，代码会变得很复杂。</p>
<p>当然，我们可以使用 ReactAgent 来解决这个问题。ReactAgent 可以在一次调用中执行多个工具，它会自动进行多轮思考和行动。但这又带来了新的问题：<strong>时间成本</strong>。ReactAgent 的每一轮思考都需要调用 LLM，如果需要调用三个工具，就需要至少三轮思考，这意味着至少三次 LLM 调用。而且这些调用是串行的，必须等前一个完成才能开始下一个，总时间会很长。</p>
<p>第二个问题是<strong>提示词的复杂度</strong>。如果我们要让一个 Agent 完成所有任务，就需要在提示词中详细描述每个任务的执行逻辑。比如：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">COMPLEX_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""你是旅行规划助手。你需要：
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">1. 使用maps_text_search搜索景点，关键词根据用户偏好确定
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">2. 使用maps_weather查询天气,获取未来几天的天气预报
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">3. 使用maps_text_search搜索酒店,类型根据用户需求确定
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">4. 整合所有信息生成旅行计划,包括每天的景点、餐饮、住宿安排
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">注意：必须按顺序执行,每个工具只能调用一次,输出必须是JSON格式...
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p>这样的提示词有几个问题。首先是<strong>难以维护</strong>。如果我们想修改景点搜索的逻辑(比如增加评分筛选)，就需要修改整个提示词，很容易影响到其他部分。其次是<strong>容易出错</strong>。LLM 需要同时理解多个任务的要求，很容易搞混不同任务的格式和参数。最后是<strong>难以调试</strong>。当生成的计划不符合预期时，我们很难知道是哪个环节出了问题，是景点搜索不准确，还是天气查询失败，还是整合逻辑有问题？</p>
<p>面对这些问题，一个自然的想法是：能不能把复杂的任务分解成多个简单的任务，让不同的 Agent 各司其职？这就是多 Agent 协作的核心思想。</p>
<p>想象一下现实世界中的旅行社。当你去旅行社咨询旅行计划时，不会只有一个人为你服务。通常会有专门的景点顾问，负责推荐景点；有酒店顾问，负责预订酒店；还有行程规划师，负责把所有信息整合成完整的行程。每个人都专注于自己擅长的领域，最后由行程规划师把所有信息汇总。这种分工协作的方式，比让一个人做所有事情要高效得多。</p>
<h3>13.3.2 Agent 角色设计</h3>
<p>基于任务分解原则，我们设计了四个专门的 Agent，如图 13.6 所示:</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-6.png" alt="" width="85%">
  <p>图 13.6 多智能体协作流程</p>
</div>
<ul>
<li>
<p><strong>AttractionSearchAgent(景点搜索专家)</strong>专注于搜索景点信息。它只需要理解用户的偏好(比如"历史文化"、"自然风光")，然后调用高德地图的 POI 搜索工具，返回相关的景点列表。它的提示词很简单，只需要说明如何根据偏好选择关键词，如何调用工具。</p>
</li>
<li>
<p><strong>WeatherQueryAgent(天气查询专家)</strong>专注于查询天气信息。它只需要知道城市名称，然后调用天气查询工具，返回未来几天的天气预报。它的任务非常明确，几乎不会出错。</p>
</li>
<li>
<p><strong>HotelAgent(酒店推荐专家)</strong>专注于搜索酒店信息。它需要理解用户的住宿需求(比如"经济型"、"豪华型")，然后调用 POI 搜索工具，返回符合要求的酒店列表。</p>
</li>
<li>
<p><strong>PlannerAgent(行程规划专家)</strong>负责整合所有信息。它接收前三个 Agent 的输出，加上用户的原始需求(日期、预算等)，然后生成完整的旅行计划。它不需要调用任何外部工具，只需要专注于信息的整合和行程的安排。</p>
</li>
</ul>
<p>现在让我们详细设计每个 Agent 的角色和提示词。设计提示词时，我们需要考虑几个关键问题：这个 Agent 需要什么输入？它应该产生什么输出？它需要调用什么工具？它可能遇到什么问题？</p>
<p><strong>AttractionSearchAgent</strong>的任务是根据用户偏好搜索景点。它的输入是城市名称和用户偏好(比如"历史文化"、"自然风光")。它需要调用<code>amap_maps_text_search</code>工具，参数是关键词和城市。它的输出是景点列表，包含名称、地址、评分等信息。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">ATTRACTION_AGENT_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""你是景点搜索专家。
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">**工具调用格式:**
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">`[TOOL_CALL:amap_maps_text_search:keywords=景点,city=城市名]`
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">**示例:**
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">- `[TOOL_CALL:amap_maps_text_search:keywords=景点,city=北京]`
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">- `[TOOL_CALL:amap_maps_text_search:keywords=博物馆,city=上海]`
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">**重要:**
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">- 必须使用工具搜索,不要编造信息
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">- 根据用户偏好({preferences})搜索{city}的景点
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p>这个提示词很简洁，但包含了所有必要的信息。它明确说明了工具调用的格式，提供了具体的示例，还强调了两个重要原则：必须使用工具(不能编造)，要根据用户偏好搜索。</p>
<p><strong>WeatherQueryAgent</strong>的任务更简单，只需要查询天气。它的输入是城市名称，输出是天气信息。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">WEATHER_AGENT_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""你是天气查询专家。
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">**工具调用格式:**
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">`[TOOL_CALL:amap_maps_weather:city=城市名]`
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">请查询{city}的天气信息。
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>HotelAgent</strong>的任务是搜索酒店。它的输入是城市名称和住宿类型，输出是酒店列表。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">HOTEL_AGENT_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""你是酒店推荐专家。
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">**工具调用格式:**
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">`[TOOL_CALL:amap_maps_text_search:keywords=酒店,city=城市名]`
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">请搜索{city}的{accommodation}酒店。
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p><strong>PlannerAgent</strong>是最复杂的，因为它需要整合所有信息。它的输入是用户需求和前三个 Agent 的输出，输出是完整的旅行计划(JSON 格式)。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">PLANNER_AGENT_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""你是行程规划专家。
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">**输出格式:**
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">严格按照以下JSON格式返回:
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">  "city": "城市名称",
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">  "start_date": "YYYY-MM-DD",
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">  "end_date": "YYYY-MM-DD",
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">  "days": [...],
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">  "weather_info": [...],
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">  "overall_suggestions": "总体建议",
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">  "budget": {...}
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">**规划要求:**
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">1. weather_info必须包含每天的天气
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">2. 温度为纯数字(不带°C)
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">3. 每天安排2-3个景点
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">4. 考虑景点距离和游览时间
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">5. 包含早中晚三餐
</span></span><span class="code-line line-number" line="21"><span class="token triple-quoted-string string">6. 提供实用建议
</span></span><span class="code-line line-number" line="22"><span class="token triple-quoted-string string">7. 包含预算信息
</span></span><span class="code-line line-number" line="23"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<h3>13.3.3 Agent 协作流程</h3>
<p>现在让我们看看这四个 Agent 如何协作完成旅行规划任务。整个流程可以分为五个步骤：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">TripPlannerAgent</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        self<span class="token punctuation">.</span>attraction_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"景点搜索"</span>prompt<span class="token operator">=</span>ATTRACTION_PROMPT<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">        self<span class="token punctuation">.</span>weather_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"天气查询"</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span>WEATHER_PROMPT<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">        self<span class="token punctuation">.</span>hotel_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"酒店推荐"</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span>HOTEL_PROMPT<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">        self<span class="token punctuation">.</span>planner_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"行程规划"</span><span class="token punctuation">,</span> prompt<span class="token operator">=</span>PLANNER_PROMPT<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">    <span class="token keyword">def</span> <span class="token function">plan_trip</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> TripPlanRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TripPlan<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">        <span class="token comment"># 步骤1: 景点搜索</span>
</span><span class="code-line line-number" line="10">        attraction_response <span class="token operator">=</span> self<span class="token punctuation">.</span>attraction_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="11">            <span class="token string-interpolation"><span class="token string">f"请搜索</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>city<span class="token punctuation">}</span></span><span class="token string">的</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>preferences<span class="token punctuation">}</span></span><span class="token string">景点"</span></span>
</span><span class="code-line line-number" line="12">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14">        <span class="token comment"># 步骤2: 天气查询</span>
</span><span class="code-line line-number" line="15">        weather_response <span class="token operator">=</span> self<span class="token punctuation">.</span>weather_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="16">            <span class="token string-interpolation"><span class="token string">f"请查询</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>city<span class="token punctuation">}</span></span><span class="token string">的天气"</span></span>
</span><span class="code-line line-number" line="17">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">
</span><span class="code-line line-number" line="19">        <span class="token comment"># 步骤3: 酒店推荐</span>
</span><span class="code-line line-number" line="20">        hotel_response <span class="token operator">=</span> self<span class="token punctuation">.</span>hotel_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="21">            <span class="token string-interpolation"><span class="token string">f"请搜索</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>city<span class="token punctuation">}</span></span><span class="token string">的</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>accommodation<span class="token punctuation">}</span></span><span class="token string">酒店"</span></span>
</span><span class="code-line line-number" line="22">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">
</span><span class="code-line line-number" line="24">        <span class="token comment"># 步骤4: 整合生成计划</span>
</span><span class="code-line line-number" line="25">        planner_query <span class="token operator">=</span> self<span class="token punctuation">.</span>_build_planner_query<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="26">            request<span class="token punctuation">,</span> attraction_response<span class="token punctuation">,</span> weather_response<span class="token punctuation">,</span> hotel_response
</span><span class="code-line line-number" line="27">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">        planner_response <span class="token operator">=</span> self<span class="token punctuation">.</span>planner_agent<span class="token punctuation">.</span>run<span class="token punctuation">(</span>planner_query<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">        <span class="token comment"># 步骤5: 解析JSON</span>
</span><span class="code-line line-number" line="31">        trip_plan <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_trip_plan<span class="token punctuation">(</span>planner_response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="32">        <span class="token keyword">return</span> trip_plan
</span></code></pre>
<p>这个流程顺序执行四个步骤，每个步骤的输出作为下一个步骤的输入。注意我们使用了<code>TripPlanRequest</code>和<code>TripPlan</code>这两个 Pydantic 模型，这是在 13.2 节中定义的。</p>
<h3>13.3.4 查询构建</h3>
<p>PlannerAgent 需要整合所有信息，这个查询需要包含所有必要的信息，而且要组织得清晰有序，让 LLM 能够准确理解。</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">def</span> <span class="token function">_build_planner_query</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="2">    self<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">    request<span class="token punctuation">:</span> TripPlanRequest<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">    attraction_response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="5">    weather_response<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    hotel_response<span class="token punctuation">:</span> <span class="token builtin">str</span>
</span><span class="code-line line-number" line="7"><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token triple-quoted-string string">"""构建规划Agent的查询"""</span>
</span><span class="code-line line-number" line="9">    <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"""
</span></span></span><span class="code-line line-number" line="10"><span class="token string-interpolation"><span class="token string">请根据以下信息生成</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>city<span class="token punctuation">}</span></span><span class="token string">的</span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>days<span class="token punctuation">}</span></span><span class="token string">日旅行计划:
</span></span></span><span class="code-line line-number" line="11"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="12"><span class="token string-interpolation"><span class="token string">**用户需求:**
</span></span></span><span class="code-line line-number" line="13"><span class="token string-interpolation"><span class="token string">- 目的地: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>city<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="14"><span class="token string-interpolation"><span class="token string">- 日期: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>start_date<span class="token punctuation">}</span></span><span class="token string"> 至 </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>end_date<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="15"><span class="token string-interpolation"><span class="token string">- 天数: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>days<span class="token punctuation">}</span></span><span class="token string">天
</span></span></span><span class="code-line line-number" line="16"><span class="token string-interpolation"><span class="token string">- 偏好: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>preferences<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="17"><span class="token string-interpolation"><span class="token string">- 预算: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>budget<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="18"><span class="token string-interpolation"><span class="token string">- 交通方式: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>transportation<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="19"><span class="token string-interpolation"><span class="token string">- 住宿类型: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>accommodation<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="20"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="21"><span class="token string-interpolation"><span class="token string">**景点信息:**
</span></span></span><span class="code-line line-number" line="22"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>attraction_response<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="23"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="24"><span class="token string-interpolation"><span class="token string">**天气信息:**
</span></span></span><span class="code-line line-number" line="25"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>weather_response<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="26"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="27"><span class="token string-interpolation"><span class="token string">**酒店信息:**
</span></span></span><span class="code-line line-number" line="28"><span class="token string-interpolation"><span class="token string"></span><span class="token interpolation"><span class="token punctuation">{</span>hotel_response<span class="token punctuation">}</span></span><span class="token string">
</span></span></span><span class="code-line line-number" line="29"><span class="token string-interpolation"><span class="token string">
</span></span></span><span class="code-line line-number" line="30"><span class="token string-interpolation"><span class="token string">请生成详细的旅行计划,包括每天的景点安排、餐饮推荐、住宿信息和预算明细。
</span></span></span><span class="code-line line-number" line="31"><span class="token string-interpolation"><span class="token string">"""</span></span>
</span></code></pre>
<p>通过这种多 Agent 协作的设计，我们把一个复杂的旅行规划任务分解成了四个简单的子任务。每个 Agent 都专注于自己擅长的领域，也为未来的功能扩展(比如添加餐厅推荐 Agent、交通规划 Agent)打下了良好的基础。</p>
<h2>13.4 MCP 工具集成详解</h2>
<h3>13.4.1 为什么不直接调用 API</h3>
<p>在 13.3 节中，我们设计了四个 Agent 来协作完成旅行规划任务。其中 AttractionSearchAgent、WeatherQueryAgent 和 HotelAgent 都需要调用高德地图的 API 来获取数据。一个自然的问题是：为什么不直接在 Agent 中调用高德地图的 HTTP API？</p>
<p>让我们先看看直接调用 API 会是什么样子。高德地图提供了 POI 搜索 API，我们需要构造 HTTP 请求，传递参数，解析响应：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> requests
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">def</span> <span class="token function">search_poi</span><span class="token punctuation">(</span>keywords<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>city<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>api_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="4">    <span class="token triple-quoted-string string">"""直接调用高德地图POI搜索API"""</span>
</span><span class="code-line line-number" line="5">    url <span class="token operator">=</span> <span class="token string">"https://restapi.amap.com/v3/place/text"</span>
</span><span class="code-line line-number" line="6">    params <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">        <span class="token string">"keywords"</span><span class="token punctuation">:</span> keywords<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">        <span class="token string">"city"</span><span class="token punctuation">:</span> city<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">        <span class="token string">"key"</span><span class="token punctuation">:</span> api_key<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">        <span class="token string">"output"</span><span class="token punctuation">:</span> <span class="token string">"json"</span>
</span><span class="code-line line-number" line="11">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="12">    response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>params<span class="token operator">=</span>params<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">    data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">    <span class="token keyword">return</span> data
</span></code></pre>
<p>这种方式看起来很简单，但在实际使用中会遇到几个问题。首先是<strong>Agent 无法自主调用</strong>。在我们的 HelloAgents 框架中，Agent 通过识别提示词中的工具调用标记(比如<code>[TOOL_CALL:tool_name:arg1=value1]</code>)来调用工具。如果我们直接在代码中调用 API，Agent 就失去了自主决策的能力，变成了一个简单的函数调用。</p>
<p>其次是<strong>参数传递复杂</strong>。高德地图的 API 有很多参数，比如 POI 搜索有<code>keywords</code>、<code>city</code>、<code>types</code>、<code>offset</code>、<code>page</code>等十几个参数。如果我们要让 Agent 能够灵活使用这些参数，就需要在提示词中详细说明每个参数的含义和格式，这会让提示词变得非常复杂。</p>
<p>第三是<strong>响应解析困难</strong>。高德地图 API 返回的是 JSON 格式的数据，结构比较复杂。我们需要编写代码来解析这些数据，提取我们需要的字段。如果 API 的响应格式发生变化，我们就需要修改解析代码。</p>
<p>最后是<strong>工具管理混乱</strong>。高德地图提供了十几个不同的 API(POI 搜索、天气查询、路线规划等)，如果我们为每个 API 都编写一个函数，然后手动注册到 Agent 的工具列表中，代码会变得很冗长。而且当我们想添加新的 API 时，需要修改多个地方。</p>
<h3>13.4.2 高德地图 MCP 集成</h3>
<p>MCP(Model Context Protocol)是 Anthropic 提出的标准化协议，用于连接 LLM 和外部工具。本节将介绍如何在项目中集成高德地图 MCP 服务器。我们的项目用的是<code>amap-mcp-server</code>，这是一个用 Node.js 实现的 MCP 服务器：</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-7.png" alt="" width="85%">
  <p>图 13.7 amap-mcp-server 工具</p>
</div>
<p>高德地图 MCP 服务器提供了多种工具，主要分为以下类别，如表 13.1 所示:</p>
<div align="center">
  <p>表 13.1 高德地图 MCP 工具分类</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-table-1.png" alt="" width="85%">
</div>
<p>通过 MCP 协议，我们可以很方便地在 HelloAgents 中集成:</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">from</span> hello_agents<span class="token punctuation">.</span>tools <span class="token keyword">import</span> MCPTool
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> app<span class="token punctuation">.</span>config <span class="token keyword">import</span> get_settings
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">settings <span class="token operator">=</span> get_settings<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token comment"># 创建MCP工具</span>
</span><span class="code-line line-number" line="7">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="8">    name<span class="token operator">=</span><span class="token string">"amap_mcp"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    command<span class="token operator">=</span><span class="token string">"npx"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@sugarforever/amap-mcp-server"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    env<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"AMAP_API_KEY"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>amap_api_key<span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    auto_expand<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="13"><span class="token punctuation">)</span>
</span></code></pre>
<p>这段代码做了什么呢？首先，<code>command</code>和<code>args</code>指定了如何启动 MCP 服务器。<code>npx -y @sugarforever/amap-mcp-server</code>会从 npm 仓库下载并运行<code>amap-mcp-server</code>这个包。<code>env</code>参数传递了环境变量，这里我们传递了高德地图的 API 密钥。</p>
<p>**注意：**本文档中部分示例使用 <code>npx</code> 启动 MCP（Model Context Protocol）服务。而在本节代码仓中，我们实际采用的是 <code>uvx</code> 方式。需要说明的是，<code>npx</code> 和 <code>uvx</code> 在设计理念上高度一致，区别仅在于所处的生态系统，<code>npx</code> 面向 JavaScript/Node.js（包来自 npm），而<code>uvx</code> 面向 Python（包来自 PyPI）。两种方式并无优劣之分，请大家在使用时按需进行选择。</p>
<p>当我们创建<code>MCPTool</code>对象时，它会在后台启动 MCP 服务器进程，并通过标准输入输出(stdin/stdout)与服务器通信。这是 MCP 协议的一个特点：使用进程间通信而不是 HTTP，这样更高效，也更容易管理。</p>
<p>最关键的是<code>auto_expand=True</code>这个参数。当设置为 True 时，<code>MCPTool</code>会自动查询 MCP 服务器提供了哪些工具，然后为每个工具创建一个独立的 Tool 对象。这就是为什么我们只创建了一个<code>MCPTool</code>，但 Agent 却获得了 16 个工具。让我们看看这个过程：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># 创建一个MCPTool</span>
</span><span class="code-line line-number" line="2">mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> auto_expand<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>mcp_tool<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token comment"># Agent实际上获得了16个工具！</span>
</span><span class="code-line line-number" line="6"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>agent<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token comment"># ['amap_maps_text_search', 'amap_maps_weather', ...]</span>
</span></code></pre>
<p>如图 13.8 所示，假设用户想搜索北京的景点，AttractionSearchAgent 接收到查询"请搜索北京的历史文化景点"。Agent 分析这个查询，决定调用<code>amap_maps_text_search</code>工具，参数是<code>keywords=景点，city=北京</code>。</p>
<div align="center">
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-8.png" alt="" width="85%">
  <p>图 13.8 MCP 工具调用流程</p>
</div>
<p>Agent 生成工具调用标记：<code>[TOOL_CALL:amap_maps_text_search:keywords=景点，city=北京]</code>。HelloAgents 框架解析这个标记，提取工具名称和参数，然后调用对应的 Tool 对象。</p>
<p>Tool 对象是<code>MCPTool</code>自动创建的，它会把调用请求发送给 MCP 服务器。具体来说，它会构造一个 JSON-RPC 格式的消息，通过 stdin 发送给服务器进程：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"jsonrpc"</span><span class="token operator">:</span> <span class="token string">"2.0"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"tools/call"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="4">  <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">    <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"amap_maps_text_search"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    <span class="token property">"arguments"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">      <span class="token property">"keywords"</span><span class="token operator">:</span> <span class="token string">"景点"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="8">      <span class="token property">"city"</span><span class="token operator">:</span> <span class="token string">"北京"</span>
</span><span class="code-line line-number" line="9">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">}</span>
</span></code></pre>
<p>MCP 服务器接收到这个消息，解析参数，然后调用高德地图的 HTTP API。它会构造 HTTP 请求，添加 API 密钥，发送请求，接收响应。</p>
<p>高德地图 API 返回 JSON 格式的数据，包含景点列表、地址、坐标等信息。MCP 服务器解析这些数据，提取关键字段，然后构造响应消息，通过 stdout 返回给<code>MCPTool</code>：</p>
<pre class="language-json"><code class="language-json code-highlight"><span class="code-line line-number" line="1"><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  <span class="token property">"jsonrpc"</span><span class="token operator">:</span> <span class="token string">"2.0"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="3">  <span class="token property">"result"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">    <span class="token property">"content"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
</span><span class="code-line line-number" line="5">      <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">        <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"找到以下景点：\n1. 故宫博物院 - 地址：东城区景山前街4号\n2. 天坛公园 - 地址：东城区天坛路\n..."</span>
</span><span class="code-line line-number" line="8">      <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="9">    <span class="token punctuation">]</span>
</span><span class="code-line line-number" line="10">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">}</span>
</span></code></pre>
<p><code>MCPTool</code>接收到响应，提取文本内容，返回给 Agent。Agent 把这个结果作为工具调用的输出，继续生成最终的回复。</p>
<p>这个流程看起来很复杂，但对于 Agent 来说，它只需要知道有一个叫<code>amap_maps_text_search</code>的工具，可以搜索景点。所有的底层细节都被 MCP 协议和<code>MCPTool</code>封装起来了。</p>
<h3>13.4.3 共享 MCP 实例</h3>
<p>在我们的多 Agent 系统中，有三个 Agent 都需要使用高德地图的工具。那么每个 Agent 应该创建自己的<code>MCPTool</code>实例，还是共享同一个实例？</p>
<p>如果每个 Agent 都创建一个<code>MCPTool</code>实例，这意味着会有三个服务器进程同时运行。每个进程都会独立地调用高德地图 API，这可能会超过 API 的速率限制。而且多个进程会占用更多的内存和 CPU 资源。</p>
<p>更好的做法是让所有 Agent 共享同一个<code>MCPTool</code>实例。这样只需要启动一个 MCP 服务器进程，所有的 API 调用都通过这个进程进行。这不仅节省资源，还可以更好地控制 API 调用频率。</p>
<p>在代码中，我们在<code>TripPlannerAgent</code>的构造函数中创建一个<code>MCPTool</code>实例，然后把它添加到每个子 Agent 的工具列表中：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">class</span> <span class="token class-name">TripPlannerAgent</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="2">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="3">        settings <span class="token operator">=</span> get_settings<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">        self<span class="token punctuation">.</span>llm <span class="token operator">=</span> HelloAgentsLLM<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6">        <span class="token comment"># 创建共享的MCP工具实例(只创建一次)</span>
</span><span class="code-line line-number" line="7">        self<span class="token punctuation">.</span>mcp_tool <span class="token operator">=</span> MCPTool<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="8">            name<span class="token operator">=</span><span class="token string">"amap_mcp"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">            command<span class="token operator">=</span><span class="token string">"npx"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">            args<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"-y"</span><span class="token punctuation">,</span> <span class="token string">"@sugarforever/amap-mcp-server"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">            env<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"AMAP_API_KEY"</span><span class="token punctuation">:</span> settings<span class="token punctuation">.</span>amap_api_key<span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">            auto_expand<span class="token operator">=</span><span class="token boolean">True</span>
</span><span class="code-line line-number" line="13">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">        <span class="token comment"># 创建多个Agent,共享同一个MCP工具</span>
</span><span class="code-line line-number" line="16">        self<span class="token punctuation">.</span>attraction_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="17">            name<span class="token operator">=</span><span class="token string">"AttractionSearchAgent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="18">            llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">            system_prompt<span class="token operator">=</span>ATTRACTION_AGENT_PROMPT
</span><span class="code-line line-number" line="20">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">        self<span class="token punctuation">.</span>attraction_agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mcp_tool<span class="token punctuation">)</span>  <span class="token comment"># 共享</span>
</span><span class="code-line line-number" line="22">
</span><span class="code-line line-number" line="23">        self<span class="token punctuation">.</span>weather_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="24">            name<span class="token operator">=</span><span class="token string">"WeatherQueryAgent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="25">            llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="26">            system_prompt<span class="token operator">=</span>WEATHER_AGENT_PROMPT
</span><span class="code-line line-number" line="27">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">        self<span class="token punctuation">.</span>weather_agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mcp_tool<span class="token punctuation">)</span>  <span class="token comment"># 共享</span>
</span><span class="code-line line-number" line="29">
</span><span class="code-line line-number" line="30">        self<span class="token punctuation">.</span>hotel_agent <span class="token operator">=</span> SimpleAgent<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="31">            name<span class="token operator">=</span><span class="token string">"HotelAgent"</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="32">            llm<span class="token operator">=</span>self<span class="token punctuation">.</span>llm<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="33">            system_prompt<span class="token operator">=</span>HOTEL_AGENT_PROMPT
</span><span class="code-line line-number" line="34">        <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="35">        self<span class="token punctuation">.</span>hotel_agent<span class="token punctuation">.</span>add_tool<span class="token punctuation">(</span>self<span class="token punctuation">.</span>mcp_tool<span class="token punctuation">)</span>  <span class="token comment"># 共享</span>
</span></code></pre>
<p>这样，三个 Agent 都可以使用高德地图的 16 个工具，但底层只有一个 MCP 服务器进程在运行。当我们调用<code>TripPlannerAgent</code>的<code>plan_trip</code>方法时，三个 Agent 会依次调用工具，所有的请求都通过同一个 MCP 服务器发送到高德地图 API。</p>
<h3>13.4.4 Unsplash 图片 API 集成</h3>
<p>除了高德地图，我们还需要为景点获取图片，让旅行计划更加生动直观。我们使用 Unsplash API 来搜索景点图片。需要注意的是，Unsplash 是国外的服务，而且是为数不多可以免费使用的图片 API，所以搜索结果可能不够准确。在实际项目中，可以考虑使用必应、百度或高德的 POI 图片 API，但这些服务通常需要付费。</p>
<p>Unsplash API 的集成比较简单，我们创建一个<code>UnsplashService</code>类来封装 API 调用：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># backend/app/services/unsplash_service.py</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> requests
</span><span class="code-line line-number" line="3"><span class="token keyword">from</span> typing <span class="token keyword">import</span> Optional<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Dict
</span><span class="code-line line-number" line="4"><span class="token keyword">import</span> logging
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6">logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token keyword">class</span> <span class="token class-name">UnsplashService</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="9">    <span class="token triple-quoted-string string">"""Unsplash图片服务"""</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> access_key<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="12">        self<span class="token punctuation">.</span>access_key <span class="token operator">=</span> access_key
</span><span class="code-line line-number" line="13">        self<span class="token punctuation">.</span>base_url <span class="token operator">=</span> <span class="token string">"https://api.unsplash.com"</span>
</span><span class="code-line line-number" line="14">
</span><span class="code-line line-number" line="15">    <span class="token keyword">def</span> <span class="token function">search_photos</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> per_page<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="16">        <span class="token triple-quoted-string string">"""搜索图片"""</span>
</span><span class="code-line line-number" line="17">        <span class="token keyword">try</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="18">            url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>self<span class="token punctuation">.</span>base_url<span class="token punctuation">}</span></span><span class="token string">/search/photos"</span></span>
</span><span class="code-line line-number" line="19">            params <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="20">                <span class="token string">"query"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="21">                <span class="token string">"per_page"</span><span class="token punctuation">:</span> per_page<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="22">                <span class="token string">"client_id"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>access_key
</span><span class="code-line line-number" line="23">            <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="24">
</span><span class="code-line line-number" line="25">            response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">            response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">
</span><span class="code-line line-number" line="28">            data <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">            results <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="30">
</span><span class="code-line line-number" line="31">            <span class="token comment"># 提取图片URL</span>
</span><span class="code-line line-number" line="32">            photos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="33">            <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="34">                photos<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="35">                    <span class="token string">"url"</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token string">"urls"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"regular"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="36">                    <span class="token string">"description"</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"description"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="37">                    <span class="token string">"photographer"</span><span class="token punctuation">:</span> result<span class="token punctuation">[</span><span class="token string">"user"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="38">                <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="39">
</span><span class="code-line line-number" line="40">            <span class="token keyword">return</span> photos
</span><span class="code-line line-number" line="41">
</span><span class="code-line line-number" line="42">        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="43">            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"搜索图片失败: </span><span class="token interpolation"><span class="token punctuation">{</span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="44">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="45">
</span><span class="code-line line-number" line="46">    <span class="token keyword">def</span> <span class="token function">get_photo_url</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Optional<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
</span><span class="code-line line-number" line="47">        <span class="token triple-quoted-string string">"""获取单张图片URL"""</span>
</span><span class="code-line line-number" line="48">        photos <span class="token operator">=</span> self<span class="token punctuation">.</span>search_photos<span class="token punctuation">(</span>query<span class="token punctuation">,</span> per_page<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="49">        <span class="token keyword">return</span> photos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"url"</span><span class="token punctuation">)</span> <span class="token keyword">if</span> photos <span class="token keyword">else</span> <span class="token boolean">None</span>
</span></code></pre>
<p>这个服务类提供了两个方法：<code>search_photos</code>搜索多张图片，<code>get_photo_url</code>获取单张图片的 URL。我们在 API 路由中使用这个服务，为每个景点获取图片：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1"><span class="token comment"># backend/app/api/routes/trip.py</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">from</span> app<span class="token punctuation">.</span>services<span class="token punctuation">.</span>unsplash_service <span class="token keyword">import</span> UnsplashService
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4">unsplash_service <span class="token operator">=</span> UnsplashService<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>unsplash_access_key<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">
</span><span class="code-line line-number" line="6"><span class="token decorator annotation punctuation">@router<span class="token punctuation">.</span>post</span><span class="token punctuation">(</span><span class="token string">"/plan"</span><span class="token punctuation">,</span> response_model<span class="token operator">=</span>TripPlan<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7"><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">create_trip_plan</span><span class="token punctuation">(</span>request<span class="token punctuation">:</span> TripPlanRequest<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> TripPlan<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="8">    <span class="token comment"># 生成旅行计划</span>
</span><span class="code-line line-number" line="9">    trip_plan <span class="token operator">=</span> trip_planner_agent<span class="token punctuation">.</span>plan_trip<span class="token punctuation">(</span>request<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="10">
</span><span class="code-line line-number" line="11">    <span class="token comment"># 为每个景点获取图片</span>
</span><span class="code-line line-number" line="12">    <span class="token keyword">for</span> day <span class="token keyword">in</span> trip_plan<span class="token punctuation">.</span>days<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="13">        <span class="token keyword">for</span> attraction <span class="token keyword">in</span> day<span class="token punctuation">.</span>attractions<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="14">            <span class="token keyword">if</span> <span class="token keyword">not</span> attraction<span class="token punctuation">.</span>image_url<span class="token punctuation">:</span>
</span><span class="code-line line-number" line="15">                image_url <span class="token operator">=</span> unsplash_service<span class="token punctuation">.</span>get_photo_url<span class="token punctuation">(</span>
</span><span class="code-line line-number" line="16">                    <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>attraction<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span>trip_plan<span class="token punctuation">.</span>city<span class="token punctuation">}</span></span><span class="token string">"</span></span>
</span><span class="code-line line-number" line="17">                <span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">                attraction<span class="token punctuation">.</span>image_url <span class="token operator">=</span> image_url
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">    <span class="token keyword">return</span> trip_plan
</span></code></pre>
<p>注意我们没有把 Unsplash 封装成 Tool 或 MCP 工具，而是直接在 API 路由中调用。这是因为图片搜索不需要 Agent 的智能决策，只是一个简单的数据增强步骤。如果你想让 Agent 能够自主决定是否需要图片，或者选择不同的图片来源，可以考虑把它封装成 Tool。</p>
<h2>13.5 前端开发详解</h2>
<h3>13.5.1 前后端分离的 Web 架构</h3>
<p>在开始前端开发之前，我们需要理解现代 Web 应用的架构模式。在早期的 Web 开发中，前端和后端是混在一起的，比如 PHP、JSP 这样的技术，HTML 模板和业务逻辑代码写在同一个文件里。这种方式在小项目中很方便，但在大型项目中会遇到很多问题：前端和后端开发者需要频繁协调，代码难以复用，测试困难。</p>
<p>现代 Web 应用普遍采用<strong>前后端分离</strong>的架构。后端只负责提供 API 接口，返回 JSON 格式的数据。前端是一个独立的应用，通过 HTTP 请求调用后端 API，获取数据后渲染页面。这种架构有几个明显的优势：前端和后端可以独立开发、独立部署、独立测试；前端可以是 Web 应用、移动应用或桌面应用，都使用同一套后端 API；前端可以使用现代的框架和工具链，提供更好的用户体验。</p>
<p>在我们的智能旅行助手项目中，后端是用 Python 和 FastAPI 实现的，提供了一个核心 API 接口<code>POST /api/trip/plan</code>，接收旅行需求，返回旅行计划。前端是用 Vue 3 和 TypeScript 实现的，是一个单页应用(SPA)，用户在浏览器中填写表单，点击"开始规划"按钮，前端发送 HTTP 请求到后端，等待响应，然后渲染结果页面。整个过程中，页面不会刷新，用户体验很流畅。</p>
<p>前端技术栈的选择需要考虑几个因素：开发效率、性能、生态系统、学习曲线。如表 13.2 所示，该项目选择了以下技术栈：</p>
<div align="center">
  <p>表 13.2 前端技术栈</p>
  <img src="https://raw.githubusercontent.com/datawhalechina/Hello-Agents/main/docs/images/13-figures/13-table-2.png" alt="" width="85%">
</div>
<p>项目的目录结构是这样的：</p>
<pre><code class="code-highlight"><span class="code-line line-number" line="1">frontend/
</span><span class="code-line line-number" line="2">├── src/
</span><span class="code-line line-number" line="3">│   ├── views/              # 页面组件
</span><span class="code-line line-number" line="4">│   │   ├── Home.vue        # 首页(表单)
</span><span class="code-line line-number" line="5">│   │   └── Result.vue      # 结果页
</span><span class="code-line line-number" line="6">│   ├── services/           # API服务
</span><span class="code-line line-number" line="7">│   │   └── api.ts
</span><span class="code-line line-number" line="8">│   ├── types/              # 类型定义
</span><span class="code-line line-number" line="9">│   │   └── index.ts
</span><span class="code-line line-number" line="10">│   ├── router/             # 路由配置
</span><span class="code-line line-number" line="11">│   │   └── index.ts
</span><span class="code-line line-number" line="12">│   ├── App.vue
</span><span class="code-line line-number" line="13">│   └── main.ts
</span><span class="code-line line-number" line="14">├── package.json
</span><span class="code-line line-number" line="15">├── vite.config.ts
</span><span class="code-line line-number" line="16">└── tsconfig.json
</span></code></pre>
<p>其中<code>views</code>目录存放页面组件，<code>services</code>目录存放 API 调用逻辑，<code>types</code>目录存放 TypeScript 类型定义，<code>router</code>目录存放路由配置。</p>
<h3>13.5.2 类型定义</h3>
<p>在 13.2 节中，我们在后端使用 Pydantic 定义了数据模型，比如<code>Location</code>、<code>Attraction</code>、<code>DayPlan</code>、<code>TripPlan</code>等。在前端，我们需要定义对应的 TypeScript 类型。</p>
<p>让我们看看如何定义这些类型。首先是最基础的<code>Location</code>类型，表示经纬度坐标：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// frontend/src/types/index.ts</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Location</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">  longitude<span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line line-number" line="4">  latitude<span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line line-number" line="5"><span class="token punctuation">}</span>
</span></code></pre>
<p>这个类型定义和后端的 Pydantic 模型完全对应。注意 TypeScript 使用<code>interface</code>关键字定义类型，字段类型用冒号分隔，不需要默认值。</p>
<p>接下来是<code>Attraction</code>类型，表示景点信息：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Attraction</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  name<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="3">  address<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="4">  location<span class="token operator">:</span> Location
</span><span class="code-line line-number" line="5">  visit_duration<span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line line-number" line="6">  description<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="7">  category<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="8">  rating<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line line-number" line="9">  image_url<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="10">  ticket_price<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line line-number" line="11"><span class="token punctuation">}</span>
</span></code></pre>
<p>注意这里使用了<code>Location</code>类型作为字段类型，这就是嵌套类型。问号<code>?</code>表示可选字段，对应后端 Pydantic 模型中的<code>Optional</code>。</p>
<p>类似地，我们定义<code>Meal</code>、<code>Hotel</code>、<code>Budget</code>、<code>WeatherInfo</code>等类型。最后是顶层的<code>TripPlan</code>类型：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">TripPlan</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  city<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="3">  start_date<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="4">  end_date<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="5">  days<span class="token operator">:</span> DayPlan<span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="6">  weather_info<span class="token operator">:</span> WeatherInfo<span class="token punctuation">[</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="7">  overall_suggestions<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="8">  budget<span class="token operator">?</span><span class="token operator">:</span> Budget
</span><span class="code-line line-number" line="9"><span class="token punctuation">}</span>
</span></code></pre>
<p>还有请求类型<code>TripPlanRequest</code>，对应后端的请求模型：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">TripPlanRequest</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  city<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="3">  start_date<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="4">  end_date<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="5">  days<span class="token operator">:</span> <span class="token builtin">number</span>
</span><span class="code-line line-number" line="6">  preferences<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="7">  budget<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="8">  transportation<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="9">  accommodation<span class="token operator">:</span> <span class="token builtin">string</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span>
</span></code></pre>
<p>这些类型定义有什么用呢？首先，当我们调用 API 时，TypeScript 会检查我们传递的数据是否符合<code>TripPlanRequest</code>类型。如果我们不小心把<code>days</code>写成了字符串，TypeScript 会立即报错。其次，当我们接收 API 响应时，TypeScript 会检查响应数据是否符合<code>TripPlan</code>类型。如果后端返回的数据结构发生变化，前端会立即发现。最后，IDE 可以根据类型定义提供代码补全，我们输入<code>tripPlan.</code>时，IDE 会自动列出所有可用的字段。</p>
<h3>13.5.3 API 服务封装</h3>
<p>有了类型定义，我们就可以封装 API 调用了。我们创建一个<code>api.ts</code>文件，使用 Axios 来发送 HTTP 请求：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> axios <span class="token keyword">from</span> <span class="token string">'axios'</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> TripPlanRequest<span class="token punctuation">,</span>TripPlan <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../types'</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token keyword">const</span> api <span class="token operator">=</span> axios<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">  baseURL<span class="token operator">:</span> <span class="token string">'http://localhost:8000/api'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">  timeout<span class="token operator">:</span> <span class="token number">120000</span><span class="token punctuation">,</span> <span class="token comment">// 2分钟超时</span>
</span><span class="code-line line-number" line="7">  headers<span class="token operator">:</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    <span class="token string-property property">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'application/json'</span>
</span><span class="code-line line-number" line="9">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p>这里我们创建了一个 Axios 实例，配置了基础 URL、超时时间和请求头。为什么超时时间设置为 2 分钟？因为生成旅行计划需要调用多个 Agent，每个 Agent 都要调用 LLM 和外部 API，整个过程可能需要 10-30 秒。如果超时时间太短，请求会被中断。</p>
<p>接下来我们添加拦截器。拦截器可以在请求发送前和响应接收后执行一些通用逻辑，比如日志记录、错误处理、认证等：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// 请求拦截器</span>
</span><span class="code-line line-number" line="2">api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="3">  config <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发送请求：'</span><span class="token punctuation">,</span>config<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">    <span class="token keyword">return</span> config
</span><span class="code-line line-number" line="6">  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="7">  error <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">
</span><span class="code-line line-number" line="10"><span class="token comment">// 响应拦截器</span>
</span><span class="code-line line-number" line="11">api<span class="token punctuation">.</span>interceptors<span class="token punctuation">.</span>response<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
</span><span class="code-line line-number" line="12">  response <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="13">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到响应：'</span><span class="token punctuation">,</span>response<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">    <span class="token keyword">return</span> response
</span><span class="code-line line-number" line="15">  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="16">  error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'请求失败：'</span><span class="token punctuation">,</span>error<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">    <span class="token keyword">return</span> <span class="token builtin">Promise</span><span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="20"><span class="token punctuation">)</span>
</span></code></pre>
<p>最后我们定义 API 函数，这是前端调用后端的唯一入口：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// 生成旅行计划</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">export</span> <span class="token keyword">const</span> generateTripPlan <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>request<span class="token operator">:</span> TripPlanRequest<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>TripPlan<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> api<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">post</span><span class="token generic class-name"><span class="token operator">&lt;</span>TripPlan<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">'/trip/plan'</span><span class="token punctuation">,</span>request<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">  <span class="token keyword">return</span> response<span class="token punctuation">.</span>data
</span><span class="code-line line-number" line="5"><span class="token punctuation">}</span>
</span></code></pre>
<p>注意这个函数的类型签名：参数是<code>TripPlanRequest</code>类型，返回值是<code>Promise&lt;TripPlan&gt;</code>类型。这意味着 TypeScript 会检查调用者传递的参数是否符合要求，也会检查返回值的使用是否正确。</p>
<h3>13.5.4 Home 表单设计</h3>
<p>Home 页面是用户的入口，包含一个表单，让用户填写旅行需求。我们使用 Vue 3 的 Composition API 来组织代码：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;script setup lang="ts"&gt;
</span><span class="code-line line-number" line="2">import { ref } from 'vue'
</span><span class="code-line line-number" line="3">import { useRouter } from 'vue-router'
</span><span class="code-line line-number" line="4">import { message } from 'ant-design-vue'
</span><span class="code-line line-number" line="5">import { generateTripPlan } from '@/services/api'
</span><span class="code-line line-number" line="6">import type { TripPlanRequest } from '@/types'
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8">const router = useRouter()
</span><span class="code-line line-number" line="9">const loading = ref(false)
</span><span class="code-line line-number" line="10">const loadingProgress = ref(0)
</span><span class="code-line line-number" line="11">const loadingStatus = ref('')
</span><span class="code-line line-number" line="12">
</span><span class="code-line line-number" line="13">const formData = ref&lt;TripPlanRequest&gt;({
</span><span class="code-line line-number" line="14">  city: '',
</span><span class="code-line line-number" line="15">  start_date: '',
</span><span class="code-line line-number" line="16">  end_date: '',
</span><span class="code-line line-number" line="17">  days: 3,
</span><span class="code-line line-number" line="18">  preferences: '历史文化',
</span><span class="code-line line-number" line="19">  budget: '中等',
</span><span class="code-line line-number" line="20">  transportation: '公共交通',
</span><span class="code-line line-number" line="21">  accommodation: '经济型酒店'
</span><span class="code-line line-number" line="22">})
</span><span class="code-line line-number" line="23">&lt;/script&gt;
</span></code></pre>
<p>这里我们使用<code>ref</code>来创建响应式变量。<code>formData</code>是表单数据，类型是<code>TripPlanRequest</code>。<code>loading</code>表示是否正在加载，<code>loadingProgress</code>表示加载进度，<code>loadingStatus</code>表示加载状态文本。</p>
<p>表单提交的逻辑是这样的：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> <span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="2">  loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
</span><span class="code-line line-number" line="3">  loadingProgress<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="4">  
</span><span class="code-line line-number" line="5">  <span class="token comment">// 模拟进度更新</span>
</span><span class="code-line line-number" line="6">  <span class="token keyword">const</span> progressInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">      loadingProgress<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">10</span>
</span><span class="code-line line-number" line="9">      <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> <span class="token number">30</span><span class="token punctuation">)</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'🔍 正在搜索景点...'</span>
</span><span class="code-line line-number" line="10">      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">)</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'🌤️ 正在查询天气...'</span>
</span><span class="code-line line-number" line="11">      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> <span class="token number">70</span><span class="token punctuation">)</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'🏨 正在推荐酒店...'</span>
</span><span class="code-line line-number" line="12">      <span class="token keyword">else</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'📋 正在生成行程计划...'</span>
</span><span class="code-line line-number" line="13">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="14">  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">500</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="15">  
</span><span class="code-line line-number" line="16">  <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateTripPlan</span><span class="token punctuation">(</span>formData<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">    <span class="token function">clearInterval</span><span class="token punctuation">(</span>progressInterval<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">    loadingProgress<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">100</span>
</span><span class="code-line line-number" line="20">    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span>state<span class="token operator">:</span> <span class="token punctuation">{</span> tripPlan<span class="token operator">:</span> response <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="22">    <span class="token function">clearInterval</span><span class="token punctuation">(</span>progressInterval<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'生成计划失败,请重试'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="25">    loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="26">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="27"><span class="token punctuation">}</span>
</span></code></pre>
<p>这段代码做了几件事。首先，设置<code>loading</code>为 true，显示加载状态。然后，启动一个定时器，每 500 毫秒更新一次进度条和状态文本。这是一个模拟的进度，因为我们无法准确知道后端的处理进度。但这样可以让用户知道系统正在工作，而不是卡住了。</p>
<p>接着，调用<code>generateTripPlan</code>函数发送 API 请求。这是一个异步操作，我们使用<code>await</code>等待响应。如果请求成功，清除定时器，设置进度为 100%，然后跳转到结果页面，并把旅行计划数据传递过去。如果请求失败，显示错误消息。最后，无论成功还是失败，都设置<code>loading</code>为 false，隐藏加载状态。</p>
<p>模板部分使用 Ant Design Vue 的组件：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;template&gt;
</span><span class="code-line line-number" line="2">  &lt;div class="home-container"&gt;
</span><span class="code-line line-number" line="3">    &lt;div class="page-header"&gt;
</span><span class="code-line line-number" line="4">      &lt;h1 class="page-title"&gt;✈️ 智能旅行助手&lt;/h1&gt;
</span><span class="code-line line-number" line="5">      &lt;p class="page-subtitle"&gt;基于AI的个性化旅行规划&lt;/p&gt;
</span><span class="code-line line-number" line="6">    &lt;/div&gt;
</span><span class="code-line line-number" line="7">    
</span><span class="code-line line-number" line="8">    &lt;a-card class="form-card"&gt;
</span><span class="code-line line-number" line="9">      &lt;a-form :model="formData" @finish="handleSubmit"&gt;
</span><span class="code-line line-number" line="10">        &lt;a-form-item label="目的地城市" name="city" :rules="[{ required: true }]"&gt;
</span><span class="code-line line-number" line="11">          &lt;a-input v-model:value="formData.city" placeholder="如：北京" /&gt;
</span><span class="code-line line-number" line="12">        &lt;/a-form-item&gt;
</span><span class="code-line line-number" line="13">        
</span><span class="code-line line-number" line="14">        &lt;!-- 更多表单项... --&gt;
</span><span class="code-line line-number" line="15">        
</span><span class="code-line line-number" line="16">        &lt;a-form-item&gt;
</span><span class="code-line line-number" line="17">          &lt;a-button type="primary" html-type="submit" size="large" :loading="loading"&gt;
</span><span class="code-line line-number" line="18">            开始规划
</span><span class="code-line line-number" line="19">          &lt;/a-button&gt;
</span><span class="code-line line-number" line="20">        &lt;/a-form-item&gt;
</span><span class="code-line line-number" line="21">        
</span><span class="code-line line-number" line="22">        &lt;!-- 加载进度条 --&gt;
</span><span class="code-line line-number" line="23">        &lt;a-form-item v-if="loading"&gt;
</span><span class="code-line line-number" line="24">          &lt;a-progress :percent="loadingProgress" status="active" /&gt;
</span><span class="code-line line-number" line="25">          &lt;p&gt;{{ loadingStatus }}&lt;/p&gt;
</span><span class="code-line line-number" line="26">        &lt;/a-form-item&gt;
</span><span class="code-line line-number" line="27">      &lt;/a-form&gt;
</span><span class="code-line line-number" line="28">    &lt;/a-card&gt;
</span><span class="code-line line-number" line="29">  &lt;/div&gt;
</span><span class="code-line line-number" line="30">&lt;/template&gt;
</span></code></pre>
<p>注意<code>v-model:value</code>指令，它实现了双向数据绑定。当用户在输入框中输入内容时，<code>formData.city</code>会自动更新。当<code>formData.city</code>的值改变时，输入框的内容也会自动更新。</p>
<h3>13.5.5 Result 页面展示</h3>
<p>Result 页面是整个应用的核心，展示生成的旅行计划。这个页面包含几个部分：行程概览、预算明细、地图可视化、每日行程详情、天气信息。</p>
<p>首先是地图可视化。我们使用高德地图 JS API 在地图上标注景点位置：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> AMapLoader <span class="token keyword">from</span> <span class="token string">'@amap/amap-jsapi-loader'</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">const</span> <span class="token function-variable function">initMap</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">  <span class="token keyword">const</span> AMap <span class="token operator">=</span> <span class="token keyword">await</span> AMapLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">    key<span class="token operator">:</span> <span class="token string">'your_amap_web_key'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="6">    version<span class="token operator">:</span> <span class="token string">'2.0'</span>
</span><span class="code-line line-number" line="7">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">  
</span><span class="code-line line-number" line="9">  map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMap</span><span class="token punctuation">.</span><span class="token function">Map</span><span class="token punctuation">(</span><span class="token string">'amap-container'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">    zoom<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="11">    center<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">116.397128</span><span class="token punctuation">,</span><span class="token number">39.916527</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="12">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="13">  
</span><span class="code-line line-number" line="14">  <span class="token comment">// 添加景点标记</span>
</span><span class="code-line line-number" line="15">  tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>days<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>day<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">    day<span class="token punctuation">.</span>attractions<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>attraction<span class="token punctuation">,</span>index<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="17">      <span class="token keyword">const</span> marker <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AMap</span><span class="token punctuation">.</span><span class="token function">Marker</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="18">        position<span class="token operator">:</span> <span class="token punctuation">[</span>attraction<span class="token punctuation">.</span>location<span class="token punctuation">.</span>longitude<span class="token punctuation">,</span>attraction<span class="token punctuation">.</span>location<span class="token punctuation">.</span>latitude<span class="token punctuation">]</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="19">        title<span class="token operator">:</span> attraction<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
</span><span class="code-line line-number" line="20">        label<span class="token operator">:</span> <span class="token punctuation">{</span> content<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>direction<span class="token operator">:</span> <span class="token string">'top'</span> <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="21">      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">      map<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>marker<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="25"><span class="token punctuation">}</span>
</span></code></pre>
<p>这段代码首先加载高德地图 SDK，然后创建地图实例，最后遍历所有景点，为每个景点创建一个标记(Marker)。标记的位置是景点的经纬度坐标，这些坐标是从后端的<code>Attraction</code>对象中获取的。</p>
<p>导出功能使用<code>html2canvas</code>和<code>jsPDF</code>库。<code>html2canvas</code>可以把 DOM 元素转换成 Canvas，然后我们可以把 Canvas 导出为图片或 PDF：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> html2canvas <span class="token keyword">from</span> <span class="token string">'html2canvas'</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">import</span> jsPDF <span class="token keyword">from</span> <span class="token string">'jspdf'</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment">// 导出为图片</span>
</span><span class="code-line line-number" line="5"><span class="token keyword">const</span> <span class="token function-variable function">exportAsImage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'trip-plan-content'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">html2canvas</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span><span class="token punctuation">{</span> scale<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">  <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">  link<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>city<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">旅行计划.png</span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line line-number" line="10">  link<span class="token punctuation">.</span>href <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="11">  link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13">
</span><span class="code-line line-number" line="14"><span class="token comment">// 导出为PDF</span>
</span><span class="code-line line-number" line="15"><span class="token keyword">const</span> <span class="token function-variable function">exportAsPDF</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="16">  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'trip-plan-content'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">html2canvas</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span><span class="token punctuation">{</span> scale<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18">  <span class="token keyword">const</span> imgData <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">  <span class="token keyword">const</span> pdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">jsPDF</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'mm'</span><span class="token punctuation">,</span><span class="token string">'a4'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="20">  <span class="token keyword">const</span> imgWidth <span class="token operator">=</span> <span class="token number">210</span>
</span><span class="code-line line-number" line="21">  <span class="token keyword">const</span> imgHeight <span class="token operator">=</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>height <span class="token operator">*</span> imgWidth<span class="token punctuation">)</span> <span class="token operator">/</span> canvas<span class="token punctuation">.</span>width
</span><span class="code-line line-number" line="22">  pdf<span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>imgData<span class="token punctuation">,</span><span class="token string">'PNG'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>imgWidth<span class="token punctuation">,</span>imgHeight<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">  pdf<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>city<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">旅行计划.pdf</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="24"><span class="token punctuation">}</span>
</span></code></pre>
<p>通过这些前端技术，我们实现了一个完整的 Web 应用。用户可以在浏览器中填写表单，提交请求，等待 AI 生成旅行计划，然后查看详细的行程安排，在地图上看到景点位置，还可以导出为图片或 PDF。整个过程流畅自然，这就是现代 Web 应用的魅力。</p>
<h2>13.6 功能实现详解</h2>
<p>本节介绍智能旅行助手的核心功能实现，包括预算计算、加载进度条、行程编辑、导出功能和侧边导航。</p>
<h3>13.6.1 预算计算功能</h3>
<p>在规划旅行时，预算是一个非常重要的考虑因素。用户需要知道这次旅行大概要花多少钱，钱都花在哪里。我们的智能旅行助手提供了自动预算计算功能，将费用分为四大类：景点门票、酒店住宿、餐饮和交通。</p>
<p>预算计算的逻辑在哪里实现呢？我们选择在后端的 PlannerAgent 中实现。为什么不在前端计算？因为预算的估算需要基于景点的门票价格、酒店的价格范围、餐饮的标准等信息，这些信息都是 PlannerAgent 在生成行程时已经获取的。如果在前端计算，就需要重复这些逻辑，而且可能不准确。</p>
<p>在 PlannerAgent 的提示词中，我们明确要求 LLM 生成预算信息：</p>
<pre class="language-python"><code class="language-python code-highlight"><span class="code-line line-number" line="1">PLANNER_AGENT_PROMPT <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
</span></span><span class="code-line line-number" line="2"><span class="token triple-quoted-string string">你是行程规划专家。
</span></span><span class="code-line line-number" line="3"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="4"><span class="token triple-quoted-string string">**输出格式：**
</span></span><span class="code-line line-number" line="5"><span class="token triple-quoted-string string">严格按照以下JSON格式返回：
</span></span><span class="code-line line-number" line="6"><span class="token triple-quoted-string string">{
</span></span><span class="code-line line-number" line="7"><span class="token triple-quoted-string string">  ...
</span></span><span class="code-line line-number" line="8"><span class="token triple-quoted-string string">  "budget": {
</span></span><span class="code-line line-number" line="9"><span class="token triple-quoted-string string">    "total_attractions": 180,
</span></span><span class="code-line line-number" line="10"><span class="token triple-quoted-string string">    "total_hotels": 1200,
</span></span><span class="code-line line-number" line="11"><span class="token triple-quoted-string string">    "total_meals": 480,
</span></span><span class="code-line line-number" line="12"><span class="token triple-quoted-string string">    "total_transportation": 200,
</span></span><span class="code-line line-number" line="13"><span class="token triple-quoted-string string">    "total": 2060
</span></span><span class="code-line line-number" line="14"><span class="token triple-quoted-string string">  }
</span></span><span class="code-line line-number" line="15"><span class="token triple-quoted-string string">}
</span></span><span class="code-line line-number" line="16"><span class="token triple-quoted-string string">
</span></span><span class="code-line line-number" line="17"><span class="token triple-quoted-string string">**规划要求：**
</span></span><span class="code-line line-number" line="18"><span class="token triple-quoted-string string">...
</span></span><span class="code-line line-number" line="19"><span class="token triple-quoted-string string">7. 包含预算信息,根据景点门票、酒店价格、餐饮标准和交通方式估算
</span></span><span class="code-line line-number" line="20"><span class="token triple-quoted-string string">"""</span>
</span></code></pre>
<p>LLM 会根据行程中的景点、酒店、餐饮安排，估算每一项的费用。比如，如果行程中包含故宫(门票 60 元)、天坛(门票 15 元)、颐和园(门票 30 元)，那么景点门票总费用就是 105 元。如果是 3 天 2 晚的行程，酒店是经济型(每晚 300 元)，那么酒店总费用就是 600 元。</p>
<p>在前端，我们使用 Ant Design Vue 的 Statistic 组件来展示预算信息。这个组件专门用于展示统计数据,支持数字动画、前缀后缀、自定义样式等：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;a-card v-if="tripPlan.budget" title="💰 预算明细"&gt;
</span><span class="code-line line-number" line="2">  &lt;a-row :gutter="16"&gt;
</span><span class="code-line line-number" line="3">    &lt;a-col :span="6"&gt;
</span><span class="code-line line-number" line="4">      &lt;a-statistic title="景点门票" :value="tripPlan.budget.total_attractions" suffix="元" /&gt;
</span><span class="code-line line-number" line="5">    &lt;/a-col&gt;
</span><span class="code-line line-number" line="6">    &lt;a-col :span="6"&gt;
</span><span class="code-line line-number" line="7">      &lt;a-statistic title="酒店住宿" :value="tripPlan.budget.total_hotels" suffix="元" /&gt;
</span><span class="code-line line-number" line="8">    &lt;/a-col&gt;
</span><span class="code-line line-number" line="9">    &lt;a-col :span="6"&gt;
</span><span class="code-line line-number" line="10">      &lt;a-statistic title="餐饮费用" :value="tripPlan.budget.total_meals" suffix="元" /&gt;
</span><span class="code-line line-number" line="11">    &lt;/a-col&gt;
</span><span class="code-line line-number" line="12">    &lt;a-col :span="6"&gt;
</span><span class="code-line line-number" line="13">      &lt;a-statistic title="交通费用" :value="tripPlan.budget.total_transportation" suffix="元" /&gt;
</span><span class="code-line line-number" line="14">    &lt;/a-col&gt;
</span><span class="code-line line-number" line="15">  &lt;/a-row&gt;
</span><span class="code-line line-number" line="16">  &lt;a-divider /&gt;
</span><span class="code-line line-number" line="17">  &lt;a-row&gt;
</span><span class="code-line line-number" line="18">    &lt;a-col :span="24" style="text-align: center;"&gt;
</span><span class="code-line line-number" line="19">      &lt;a-statistic
</span><span class="code-line line-number" line="20">        title="预估总费用"
</span><span class="code-line line-number" line="21">        :value="tripPlan.budget.total"
</span><span class="code-line line-number" line="22">        suffix="元"
</span><span class="code-line line-number" line="23">        :value-style="{ color: '#cf1322',fontSize: '32px',fontWeight: 'bold' }"
</span><span class="code-line line-number" line="24">      /&gt;
</span><span class="code-line line-number" line="25">    &lt;/a-col&gt;
</span><span class="code-line line-number" line="26">  &lt;/a-row&gt;
</span><span class="code-line line-number" line="27">&lt;/a-card&gt;
</span></code></pre>
<p>这段代码使用了栅格布局(<code>a-row</code>和<code>a-col</code>)，将四项费用并排显示。每项费用使用一个<code>a-statistic</code>组件，显示标题和数值。最后用一个分隔线(<code>a-divider</code>)隔开，下面显示总费用，使用红色大字体突出显示。</p>
<p>注意<code>v-if="tripPlan.budget"</code>这个条件渲染。因为预算信息是可选的(在 Pydantic 模型中定义为<code>Optional[Budget]</code>)，如果 LLM 没有生成预算信息，这个卡片就不会显示。这体现了前端对数据的容错处理。</p>
<h3>13.6.2 加载进度条</h3>
<p>生成旅行计划是一个耗时的操作。后端需要依次调用 AttractionSearchAgent、WeatherQueryAgent、HotelAgent 和 PlannerAgent，每个 Agent 都要调用 LLM 和外部 API。整个过程可能需要 10-30 秒。如果用户点击"开始规划"按钮后，页面没有任何反馈，用户会以为系统卡住了，可能会刷新页面或重复点击。</p>
<p>为了提升用户体验，我们添加了加载进度条和状态提示。现在只是模拟进度，可以让用户知道系统正在工作。</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> loading <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">const</span> loadingProgress <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3"><span class="token keyword">const</span> loadingStatus <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5"><span class="token keyword">const</span> <span class="token function-variable function">handleSubmit</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">  loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
</span><span class="code-line line-number" line="7">  loadingProgress<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span>
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">  <span class="token comment">// 模拟进度更新</span>
</span><span class="code-line line-number" line="10">  <span class="token keyword">const</span> progressInterval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;</span> <span class="token number">90</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="12">      loadingProgress<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">10</span>
</span><span class="code-line line-number" line="13">      <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> <span class="token number">30</span><span class="token punctuation">)</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'🔍 正在搜索景点...'</span>
</span><span class="code-line line-number" line="14">      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> <span class="token number">50</span><span class="token punctuation">)</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'🌤️ 正在查询天气...'</span>
</span><span class="code-line line-number" line="15">      <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loadingProgress<span class="token punctuation">.</span>value <span class="token operator">&lt;=</span> <span class="token number">70</span><span class="token punctuation">)</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'🏨 正在推荐酒店...'</span>
</span><span class="code-line line-number" line="16">      <span class="token keyword">else</span> loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'📋 正在生成行程计划...'</span>
</span><span class="code-line line-number" line="17">    <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="18">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">
</span><span class="code-line line-number" line="20">  <span class="token keyword">try</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="21">    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">generateTripPlan</span><span class="token punctuation">(</span>formData<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">    <span class="token function">clearInterval</span><span class="token punctuation">(</span>progressInterval<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="23">    loadingProgress<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">100</span>
</span><span class="code-line line-number" line="24">    loadingStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'✅ 完成！'</span>
</span><span class="code-line line-number" line="25">    router<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">'result'</span><span class="token punctuation">,</span> state<span class="token operator">:</span> <span class="token punctuation">{</span> tripPlan<span class="token operator">:</span> response <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="27">    <span class="token function">clearInterval</span><span class="token punctuation">(</span>progressInterval<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28">    message<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'生成计划失败'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="29">  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="30">    loading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="31">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="32"><span class="token punctuation">}</span>
</span></code></pre>
<h3>13.6.3 行程编辑功能</h3>
<p>AI 生成的旅行计划虽然很智能，但可能不完全符合用户的个人需求。比如，用户可能不喜欢某个景点，想删除它；或者想调整景点的游览顺序。我们提供了行程编辑功能，让用户可以自定义行程。</p>
<p>编辑功能的核心是<strong>状态管理</strong>。我们需要维护两个状态：当前的行程计划和原始的行程计划。当用户进入编辑模式时，我们保存原始计划的副本。如果用户取消编辑，就恢复原始计划。如果用户保存修改，就更新当前计划：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> editMode <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">const</span> originalPlan <span class="token operator">=</span> <span class="token generic-function"><span class="token function">ref</span><span class="token generic class-name"><span class="token operator">&lt;</span>TripPlan <span class="token operator">|</span> <span class="token keyword">null</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="3">
</span><span class="code-line line-number" line="4"><span class="token comment">// 进入编辑模式</span>
</span><span class="code-line line-number" line="5"><span class="token keyword">const</span> <span class="token function-variable function">toggleEditMode</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="6">  editMode<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
</span><span class="code-line line-number" line="7">  originalPlan<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8"><span class="token punctuation">}</span>
</span></code></pre>
<p>注意这里使用了<code>JSON.parse(JSON.stringify(...))</code>来深拷贝对象。为什么不直接赋值？因为 JavaScript 中对象是引用类型，如果直接赋值，<code>originalPlan</code>和<code>tripPlan</code>会指向同一个对象，修改一个会影响另一个。深拷贝可以创建一个完全独立的副本。</p>
<p>移动景点的逻辑是交换数组中两个元素的位置：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// 移动景点</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">const</span> moveAttraction <span class="token operator">=</span> <span class="token punctuation">(</span>dayIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>attractionIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>direction<span class="token operator">:</span> <span class="token string">'up'</span> <span class="token operator">|</span> <span class="token string">'down'</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">  <span class="token keyword">const</span> attractions <span class="token operator">=</span> tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>days<span class="token punctuation">[</span>dayIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>attractions
</span><span class="code-line line-number" line="4">  <span class="token keyword">const</span> newIndex <span class="token operator">=</span> direction <span class="token operator">===</span> <span class="token string">'up'</span> <span class="token operator">?</span> attractionIndex <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">:</span> attractionIndex <span class="token operator">+</span> <span class="token number">1</span>
</span><span class="code-line line-number" line="5">  
</span><span class="code-line line-number" line="6">  <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> newIndex <span class="token operator">&lt;</span> attractions<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="7">    <span class="token punctuation">[</span>attractions<span class="token punctuation">[</span>attractionIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>attractions<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> 
</span><span class="code-line line-number" line="8">    <span class="token punctuation">[</span>attractions<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>attractions<span class="token punctuation">[</span>attractionIndex<span class="token punctuation">]</span><span class="token punctuation">]</span>
</span><span class="code-line line-number" line="9">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span>
</span></code></pre>
<p>这里使用了 ES6 的解构赋值语法来交换两个元素。<code>[a,b] = [b,a]</code>是一个很优雅的交换方式，不需要临时变量。</p>
<p>删除景点使用数组的<code>splice</code>方法：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// 删除景点</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">const</span> <span class="token function-variable function">deleteAttraction</span> <span class="token operator">=</span> <span class="token punctuation">(</span>dayIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>attractionIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">  tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>days<span class="token punctuation">[</span>dayIndex<span class="token punctuation">]</span><span class="token punctuation">.</span>attractions<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>attractionIndex<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="4"><span class="token punctuation">}</span>
</span></code></pre>
<p>保存修改时，我们需要重新初始化地图，因为景点的位置可能发生了变化：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token comment">// 保存修改</span>
</span><span class="code-line line-number" line="2"><span class="token keyword">const</span> <span class="token function-variable function">saveChanges</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="3">  editMode<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="4">  message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'修改已保存'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">  <span class="token function">initMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment">// 重新初始化地图</span>
</span><span class="code-line line-number" line="6"><span class="token punctuation">}</span>
</span><span class="code-line line-number" line="7">
</span><span class="code-line line-number" line="8"><span class="token comment">// 取消编辑</span>
</span><span class="code-line line-number" line="9"><span class="token keyword">const</span> <span class="token function-variable function">cancelEdit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="10">  <span class="token keyword">if</span> <span class="token punctuation">(</span>originalPlan<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">    tripPlan<span class="token punctuation">.</span>value <span class="token operator">=</span> originalPlan<span class="token punctuation">.</span>value
</span><span class="code-line line-number" line="12">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="13">  editMode<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
</span><span class="code-line line-number" line="14"><span class="token punctuation">}</span>
</span></code></pre>
<p>在模板中，我们根据<code>editMode</code>的值显示不同的 UI。编辑模式下，每个景点旁边会显示上移、下移、删除按钮：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;div v-if="editMode" class="edit-buttons"&gt;
</span><span class="code-line line-number" line="2">  &lt;a-button size="small" @click="moveAttraction(dayIndex,index,'up')"&gt;上移&lt;/a-button&gt;
</span><span class="code-line line-number" line="3">  &lt;a-button size="small" @click="moveAttraction(dayIndex,index,'down')"&gt;下移&lt;/a-button&gt;
</span><span class="code-line line-number" line="4">  &lt;a-button size="small" danger @click="deleteAttraction(dayIndex,index)"&gt;删除&lt;/a-button&gt;
</span><span class="code-line line-number" line="5">&lt;/div&gt;
</span></code></pre>
<h3>13.6.4 导出功能</h3>
<p>用户生成了满意的旅行计划后，可能想保存下来或分享给朋友。我们提供了两种导出方式：导出为图片和导出为 PDF。</p>
<p>导出功能的核心是<code>html2canvas</code>库。这个库可以把 DOM 元素转换成 Canvas，然后我们可以把 Canvas 导出为图片。但这里有一个技术难点：地图是用 Canvas 渲染的，而<code>html2canvas</code>在处理嵌套 Canvas 时存在兼容性问题。</p>
<p>我们尝试了多种解决方案，包括将地图 Canvas 转换成图片后再导出，但由于高德地图的 Canvas 渲染机制和跨域限制，这个方案并没有完全解决问题。在实际项目中，可能需要考虑以下替代方案：</p>
<ol>
<li><strong>使用高德地图的静态地图 API</strong>：调用<code>maps_staticmap</code>工具生成静态地图图片，替代动态地图</li>
<li><strong>分开导出</strong>：地图和行程内容分开导出，最后在后端合并</li>
<li><strong>使用截图服务</strong>：使用 Puppeteer 等无头浏览器在服务端截图</li>
<li><strong>简化导出内容</strong>：导出时隐藏地图，只导出文字内容</li>
</ol>
<p>目前的实现中，我们采用了简化方案，在导出时暂时隐藏地图部分，只导出行程的文字内容和景点信息。虽然这不是最理想的方案，但可以保证导出功能的可用性。</p>
<p>导出为图片的逻辑很简单：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> html2canvas <span class="token keyword">from</span> <span class="token string">'html2canvas'</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">const</span> <span class="token function-variable function">exportAsImage</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'trip-plan-content'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="5">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">)</span> <span class="token keyword">return</span>
</span><span class="code-line line-number" line="6">  
</span><span class="code-line line-number" line="7">  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">html2canvas</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    backgroundColor<span class="token operator">:</span> <span class="token string">'#ffffff'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="9">    scale<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="10">    useCORS<span class="token operator">:</span> <span class="token boolean">true</span>
</span><span class="code-line line-number" line="11">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="12">  
</span><span class="code-line line-number" line="13">  <span class="token keyword">const</span> link <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="14">  link<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>city<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">旅行计划.png</span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line line-number" line="15">  link<span class="token punctuation">.</span>href <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">  link<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="17">  message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'导出成功！'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="18"><span class="token punctuation">}</span>
</span></code></pre>
<p><code>scale: 2</code>表示使用 2 倍分辨率，这样导出的图片更清晰。<code>useCORS: true</code>允许跨域加载图片，这对于景点图片(来自 Unsplash)很重要。</p>
<p>导出为 PDF 需要额外的步骤：先转换成 Canvas，再转换成图片，最后添加到 PDF 中：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">import</span> jsPDF <span class="token keyword">from</span> <span class="token string">'jspdf'</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token keyword">const</span> <span class="token function-variable function">exportAsPDF</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="4">  <span class="token comment">// 先截取地图</span>
</span><span class="code-line line-number" line="5">  <span class="token keyword">await</span> <span class="token function">captureMapImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="6">  
</span><span class="code-line line-number" line="7">  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'trip-plan-content'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="8">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">)</span> <span class="token keyword">return</span>
</span><span class="code-line line-number" line="9">  
</span><span class="code-line line-number" line="10">  <span class="token keyword">const</span> canvas <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">html2canvas</span><span class="token punctuation">(</span>element<span class="token punctuation">,</span><span class="token punctuation">{</span>
</span><span class="code-line line-number" line="11">    backgroundColor<span class="token operator">:</span> <span class="token string">'#ffffff'</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="12">    scale<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="13">    useCORS<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
</span><span class="code-line line-number" line="14">    allowTaint<span class="token operator">:</span> <span class="token boolean">true</span>
</span><span class="code-line line-number" line="15">  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="16">  
</span><span class="code-line line-number" line="17">  <span class="token comment">// 恢复地图</span>
</span><span class="code-line line-number" line="18">  <span class="token function">restoreMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="19">  
</span><span class="code-line line-number" line="20">  <span class="token keyword">const</span> pdf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">jsPDF</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span><span class="token string">'mm'</span><span class="token punctuation">,</span><span class="token string">'a4'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="21">  <span class="token keyword">const</span> imgData <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token string">'image/png'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="22">  <span class="token keyword">const</span> imgWidth <span class="token operator">=</span> <span class="token number">210</span>  <span class="token comment">// A4宽度</span>
</span><span class="code-line line-number" line="23">  <span class="token keyword">const</span> imgHeight <span class="token operator">=</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>height <span class="token operator">*</span> imgWidth<span class="token punctuation">)</span> <span class="token operator">/</span> canvas<span class="token punctuation">.</span>width
</span><span class="code-line line-number" line="24">  
</span><span class="code-line line-number" line="25">  pdf<span class="token punctuation">.</span><span class="token function">addImage</span><span class="token punctuation">(</span>imgData<span class="token punctuation">,</span><span class="token string">'PNG'</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>imgWidth<span class="token punctuation">,</span>imgHeight<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="26">  pdf<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tripPlan<span class="token punctuation">.</span>value<span class="token punctuation">.</span>city<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">旅行计划.pdf</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="27">  message<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token string">'导出成功！'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="28"><span class="token punctuation">}</span>
</span></code></pre>
<p>这里需要计算图片的高度，保持宽高比。A4 纸的宽度是 210mm，我们根据 Canvas 的宽高比计算出对应的高度。</p>
<h3>13.6.5 侧边导航与锚点跳转</h3>
<p>Result 页面的内容很多，包括行程概览、预算明细、地图、每日行程、天气信息等。如果用户想快速跳转到某个部分，需要滚动很长的距离。我们提供了侧边导航和锚点跳转功能，让用户可以快速定位。</p>
<p>侧边导航使用 Ant Design Vue 的 Menu 组件：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;a-menu
</span><span class="code-line line-number" line="2">  v-model:selectedKeys="[activeSection]"
</span><span class="code-line line-number" line="3">  mode="inline"
</span><span class="code-line line-number" line="4">  @click="scrollToSection"
</span><span class="code-line line-number" line="5">&gt;
</span><span class="code-line line-number" line="6">  &lt;a-menu-item key="overview"&gt;📋 行程概览&lt;/a-menu-item&gt;
</span><span class="code-line line-number" line="7">  &lt;a-menu-item key="budget"&gt;💰 预算明细&lt;/a-menu-item&gt;
</span><span class="code-line line-number" line="8">  &lt;a-menu-item key="map"&gt;🗺️ 地图&lt;/a-menu-item&gt;
</span><span class="code-line line-number" line="9">  &lt;a-menu-item key="days"&gt;📅 每日行程&lt;/a-menu-item&gt;
</span><span class="code-line line-number" line="10">  &lt;a-menu-item key="weather"&gt;🌤️ 天气&lt;/a-menu-item&gt;
</span><span class="code-line line-number" line="11">&lt;/a-menu&gt;
</span></code></pre>
<p>点击菜单项时，调用<code>scrollToSection</code>函数：</p>
<pre class="language-typescript"><code class="language-typescript code-highlight"><span class="code-line line-number" line="1"><span class="token keyword">const</span> activeSection <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'overview'</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="2">
</span><span class="code-line line-number" line="3"><span class="token comment">// 滚动到指定区域</span>
</span><span class="code-line line-number" line="4"><span class="token keyword">const</span> <span class="token function-variable function">scrollToSection</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> key <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="5">  activeSection<span class="token punctuation">.</span>value <span class="token operator">=</span> key
</span><span class="code-line line-number" line="6">  <span class="token keyword">const</span> element <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
</span><span class="code-line line-number" line="7">  <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line line-number" line="8">    element<span class="token punctuation">.</span><span class="token function">scrollIntoView</span><span class="token punctuation">(</span><span class="token punctuation">{</span> behavior<span class="token operator">:</span> <span class="token string">'smooth'</span><span class="token punctuation">,</span>block<span class="token operator">:</span> <span class="token string">'start'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line line-number" line="9">  <span class="token punctuation">}</span>
</span><span class="code-line line-number" line="10"><span class="token punctuation">}</span>
</span></code></pre>
<p><code>scrollIntoView</code>是浏览器原生的 API，可以让元素滚动到可视区域。<code>behavior: 'smooth'</code>表示平滑滚动，而不是瞬间跳转。<code>block: 'start'</code>表示元素的顶部对齐到可视区域的顶部。</p>
<p>在页面的各个部分，我们需要添加对应的 id：</p>
<pre><code class="language-vue code-highlight"><span class="code-line line-number" line="1">&lt;div id="overview"&gt;
</span><span class="code-line line-number" line="2">  &lt;!-- 行程概览内容 --&gt;
</span><span class="code-line line-number" line="3">&lt;/div&gt;
</span><span class="code-line line-number" line="4">
</span><span class="code-line line-number" line="5">&lt;div id="budget"&gt;
</span><span class="code-line line-number" line="6">  &lt;!-- 预算明细内容 --&gt;
</span><span class="code-line line-number" line="7">&lt;/div&gt;
</span><span class="code-line line-number" line="8">
</span><span class="code-line line-number" line="9">&lt;div id="map"&gt;
</span><span class="code-line line-number" line="10">  &lt;!-- 地图内容 --&gt;
</span><span class="code-line line-number" line="11">&lt;/div&gt;
</span></code></pre>
<p>这样，当用户点击侧边导航的某个菜单项时，页面会平滑滚动到对应的部分。</p>
<p>通过这些功能的实现，我们的智能旅行助手不仅能够生成旅行计划，还提供了丰富的交互功能：预算计算让用户了解费用，加载进度条让等待不再焦虑，行程编辑让计划更符合个人需求，导出功能让计划可以分享和保存，侧边导航让长页面易于浏览。这些功能的组合，构成了一个完整、易用、实用的 Web 应用。</p>
<h2>13.7 结语</h2>
<p>恭喜你完成了第十三章的学习！</p>
<p>通过本章，你不仅学会了如何构建一个完整的智能旅行助手应用，更重要的是掌握了：</p>
<ol>
<li><strong>系统设计思维</strong>： 如何将复杂问题分解为多个简单任务</li>
<li><strong>工程实践能力</strong>： 如何将理论知识转化为可运行的代码</li>
<li><strong>全栈开发能力</strong>： 如何整合前后端技术栈</li>
<li><strong>AI 应用开发</strong>： 如何利用 LLM 构建实用的应用</li>
</ol>
<p>这个项目是一个起点，而不是终点。你可以基于这个项目：</p>
<ul>
<li>添加更多功能</li>
<li>优化用户体验</li>
<li>扩展到其他领域(如智能购物助手、智能学习助手等)</li>
<li>部署到生产环境，服务真实用户</li>
</ul>
<p>最好的学习方式是实践。不要只是阅读代码，而是要动手修改、扩展、优化。每一次实践都会让你对多 Agent 系统有更深的理解。</p>
<p>祝你在 AI 应用开发的道路上越走越远！</p>